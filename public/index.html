<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>SOLUCNET - Panel de Control WhatsApp</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            height: 100dvh;
            overflow: hidden;
            font-size: 14px;
        }

        /* Variables CSS para facilitar ajustes */
        :root {
            --sidebar-width-desktop: 350px;
            --sidebar-width-tablet: 280px;
            --sidebar-width-mobile: 250px;
            --header-height-desktop: 60px;
            --header-height-mobile: 50px;
            --primary-color: #00d4aa;
            --secondary-color: #17a2b8;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --success-color: #28a745;
            --border-radius: 8px;
        }

        .container {
            display: flex;
            height: calc(100dvh - var(--header-height-desktop));
            margin-top: var(--header-height-desktop);
        }

        /* ===============================================
           HEADER PRINCIPAL - OPTIMIZADO PARA TODOS LOS TAMAï¿½OS
           =============================================== */

        .main-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height-desktop);
            background: rgba(255, 255, 255, 0.95);
            border-bottom: 1px solid #e1e8ed;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 0;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .header-logo {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar-toggle-btn {
            background: #2a2f3a;
            color: #8b949e;
            border: none;
            padding: 6px 10px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 32px;
            height: 32px;
            flex-shrink: 0;
        }

        .sidebar-toggle-btn:hover {
            background: #3e4651;
            color: #ffffff;
        }

        .sidebar-toggle-btn.slide-right {
            transform: translateX(100px);
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            box-shadow: 0 4px 15px rgba(0, 212, 170, 0.4);
        }

        .user-info-btn {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.8em;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
            max-width: 120px;
            overflow: hidden;
        }

        .user-info-btn:hover {
            background: linear-gradient(135deg, #148496, #00b894);
            transform: translateY(-1px);
        }

        #user-name {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-role {
            font-size: 0.7em;
            opacity: 0.9;
            font-weight: 400;
        }

        .logout-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.8em;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .logout-btn:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        .qr-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(37, 211, 102, 0.1);
            border: 1px solid rgba(37, 211, 102, 0.3);
            border-radius: 8px;
            color: #25d366;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 8px;
        }

        .qr-btn:hover {
            background: rgba(37, 211, 102, 0.2);
            border-color: rgba(37, 211, 102, 0.5);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(37, 211, 102, 0.3);
        }

        .qr-btn i {
            font-size: 16px;
        }

        .qr-btn span {
            font-size: 14px;
        }

        .scan-qr-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #25d366, #128c7e);
            border: 1px solid rgba(37, 211, 102, 0.3);
            border-radius: 8px;
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 8px;
        }

        .scan-qr-btn:hover {
            background: linear-gradient(135deg, #128c7e, #075e54);
            border-color: rgba(37, 211, 102, 0.5);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.4);
        }

        .scan-qr-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(37, 211, 102, 0.3);
        }

        .scan-qr-btn i {
            font-size: 16px;
        }

        .scan-qr-btn span {
            font-size: 13px;
            white-space: nowrap;
        }

        .session-counter {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: linear-gradient(135deg, #17a2b8, #138496);
            border: 1px solid rgba(23, 162, 184, 0.3);
            border-radius: 8px;
            color: white;
            font-weight: 500;
            cursor: default;
            margin-right: 8px;
            font-family: 'Courier New', monospace;
            min-width: 80px;
        }

        .session-counter.warning {
            background: linear-gradient(135deg, #fd7e14, #e8680e);
            animation: pulse-warning 2s infinite;
        }

        .session-counter.critical {
            background: linear-gradient(135deg, #dc3545, #c82333);
            animation: pulse-critical 1s infinite;
        }

        @keyframes pulse-warning {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes pulse-critical {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .session-counter i {
            font-size: 14px;
            animation: clock-tick 1s infinite;
        }

        @keyframes clock-tick {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(5deg); }
        }

        .session-counter span {
            font-size: 13px;
            font-weight: bold;
            letter-spacing: 1px;
        }

        /* ===============================================
           SIDEBAR - COMPLETAMENTE RESPONSIVE
           =============================================== */

        .sidebar {
            width: 320px; /* Ancho fijo Ã³ptimo para todos los dispositivos */
            background: #FFFFFF;
            color: #3B4A54;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #E9EDEF;
            height: 100%;
            transition: all 0.3s ease;
        }

        .sidebar.hidden {
            width: 0;
            padding: 0;
            border: none;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 15px;
            background: #008069;
            border-bottom: none;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .sidebar-header:hover {
            background-color: #006d5b;
        }

        .sidebar-header h1 {
            font-size: 1.2em;
            margin-bottom: 5px;
            color: #FFFFFF;
        }

        .status {
            display: flex;
            align-items: center;
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.9);
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online {
            background: var(--success-color);
            box-shadow: 0 0 6px rgba(40, 167, 69, 0.5);
        }

        .status-offline {
            background: var(--danger-color);
            box-shadow: 0 0 6px rgba(220, 53, 69, 0.5);
        }

        /* Panel Buttons */
        .panel-buttons {
            display: flex;
            gap: 8px;
            padding: 15px;
            border-bottom: 1px solid #3e4651;
            flex-wrap: wrap;
        }

        .panel-btn {
            flex: 1;
            min-width: 80px;
            padding: 10px 8px;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8em;
            text-align: center;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .panel-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-health {
            background: linear-gradient(135deg, #00d2ff, #3a7bd5);
            position: relative;
        }

        .btn-health .alert-dot {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 8px;
            height: 8px;
            background: #ff4757;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .btn-omitted {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        }

        .btn-logs {
            background: linear-gradient(135deg, #00a884, #06cf9c);
        }

        .btn-admin {
            background: linear-gradient(135deg, #9c88ff, #6c5ce7);
        }

        .btn-clear {
            background: linear-gradient(135deg, #00b894, #00cec9);
        }

        .panel-btn i {
            font-size: 1em;
            margin-bottom: 2px;
        }

        .panel-btn span {
            font-size: 0.7em;
            line-height: 1;
        }

        /* New Chat Button */
        .new-chat-btn {
            width: auto;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: var(--border-radius);
            font-size: 0.75em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .new-chat-btn:hover {
            background: linear-gradient(135deg, #00b894, #148496);
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0, 212, 170, 0.3);
        }

        /* Chat Filters */
        .chat-filters {
            padding: 10px 15px;
            border-bottom: 1px solid #3e4651;
        }

        .filter-buttons {
            display: flex;
            gap: 4px;
        }

        .filter-btn {
            flex: 1;
            padding: 6px 8px;
            background: #3e4651;
            border: none;
            border-radius: var(--border-radius);
            color: #8b949e;
            cursor: pointer;
            font-size: 0.7em;
            transition: all 0.3s ease;
            text-align: center;
        }

        .filter-btn.active {
            background: var(--primary-color);
            color: white;
        }

        .filter-btn:hover {
            background: #4a5568;
        }

        .filter-btn.active:hover {
            background: #00b894;
        }

        /* Barras de BÃºsqueda */
        .search-container {
            padding: 10px 15px;
            border-bottom: 1px solid #3e4651;
            background: #2a2f3a;
        }

        .search-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-input {
            width: 100%;
            padding: 10px 40px 10px 40px;
            background: #3e4651;
            border: 1px solid #4a5568;
            border-radius: var(--border-radius);
            color: #e1e8ed;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            background: #4a5568;
        }

        .search-input::placeholder {
            color: #8b949e;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            color: #8b949e;
            pointer-events: none;
        }

        .search-clear {
            position: absolute;
            right: 12px;
            color: #8b949e;
            cursor: pointer;
            transition: color 0.3s ease;
            display: none;
        }

        .search-clear:hover {
            color: #e1e8ed;
        }

        .search-clear.visible {
            display: block;
        }

        /* Resaltado de bÃºsqueda en mensajes */
        .search-highlight {
            background-color: yellow;
            color: black;
            font-weight: bold;
            padding: 2px 4px;
            border-radius: 3px;
        }

        /* Chat List */
        .chat-list {
            flex: 1;
            overflow-y: auto;
            max-height: calc(100vh - 200px); /* Asegurar que tenga altura especÃ­fica */
            min-height: 300px; /* Altura mÃ­nima para scroll */
            background: #FFFFFF;
        }

        .chat-item {
            padding: 12px 15px;
            border-bottom: 1px solid #E9EDEF;
            cursor: pointer;
            transition: background 0.2s ease;
            position: relative;
            background: #FFFFFF;
        }

        .chat-item:hover {
            background: #F0F2F5;
        }

        .chat-item.active {
            background: #E9EDEF;
            color: #3B4A54;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .chat-name {
            font-weight: 600;
            font-size: 1.3em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #111B21;
        }

        .chat-time {
            font-size: 1.05em;
            color: #667781;
            flex-shrink: 0;
        }

        .chat-preview {
            font-size: 1.15em;
            color: #667781;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-mode {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.6em;
            font-weight: bold;
        }

        .mode-bot {
            background: #007bff;
            color: white;
        }

        .mode-human {
            background: var(--success-color);
            color: white;
        }

        /* ===============================================
           ï¿½REA PRINCIPAL - RESPONSIVE
           =============================================== */

        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            height: 100%;
            overflow: hidden;
            min-width: 0;
        }

        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #8b949e;
            text-align: center;
            padding: 20px;
        }

        .empty-state i {
            font-size: 3em;
            margin-bottom: 15px;
            color: #e1e8ed;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #1a1a1a;
            font-size: 1.2em;
        }

        .empty-state p {
            font-size: 0.9em;
            line-height: 1.4;
        }

        /* Chat Area */
        .chat-area {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            max-width: 100%;
            width: auto;
            overflow-x: auto;
            position: relative;
        }

        .chat-header-main {
            padding: 10px 15px;
            background: #075E54;
            border-bottom: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            min-height: 60px;
            height: auto;
            overflow: visible;
        }

        .back-to-sidebar-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            display: none;
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-title {
            font-size: 1em;
            font-weight: 600;
            color: #FFFFFF;
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-subtitle {
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 2px;
        }

        .chat-actions {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }

        .action-btn {
            padding: 6px 10px;
            border: 1px solid #e1e8ed;
            background: white;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .action-btn:hover {
            background: #f8f9fa;
        }

        .action-btn.primary {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .action-btn.danger {
            background: var(--danger-color);
            color: white;
            border-color: var(--danger-color);
        }

        /* BotÃ³n Cargar Historial */
        .load-history-btn {
            display: block;
            width: 90%;
            max-width: 300px;
            margin: 10px auto;
            padding: 10px 20px;
            background: #e1e8ed;
            color: #2a2f3a;
            border: 1px solid #8b949e;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.3s ease;
            text-align: center;
        }

        .load-history-btn:hover {
            background: #8b949e;
            color: white;
        }

        .load-history-btn:disabled {
            background: #ccc;
            color: #666;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .load-history-btn i {
            margin-right: 8px;
        }

        /* Messages Area */
        .messages-area {
            flex: 1;
            padding: 15px 10px 70px 10px; /* Reducido para subir el chat */
            overflow-y: auto;
            background: #E5DDD5;
            background-image:
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 35px,
                    rgba(255,255,255,.05) 35px,
                    rgba(255,255,255,.05) 70px
                );
            min-height: 0;
            max-width: 100%;
            width: auto;
            overflow-x: auto;
            scroll-behavior: auto; /* Desactivar scroll suave para scroll programÃ¡tico */
        }

        .message {
            margin-bottom: 10px;
            display: flex;
            align-items: flex-start;
        }

        .message.outgoing {
            justify-content: flex-end;
        }

        .message-content {
            max-width: 80%;
            padding: 6px 7px 8px 9px;
            border-radius: 7.5px;
            position: relative;
            word-wrap: break-word;
            font-size: 1.3em;
            box-shadow: 0 1px 0.5px rgba(0,0,0,.13);
        }

        .message.incoming .message-content {
            background: #FFFFFF;
            border: none;
            margin-right: 20px;
            color: #303030;
        }

        .message.outgoing .message-content {
            background: #D9FDD3;
            color: #303030;
            margin-left: 20px;
        }

        .message-time {
            font-size: 1em;
            opacity: 0.7;
            margin-top: 4px;
            text-align: right;
        }

        /* Estilos para multimedia dentro de mensajes */
        .message-text img {
            max-width: 100%;
            max-height: 300px;
            height: auto;
            width: auto;
            display: block;
            border-radius: 8px;
            cursor: pointer;
            object-fit: contain;
        }

        .message-text audio {
            max-width: 100%;
            width: 300px;
            display: block;
        }

        .message-text video {
            max-width: 100%;
            max-height: 400px;
            height: auto;
            width: auto;
            display: block;
            border-radius: 8px;
        }

        /* En mÃ³viles, ajustar tamaÃ±os */
        @media screen and (max-width: 768px) {
            .message-text img {
                max-height: 250px;
            }

            .message-text audio {
                width: 100%;
                max-width: 280px;
            }

            .message-text video {
                max-height: 300px;
            }
        }

        /* Message Input Area - EstÃ¡tica en la parte inferior */
        .message-input-area {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            padding: 10px 15px;
            background: #F0F0F0;
            border-top: none;
            z-index: 100;
            box-shadow: none;
            flex-shrink: 0;
            max-width: 100%;
            box-sizing: border-box;
        }

        .message-input-container {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            width: 100%;
        }

        .message-input {
            flex: 1;
            padding: 9px 12px;
            border: none;
            border-radius: 21px;
            font-size: 1.2em;
            outline: none;
            resize: none;
            max-height: 80px;
            min-height: 40px;
            line-height: 1.4;
            font-family: inherit;
            width: 100%;
            box-sizing: border-box;
            background: #FFFFFF;
        }

        .message-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 212, 170, 0.2);
        }

        .attach-btn {
            background: transparent;
            color: #54656F;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 1.2em;
            flex-shrink: 0;
        }

        .attach-btn:hover {
            background: rgba(84, 101, 111, 0.1);
        }

        .audio-btn {
            background: transparent;
            color: #54656F;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1.2em;
            flex-shrink: 0;
        }

        .audio-btn:hover {
            background: rgba(84, 101, 111, 0.1);
        }

        .audio-btn.recording {
            background: #ff4757;
            animation: pulse-recording 1s infinite;
        }

        @keyframes pulse-recording {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .send-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: #128C7E;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1em;
            transition: background 0.2s ease;
            flex-shrink: 0;
        }

        .send-btn:hover {
            background: #075E54;
        }

        .send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* ===============================================
           LOGIN SCREEN - RESPONSIVE
           =============================================== */

        .login-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.5s ease;
            padding: 15px;
        }

        .login-card {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-header h2 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.6em;
        }

        .login-header p {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 20px;
        }

        .login-form .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .login-form label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
            font-size: 0.9em;
        }

        .login-form input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 0.9em;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        .login-form input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 212, 170, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--primary-color), #00b894);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 212, 170, 0.3);
        }

        .login-error {
            background: #f8d7da;
            color: #721c24;
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 15px;
            border: 1px solid #f5c6cb;
            display: none;
            font-size: 0.8em;
        }

        .login-info {
            background: #d1ecf1;
            color: #0c5460;
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #bee5eb;
            font-size: 0.8em;
            text-align: left;
        }

        /* ===============================================
           MODALES - COMPLETAMENTE RESPONSIVE
           =============================================== */

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            animation: fadeIn 0.3s ease;
            padding: 15px;
        }

        .omitted-modal, .users-admin-modal, .logs-api-modal, .new-chat-modal,
        .edit-user-modal, .add-user-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            animation: fadeIn 0.3s ease;
            padding: 15px;
        }

        .omitted-modal.hidden, .users-admin-modal.hidden, .logs-api-modal.hidden,
        .new-chat-modal.hidden, .edit-user-modal.hidden, .add-user-modal.hidden {
            display: none;
        }

        .omitted-content, .new-chat-content {
            background: linear-gradient(145deg, #ffffff, #f8f9fa);
            padding: 20px;
            border-radius: 15px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            animation: modalSlideIn 0.4s ease;
        }

        .omitted-header, .new-chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f3f4;
        }

        .omitted-header h3, .new-chat-header h3 {
            margin: 0;
            color: #2d3748;
            font-size: 1.3em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .close-modal {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            border-radius: 8px;
            width: 32px;
            height: 32px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-modal:hover {
            background: linear-gradient(135deg, #ff5252, #d84315);
            transform: translateY(-2px);
        }

        /* Form Styles */
        .omitted-form, .new-chat-form {
            margin-bottom: 20px;
        }

        .omitted-form .form-row, .new-chat-form > div {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: flex-end;
        }

        .omitted-form input, .omitted-form textarea, .omitted-form select,
        .new-chat-form input, .new-chat-form textarea {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.9em;
            transition: all 0.3s ease;
            background: white;
        }

        .omitted-form input:focus, .omitted-form textarea:focus,
        .new-chat-form input:focus, .new-chat-form textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 212, 170, 0.1);
            outline: none;
        }

        .omitted-form textarea, .new-chat-form textarea {
            resize: vertical;
            min-height: 60px;
        }

        .new-chat-actions, .omitted-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 15px;
        }

        .btn-new-chat, .btn-cancel {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-new-chat {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .btn-cancel {
            background: #6c757d;
            color: white;
        }

        /* Barra de bÃºsqueda para nÃºmeros omitidos */
        .omitted-search-container {
            margin: 15px 0;
            position: relative;
        }

        .omitted-search-input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 14px;
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .omitted-search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(103, 116, 142, 0.1);
        }

        .omitted-search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #a0aec0;
            font-size: 16px;
        }

        .omitted-clear-search {
            position: absolute;
            right: 40px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #a0aec0;
            cursor: pointer;
            padding: 2px;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .omitted-clear-search:hover {
            background: #e2e8f0;
            color: #4a5568;
        }

        .omitted-search-stats {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            text-align: right;
        }

        .omitted-no-results {
            text-align: center;
            padding: 40px 20px;
            color: #666;
            background: linear-gradient(135deg, #f8f9fa, #ffffff);
            border-radius: 10px;
            border: 2px dashed #e2e8f0;
        }

        .omitted-no-results i {
            font-size: 48px;
            color: #cbd5e0;
            margin-bottom: 15px;
        }

        /* Lista Items */
        .omitted-list {
            padding-right: 5px;
            max-height: 350px;
            overflow-y: auto;
        }

        .omitted-item {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 12px;
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            overflow: hidden;
        }

        .omitted-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            transition: width 0.3s ease;
        }

        .omitted-item:hover {
            border-color: var(--primary-color);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(103, 116, 142, 0.15);
        }

        .omitted-item:hover::before {
            width: 6px;
        }

        .omitted-item .delete-btn, .omitted-item .edit-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.75em;
            font-weight: 600;
            transition: all 0.3s ease;
            opacity: 0.8;
        }

        .omitted-item:hover .delete-btn,
        .omitted-item:hover .edit-btn {
            opacity: 1;
        }

        .omitted-item .delete-btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            box-shadow: 0 2px 4px rgba(255, 107, 107, 0.3);
        }

        .omitted-item .delete-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(255, 107, 107, 0.4);
        }

        .omitted-item .edit-btn {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            right: 70px;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }

        .omitted-item .edit-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.4);
        }

        .omitted-item .numero {
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 1.1em;
            padding-right: 120px;
            display: flex;
            align-items: center;
        }

        .omitted-item .numero::before {
            content: 'ðŸ“±';
            margin-right: 8px;
            font-size: 1.2em;
        }

        .omitted-item .motivo {
            color: #4a5568;
            margin-bottom: 10px;
            line-height: 1.5;
            font-size: 0.9em;
            background: rgba(103, 116, 142, 0.05);
            padding: 8px 12px;
            border-radius: 8px;
            border-left: 3px solid var(--primary-color);
        }

        .omitted-item .meta {
            color: #718096;
            font-size: 0.8em;
            font-style: italic;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .omitted-item .meta::before {
            content: 'ðŸ‘¤';
            font-style: normal;
        }

        .omitted-item .meta::after {
            content: 'ðŸ“…';
            font-style: normal;
            margin-left: auto;
        }

        /* File handling */
        .file-preview-area {
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            padding: 8px;
            max-height: 150px;
            overflow-y: auto;
        }

        .file-preview-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 8px;
        }

        .file-preview-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 150px;
            position: relative;
            font-size: 0.8em;
        }

        .file-preview-item.image {
            flex-direction: column;
            align-items: center;
            width: 100px;
        }

        .file-preview-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
        }

        .file-preview-remove {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Notification System */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 16px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 10002;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            font-size: 0.9em;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: var(--success-color);
        }

        .notification.error {
            background: var(--danger-color);
        }

        .notification.info {
            background: var(--secondary-color);
        }

        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #e1e8ed;
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        /* Scrollbar personalizado */
        .chat-list::-webkit-scrollbar,
        .messages-area::-webkit-scrollbar,
        .omitted-list::-webkit-scrollbar {
            width: 4px;
        }

        .chat-list::-webkit-scrollbar-track,
        .messages-area::-webkit-scrollbar-track,
        .omitted-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-list::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 2px;
        }

        .messages-area::-webkit-scrollbar-thumb,
        .omitted-list::-webkit-scrollbar-thumb {
            background: #e1e8ed;
            border-radius: 2px;
        }
        /* Estilos para mensajes de audio enviados */
        .audio-message-container {
            background: #f0f2f5;
            border-radius: 12px;
            padding: 12px;
            margin: 4px 0;
            border-left: 4px solid #0084ff;
            max-width: 280px;
        }
        
        .message.outgoing .audio-message-container {
            background: #dcf8c6;
            border-left-color: #25d366;
        }
        
        .audio-message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
        }
        
        .message.outgoing .audio-message-header {
            color: #2e7d32;
        }
        
        .sent-audio-player {
            width: 100%;
            height: 40px;
            border-radius: 8px;
            outline: none;
        }
        
        .sent-audio-player::-webkit-media-controls-panel {
            background-color: transparent;
        }
        
        .sent-audio-player::-webkit-media-controls-play-button,
        .sent-audio-player::-webkit-media-controls-pause-button {
            background-color: #0084ff;
            border-radius: 50%;
        }
        
        .message.outgoing .sent-audio-player::-webkit-media-controls-play-button,
        .message.outgoing .sent-audio-player::-webkit-media-controls-pause-button {
            background-color: #25d366;
        }

        /* ===============================================
           RESPONSIVE DESIGN - OPTIMIZADO PARA MÃ“VILES
           =============================================== */
        
        /* Tablet - 768px y menores */
        @media screen and (max-width: 768px) {
            :root {
                --sidebar-width-desktop: var(--sidebar-width-tablet);
                --header-height-desktop: var(--header-height-mobile);
            }

            .container {
                height: calc(100dvh - var(--header-height-mobile));
                margin-top: var(--header-height-mobile);
            }

            .main-header {
                height: var(--header-height-mobile);
                padding: 0 10px;
            }

            .header-logo {
                font-size: 1.1em;
            }

            .sidebar {
                width: var(--sidebar-width-tablet);
            }

            .chat-area {
                flex: 1;
                min-width: 0;
            }

            .messages-area {
                padding: 10px 8px 120px 8px;
            }

            .message-input-area {
                padding: 8px 10px;
            }

            .message-input-container {
                gap: 6px;
            }

            .message-input {
                font-size: 14px;
                padding: 8px 10px;
            }

            .chat-item {
                padding: 10px;
            }

            .chat-name {
                font-size: 1.3em;
            }

            .chat-preview {
                font-size: 1.15em;
            }
        }

        /* MÃ³vil - 480px y menores */
        @media screen and (max-width: 480px) {
            :root {
                --sidebar-width-desktop: var(--sidebar-width-mobile);
                --header-height-desktop: 45px;
            }

            .container {
                height: calc(100dvh - 45px);
                margin-top: 45px;
                position: relative;
            }

            .main-header {
                height: 45px;
                padding: 0 8px;
            }

            .header-logo {
                font-size: 1em;
            }

            .sidebar-toggle-btn {
                padding: 4px 8px;
                font-size: 0.9em;
            }

            .sidebar {
                position: fixed;
                top: 45px; /* Debajo del header mÃ³vil */
                left: 0;
                width: 100%;
                height: calc(100dvh - 45px); /* Altura completa menos header */
                z-index: 1000;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                background: white;
                box-shadow: 2px 0 10px rgba(0,0,0,0.1);
                display: flex;
                flex-direction: column;
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .chat-area {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100%;
                display: none;
                z-index: 500;
            }

            .chat-area.mobile-active {
                display: flex;
            }

            .sidebar.mobile-hidden {
                display: none;
            }

            .back-to-sidebar-btn {
                display: flex;
            }

            .messages-area {
                padding: 8px 6px 85px 6px;
                font-size: 13px;
            }

            .message-input-area {
                padding: 6px 8px;
                background: rgba(255, 255, 255, 0.98);
            }

            .message-input-container {
                gap: 4px;
            }

            .message-input {
                font-size: 13px;
                padding: 6px 8px;
                min-height: 32px;
            }

            .send-btn {
                padding: 6px 8px;
            }

            .attach-btn, .audio-btn {
                padding: 6px;
                font-size: 0.9em;
            }

            .chat-item {
                padding: 8px;
                padding-bottom: 12px; /* MÃ¡s espacio para informaciÃ³n de mensajes */
            }

            .chat-name {
                font-size: 1.4em;
            }

            .chat-preview {
                font-size: 1.25em;
                line-height: 1.3;
            }

            .chat-time {
                font-size: 1.1em;
            }

            .chat-header-main {
                padding: 8px 10px;
            }

            .chat-title {
                font-size: 1em;
            }

            .chat-subtitle {
                font-size: 0.8em;
            }

            .action-btn span {
                display: none;
            }

            .action-btn {
                min-width: auto;
                padding: 6px 8px;
            }

            /* Mejoras para scroll en lista de chats en mÃ³vil */
            .chat-list {
                -webkit-overflow-scrolling: touch;
                scroll-behavior: smooth;
                flex: 1; /* Tomar todo el espacio disponible */
                max-height: none; /* Remover limitaciÃ³n de altura */
                padding-bottom: 20px; /* Espacio adicional para el Ãºltimo chat */
                margin: 0; /* Sin mÃ¡rgenes */
                overflow-y: auto;
                overflow-x: hidden;
            }

            .chat-list::-webkit-scrollbar {
                width: 2px;
            }

            /* Asegurar que el Ãºltimo chat sea visible */
            .chat-item:last-child {
                margin-bottom: 20px;
                border-bottom: none;
            }

            /* Modal optimizado para mÃ³vil */
            .qr-modal, .omitted-modal, .users-admin-modal {
                width: 95%;
                height: 90%;
                max-width: none;
                max-height: none;
                margin: 5vh 2.5%;
                border-radius: 10px;
            }

            .login-card {
                margin: 10px;
                padding: 20px;
                max-width: none;
                width: calc(100% - 20px);
            }

            .login-form input {
                padding: 10px;
                font-size: 16px; /* Evita zoom en iOS */
            }

            /* BÃºsqueda de nÃºmeros omitidos optimizada para mÃ³vil */
            .omitted-search-input {
                font-size: 16px; /* Evita zoom en iOS */
                padding: 10px 40px 10px 12px;
            }

            .omitted-item {
                padding: 15px;
                margin-bottom: 8px;
            }

            .omitted-item .numero {
                font-size: 1em;
                padding-right: 70px;
            }

            .omitted-item .numero::before {
                font-size: 1em;
            }

            .omitted-item .delete-btn {
                padding: 6px 8px;
                font-size: 0.7em;
                top: 12px;
                right: 12px;
            }

            .omitted-search-stats {
                font-size: 11px;
            }

            .login-btn {
                padding: 10px 20px;
                font-size: 15px;
            }
        }

        /* Extra pequeÃ±o - 360px y menores */
        @media screen and (max-width: 360px) {
            .messages-area {
                padding: 6px 4px 70px 4px;
                font-size: 12px;
            }

            .message-input {
                font-size: 12px;
                padding: 5px 6px;
            }

            .chat-item {
                padding: 6px;
                padding-bottom: 10px; /* Espacio adicional para informaciÃ³n de mensajes */
            }

            .header-logo {
                font-size: 0.9em;
            }

            .main-header {
                padding: 0 6px;
            }

            .chat-list {
                flex: 1; /* Tomar todo el espacio disponible */
                max-height: none; /* Sin limitaciÃ³n de altura */
                padding-bottom: 25px; /* MÃ¡s espacio para el Ãºltimo elemento */
                min-height: 0; /* Permitir que flexbox funcione correctamente */
            }

            /* Forzar que sidebar tenga la estructura correcta en pantallas pequeÃ±as */
            .sidebar {
                overflow: hidden; /* Evitar scroll en el sidebar completo */
            }

            .sidebar-filters {
                flex-shrink: 0; /* No reducir el tamaÃ±o de los filtros */
            }
        }

        /* ========================================
           MEDIA QUERIES ESPECÃFICAS PARA TABLETS
           ======================================== */
        
        /* Tablets estÃ¡ndar (iPad, Samsung Galaxy Tab, etc.) */
        @media (min-width: 768px) and (max-width: 1024px) {
            .container {
                height: 100dvh;
            }
            
            .chat-area {
                font-size: 0.95rem;
                height: 100dvh;
                max-width: 100%;
                overflow-y: auto;
            }
            
            .messages-area {
                padding: 15px 12px 100px 12px;
                font-size: 0.95rem;
                height: auto;
                max-width: 100%;
                overflow-x: hidden;
            }
            
            .message-content {
                max-width: 85%;
                font-size: 0.9rem;
            }
            
            /* Optimizar barra de entrada para tablets */
            .message-input-container {
                padding: 10px 15px;
                bottom: 0;
                position: absolute;
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
            }
            
            .message-input {
                font-size: 1rem;
                padding: 12px 15px;
                min-height: 45px;
                max-height: 120px;
                width: 100%;
                box-sizing: border-box;
            }
            
            /* Asegurar que el Ãºltimo mensaje sea visible */
            .messages-area {
                scroll-padding-bottom: 75px;
                scroll-behavior: smooth;
            }
            
            /* Optimizar sidebar para tablets */
            .sidebar {
                width: var(--sidebar-width-tablet);
                max-width: 320px;
            }
            
            /* Chat header optimizado */
            .chat-header-main {
                padding: 12px 15px;
                min-height: 65px;
            }
            
            /* Botones mÃ¡s accesibles en tablet */
            .send-btn, .attach-btn, .emoji-btn {
                min-width: 45px;
                min-height: 45px;
                font-size: 1.1rem;
            }
        }
        
        /* Tablets en orientaciÃ³n landscape */
        @media (min-width: 1024px) and (max-width: 1366px) and (orientation: landscape) {
            .container {
                max-width: 100%;
            }
            
            .chat-area {
                max-width: calc(100% - var(--sidebar-width-desktop));
            }
            
            .messages-area {
                padding: 20px 15px 75px 15px;
            }
        }

        /* Mejoras adicionales para mejor scroll y rendimiento */
        .chat-list {
            will-change: scroll-position;
            contain: layout style paint;
            scroll-behavior: smooth;
        }

        .messages-area {
            will-change: scroll-position;
            contain: layout style paint;
            scroll-behavior: smooth;
            /* Mejorar visualizaciÃ³n del Ãºltimo mensaje */
            scroll-padding-bottom: 70px;
        }
        
        /* Estilos adicionales para mejorar la experiencia en tablets */
        @supports (-webkit-overflow-scrolling: touch) {
            .messages-area {
                -webkit-overflow-scrolling: touch;
            }
        }
        
        /* Asegurar que todos los elementos sean accesibles en pantallas tÃ¡ctiles */
        .message-input-container * {
            touch-action: manipulation;
        }

        /* Smooth scrolling para toda la aplicaciÃ³n */
        * {
            scroll-behavior: smooth;
        }

        /* Optimizaciones tÃ¡ctiles */
        .chat-item, .action-btn, .sidebar-toggle-btn, .send-btn, .attach-btn, .audio-btn {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        /* Mejora la legibilidad en pantallas pequeÃ±as */
        @media screen and (max-width: 480px) {
            .message {
                max-width: 85%;
            }

            .message.incoming {
                margin-right: 15%;
            }

            .message.outgoing {
                margin-left: 15%;
            }
        }
        
        /* Optimizaciones adicionales para tablets */
        @media (min-width: 768px) and (max-width: 1024px) {
            /* Forzar altura completa para tablets */
            html, body {
                height: 100dvh !important;
                max-height: 100dvh !important;
                overflow: hidden;
            }
            
            .container {
                height: 100dvh !important;
                max-height: 100dvh !important;
                margin-top: 0;
            }
            
            .main-header {
                position: fixed;
                top: 0;
                z-index: 1001;
                height: 60px;
                width: 100%;
            }
            
            .chat-area {
                height: calc(100dvh - 60px) !important;
                margin-top: 60px;
            }
            
            .messages-area {
                height: calc(100dvh - 120px) !important;
                padding-bottom: 120px !important;
            }
            
            .message-input-area {
                position: absolute !important;
                bottom: 0 !important;
                height: 60px;
                z-index: 100;
                width: 100% !important;
                left: 0 !important;
                right: 0 !important;
            }
        }
    </style>
    <!-- Socket.io Client -->
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <!-- Pantalla de login -->
    <div class="login-container" id="login-container">
        <div class="login-card">
            <div class="login-header">
                <h2><i class="fab fa-whatsapp"></i> SOLUCNET</h2>
                <p>Panel de Control WhatsApp</p>
            </div>

            <form class="login-form" id="login-form">
                <div class="form-group">
                    <label for="username">Usuario</label>
                    <input type="text" id="username" name="username" required autocomplete="username">
                </div>

                <div class="form-group">
                    <label for="password">Contraseï¿½a</label>
                    <input type="password" id="password" name="password" required autocomplete="current-password">
                </div>

                <div class="login-error" id="login-error"></div>

                <button type="submit" class="login-btn" id="login-btn">
                    <i class="fas fa-sign-in-alt"></i> Iniciar Sesiï¿½n
                </button>
            </form>

            <div class="login-info">
                <strong>Usuarios disponibles:</strong><br>
                ï¿½ Usuario: <strong>admin</strong> / Contraseï¿½a: <strong>admin123</strong> (Administrador)<br>
                ï¿½ Usuario: <strong>soporte</strong> / Contraseï¿½a: <strong>soporte123</strong> (Soporte)
            </div>
        </div>
    </div>

    <!-- Contenedor principal de la aplicaciï¿½n -->
    <div class="container" id="main-container" style="display: none;">
        <!-- Header principal -->
        <div class="main-header">
            <div class="header-left">
                <button class="sidebar-toggle-btn" id="sidebar-toggle-btn" title="Mostrar/Ocultar Panel">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="header-logo">
                    <i class="fab fa-whatsapp"></i>
                    SOLUCNET
                </div>
            </div>
            <div class="header-right">
                <button class="user-info-btn" id="admin-visits-btn" title="GestiÃ³n de Visitas - Panel de AdministraciÃ³n">
                    <i class="fas fa-users-cog"></i>
                    <span>GestiÃ³n de Visitas</span>
                </button>
                <div class="session-counter" id="session-counter" title="Tiempo restante de sesiÃ³n">
                    <i class="fas fa-clock"></i>
                    <span id="session-time">15:00</span>
                </div>
                <button class="scan-qr-btn" id="scan-qr-btn" title="Escanear cÃ³digo QR de WhatsApp">
                    <i class="fas fa-qrcode"></i>
                    <span>Escanear QR</span>
                </button>
                <button class="logout-btn" id="logout-btn" title="Cerrar sesiï¿½n">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Salir</span>
                </button>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header" onclick="toggleSidebar()">
                <div>
                    <h1><i class="fab fa-whatsapp"></i> SOLUCNET</h1>
                    <div class="status">
                        <span class="status-indicator status-offline" id="connection-status"></span>
                        <span id="status-text">Conectando...</span>
                    </div>
                    </div>
                </div>
                
            <!-- Botones del panel -->
                <div class="panel-buttons">
                <button class="panel-btn btn-health" onclick="showHealthDashboard()" title="Dashboard de Salud del Bot">
                        <i class="fas fa-heartbeat"></i>
                        <span>Salud Bot</span>
                    </button>
                <button class="panel-btn btn-omitted" onclick="showOmittedModal()" title="Nï¿½meros Omitidos">
                        <i class="fas fa-ban"></i>
                        <span>Omitidos</span>
                    </button>
                    <button class="panel-btn btn-logs" onclick="window.location.href='/historial.html'" title="Historial de Chats">
                        <i class="fas fa-history"></i>
                        <span>Historial</span>
                    </button>
                    <button class="panel-btn btn-admin" onclick="showUsersAdminModal()" title="Administrar Usuarios">
                        <i class="fas fa-users-cog"></i>
                        <span>Usuarios</span>
                    </button>
                    <button class="panel-btn btn-clear" onclick="clearAllChats()" title="Eliminar todos los chats">
                        <i class="fas fa-broom"></i>
                        <span>Limpiar Chats</span>
                    </button>
                </div>
                
            <!-- Botï¿½n Nuevo Chat -->
            <button class="new-chat-btn" onclick="showNewChatModal()" title="Iniciar nueva conversaciï¿½n">
                    <i class="fas fa-plus"></i>
                    Nuevo Chat
                </button>
                
                <!-- Filtros de Chat -->
                <div class="chat-filters">
                    <div class="filter-buttons">
                        <button class="filter-btn active" data-filter="all">
                            <i class="fas fa-comments"></i> Todos
                        </button>
                        <button class="filter-btn" data-filter="bot">
                            <i class="fas fa-robot"></i> Bot
                        </button>
                        <button class="filter-btn" data-filter="human">
                            <i class="fas fa-user"></i> Humano
                        </button>
                </div>
            </div>

            <!-- Barra de BÃºsqueda de Chats -->
            <div class="search-container">
                <div class="search-input-wrapper">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text"
                           id="chat-search-input"
                           class="search-input"
                           placeholder="Buscar chat por nÃºmero o nombre..."
                           autocomplete="off">
                    <i class="fas fa-times search-clear" id="chat-search-clear"></i>
                </div>
            </div>

            <!-- Lista de Chats -->
            <div class="chat-list" id="chat-list">
                <!-- Los chats se cargarï¿½n aquï¿½ dinï¿½micamente -->
            </div>
        </div>

        <!-- ï¿½rea principal -->
        <div class="main-area">
            <!-- Estado vacï¿½o por defecto -->
            <div class="empty-state" id="empty-state">
                <i class="fab fa-whatsapp"></i>
                <h3>Panel de Control WhatsApp</h3>
                <p>Selecciona un chat para comenzar a ver y enviar mensajes</p>
                <p style="margin-top: 15px; font-size: 0.85em;">
                    <strong>Modos disponibles:</strong><br>
                    ðŸ¤– <span style="color: #007bff;">Bot</span> - Conversaciones automÃ¡ticas<br>
                    ðŸ‘¤ <span style="color: #28a745;">Humano</span> - IntervenciÃ³n manual
                </p>
            </div>

            <!-- ï¿½rea de chat (oculta por defecto) -->
            <div class="chat-area" id="chat-area" style="display: none;">
                <div class="chat-header-main">
                    <button class="back-to-sidebar-btn" id="back-to-sidebar-btn" onclick="showSidebarFromChat()" title="Volver al Panel">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div class="chat-info">
                        <div class="chat-title" id="current-chat-name">Cliente</div>
                        <div class="chat-subtitle" id="current-chat-subtitle">En lï¿½nea</div>
                </div>
                    <div class="chat-actions">
                        <button class="action-btn" id="search-messages-btn" title="Buscar en mensajes">
                            <i class="fas fa-search"></i> <span>Buscar</span>
                        </button>
                        <button class="action-btn" id="refresh-messages-btn">
                            <i class="fas fa-sync-alt"></i> <span>Refrescar</span>
                        </button>
                        <button class="action-btn" id="toggle-mode-btn">
                            <i class="fas fa-exchange-alt"></i> <span>Cambiar Modo</span>
                        </button>
                        <button class="action-btn danger" id="end-chat-btn">
                            <i class="fas fa-times"></i> <span>Finalizar</span>
                        </button>
                    </div>
                </div>

                <!-- Barra de BÃºsqueda dentro del Chat -->
                <div class="search-container" style="display: none;" id="message-search-container">
                    <div class="search-input-wrapper">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text"
                               id="message-search-input"
                               class="search-input"
                               placeholder="Buscar en los mensajes..."
                               autocomplete="off">
                        <i class="fas fa-times search-clear" id="message-search-clear"></i>
                    </div>
                    <div style="padding: 5px 0; font-size: 0.8em; color: #8b949e; text-align: center;" id="search-results-count"></div>
                </div>

                <div class="messages-area" id="messages-area">
                    <!-- Los mensajes se cargarï¿½n aquï¿½ -->
            </div>

                <div class="message-input-area" id="message-input-area">
                    <!-- ï¿½rea de preview de archivos -->
                    <div class="file-preview-area" id="file-preview-area" style="display: none;">
                        <div class="file-preview-list" id="file-preview-list">
                            <!-- Previews de archivos aparecerï¿½n aquï¿½ -->
                </div>
                        <button class="clear-files-btn" id="clear-files-btn">
                            <i class="fas fa-times"></i> Limpiar
                        </button>
                    </div>
                    
                    <div class="message-input-container">
                        <button class="attach-btn" id="attach-btn" title="Adjuntar archivo">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <button class="audio-btn" id="audio-btn" title="Grabar audio">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <input type="file" id="file-input" style="display: none;" multiple 
                               accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt,.zip,.rar">
                        <textarea 
                            class="message-input" 
                            id="message-input" 
                            placeholder="Escribe un mensaje..."
                            rows="1"
                        ></textarea>
                        <button class="send-btn" id="send-btn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    
                    <!-- Overlay para drag and drop -->
                    <div class="drag-overlay" id="drag-overlay" style="display: none;">
                        <div class="drag-content">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Suelta los archivos aquï¿½ para enviarlos</p>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        </div>

       
    <style>
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Asegurar que el modal QR sea visible sobre otros elementos */
    .qr-modal {
        backdrop-filter: blur(5px);
        border: 2px solid rgba(37, 211, 102, 0.3);
    }

    /* AnimaciÃ³n de entrada para el modal QR */
    .qr-modal:not(.hidden) {
        animation: slideInFromRight 0.3s ease-out;
    }

    /* AnimaciÃ³n de salida para el modal QR */
    .qr-modal.hidden {
        animation: slideOutToRight 0.2s ease-in;
    }

    @keyframes slideInFromRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes slideOutToRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
    </style>

    <!-- Modal para Dashboard de Salud del Bot -->
    <div class="omitted-modal hidden" id="health-dashboard-modal">
        <div class="omitted-content" style="max-width: 900px;">
            <div class="omitted-header">
                <h3><i class="fas fa-heartbeat"></i> Dashboard de Salud del Bot</h3>
                <button class="close-modal" onclick="closeHealthDashboard()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div style="padding: 20px;">
                <!-- Estado General -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 20px; margin-bottom: 20px; color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="margin: 0;"><i class="fas fa-robot"></i> Estado del Bot</h4>
                        <span id="health-status-badge" style="background: rgba(255,255,255,0.3); padding: 5px 15px; border-radius: 20px; font-size: 0.9em;">Cargando...</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <div style="opacity: 0.8; font-size: 0.85em;">Estado WhatsApp</div>
                            <div id="health-whatsapp-state" style="font-size: 1.2em; font-weight: bold; margin-top: 5px;">-</div>
                        </div>
                        <div>
                            <div style="opacity: 0.8; font-size: 0.85em;">Tiempo Activo</div>
                            <div id="health-uptime" style="font-size: 1.2em; font-weight: bold; margin-top: 5px;">-</div>
                        </div>
                        <div>
                            <div style="opacity: 0.8; font-size: 0.85em;">Chats Activos</div>
                            <div id="health-active-chats" style="font-size: 1.2em; font-weight: bold; margin-top: 5px;">-</div>
                        </div>
                    </div>
                </div>

                <!-- Mensajes y Errores -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <!-- Mensajes Exitosos -->
                    <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); border-radius: 12px; padding: 20px; color: white;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="opacity: 0.9; font-size: 0.85em;">Mensajes Exitosos</div>
                                <div id="health-success-count" style="font-size: 2em; font-weight: bold; margin-top: 5px;">0</div>
                                <div id="health-success-rate" style="opacity: 0.8; font-size: 0.9em; margin-top: 5px;">0% tasa de Ã©xito</div>
                            </div>
                            <i class="fas fa-check-circle" style="font-size: 3em; opacity: 0.3;"></i>
                        </div>
                    </div>

                    <!-- Mensajes Fallidos -->
                    <div style="background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); border-radius: 12px; padding: 20px; color: white;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="opacity: 0.9; font-size: 0.85em;">Mensajes Fallidos</div>
                                <div id="health-error-count" style="font-size: 2em; font-weight: bold; margin-top: 5px;">0</div>
                                <div id="health-error-rate" style="opacity: 0.8; font-size: 0.9em; margin-top: 5px;">0% tasa de error</div>
                            </div>
                            <i class="fas fa-exclamation-triangle" style="font-size: 3em; opacity: 0.3;"></i>
                        </div>
                    </div>
                </div>

                <!-- LÃ­mites Diarios -->
                <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h4 style="margin: 0 0 15px 0; color: #2d3748;"><i class="fas fa-chart-line"></i> Uso de LÃ­mites</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <!-- LÃ­mite Diario -->
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: #4a5568; font-size: 0.9em;">Mensajes Hoy</span>
                                <span id="health-daily-count" style="font-weight: bold; color: #2d3748;">0 / 300</span>
                            </div>
                            <div style="background: #e2e8f0; border-radius: 10px; height: 12px; overflow: hidden;">
                                <div id="health-daily-bar" style="background: linear-gradient(90deg, #4299e1, #3182ce); height: 100%; width: 0%; transition: width 0.3s;"></div>
                            </div>
                            <div id="health-daily-percentage" style="text-align: right; margin-top: 5px; font-size: 0.85em; color: #718096;">0%</div>
                        </div>

                        <!-- LÃ­mite por Hora -->
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: #4a5568; font-size: 0.9em;">Mensajes Esta Hora</span>
                                <span id="health-hourly-count" style="font-weight: bold; color: #2d3748;">0 / 120</span>
                            </div>
                            <div style="background: #e2e8f0; border-radius: 10px; height: 12px; overflow: hidden;">
                                <div id="health-hourly-bar" style="background: linear-gradient(90deg, #48bb78, #38a169); height: 100%; width: 0%; transition: width 0.3s;"></div>
                            </div>
                            <div id="health-hourly-percentage" style="text-align: right; margin-top: 5px; font-size: 0.85em; color: #718096;">0%</div>
                        </div>
                    </div>
                </div>

                <!-- Alertas Activas -->
                <div id="health-alerts-container" style="display: none; background: #fff3cd; border: 2px solid #ffc107; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #856404;"><i class="fas fa-exclamation-triangle"></i> Alertas Activas</h4>
                    <div id="health-alerts-list" style="color: #856404; font-size: 0.9em;"></div>
                </div>

                <!-- Ãšltimo Error -->
                <div id="health-last-error-container" style="display: none; background: #f8d7da; border: 2px solid #f5c6cb; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #721c24;"><i class="fas fa-bug"></i> Ãšltimo Error</h4>
                    <div id="health-last-error-details" style="color: #721c24; font-size: 0.85em; font-family: monospace;"></div>
                </div>

                <!-- Mensajes del Chatbot -->
                <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h4 style="margin: 0 0 15px 0; color: #2d3748;"><i class="fas fa-comments"></i> Mensajes Recientes del Chatbot</h4>
                    <div id="health-chatbot-messages" style="max-height: 400px; overflow-y: auto;">
                        <!-- Los mensajes se cargarÃ¡n aquÃ­ -->
                    </div>
                </div>

                <!-- BotÃ³n de Actualizar -->
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="refreshHealthDashboard()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                        <i class="fas fa-sync-alt"></i> Actualizar Datos
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para nï¿½meros omitidos -->
    <div class="omitted-modal hidden" id="omitted-modal">
        <div class="omitted-content">
            <div class="omitted-header">
                <h3><i class="fas fa-user-slash"></i> Nï¿½meros Omitidos</h3>
                <button class="close-modal" onclick="closeOmittedModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="omitted-form">
                <h4 style="margin: 0 0 15px 0; color: #2d3748; font-size: 1.1em;">Agregar nuevo nï¿½mero omitido</h4>
                <div class="form-row">
                    <input type="text" id="omitted-number" placeholder="Nï¿½mero (ej: 573001234567)" maxlength="20">
                    <button class="panel-btn btn-omitted" onclick="agregarNumeroOmitido()" style="flex-shrink: 0;">
                        <i class="fas fa-plus"></i> Agregar
                    </button>
                </div>
                <textarea id="omitted-reason" placeholder="Motivo por el cual se omite este nï¿½mero (opcional)" rows="2"></textarea>
            </div>

            <!-- Barra de bÃºsqueda -->
            <div class="omitted-search-container">
                <input type="text"
                       id="omitted-search"
                       class="omitted-search-input"
                       placeholder="Buscar nÃºmeros, motivos o usuarios..."
                       onkeyup="filterOmittedNumbers()"
                       onkeydown="handleOmittedSearchKeydown(event)"
                       autocomplete="off">
                <button class="omitted-clear-search" id="omitted-clear-search" onclick="clearOmittedSearch()">
                    <i class="fas fa-times"></i>
                </button>
                <i class="fas fa-search omitted-search-icon"></i>
                <div class="omitted-search-stats" id="omitted-search-stats"></div>
            </div>

            <div class="omitted-list" id="omitted-list">
                <!-- Lista de nï¿½meros omitidos se cargarï¿½ aquï¿½ -->
            </div>
        </div>
    </div>

    <!-- Modal para administraciï¿½n de usuarios -->
    <div class="users-admin-modal hidden" id="users-admin-modal">
        <div class="omitted-content" style="max-width: 700px;">
            <div class="omitted-header">
                <h3><i class="fas fa-users-cog"></i> Administraciï¿½n de Usuarios</h3>
                <button class="close-modal" onclick="closeUsersAdminModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Botï¿½n para agregar nuevo usuario -->
            <div style="text-align: center; margin: 15px 0; padding: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px;">
                <button class="panel-btn" onclick="showAddUserModal()" style="background: white; color: #667eea; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all 0.3s ease;">
                    <i class="fas fa-user-plus"></i> Agregar Nuevo Usuario
                </button>
            </div>

            <div class="omitted-list" id="users-admin-list">
                <!-- Lista de usuarios se cargarï¿½ aquï¿½ -->
            </div>
        </div>
    </div>

    <!-- Modal para editar usuarios -->
    <div class="edit-user-modal hidden" id="edit-user-modal">
        <div class="omitted-content" style="max-width: 500px;">
            <div class="omitted-header">
                <h3><i class="fas fa-user-edit"></i> Editar Usuario</h3>
                <button class="close-modal" onclick="closeEditUserModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="omitted-form">
                <input type="hidden" id="edit-user-id">
                <input type="text" id="edit-user-username" placeholder="Nombre de usuario" maxlength="50" style="width: 100%; margin-bottom: 10px;">
                <input type="password" id="edit-user-password" placeholder="Nueva contraseï¿½a (opcional)" maxlength="100" style="width: 100%; margin-bottom: 10px;">
                <select id="edit-user-role" style="width: 100%; margin-bottom: 10px; padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px;">
                        <option value="soporte">Soporte</option>
                        <option value="admin">Administrador</option>
                    </select>
                <input type="text" id="edit-user-nombre" placeholder="Nombre completo" style="width: 100%; margin-bottom: 15px;">
                <div style="text-align: center;">
                    <button class="panel-btn btn-admin" onclick="actualizarUsuario()" style="padding: 10px 25px; font-size: 0.9em;">
                        <i class="fas fa-save"></i> Actualizar Usuario
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para agregar nuevos usuarios -->
    <div class="add-user-modal hidden" id="add-user-modal">
        <div class="omitted-content" style="max-width: 500px;">
            <div class="omitted-header">
                <h3><i class="fas fa-user-plus"></i> Agregar Nuevo Usuario</h3>
                <button class="close-modal" onclick="closeAddUserModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="omitted-form">
                <input type="text" id="new-user-username" placeholder="Nombre de usuario" maxlength="50" style="width: 100%; margin-bottom: 10px;">
                <input type="password" id="new-user-password" placeholder="Contraseï¿½a" maxlength="100" style="width: 100%; margin-bottom: 10px;">
                <select id="new-user-role" style="width: 100%; margin-bottom: 10px; padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px;">
                        <option value="soporte">Soporte</option>
                        <option value="admin">Administrador</option>
                    </select>
                <input type="text" id="new-user-nombre" placeholder="Nombre completo" style="width: 100%; margin-bottom: 15px;">
                <div style="text-align: center;">
                    <button class="panel-btn btn-admin" onclick="agregarUsuario()" style="padding: 10px 25px; font-size: 0.9em; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white; border-radius: 8px;">
                        <i class="fas fa-save"></i> Crear Usuario
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para nuevo chat -->
    <div class="new-chat-modal hidden" id="new-chat-modal">
        <div class="omitted-content" style="max-width: 400px;">
            <div class="omitted-header">
                <h3><i class="fas fa-plus"></i> Nuevo Chat</h3>
                <button class="close-modal" onclick="closeNewChatModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="omitted-form">
                <div style="margin-bottom: 15px;">
                    <label for="new-chat-phone" style="display: block; margin-bottom: 5px; font-weight: bold;">NÃºmero de telÃ©fono:</label>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <span style="padding: 8px 12px; background: #f8f9fa; border: 2px solid #e2e8f0; border-radius: 8px 0 0 8px; color: #666;">+57</span>
                        <input type="tel" id="new-chat-phone" placeholder="3001234567" maxlength="10" 
                               style="flex: 1; padding: 8px 12px; border: 2px solid #e2e8f0; border-left: none; border-radius: 0 8px 8px 0;">
                    </div>
                    <small style="color: #666; font-size: 0.8em;">Solo ingresa los 10 dÃ­gitos del nÃºmero mÃ³vil</small>
                </div>

                <div style="margin-bottom: 15px;">
                    <label for="new-chat-message" style="display: block; margin-bottom: 5px; font-weight: bold;">Mensaje inicial:</label>
                    <textarea id="new-chat-message" placeholder="Escribe el primer mensaje..." rows="3"
                              style="width: 100%; padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px; resize: vertical; min-height: 60px;"></textarea>
                </div>

                <div style="text-align: center; display: flex; gap: 10px;">
                    <button class="panel-btn" onclick="closeNewChatModal()" 
                            style="flex: 1; padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px;">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button class="panel-btn btn-admin" onclick="createNewChat()" id="create-chat-btn"
                            style="flex: 1; padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 8px;">
                        <i class="fas fa-paper-plane"></i> Enviar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para logs de API -->
    <div class="logs-api-modal hidden" id="logs-api-modal">
        <div class="omitted-content" style="max-width: 900px;">
            <div class="omitted-header">
                <h3><i class="fas fa-history"></i> Logs de API</h3>
                <button class="close-modal" onclick="closeLogsAPIModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <select id="logs-filter-estado" onchange="loadLogsAPI()" style="padding: 6px 10px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 0.8em;">
                        <option value="">Todos los estados</option>
                        <option value="enviado">Enviado</option>
                        <option value="error_envio">Error de envï¿½o</option>
                        <option value="error_parametros">Error de parï¿½metros</option>
                        <option value="error_whatsapp_no_listo">WhatsApp no listo</option>
                        <option value="error_excepcion">Error de excepciï¿½n</option>
                    </select>
                    <button class="panel-btn btn-logs" onclick="loadLogsAPI()" style="padding: 6px 12px; font-size: 0.8em;">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                </div>
                <div style="font-size: 0.8em; color: #666;">
                    ï¿½ltimos 100 registros
                </div>
            </div>

            <div class="omitted-list" id="logs-api-list">
                <!-- Lista de logs se cargarï¿½ aquï¿½ -->
            </div>
        </div>
    </div>

    <!-- Modal para nuevo chat -->
    <div class="new-chat-modal hidden" id="new-chat-modal">
        <div class="new-chat-content">
            <div class="new-chat-header">
                <h3><i class="fas fa-comment-dots"></i> Nuevo Chat</h3>
                <button class="close-modal" onclick="closeNewChatModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form class="new-chat-form" onsubmit="createNewChat(event)">
                <div>
                    <label for="new-chat-number" style="display: block; margin-bottom: 6px; font-weight: 600; color: #4a5568; font-size: 0.9em;">
                        Nï¿½mero de telï¿½fono <span style="color: #e53e3e;">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="new-chat-number" 
                        placeholder="Ej: 573001234567" 
                        required
                        pattern="[0-9]{10,15}"
                        title="Ingresa un nï¿½mero vï¿½lido (solo dï¿½gitos, 10-15 caracteres)"
                    >
                    <small style="color: #718096; font-size: 0.75em; display: block; margin-top: 4px;">
                        Formato: cï¿½digo paï¿½s + nï¿½mero (sin espacios ni sï¿½mbolos)
                    </small>
                </div>
                
                <div>
                    <label for="new-chat-message" style="display: block; margin-bottom: 6px; font-weight: 600; color: #4a5568; font-size: 0.9em;">
                        Mensaje inicial (opcional)
                    </label>
                    <textarea 
                        id="new-chat-message" 
                        placeholder="Si no escribes nada, se enviarï¿½: 'Buenos dï¿½as, Bienvenido a SOLUCNET'"
                        rows="3"
                    ></textarea>
                </div>

                <div class="new-chat-actions">
                    <button type="button" class="btn-cancel" onclick="closeNewChatModal()">
                        Cancelar
                    </button>
                    <button type="submit" class="btn-new-chat">
                        <i class="fas fa-paper-plane"></i>
                        Crear Chat
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ï¿½rea de notificaciones -->
    <div id="notifications"></div>

    <script>
        // Variables globales
        let currentChatId = null;
        let chats = new Map();
        let currentFilter = 'all';
        let currentSearchTerm = ''; // TÃ©rmino de bÃºsqueda actual para persistir entre actualizaciones
        let currentMessageOffset = 0; // Offset para paginaciÃ³n de mensajes
        let hasMoreMessages = false; // Indica si hay mÃ¡s mensajes para cargar
        let totalMessagesInDB = 0; // Total de mensajes en la BD
        let isLoadingHistory = false; // Flag para evitar cargas mÃºltiples
        let socket = null;
        let socketIO = null; // Socket.io connection para WebSockets
        let isConnected = false;
        let useWebSockets = true; // Flag para usar WebSockets en lugar de polling
        let qrModalClosedByConnection = false; // Flag para saber si el modal se cerrÃ³ por conexiÃ³n exitosa
        let currentUser = null;
        let token = null;
        let selectedFiles = [];
        
        // CachÃ© para rastrear chats que ya cargaron sus mensajes viejos
        let loadedChatsCache = new Set();
        let chatMessagesCache = new Map(); // Almacenar mensajes cargados por chat
        
        // Set para rastrear chats que ya mostraron la notificaciÃ³n de mensajes cargados
        let notificationShownChats = new Set();

        // Inicializaciï¿½n
        // FunciÃ³n para manejar cambios de tamaÃ±o de ventana
        function handleWindowResize() {
            const sidebar = document.getElementById('sidebar');
            const chatArea = document.getElementById('chat-area');
            const toggleBtn = document.getElementById('sidebar-toggle-btn');
            const icon = toggleBtn?.querySelector('i');

            // Limpiar clases mÃ³viles cuando se cambia a desktop
            if (window.innerWidth > 480) {
                sidebar?.classList.remove('mobile-open');
                chatArea?.classList.remove('mobile-active');
                removeMobileOverlay();
                
                // Restaurar estado normal en desktop
                if (window.innerWidth > 768) {
                    sidebar?.classList.remove('expanded');
                    toggleBtn?.classList.remove('slide-right');
                    if (icon) {
                        icon.className = 'fas fa-bars';
                        toggleBtn.title = 'Mostrar/Ocultar Panel';
                    }
                }
            }

            // Ajustar scroll de lista de chats para el nuevo tamaÃ±o
            const chatList = document.getElementById('chat-list');
            if (chatList) {
                chatList.style.scrollBehavior = 'smooth';
            }

            // Forzar recÃ¡lculo de dimensiones de scroll para mensajes
            const messagesArea = document.getElementById('messages-area');
            if (messagesArea && currentChatId) {
                // PequeÃ±o delay para que se complete el resize
                setTimeout(() => {
                    if (messagesArea.scrollHeight > messagesArea.clientHeight) {
                        messagesArea.scrollTop = messagesArea.scrollHeight;
                    }
                }, 100);
            }

            console.log(`ðŸ“± Window resize: ${window.innerWidth}x${window.innerHeight}`);
        }

        // ===============================================
        // FUNCIONALIDAD DE BÃšSQUEDA
        // ===============================================

        function initSearchFeatures() {
            // BÃºsqueda en lista de chats
            const chatSearchInput = document.getElementById('chat-search-input');
            const chatSearchClear = document.getElementById('chat-search-clear');

            if (chatSearchInput) {
                chatSearchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.trim().toLowerCase();

                    // Mostrar/ocultar botÃ³n de limpiar
                    if (searchTerm) {
                        chatSearchClear.classList.add('visible');
                    } else {
                        chatSearchClear.classList.remove('visible');
                    }

                    // Filtrar chats en tiempo real
                    filterChatsBySearch(searchTerm);
                });

                chatSearchClear.addEventListener('click', function() {
                    chatSearchInput.value = '';
                    chatSearchClear.classList.remove('visible');
                    filterChatsBySearch('');
                });
            }

            // BÃºsqueda dentro del chat
            const messageSearchInput = document.getElementById('message-search-input');
            const messageSearchClear = document.getElementById('message-search-clear');
            const searchMessagesBtn = document.getElementById('search-messages-btn');
            const messageSearchContainer = document.getElementById('message-search-container');

            if (searchMessagesBtn) {
                searchMessagesBtn.addEventListener('click', function() {
                    // Toggle visibilidad de la barra de bÃºsqueda
                    if (messageSearchContainer.style.display === 'none') {
                        messageSearchContainer.style.display = 'block';
                        messageSearchInput.focus();
                    } else {
                        messageSearchContainer.style.display = 'none';
                        messageSearchInput.value = '';
                        clearMessageSearch();
                    }
                });
            }

            if (messageSearchInput) {
                messageSearchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.trim().toLowerCase();

                    // Mostrar/ocultar botÃ³n de limpiar
                    if (searchTerm) {
                        messageSearchClear.classList.add('visible');
                    } else {
                        messageSearchClear.classList.remove('visible');
                    }

                    // Debouncing: Esperar 500ms despuÃ©s de que el usuario deje de escribir
                    if (messageSearchTimeout) {
                        clearTimeout(messageSearchTimeout);
                    }

                    messageSearchTimeout = setTimeout(() => {
                        searchInMessages(searchTerm);
                    }, 500);
                });

                messageSearchClear.addEventListener('click', function() {
                    messageSearchInput.value = '';
                    messageSearchClear.classList.remove('visible');
                    clearMessageSearch();
                });
            }
        }

        function filterChatsBySearch(searchTerm) {
            // Guardar el tÃ©rmino de bÃºsqueda en la variable global
            currentSearchTerm = searchTerm;

            console.log(`ðŸ” BÃºsqueda de chats: tÃ©rmino actualizado a "${searchTerm}"`);

            // Re-renderizar la lista de chats con el filtro aplicado
            // El filtro se aplica automÃ¡ticamente durante renderChatList()
            renderChatList();
        }

        // Variable para almacenar el tÃ©rmino de bÃºsqueda actual
        let currentMessageSearchTerm = '';
        let isSearching = false;
        let messageSearchTimeout = null;

        async function searchInMessages(searchTerm) {
            const resultsCount = document.getElementById('search-results-count');

            // Si no hay tÃ©rmino o es muy corto, restaurar vista normal
            if (!searchTerm || searchTerm.trim().length < 2) {
                if (currentMessageSearchTerm) {
                    // Restaurar mensajes originales
                    currentMessageSearchTerm = '';
                    await loadMessagesSmart(currentChatId, false);
                }
                resultsCount.textContent = '';
                return;
            }

            if (isSearching) {
                console.log('ðŸ” Ya hay una bÃºsqueda en progreso...');
                return;
            }

            currentMessageSearchTerm = searchTerm;
            isSearching = true;

            try {
                console.log(`ðŸ” Buscando en toda la BD: "${searchTerm}"`);
                resultsCount.textContent = 'Buscando...';

                const response = await fetch(`/api/chats/${currentChatId}/search?q=${encodeURIComponent(searchTerm)}&limit=100`);

                if (!response.ok) {
                    throw new Error('Error en la bÃºsqueda');
                }

                const data = await response.json();

                if (data.success) {
                    const matchCount = data.total;
                    resultsCount.textContent = matchCount > 0
                        ? `${matchCount} resultado${matchCount !== 1 ? 's' : ''} encontrado${matchCount !== 1 ? 's' : ''} en BD`
                        : 'Sin resultados en BD';

                    // Mostrar resultados de bÃºsqueda en el Ã¡rea de mensajes
                    if (matchCount > 0) {
                        displaySearchResults(data.messages, searchTerm);
                    } else {
                        const messagesArea = document.getElementById('messages-area');
                        messagesArea.innerHTML = `
                            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #8b949e; text-align: center; padding: 20px;">
                                <i class="fas fa-search" style="font-size: 3em; margin-bottom: 15px; opacity: 0.5;"></i>
                                <p style="font-size: 1.1em; margin-bottom: 5px;">No se encontraron resultados</p>
                                <p style="font-size: 0.9em; opacity: 0.7;">No hay mensajes que coincidan con "${escapeHtml(searchTerm)}"</p>
                            </div>
                        `;
                    }

                    console.log(`âœ… BÃºsqueda completada: ${matchCount} resultados`);
                } else {
                    throw new Error(data.error || 'Error en la bÃºsqueda');
                }
            } catch (error) {
                console.error('âŒ Error en bÃºsqueda:', error);
                resultsCount.textContent = 'Error en bÃºsqueda';
                showNotification('Error al buscar mensajes', 'error');
            } finally {
                isSearching = false;
            }
        }

        function displaySearchResults(messages, searchTerm) {
            const messagesArea = document.getElementById('messages-area');

            if (!messages || messages.length === 0) {
                messagesArea.innerHTML = '<p style="text-align: center; color: #8b949e; padding: 20px;">No se encontraron resultados</p>';
                return;
            }

            // Crear regex para resaltar el tÃ©rmino de bÃºsqueda
            const regex = new RegExp(`(${escapeRegex(searchTerm)})`, 'gi');

            const messagesHTML = messages.map((msg, index) => {
                const messageId = generateMessageId(msg, index);
                const messageClass = msg.fromMe ? 'outgoing' : 'incoming';
                const messageTime = formatTime(msg.timestamp);
                const messageStatus = msg.fromMe ? getMessageStatus(msg.status) : '';

                // Procesar body y media por separado
                let messageContent = '';

                // Si hay mediaUrl, renderizar el elemento multimedia
                if (msg.mediaUrl) {
                    if (msg.type === 'image') {
                        messageContent += `<img src="${msg.mediaUrl}" alt="Imagen" style="max-width: 100%; border-radius: 8px; cursor: pointer; margin-bottom: 5px;" onclick="showImageModal(this.src)">`;
                    } else if (msg.type === 'audio' || msg.type === 'ptt') {
                        messageContent += `
                            <audio controls preload="metadata" playsinline style="width: 100%; max-width: 400px; margin-bottom: 5px;">
                                <source src="${msg.mediaUrl}" type="audio/ogg">
                                <source src="${msg.mediaUrl}" type="audio/mpeg">
                            </audio>
                        `;
                    }
                }

                // Si hay texto en el body, agregarlo con resaltado
                if (msg.body && msg.body.trim()) {
                    const highlightedBody = escapeHtml(msg.body).replace(regex, '<span class="search-highlight">$1</span>');
                    messageContent += `<div>${highlightedBody}</div>`;
                }

                return `
                    <div class="message ${messageClass}" data-message-id="${messageId}" data-timestamp="${msg.timestamp}">
                        <div class="message-content">
                            <div class="message-text">${messageContent}</div>
                            <div class="message-time">
                                ${messageTime}
                                ${msg.fromMe ? `<span class="message-status">${messageStatus}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Agregar banner indicando que se estÃ¡ en modo bÃºsqueda
            const searchBanner = `
                <div style="background: #2a2f3a; padding: 10px; text-align: center; border-bottom: 2px solid #4CAF50; position: sticky; top: 0; z-index: 100;">
                    <span style="color: #4CAF50;">ðŸ” Mostrando resultados de bÃºsqueda</span>
                    <button onclick="clearMessageSearch()" style="margin-left: 10px; padding: 5px 10px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Volver a chat completo
                    </button>
                </div>
            `;

            messagesArea.innerHTML = searchBanner + messagesHTML;
        }

        async function clearMessageSearch() {
            const resultsCount = document.getElementById('search-results-count');
            const messageSearchInput = document.getElementById('message-search-input');

            // Limpiar bÃºsqueda
            currentMessageSearchTerm = '';
            resultsCount.textContent = '';

            if (messageSearchInput) {
                messageSearchInput.value = '';
            }

            // Recargar mensajes originales
            if (currentChatId) {
                await loadMessagesSmart(currentChatId, false);
            }
        }

        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        document.addEventListener('DOMContentLoaded', function() {
            checkExistingSession();
            setupLoginEvents();
            initMobileScrollObserver();
            initSearchFeatures(); // Inicializar funcionalidad de bÃºsqueda

            // Agregar listener para cambios de tamaÃ±o de ventana
            let resizeTimeout;
            window.addEventListener('resize', function() {
                // Debounce para evitar llamadas excesivas
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(handleWindowResize, 250);
            });

            // Agregar listener para cambio de orientaciÃ³n en mÃ³vil
            window.addEventListener('orientationchange', function() {
                setTimeout(handleWindowResize, 500); // Delay mayor para orientationchange
            });
        });

        function checkExistingSession() {
            const savedToken = localStorage.getItem('token');
            console.log('ðŸ” Checking existing session...');
            console.log('ðŸ“‹ Saved token in localStorage:', savedToken ? 'EXISTS' : 'NULL');
            
            if (savedToken) {
                console.log('âœ… Token found, verifying session...');
                verifySession(savedToken);
            } else {
                console.log('âŒ No token found, showing login screen');
                showLoginScreen();
            }
        }

        function showLoginScreen() {
            const loginContainer = document.getElementById('login-container');
            const mainContainer = document.getElementById('main-container');
            
            if (loginContainer) loginContainer.style.display = 'flex';
            if (mainContainer) mainContainer.style.display = 'none';
        }

        function setupLoginEvents() {
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }

            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
            }
        }

        async function handleLogin(e) {
            e.preventDefault();

            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const loginBtn = document.getElementById('login-btn');

            if (!username || !password) {
                showLoginError('Por favor ingresa usuario y contraseï¿½a');
                return;
            }

            try {
                loginBtn.disabled = true;
                loginBtn.innerHTML = '<div class="loading"></div> Iniciando...';

                console.log('ðŸ” Iniciando proceso de login...');
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                console.log('ðŸ“¡ Respuesta del servidor:', response.status);

                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('Credenciales incorrectas');
                    } else if (response.status === 403) {
                        throw new Error('Acceso denegado');
                    } else if (response.status >= 500) {
                        throw new Error('Error del servidor. Intenta mÃ¡s tarde');
                    } else {
                        throw new Error(`Error HTTP ${response.status}`);
                    }
                }

                const data = await response.json();
                console.log('ðŸ“‹ Datos de respuesta:', data);

                if (data.success && data.token) {
                    console.log('=== LOGIN SUCCESSFUL - Starting QR modal sequence ===');
                    currentUser = data.user;
                    token = data.token;
                    localStorage.setItem('token', token);

                    // Validar la sesiÃ³n antes de mostrar la app
                    console.log('ðŸ” Validando sesiÃ³n despuÃ©s del login...');
                    const sessionValid = await validateSession();
                    if (!sessionValid) {
                        throw new Error('SesiÃ³n no pudo ser validada despuÃ©s del login');
                    }

                    // Resetear flag para permitir mostrar el modal QR en esta nueva sesiÃ³n
                    qrModalClosedByConnection = false;
                    console.log('QR modal flag reset to:', qrModalClosedByConnection);

                    // Inicializar los botones QR, contador de sesiÃ³n y manejo de errores de audio
                    console.log('Initializing QR buttons, session counter and audio error handling...');
                    initializeQRButton();
                    initializeScanQRButton();
                    initializeSessionCounter();
                    setupAudioErrorHandling();
                    fixMultimediaUrls();

                    // Verificar que el modal QR estÃ© oculto despuÃ©s del login
                    setTimeout(() => {
                        const qrModal = document.getElementById('qr-modal');
                        if (qrModal && !qrModal.classList.contains('hidden')) {
                            console.error('âŒ QR modal is visible after login - this should not happen!');
                            console.log('QR modal classes:', qrModal.classList.toString());
                            // Forzar ocultar el modal
                            qrModal.classList.add('hidden');
                            console.log('âœ… QR modal forced hidden after login');
                        } else {
                            console.log('âœ… QR modal correctly hidden after login');
                        }
                    }, 500);
                    
                    showMainApp();
                    initializeApp();
                    setupEventListeners();

                    // Inicializar WebSockets primero
                    initWebSockets();

                    // Iniciar polling como fallback
                    startPolling();

                    // Iniciar mantenimiento automÃ¡tico de sesiÃ³n
                    initializeSessionMaintenance();
                } else {
                    showLoginError(data.message || 'Error de autenticaciï¿½n');
                }
            } catch (error) {
                console.error('âŒ Error en login:', error);
                showLoginError(error.message || 'Error de conexiÃ³n. Intenta nuevamente.');

                // Limpiar datos corruptos si es necesario
                localStorage.removeItem('token');
                token = null;
                currentUser = null;
            } finally {
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Iniciar Sesiï¿½n';
            }
        }

        function showLoginError(message) {
            const loginError = document.getElementById('login-error');
            if (loginError) {
                loginError.textContent = message;
                loginError.style.display = 'block';
                setTimeout(() => loginError.style.display = 'none', 5000);
            }
        }

        // FunciÃ³n para validar sesiÃ³n antes de operaciones crÃ­ticas
        async function validateSession() {
            if (!token) {
                console.error('âŒ No hay token para validar');
                showNotification('SesiÃ³n no iniciada', 'error');
                showLoginScreen();
                return false;
            }

            try {
                console.log('ðŸ” Validando sesiÃ³n activa...');
                const response = await fetch(`/api/session?token=${token}`);
                const data = await response.json();

                if (data.success && data.user) {
                    console.log('âœ… SesiÃ³n vÃ¡lida:', data.user.username);
                    currentUser = data.user;
                    return true;
                } else {
                    console.error('âŒ SesiÃ³n invÃ¡lida o expirada');
                    showNotification('SesiÃ³n expirada. Redirigiendo al login...', 'error');
                    localStorage.removeItem('token');
                    token = null;
                    showLoginScreen();
                    return false;
                }
            } catch (error) {
                console.error('âŒ Error validando sesiÃ³n:', error);
                showNotification('Error de conexiÃ³n. Verificando sesiÃ³n...', 'error');
                // Intentar reconectar en 3 segundos
                setTimeout(() => {
                    if (token) validateSession();
                }, 3000);
                return false;
            }
        }

        async function verifySession(savedToken) {
            try {
                console.log('ðŸ” Verificando sesiÃ³n en inicializaciÃ³n...');
                console.log('ðŸŽ« Token to verify:', savedToken.substring(0, 20) + '...');
                const response = await fetch(`/api/session?token=${savedToken}`);
                console.log('ðŸ“¡ Response status:', response.status);
                const data = await response.json();
                console.log('ðŸ“‹ Response data:', data);

                if (data.success) {
                    currentUser = data.user;
                    // Asignar el token a la variable global
                    token = savedToken;
                    window.token = savedToken;
                    console.log('âœ… SesiÃ³n verificada exitosamente:', data.user.username);
                    console.log('ðŸŽ« Token assigned to global scope:', savedToken.substring(0, 20) + '...');

                    // Validar sesiÃ³n completa antes de mostrar la app
                    const isValid = await validateSession();
                    if (isValid) {
                        showMainApp();
                        initializeApp();
                        setupEventListeners();

                        // Inicializar WebSockets primero
                        initWebSockets();

                        // Iniciar polling como fallback
                        startPolling();
                        // Iniciar mantenimiento automÃ¡tico de sesiÃ³n
                        initializeSessionMaintenance();
                    }
                } else {
                    console.error('âŒ VerificaciÃ³n de sesiÃ³n fallida');
                    console.error('ðŸ“‹ Failed response data:', data);
                    localStorage.removeItem('token');
                    showLoginScreen();
                }
            } catch (error) {
                console.error('âŒ Error verificando sesiÃ³n:', error);
                console.error('ðŸ“‹ Error details:', error.message);
                localStorage.removeItem('token');
                showLoginScreen();
            }
        }

        function showMainApp() {
            const loginContainer = document.getElementById('login-container');
            const mainContainer = document.getElementById('main-container');

            if (loginContainer) loginContainer.style.display = 'none';
            if (mainContainer) mainContainer.style.display = 'flex';

            updateUserInfo();
        }

        function updateUserInfo() {
            // La informaciÃ³n del usuario ahora se muestra a travÃ©s del botÃ³n de "GestiÃ³n de Visitas"
            // que solo aparece para usuarios administradores

            if (currentUser) {
                console.log('ðŸ‘¤ User info updated:', currentUser.nombre, `(${currentUser.rol})`);

                // Mostrar botÃ³n de gestiÃ³n de visitas para todos los usuarios
                const adminVisitsBtn = document.getElementById('admin-visits-btn');
                if (adminVisitsBtn) {
                    adminVisitsBtn.style.display = 'flex';
                }
            }
        }

        async function handleLogout() {
            try {
                if (token) {
                    await fetch('/api/logout', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token })
                    });
                }
            } catch (error) {
                console.error('Error en logout:', error);
            } finally {
                currentUser = null;
                token = null;
                localStorage.removeItem('token');
                
                // Limpiar cachÃ© de mensajes y notificaciones al cerrar sesiÃ³n
                loadedChatsCache.clear();
                chatMessagesCache.clear();
                notificationShownChats.clear();
                console.log('ðŸ’¾ CachÃ© de mensajes y notificaciones limpiado al cerrar sesiÃ³n');

                const loginContainer = document.getElementById('login-container');
                const mainContainer = document.getElementById('main-container');

                if (loginContainer) loginContainer.style.display = 'flex';
                if (mainContainer) mainContainer.style.display = 'none';

                document.getElementById('username').value = '';
                document.getElementById('password').value = '';

                showNotification('Sesiï¿½n cerrada correctamente', 'info');
            }
        }

        function initializeApp() {
            // NO ocultar el modal QR aquÃ­ - debe mantenerse visible hasta que WhatsApp se conecte
            // El modal QR se muestra en handleLogin() antes de inicializar la app

            // Inicializar manejo de errores de audio y corregir URLs multimedia
            setupAudioErrorHandling();
            fixMultimediaUrls();

            // Verificar conexiÃ³n despuÃ©s de un pequeÃ±o delay
            setTimeout(() => {
                checkConnectionStatus();
            }, 1000);
            loadChats();
        }

        function setupEventListeners() {
            if (window.eventListenersSetup) return;
            window.eventListenersSetup = true;

            // Filtros de chat
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.dataset.filter;
                    filterChats();
                });
            });

            // Manejo de archivos
            setupFileHandling();

            // Envï¿½o de mensajes
            const messageInput = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');

            if (messageInput) {
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 100) + 'px';
            });
            }

            if (sendBtn) {
                // Remover listeners anteriores para evitar duplicados
                const newSendBtn = sendBtn.cloneNode(true);
                sendBtn.parentNode.replaceChild(newSendBtn, sendBtn);
                newSendBtn.addEventListener('click', sendMessage);
            }

            // Configurar grabaciÃ³n de audio
            setupAudioRecording();

            // Botones de acciï¿½n
            const refreshMessagesBtn = document.getElementById('refresh-messages-btn');
            const toggleModeBtn = document.getElementById('toggle-mode-btn');
            const endChatBtn = document.getElementById('end-chat-btn');
            const adminVisitsBtn = document.getElementById('admin-visits-btn');
            const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');

            if (refreshMessagesBtn) refreshMessagesBtn.addEventListener('click', () => {
                if (currentChatId) {
                    loadMessagesSmart(currentChatId, true, false); // Forzar recarga completa, no silencioso
                    showNotification('Refrescando mensajes...', 'info');
                }
            });
            if (toggleModeBtn) toggleModeBtn.addEventListener('click', toggleChatMode);
            if (endChatBtn) endChatBtn.addEventListener('click', endChat);
            if (adminVisitsBtn) adminVisitsBtn.addEventListener('click', openAdminPanel);
            if (sidebarToggleBtn) sidebarToggleBtn.addEventListener('click', toggleSidebar);
        }

        // Funciï¿½n para toggle del sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('sidebar-toggle-btn');
            const icon = toggleBtn.querySelector('i');
            const chatArea = document.getElementById('chat-area');

            // Manejo mejorado para dispositivos mÃ³viles
            if (window.innerWidth <= 480) {
                // En mÃ³vil: alternar clases mobile-open/mobile-hidden
                sidebar.classList.toggle('mobile-open');
                
                if (sidebar.classList.contains('mobile-open')) {
                    icon.className = 'fas fa-arrow-left';
                    toggleBtn.title = 'Ocultar Panel';
                    // Ocultar Ã¡rea de chat cuando se muestra sidebar en mÃ³vil
                    if (chatArea) {
                        chatArea.classList.remove('mobile-active');
                    }
                    // Agregar overlay para cerrar sidebar tocando fuera
                    addMobileOverlay();
                } else {
                    icon.className = 'fas fa-bars';
                    toggleBtn.title = 'Mostrar Panel';
                    removeMobileOverlay();
                }
            } else if (window.innerWidth <= 768) {
                // En tablet: usar lÃ³gica existente
                sidebar.classList.toggle('expanded');

                if (sidebar.classList.contains('expanded')) {
                    toggleBtn.classList.add('slide-right');
                    icon.className = 'fas fa-arrow-left';
                    toggleBtn.title = 'Ocultar Panel';

                    if (chatArea && chatArea.classList.contains('fullscreen')) {
                        chatArea.classList.remove('fullscreen');
                    }
                } else {
                    toggleBtn.classList.remove('slide-right');
                    icon.className = 'fas fa-bars';
                    toggleBtn.title = 'Mostrar Panel';
                }
            } else {
                // En desktop: lÃ³gica original
                sidebar.classList.toggle('hidden');

                if (sidebar.classList.contains('hidden')) {
                    icon.className = 'fas fa-arrow-right';
                    toggleBtn.title = 'Mostrar Panel';
                } else {
                    icon.className = 'fas fa-bars';
                    toggleBtn.title = 'Ocultar Panel';
                }
            }
        }

        // ===== FUNCIONALIDAD DE GRABACIÃ“N DE AUDIO =====
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let recordingStartTime = null;

        function setupAudioRecording() {
            const audioBtn = document.getElementById('audio-btn');
            if (!audioBtn) return;

            audioBtn.addEventListener('click', toggleAudioRecording);
        }

        async function toggleAudioRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        async function startRecording() {
            try {
                console.log('ðŸŽ¤ Iniciando grabaciÃ³n de audio...');
                
                // Solicitar permisos de micrÃ³fono
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 44100
                    } 
                });

                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm;codecs=opus'
                });

                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    handleRecordingComplete();
                    // Detener el stream
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                isRecording = true;
                recordingStartTime = Date.now();

                // Actualizar UI
                const audioBtn = document.getElementById('audio-btn');
                audioBtn.classList.add('recording');
                audioBtn.innerHTML = '<i class="fas fa-stop"></i>';
                audioBtn.title = 'Detener grabaciÃ³n';

                showNotification('ðŸŽ¤ Grabando audio... Click para detener', 'info');

            } catch (error) {
                console.error('Error iniciando grabaciÃ³n:', error);
                showNotification('âŒ Error accediendo al micrÃ³fono. Verifica permisos.', 'error');
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                console.log('â¹ï¸ Deteniendo grabaciÃ³n...');
                mediaRecorder.stop();
                isRecording = false;

                // Actualizar UI
                const audioBtn = document.getElementById('audio-btn');
                audioBtn.classList.remove('recording');
                audioBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                audioBtn.title = 'Grabar audio';
            }
        }

        async function handleRecordingComplete() {
            try {
                const recordingDuration = Date.now() - recordingStartTime;
                console.log(`ðŸŽµ GrabaciÃ³n completada. DuraciÃ³n: ${recordingDuration}ms`);

                if (recordingDuration < 1000) {
                    showNotification('âš ï¸ La grabaciÃ³n debe durar al menos 1 segundo', 'warning');
                    return;
                }

                // Crear blob de audio
                const audioBlob = new Blob(audioChunks, { 
                    type: 'audio/webm;codecs=opus' 
                });

                console.log('ðŸ“ Audio blob creado:', {
                    size: audioBlob.size,
                    type: audioBlob.type
                });

                // Mostrar vista previa del audio antes de enviar
                showAudioPreview(audioBlob);

            } catch (error) {
                console.error('Error procesando audio:', error);
                showNotification('âŒ Error procesando el audio grabado', 'error');
            }
        }

        function showAudioPreview(audioBlob) {
            console.log('ðŸ”Š Mostrando vista previa de audio');
            
            // Crear URL del blob para reproducciÃ³n
            const audioUrl = URL.createObjectURL(audioBlob);
            const duration = Math.round((Date.now() - recordingStartTime) / 1000);
            
            // Crear elemento de vista previa
            const previewContainer = document.createElement('div');
            previewContainer.className = 'audio-preview-container';
            previewContainer.innerHTML = `
                <div class="audio-preview-header">
                    <i class="fas fa-microphone"></i>
                    <span>Audio grabado (${duration}s)</span>
                    <button class="audio-preview-close" onclick="cancelAudioPreview()">&times;</button>
                </div>
                <div class="audio-preview-content">
                    <audio controls class="audio-preview-player">
                        <source src="${audioUrl}" type="audio/webm">
                        Tu navegador no soporta la reproducciÃ³n de audio.
                    </audio>
                    <div class="audio-preview-actions">
                        <button class="audio-preview-btn cancel" onclick="cancelAudioPreview()">
                            <i class="fas fa-trash"></i> Descartar
                        </button>
                        <button class="audio-preview-btn send" onclick="confirmSendAudio()">
                            <i class="fas fa-paper-plane"></i> Enviar
                        </button>
                    </div>
                </div>
            `;
            
            // Agregar estilos
            const style = document.createElement('style');
            style.textContent = `
                .audio-preview-container {
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: white;
                    border-radius: 12px;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                    z-index: 10000;
                    min-width: 350px;
                    max-width: 400px;
                    width: 90%;
                    max-height: 90vh;
                    overflow: hidden;
                }
                
                
                .audio-preview-header {
                    background: #0084ff;
                    color: white;
                    padding: 12px 16px;
                    border-radius: 12px 12px 0 0;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    font-weight: 500;
                }
                
                .audio-preview-close {
                    margin-left: auto;
                    background: none;
                    border: none;
                    color: white;
                    font-size: 20px;
                    cursor: pointer;
                    padding: 0;
                    width: 24px;
                    height: 24px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }
                
                .audio-preview-close:hover {
                    background: rgba(255,255,255,0.2);
                }
                
                .audio-preview-content {
                    padding: 20px;
                }
                
                .audio-preview-player {
                    width: 100%;
                    margin-bottom: 16px;
                    border-radius: 6px;
                }
                
                .audio-preview-actions {
                    display: flex;
                    gap: 12px;
                    justify-content: center;
                }
                
                .audio-preview-btn {
                    padding: 10px 20px;
                    border: none;
                    border-radius: 6px;
                    font-weight: 500;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 6px;
                    transition: all 0.2s ease;
                }
                
                .audio-preview-btn.cancel {
                    background: #f44336;
                    color: white;
                }
                
                .audio-preview-btn.cancel:hover {
                    background: #d32f2f;
                }
                
                .audio-preview-btn.send {
                    background: #4caf50;
                    color: white;
                }
                
                .audio-preview-btn.send:hover {
                    background: #388e3c;
                }
                
                .audio-preview-overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    z-index: 9999;
                }
            `;
            
            // Crear overlay de fondo
            const overlay = document.createElement('div');
            overlay.className = 'audio-preview-overlay';
            overlay.onclick = () => cancelAudioPreview();
            
            // Agregar elementos al DOM
            document.head.appendChild(style);
            document.body.appendChild(overlay);
            document.body.appendChild(previewContainer);
            
            // Guardar referencias globales
            window.currentAudioBlob = audioBlob;
            window.currentAudioUrl = audioUrl;
            window.currentPreviewContainer = previewContainer;
            window.currentPreviewOverlay = overlay;
            window.currentPreviewStyle = style;
            
            // Agregar listener para cerrar con Escape
            const escapeHandler = (e) => {
                if (e.key === 'Escape') {
                    cancelAudioPreview();
                }
            };
            document.addEventListener('keydown', escapeHandler);
            window.currentEscapeHandler = escapeHandler;
            
            // Focus en el primer botÃ³n y configurar eventos de audio
            setTimeout(() => {
                const firstBtn = previewContainer.querySelector('.audio-preview-btn');
                if (firstBtn) firstBtn.focus();
                
                // Configurar eventos del reproductor de audio
                const audioPlayer = previewContainer.querySelector('.audio-preview-player');
                if (audioPlayer) {
                    audioPlayer.addEventListener('play', () => {
                        console.log('â–¶ï¸ Reproduciendo audio grabado');
                    });
                    
                    audioPlayer.addEventListener('pause', () => {
                        console.log('â¸ï¸ Audio pausado');
                    });
                    
                    audioPlayer.addEventListener('ended', () => {
                        console.log('â¹ï¸ ReproducciÃ³n terminada');
                    });
                }
            }, 100);
        }

        function cancelAudioPreview() {
            console.log('âŒ Cancelando vista previa de audio');
            
            // Limpiar URL del blob
            if (window.currentAudioUrl) {
                URL.revokeObjectURL(window.currentAudioUrl);
            }
            
            // Remover elementos del DOM
            if (window.currentPreviewContainer) {
                window.currentPreviewContainer.remove();
            }
            if (window.currentPreviewOverlay) {
                window.currentPreviewOverlay.remove();
            }
            if (window.currentPreviewStyle) {
                window.currentPreviewStyle.remove();
            }
            
            // Remover listener del teclado
            if (window.currentEscapeHandler) {
                document.removeEventListener('keydown', window.currentEscapeHandler);
            }
            
            // Limpiar referencias
            window.currentAudioBlob = null;
            window.currentAudioUrl = null;
            window.currentPreviewContainer = null;
            window.currentPreviewOverlay = null;
            window.currentPreviewStyle = null;
            window.currentEscapeHandler = null;
            
            showNotification('ðŸ—‘ï¸ Audio descartado', 'info');
        }

        function confirmSendAudio() {
            console.log('âœ… Confirmando envÃ­o de audio');
            
            const audioBlob = window.currentAudioBlob;
            
            // Limpiar vista previa
            cancelAudioPreview();
            
            // Enviar audio
            if (audioBlob) {
                sendAudioMessage(audioBlob);
            }
        }

        async function sendAudioMessage(audioBlob) {
            if (!currentChatId) {
                showNotification('âŒ No hay chat seleccionado', 'error');
                return;
            }

            try {
                console.log('ðŸ“¤ Enviando audio a:', currentChatId);

                // Crear FormData con el audio
                const formData = new FormData();
                const audioFile = new File([audioBlob], `audio_${Date.now()}.webm`, {
                    type: 'audio/webm;codecs=opus'
                });
                
                formData.append('audio', audioFile);
                formData.append('chatId', currentChatId);

                // Crear AbortController para timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    controller.abort();
                    console.warn('â° EnvÃ­o de audio cancelado por timeout (60 segundos)');
                }, 60000);

                showNotification('ðŸ“¤ Enviando audio...', 'info');

                const response = await fetch('/api/send-audio', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData,
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (response.ok) {
                    const data = await response.json();
                    console.log('âœ… Audio enviado exitosamente:', data);
                    showNotification('âœ… Audio enviado correctamente', 'success');
                    
                    // Recargar mensajes despuÃ©s de un momento
                    setTimeout(() => {
                        if (currentChatId) {
                            loadMessagesSmart(currentChatId);
                        }
                    }, 1000);

                } else {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('âŒ Error enviando audio:', response.status, errorData);
                    showNotification(`âŒ Error enviando audio: ${errorData.message || response.status}`, 'error');
                }

            } catch (error) {
                console.error('Error enviando audio:', error);
                
                let errorMessage = 'âŒ Error enviando audio';
                if (error.name === 'AbortError') {
                    errorMessage = 'â° Timeout enviando audio - el archivo era demasiado grande o la conexiÃ³n lenta';
                } else if (error.message) {
                    errorMessage = `âŒ Error: ${error.message}`;
                }
                
                showNotification(errorMessage, 'error');
            }
        }

        // FunciÃ³n para mostrar notificaciÃ³n de historial cargado
        function showHistoryLoadedNotification(messageCount) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 70px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 212, 170, 0.95);
                color: white;
                padding: 8px 16px;
                border-radius: 20px;
                font-size: 0.9em;
                font-weight: 500;
                z-index: 9999;
                opacity: 0;
                transition: opacity 0.3s ease;
                backdrop-filter: blur(10px);
                box-shadow: 0 4px 15px rgba(0, 212, 170, 0.3);
                pointer-events: none;
            `;
            notification.innerHTML = `ðŸ“š ${messageCount} mensajes del historial cargados`;
            document.body.appendChild(notification);
            
            // Fade in
            setTimeout(() => notification.style.opacity = '1', 50);
            
            // Fade out y remover
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000); // Mostrar por mÃ¡s tiempo
        }

        // FunciÃ³n para mostrar indicador de carga de historial
        function showHistoryLoadingIndicator() {
            const indicator = document.createElement('div');
            indicator.id = 'history-loading-indicator';
            indicator.style.cssText = `
                position: fixed;
                top: 70px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(23, 162, 184, 0.95);
                color: white;
                padding: 8px 16px;
                border-radius: 20px;
                font-size: 0.9em;
                font-weight: 500;
                z-index: 9999;
                opacity: 0;
                transition: opacity 0.3s ease;
                backdrop-filter: blur(10px);
                box-shadow: 0 4px 15px rgba(23, 162, 184, 0.3);
                pointer-events: none;
            `;
            indicator.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Cargando mensajes...`;
            document.body.appendChild(indicator);
            
            // Fade in
            setTimeout(() => indicator.style.opacity = '1', 50);
            
            return indicator;
        }

        // FunciÃ³n para ocultar indicador de carga de historial
        function hideHistoryLoadingIndicator() {
            const indicator = document.getElementById('history-loading-indicator');
            if (indicator) {
                indicator.style.opacity = '0';
                setTimeout(() => indicator.remove(), 300);
            }
        }

        // FunciÃ³n para mostrar indicador de carga lazy en el Ã¡rea de mensajes
        function showLazyLoadingIndicator() {
            const messagesArea = document.getElementById('messages-area');
            if (!messagesArea) return;

            // Limpiar mensajes existentes
            messagesArea.innerHTML = '';
            
            // Crear indicador de carga lazy
            const loadingIndicator = document.createElement('div');
            loadingIndicator.id = 'lazy-loading-indicator';
            loadingIndicator.style.cssText = `
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: 100%;
                color: #8b949e;
                font-size: 0.9em;
                text-align: center;
                animation: fadeIn 0.3s ease;
            `;
            
            loadingIndicator.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <i class="fas fa-comment-dots" style="font-size: 2.5em; color: var(--primary-color); animation: pulse 1.5s ease-in-out infinite;"></i>
                </div>
                <div style="font-weight: 500; margin-bottom: 5px;">Cargando mensajes...</div>
                <div style="font-size: 0.8em; color: #adb5bd;">Un momento por favor</div>
                
                <style>
                    @keyframes pulse {
                        0% { opacity: 0.6; transform: scale(1); }
                        50% { opacity: 1; transform: scale(1.05); }
                        100% { opacity: 0.6; transform: scale(1); }
                    }
                    
                    @keyframes fadeIn {
                        from { opacity: 0; transform: translateY(20px); }
                        to { opacity: 1; transform: translateY(0); }
                    }
                </style>
            `;
            
            messagesArea.appendChild(loadingIndicator);
        }

        // FunciÃ³n para ocultar indicador de carga lazy
        function hideLazyLoadingIndicator() {
            const indicator = document.getElementById('lazy-loading-indicator');
            if (indicator) {
                indicator.style.opacity = '0';
                indicator.style.transform = 'translateY(-20px)';
                setTimeout(() => indicator.remove(), 300);
            }
        }

        // FunciÃ³n para limpiar cachÃ© de un chat especÃ­fico
        function clearChatCache(chatId) {
            let cleared = false;
            if (loadedChatsCache.has(chatId)) {
                loadedChatsCache.delete(chatId);
                chatMessagesCache.delete(chatId);
                cleared = true;
            }
            if (notificationShownChats.has(chatId)) {
                notificationShownChats.delete(chatId);
                cleared = true;
            }
            if (cleared) {
                console.log(`ðŸ’¾ CachÃ© y notificaciones limpiados para chat ${chatId}`);
            }
            return cleared;
        }

        // FunciÃ³n para verificar estado del cachÃ©
        function getCacheStats() {
            return {
                totalCachedChats: loadedChatsCache.size,
                totalCachedMessages: Array.from(chatMessagesCache.values()).reduce((total, messages) => total + messages.length, 0),
                cachedChatIds: Array.from(loadedChatsCache),
                totalNotificationsShown: notificationShownChats.size,
                notificationShownIds: Array.from(notificationShownChats)
            };
        }

        // FunciÃ³n para mostrar notificaciÃ³n de chats y mensajes cargados - DESHABILITADA
        /*
        function showChatMessagesLoadedNotification(totalChats, totalMessages, source) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 70px;
                right: 20px;
                background: rgba(40, 167, 69, 0.95);
                color: white;
                padding: 10px 16px;
                border-radius: 15px;
                font-size: 0.85em;
                font-weight: 500;
                z-index: 9999;
                opacity: 0;
                transition: opacity 0.3s ease;
                backdrop-filter: blur(10px);
                box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
                pointer-events: none;
                max-width: 280px;
            `;
            
            const sourceText = source === 'whatsapp+cache' ? 'WhatsApp + Cache' : 
                             source === 'whatsapp' ? 'WhatsApp' : 
                             source === 'cache' ? 'Cache Local' : 'Servidor';
                             
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-comments" style="font-size: 1.1em;"></i>
                    <div>
                        <div><strong>${totalChats}</strong> chats cargados</div>
                        <div style="opacity: 0.9; font-size: 0.9em;"><strong>${totalMessages}</strong> mensajes desde ${sourceText}</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Fade in
            setTimeout(() => notification.style.opacity = '1', 50);
            
            // Fade out y remover
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 4000); // Mostrar por 4 segundos
        }
        */

        // Funciones auxiliares para manejo mÃ³vil
        function addMobileOverlay() {
            if (document.getElementById('mobile-sidebar-overlay')) return;
            
            const overlay = document.createElement('div');
            overlay.id = 'mobile-sidebar-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 999;
                opacity: 0;
                transition: opacity 0.3s ease;
            `;
            
            document.body.appendChild(overlay);
            
            // Fade in
            setTimeout(() => overlay.style.opacity = '1', 10);
            
            // Cerrar sidebar al hacer click en overlay
            overlay.addEventListener('click', () => {
                const sidebar = document.getElementById('sidebar');
                if (sidebar) sidebar.classList.remove('mobile-open');
                removeMobileOverlay();
                const toggleBtn = document.getElementById('sidebar-toggle-btn');
                if (toggleBtn) {
                    toggleBtn.querySelector('i').className = 'fas fa-bars';
                    toggleBtn.title = 'Mostrar Panel';
                }
            });
        }

        function removeMobileOverlay() {
            const overlay = document.getElementById('mobile-sidebar-overlay');
            if (overlay) {
                overlay.style.opacity = '0';
                setTimeout(() => overlay.remove(), 300);
            }
        }

        function showSidebarFromChat() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('sidebar-toggle-btn');
            const icon = toggleBtn.querySelector('i');
            const chatArea = document.getElementById('chat-area');

            if (window.innerWidth <= 480) {
                // En mÃ³vil: ocultar chat y mostrar sidebar
                chatArea.classList.remove('mobile-active');
                sidebar.classList.add('mobile-open');
                icon.className = 'fas fa-arrow-left';
                toggleBtn.title = 'Ocultar Panel';
                addMobileOverlay();
                
                // *** DESACTIVADO: Auto-scroll a chat activo (permite scroll libre) ***
                // setTimeout(() => {
                //     const chatList = document.getElementById('chat-list');
                //     if (chatList && currentChatId) {
                //         const activeChatElement = chatList.querySelector('.chat-item.active');
                //         if (activeChatElement) {
                //             activeChatElement.scrollIntoView({
                //                 behavior: 'smooth',
                //                 block: 'center',
                //                 inline: 'nearest'
                //             });
                //         }
                //     }
                // }, 300); // Esperar a que termine la animaciÃ³n del sidebar
            } else {
                // LÃ³gica original para tablet y desktop
                sidebar.classList.remove('hidden');
                sidebar.classList.add('expanded');

                toggleBtn.classList.add('slide-right');
                icon.className = 'fas fa-arrow-left';
                toggleBtn.title = 'Ocultar Panel';

                if (chatArea && chatArea.classList.contains('fullscreen')) {
                    chatArea.classList.remove('fullscreen');
                }
            }
        }

        function openAdminPanel() {
            console.log('ðŸ”— [MAIN] Opening Admin Panel...');

            // Abrir directamente el panel de gestiÃ³n de visitas tÃ©cnicas
            // Usar la URL base actual (funciona tanto en IP pÃºblica como localhost)
            const protocol = window.location.protocol; // http: o https:
            const hostname = window.location.hostname; // IP o localhost
            const port = window.location.port || '3000'; // Puerto actual o 3000 por defecto
            const adminUrl = `${protocol}//${hostname}:${port}/admin`;

            console.log('âœ… [MAIN] Opening admin visits panel:', adminUrl);
            window.open(adminUrl, '_blank');
        }

        // FunciÃ³n de debugging para diagnosticar problemas de sesiÃ³n
        function debugSession() {
            console.log('ðŸ” === SESSION DEBUG INFO ===');
            console.log('Current page:', window.location.href);
            console.log('Token (variable):', token ? 'SET' : 'NULL');
            console.log('Token (localStorage):', localStorage.getItem('token') ? 'EXISTS' : 'NULL');
            console.log('Current user:', currentUser);
            console.log('User role:', currentUser ? currentUser.rol : 'NULL');
            console.log('================================');

            if (token && localStorage.getItem('token')) {
                console.log('âœ… Session appears valid');
                console.log('ðŸ’¡ You can manually navigate to /admin.html');
            } else {
                console.log('âŒ Session issue detected');
                console.log('ðŸ’¡ Try logging in again');
            }

            return {
                token: token ? 'SET' : 'NULL',
                localStorage: localStorage.getItem('token') ? 'EXISTS' : 'NULL',
                currentUser,
                userRole: currentUser ? currentUser.rol : 'NULL'
            };
        }

        function showUserInfo_OLD() {
            const userName = document.getElementById('user-name').textContent;
            const userRole = document.getElementById('user-role').textContent;

            const modalHTML = `
                <div class="modal-overlay">
                    <div style="background: white; border-radius: 20px; width: 90%; max-width: 400px; overflow: hidden; animation: modalSlideIn 0.3s ease;">
                        <div style="background: linear-gradient(135deg, #17a2b8, #00d4aa); color: white; padding: 20px; display: flex; align-items: center; justify-content: space-between;">
                            <h3 style="margin: 0; font-size: 1.2em; display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-user"></i> Informaciï¿½n del Usuario
                            </h3>
                            <button onclick="closeUserInfoModal()" style="background: rgba(255, 255, 255, 0.2); border: none; color: white; padding: 8px; border-radius: 6px; cursor: pointer;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div style="padding: 30px; text-align: center;">
                            <div style="font-size: 4em; color: #17a2b8; margin-bottom: 20px;">
                                <i class="fas fa-user-circle"></i>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #e9ecef;">
                                    <label style="font-weight: 600; color: #495057; font-size: 0.9em;">Nombre:</label>
                                    <span style="font-weight: 500; color: #212529;">${userName}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #e9ecef;">
                                    <label style="font-weight: 600; color: #495057; font-size: 0.9em;">Rol:</label>
                                    <span style="background: linear-gradient(135deg, #00d4aa, #17a2b8); color: white; padding: 4px 12px; border-radius: 15px; font-size: 0.8em; font-weight: 600;">${userRole}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0;">
                                    <label style="font-weight: 600; color: #495057; font-size: 0.9em;">Estado:</label>
                                    <span style="display: flex; align-items: center; gap: 5px; color: #28a745; font-weight: 600; font-size: 0.9em;">
                                        <i class="fas fa-circle" style="font-size: 0.7em;"></i> Conectado
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeUserInfoModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) modal.remove();
        }

        // Cerrar modal al hacer clic fuera
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal-overlay')) {
                closeUserInfoModal();
            }
        });

        // Cerrar modal con tecla Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeUserInfoModal();
                closeOmittedModal();
                closeUsersAdminModal();
                closeLogsAPIModal();
                closeNewChatModal();
                closeEditUserModal();
                closeAddUserModal();
            }
        });

        async function checkConnectionStatus() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();

                console.log('Connection status response:', data); // Debug log
                
                const statusIndicator = document.getElementById('connection-status');
                const statusText = document.getElementById('status-text');
                
                // Verificar mÃºltiples indicadores de conexiÃ³n
                const isWhatsAppReady = data.whatsappListo || data.connected || data.ready;
                console.log('WhatsApp ready status:', isWhatsAppReady); // Debug log

                if (isWhatsAppReady) {
                    statusIndicator.className = 'status-indicator status-online';
                    statusText.textContent = 'WhatsApp Conectado';
                    
                    // Detectar reconexiÃ³n (si antes estaba desconectado)
                    const wasDisconnected = !isConnected;
                    isConnected = true;
                    console.log('ðŸš€ [CONNECTION] isConnected establecido a TRUE');

                    // Si hubo reconexiÃ³n, recuperar mensajes automÃ¡ticamente
                    if (wasDisconnected) {
                        console.log('ðŸ”„ [RECOVERY] WhatsApp reconectado - iniciando recuperaciÃ³n automÃ¡tica...');
                        setTimeout(() => {
                            recoverMessagesAfterReconnection();
                        }, 2000); // Esperar 2 segundos para que la conexiÃ³n se estabilice
                    }

                    // Marcar que WhatsApp estÃ¡ conectado para futuras referencias
                    qrModalClosedByConnection = true;

                    // Actualizar visibilidad de los botones QR (ocultarlos)
                    updateQRButtonVisibility();
                    updateScanQRButtonVisibility();

                    // Verificar si el modal QR estÃ¡ visible
                    const qrModal = document.getElementById('qr-modal');
                    const isModalVisible = qrModal && !qrModal.classList.contains('hidden');

                    if (isModalVisible) {
                        // Actualizar indicador de estado
                        updateQRStatusIndicator('connected', '<i class="fas fa-check-circle"></i> Â¡WhatsApp conectado! La ventana se cerrarÃ¡ automÃ¡ticamente...');

                        // Mostrar notificaciÃ³n de conexiÃ³n exitosa
                        showNotification('Â¡WhatsApp conectado exitosamente!', 'success');

                        // Cerrar el modal despuÃ©s de 2 segundos para dar tiempo a que el usuario vea la confirmaciÃ³n
                        setTimeout(() => {
                            hideQRModalByConnection();
                        }, 2000);
                    } else {
                        console.log('WhatsApp connected - QR modal was not visible');
                        // Asegurar que el modal estÃ© cerrado por si acaso
                        hideQRModalByConnection();
                    }

                    console.log('WhatsApp connected - hiding QR modal');
                    console.log('Connection data:', {
                        whatsappListo: data.whatsappListo,
                        connected: data.connected,
                        ready: data.ready,
                        hasSession: data.hasSession,
                        sessionActive: data.sessionActive
                    });
                } else {
                    statusIndicator.className = 'status-indicator status-offline';
                    statusText.textContent = 'WhatsApp Desconectado';
                    isConnected = false;

                    // Actualizar visibilidad de los botones QR
                    updateQRButtonVisibility();
                    updateScanQRButtonVisibility();

                    console.log('WhatsApp disconnected - connection data:', {
                        whatsappListo: data.whatsappListo,
                        connected: data.connected,
                        ready: data.ready,
                        hasSession: data.hasSession,
                        sessionActive: data.sessionActive
                    });

                    // No mostrar automÃ¡ticamente el modal QR - solo mostrar el botÃ³n
                    console.log('QR button available for manual QR display');
                }
            } catch (error) {
                console.error('Error checking connection:', error);
                const statusIndicator = document.getElementById('connection-status');
                const statusText = document.getElementById('status-text');
                statusIndicator.className = 'status-indicator status-offline';
                statusText.textContent = 'Error de ConexiÃ³n';

                // Verificar si el modal QR ya estÃ¡ visible
                const qrModal = document.getElementById('qr-modal');
                const isModalVisible = qrModal && !qrModal.classList.contains('hidden');

                if (!isModalVisible) {
                    // Actualizar indicador de estado a error y mostrar modal
                    updateQRStatusIndicator('error', '<i class="fas fa-exclamation-triangle"></i> Error de conexiÃ³n - Reintentando...');
                    showQRModal();
                } else {
                    // Solo actualizar el indicador si el modal ya estÃ¡ visible
                    updateQRStatusIndicator('error', '<i class="fas fa-exclamation-triangle"></i> Error de conexiÃ³n - Reintentando...');
                }
            }
        }

        let lastChatsCount = 0;
        let lastMessagesCount = 0;
        let chatCache = new Map(); // Cache para evitar cargar chats repetidamente
        let lastChatHash = null;   // Hash para detectar cambios reales

        async function loadChats() {
            try {
                console.log('ðŸ“ž [LOAD-CHATS] Iniciando peticiÃ³n a /api/all-chats...');
                const response = await fetch('/api/all-chats');
                console.log('ðŸ“ž [LOAD-CHATS] Respuesta recibida:', response.status, response.ok);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('ðŸ“ž [LOAD-CHATS] Datos recibidos:', data);
                    
                    // Crear hash de los datos para detectar cambios reales
                    const currentHash = JSON.stringify(data.chats || []).substring(0, 100);
                    console.log('ðŸ“ž [LOAD-CHATS] Hash actual:', currentHash, 'Hash anterior:', lastChatHash);
                    
                    // Siempre actualizar para asegurar que se muestren los chats
                    if (true) {
                        console.log('ðŸ“ž [LOAD-CHATS] Actualizando lista de chats (forzado)...');
                        const currentChatsCount = data.totalChats || 0;
                        const currentMessagesCount = data.totalMessages || 0;
                        
                        if (currentChatsCount !== lastChatsCount || currentMessagesCount !== lastMessagesCount) {
                            console.log('ðŸ”„ [LOAD CHATS] Detectados cambios - actualizando...');
                            console.log(`ðŸ“‹ [CHATS LOADED] ${currentChatsCount} chats cargados`);
                            console.log(`ðŸ“Š [MESSAGES TOTAL] ${currentMessagesCount} mensajes totales obtenidos`);
                            console.log(`ðŸ“¡ [SOURCE] Datos desde: ${data.source || 'unknown'}`);
                            
                            // Log de estadÃ­sticas por chat solo si hay chats nuevos o modificados
                            if (data.chats && data.chats.length > 0) {
                                data.chats.forEach(chat => {
                                    if (chat.messagesCount > 0 && !chatCache.has(chat.id)) {
                                        console.log(`   ðŸ’¬ ${chat.name}: ${chat.messagesCount} mensajes, Ãºltimo: ${new Date(chat.lastActivity).toLocaleString()}`);
                                    }
                                });
                            }
                            
                            lastChatsCount = currentChatsCount;
                            lastMessagesCount = currentMessagesCount;
                        }
                        
                        lastChatHash = currentHash;
                        updateChatList(data.chats || []);
                    } else {
                        console.log('ðŸ“ž [LOAD-CHATS] Sin cambios detectados, omitiendo actualizaciÃ³n');
                    }
                } else {
                    console.error('ðŸ“ž [LOAD-CHATS] Error HTTP:', response.status, response.statusText);
                }
            } catch (error) {
                console.error('ðŸ“ž [LOAD-CHATS] Error en peticiÃ³n:', error);
            }
        }

        function updateChatList(chatData) {
            const chatList = document.getElementById('chat-list');
            let hasChanges = false;

            console.log('ðŸ“ [UPDATE-CHAT-LIST] Procesando', chatData.length, 'chats');

            chatData.forEach(chat => {
                console.log('ðŸ“ [CHAT-DATA]', chat.name, '- Ãšltimo mensaje:', chat.lastMessage);

                const existingChat = chats.get(chat.id);

                // Siempre agregar/actualizar todos los chats
                console.log(`ðŸ“ [CHAT-UPDATE] Actualizando chat: ${chat.name} (${existingChat ? 'existente' : 'nuevo'})`);
                chats.set(chat.id, chat);
                chatCache.set(chat.id, chat);
                hasChanges = true;
            });

            // Solo re-renderizar si hay cambios reales
            if (hasChanges) {
                renderChatList();
            } else if (chatData.length > 0 && Array.from(chats.values()).length === 0) {
                // Forzar renderizado si hay datos pero no hay chats renderizados
                console.log('ðŸ”§ [FORCE-RENDER] Forzando renderizado porque hay datos pero no chats visibles');
                renderChatList();
            }
        }

        function renderChatList() {
            const chatList = document.getElementById('chat-list');

            console.log('ðŸŽ¨ [RENDER-CHAT-LIST] Iniciando renderizado, chats disponibles:', chats.size);

            const filteredChats = Array.from(chats.values()).filter(chat => {
                if (currentFilter === 'all') return true;
                return chat.mode === currentFilter;
            });

            console.log('ðŸŽ¨ [RENDER-CHAT-LIST] Chats filtrados:', filteredChats.length);

            if (filteredChats.length === 0) {
                const emptyMessage = `
                    <div style="padding: 20px; text-align: center; color: #8b949e;">
                        <i class="fas fa-comments" style="font-size: 2em; margin-bottom: 10px;"></i>
                        <p>No hay chats ${currentFilter === 'all' ? '' : 'en modo ' + currentFilter}</p>
                        <small style="color: #666;">Chats totales en memoria: ${chats.size}</small>
                    </div>
                `;
                console.log('ðŸŽ¨ [RENDER-CHAT-LIST] Mostrando mensaje vacÃ­o');
                chatList.innerHTML = emptyMessage;
                return;
            }

            // Ordenar chats por Ãºltima actividad (mÃ¡s recientes primero)
            const sortedChats = filteredChats.sort((a, b) => {
                const timeA = a.lastActivity || 0;
                const timeB = b.lastActivity || 0;
                return timeB - timeA; // Orden descendente (mÃ¡s recientes primero)
            });

            // Solo loggear si hay chats para renderizar
            if (sortedChats.length > 0) {
                console.log(`ðŸ“‹ Renderizando ${sortedChats.length} chats ordenados por actividad`);
                // Log para depurar el Ãºltimo mensaje de cada chat
                sortedChats.forEach((chat, idx) => {
                    console.log(`ðŸ“‹ [RENDER] Chat ${idx}: ${chat.name} - Ãšltimo mensaje: "${chat.lastMessage}"`);
                });
            }

            chatList.innerHTML = sortedChats.map((chat, index) => {
                // *** NUEVA FUNCIONALIDAD: Mostrar informaciÃ³n de mensajes ***
                const messagesInfo = chat.messagesCount > 0 ?
                    `<div style="font-size: 0.7em; color: #0084ff; margin-top: 2px; font-weight: 500;">
                        ðŸ“š ${chat.messagesCount} mensajes cargados
                     </div>` : '';

                const unreadBadge = chat.unreadCount > 0 ?
                    `<div style="position: absolute; top: 8px; right: 8px; background: #dc3545; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 0.7em; display: flex; align-items: center; justify-content: center; font-weight: bold;">${chat.unreadCount}</div>` : '';

                // Aplicar filtro de bÃºsqueda DURANTE el renderizado para evitar parpadeo
                let displayStyle = '';
                if (currentSearchTerm) {
                    const chatName = chat.name.toLowerCase();
                    const chatNumber = chat.id.toLowerCase();
                    const chatPreview = (chat.lastMessage || '').toLowerCase();
                    const searchTerm = currentSearchTerm.toLowerCase();

                    const matches = chatName.includes(searchTerm) ||
                                   chatNumber.includes(searchTerm) ||
                                   chatPreview.includes(searchTerm);

                    if (!matches) {
                        displayStyle = 'style="display: none;"';
                    }
                }

                return `
                    <div class="chat-item ${chat.id === currentChatId ? 'active' : ''}"
                         onclick="selectChat('${chat.id}')"
                         data-chat-id="${chat.id}"
                         data-chat-index="${index}"
                         data-messages-count="${chat.messagesCount || 0}"
                         ${displayStyle}>
                        <div class="chat-mode mode-${chat.mode}">${chat.mode === 'bot' ? 'BOT' : 'HUMANO'}</div>
                        ${unreadBadge}
                        <div class="chat-header">
                            <div class="chat-name">${chat.name}</div>
                            <div class="chat-time">${formatTime(chat.lastActivity)}</div>
                        </div>
                        <div class="chat-preview">${formatChatPreview(chat.lastMessage)}</div>
                        ${messagesInfo}
                    </div>
                `;
            }).join('');

            // *** SOLUCION: Asegurar que todos los chats sean visibles ***
            // Forzar recÃ¡lculo de altura despuÃ©s del render
            setTimeout(() => {
                const chatListElement = document.getElementById('chat-list');
                if (chatListElement) {
                    // Forzar un repaint/reflow para actualizar el scroll
                    chatListElement.style.height = 'auto';
                    const computedHeight = chatListElement.scrollHeight;
                    chatListElement.style.height = '';
                    
                    console.log(`ðŸ“ Lista de chats: ${sortedChats.length} elementos, altura: ${computedHeight}px`);
                    
                    // DESACTIVADO: Auto-scroll a chat activo (permite scroll libre)
                    // if (currentChatId) {
                    //     const activeChatElement = chatListElement.querySelector('.chat-item.active');
                    //     if (activeChatElement) {
                    //         activeChatElement.scrollIntoView({
                    //             behavior: 'smooth',
                    //             block: 'nearest',
                    //             inline: 'nearest'
                    //         });
                    //     }
                    // }

                    // Asegurarse de que el input de bÃºsqueda mantenga el valor correcto
                    if (currentSearchTerm) {
                        const searchInput = document.getElementById('chat-search-input');
                        if (searchInput && searchInput.value.trim().toLowerCase() !== currentSearchTerm) {
                            searchInput.value = currentSearchTerm;
                        }
                        const searchClear = document.getElementById('chat-search-clear');
                        if (searchClear) {
                            searchClear.classList.add('visible');
                        }
                    }
                }
            }, 100);
        }

        function selectChat(chatId) {
            // Reiniciar hash de mensajes cuando se cambia de chat para permitir actualizaciones en tiempo real
            lastMessagesHash = '';
            currentChatId = chatId;

            // Resetear paginaciÃ³n cuando se selecciona un nuevo chat
            currentMessageOffset = 0;
            hasMoreMessages = false;
            totalMessagesInDB = 0;
            const chat = chats.get(chatId);

            if (!chat) {
                console.error(`âŒ Chat ${chatId} no encontrado`);
                return;
            }

            console.log(`ðŸ“± Seleccionando chat: ${chat.name} (${chatId}) - Dispositivo: ${window.innerWidth}px`);

            // Manejo especÃ­fico por tipo de dispositivo
            if (window.innerWidth <= 480) {
                // MÃ³vil: Ocultar sidebar y mostrar chat
                const sidebar = document.getElementById('sidebar');
                const chatArea = document.getElementById('chat-area');
                const toggleBtn = document.getElementById('sidebar-toggle-btn');
                const icon = toggleBtn?.querySelector('i');

                sidebar.classList.remove('mobile-open');
                chatArea.classList.add('mobile-active');
                removeMobileOverlay();

                if (icon) {
                    icon.className = 'fas fa-bars';
                    toggleBtn.title = 'Mostrar Panel';
                }
            } else if (window.innerWidth <= 768) {
                // Tablet: LÃ³gica existente
                const sidebar = document.getElementById('sidebar');
                const toggleBtn = document.getElementById('sidebar-toggle-btn');
                const icon = toggleBtn?.querySelector('i');

                sidebar.classList.remove('expanded');
                sidebar.classList.add('hidden');
                toggleBtn.classList.remove('slide-right');
                if (icon) {
                    icon.className = 'fas fa-bars';
                    toggleBtn.title = 'Mostrar Panel';
                }

                document.getElementById('chat-area').classList.add('fullscreen');
            }

            // Actualizar interfaz
            renderChatList();
            showChatArea(chat);

            // Marcar como leÃ­do si tiene mensajes no leÃ­dos
            if (chat.unreadCount > 0) {
                markAsRead(chatId);
            }

            // *** LAZY LOADING CON CACHE: Cargar mensajes viejos solo una vez ***
            // Verificar si los mensajes viejos ya fueron cargados para este chat
            if (loadedChatsCache.has(chatId) && chatMessagesCache.has(chatId)) {
                // Chat ya tiene mensajes cargados - mostrarlos inmediatamente desde el cachÃ©
                console.log(`ðŸ“‹ Chat ${chatId} ya tiene mensajes cargados - usando cachÃ©`);
                const cachedMessages = chatMessagesCache.get(chatId);
                displayMessages(cachedMessages, false, false); // No silencioso
                
                // Solo cargar nuevos mensajes si es necesario (sin forzar recarga completa)
                setTimeout(() => {
                    loadMessagesSmart(chatId, false); // false = no forzar, solo verificar nuevos mensajes
                }, 500);
            } else {
                // Primera carga de este chat - cargar mensajes desde BD
                console.log(`ðŸ”„ Primera carga para chat ${chatId} - cargando mensajes desde BD...`);

                // NO mostrar indicador de carga porque BD es instantÃ¡nea
                // showLazyLoadingIndicator();

                // Cargar mensajes inmediatamente desde BD
                loadMessagesSmart(chatId, true); // true = forzar recarga completa
            }

            // Asegurar que el polling estÃ© activo
            if (!messagePollingInterval) {
                console.log('âš ï¸ Polling no estaba activo, reiniciando...');
                startSmartMessagePolling();
            }

            // Configurar detecciÃ³n de scroll para preservar UX
            setupScrollDetection();

            // DESACTIVADO: Auto-scroll a chat seleccionado (permite scroll libre)
            // setTimeout(() => {
            //     const selectedChatElement = document.querySelector(`.chat-item[onclick="selectChat('${chatId}')"]`);
            //     if (selectedChatElement) {
            //         selectedChatElement.scrollIntoView({
            //             behavior: 'smooth',
            //             block: 'nearest',
            //             inline: 'nearest'
            //         });
            //     }
            // }, 100);
        }

        function showChatArea(chat) {
            document.getElementById('empty-state').style.display = 'none';
            const chatArea = document.getElementById('chat-area');
            const sidebar = document.getElementById('sidebar');
            
            chatArea.style.display = 'flex';
            
            // Manejo especÃ­fico para mÃ³viles
            if (window.innerWidth <= 480) {
                chatArea.classList.add('mobile-active');
                sidebar.classList.remove('mobile-open');
                removeMobileOverlay();
            }
            
            document.getElementById('current-chat-name').textContent = chat.name;
            document.getElementById('current-chat-subtitle').textContent = 
                `Modo ${chat.mode === 'bot' ? 'Bot' : 'Humano'} ï¿½ ${chat.phone}`;
                
            const toggleBtn = document.getElementById('toggle-mode-btn');
            toggleBtn.innerHTML = chat.mode === 'bot' ? 
                '<i class="fas fa-user"></i> <span>Cambiar a Humano</span>' : 
                '<i class="fas fa-robot"></i> <span>Cambiar a Bot</span>';
        }

        // *** FUNCIÃ“N DESHABILITADA: loadMessages ***
        // Esta funciÃ³n estaba interfiriendo con loadMessagesSmart y cargando mensajes incompletos
        // Ahora usamos solo loadMessagesSmart que carga TODO el historial correctamente
        /*
        async function loadMessages(chatId) {
            try {
                const response = await fetch(`/api/chats/${chatId}/messages`);
                if (response.ok) {
                const data = await response.json();
                    displayMessages(data.messages || [], false, false); // No silencioso
                }
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }
        */



        // FunciÃ³n para generar IDs Ãºnicos para mensajes
        function generateMessageId(msg, index) {
            if (msg.id) return msg.id;
            if (msg.timestamp) return `msg-${msg.timestamp}-${index}`;
            return `msg-${Date.now()}-${index}`;
        }

        // FunciÃ³n para guardar el estado de los elementos de audio
        function saveAudioStates() {
            const audioElements = document.querySelectorAll('audio');
            const audioStates = new Map();

            audioElements.forEach((audio, index) => {
                const messageElement = audio.closest('.message');
                if (messageElement) {
                    const messageId = messageElement.dataset.messageId || `audio-${index}`;

                    // Guardar estado de TODOS los audios que tengan progreso
                    if (audio.currentTime > 0) {
                        // Verificar mÃ¡s precisamente si el audio estÃ¡ realmente reproduciÃ©ndose
                        const isActuallyPlaying = !audio.paused && audio.readyState >= 2 && !audio.ended;

                        audioStates.set(messageId, {
                            currentTime: audio.currentTime,
                            isPlaying: isActuallyPlaying,
                            volume: audio.volume,
                            muted: audio.muted,
                            src: audio.src,
                            duration: audio.duration,
                            playbackRate: audio.playbackRate,
                            timestamp: Date.now(),
                            readyState: audio.readyState,
                            ended: audio.ended
                        });

                        if (isActuallyPlaying) {
                            console.log(`ðŸ’¾ Audio guardado: ${messageId} - Tiempo: ${audio.currentTime.toFixed(2)}s - ReproduciÃ©ndose activamente`);
                        } else if (!audio.paused) {
                            console.log(`ðŸ’¾ Audio guardado: ${messageId} - Tiempo: ${audio.currentTime.toFixed(2)}s - Cargando...`);
                        } else {
                            console.log(`ðŸ’¾ Audio guardado: ${messageId} - Tiempo: ${audio.currentTime.toFixed(2)}s - Pausado`);
                        }
                    }
                }
            });

            console.log(`ðŸŽµ Estados de audio guardados: ${audioStates.size} elementos`);
            return audioStates;
        }

        // FunciÃ³n para restaurar el estado de los elementos de audio
        function restoreAudioStates(audioStates) {
            setTimeout(() => {
                const audioElements = document.querySelectorAll('audio');
                let restoredCount = 0;

                audioElements.forEach((audio, index) => {
                    const messageElement = audio.closest('.message');
                    if (messageElement) {
                        const messageId = messageElement.dataset.messageId || `audio-${index}`;
                        const savedState = audioStates.get(messageId);

                        if (savedState && savedState.src === audio.src) {
                            // Restaurar propiedades bÃ¡sicas
                            audio.currentTime = savedState.currentTime;
                            audio.volume = savedState.volume;
                            audio.muted = savedState.muted;
                            audio.playbackRate = savedState.playbackRate || 1;

                            restoredCount++;

                            if (savedState.isPlaying) {
                                // Reanudar reproducciÃ³n automÃ¡ticamente con un pequeÃ±o delay
                                setTimeout(() => {
                                    audio.play().then(() => {
                                        console.log(`â–¶ï¸ Audio reanudado automÃ¡ticamente: ${messageId} - PosiciÃ³n: ${audio.currentTime.toFixed(2)}s`);
                                    }).catch(error => {
                                        console.log(`âš ï¸ No se pudo reanudar audio automÃ¡ticamente: ${messageId} - Error: ${error.message}`);
                                        console.log(`ðŸ’¡ El usuario puede hacer clic en play para continuar reproduciendo`);
                                    });
                                }, 50);

                                console.log(`ðŸ”„ Audio restaurado y reanudÃ¡ndose: ${messageId} - PosiciÃ³n: ${audio.currentTime.toFixed(2)}s`);
                            } else {
                                console.log(`âœ… Audio restaurado: ${messageId} - PosiciÃ³n: ${audio.currentTime.toFixed(2)}s - Estaba pausado`);
                            }
                        }
                    }
                });

                if (restoredCount > 0) {
                    console.log(`ðŸŽµ Estados de audio restaurados: ${restoredCount} elementos`);
                    console.log(`â–¶ï¸ Los audios que estaban reproduciÃ©ndose se reanudan automÃ¡ticamente`);
                    console.log(`ðŸ’¡ Si no se reanudan, verifica la configuraciÃ³n de autoplay del navegador`);
                } else {
                    console.log(`â„¹ï¸ No se encontraron audios para restaurar`);
                }
            }, 150);
        }

        // Variable global para controlar cuÃ¡ndo hacer auto-scroll
        let shouldAutoScroll = true;

        function displayMessages(messages, preserveScrollPosition = false, silent = false, skipAutoScroll = false, append = false, metadata = {}) {
            const messagesArea = document.getElementById('messages-area');

            // Guardar metadata de paginaciÃ³n si viene
            if (metadata.hasMore !== undefined) {
                hasMoreMessages = metadata.hasMore;
            }
            if (metadata.totalInDB !== undefined) {
                totalMessagesInDB = metadata.totalInDB;
            }
            if (metadata.offset !== undefined) {
                currentMessageOffset = metadata.offset + messages.length;
            }

            console.log(`ðŸ“Š [PAGINATION] hasMore: ${hasMoreMessages}, totalInDB: ${totalMessagesInDB}, offset: ${currentMessageOffset}, mensajes mostrados: ${messages.length}`);

            // Ocultar indicador de carga lazy si estÃ¡ presente
            hideLazyLoadingIndicator();

            if (!messages || messages.length === 0) {
                messagesArea.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #8b949e; text-align: center; padding: 20px;">
                        <i class="fas fa-comment-slash" style="font-size: 3em; margin-bottom: 15px; opacity: 0.5;"></i>
                        <p style="font-size: 1.1em; margin-bottom: 5px;">No hay mensajes en este chat</p>
                        <p style="font-size: 0.9em; opacity: 0.7;">Los mensajes aparecerÃ¡n aquÃ­ cuando comience la conversaciÃ³n</p>
                    </div>
                `;
                return;
            }

            // 1. Guardar posiciÃ³n de scroll si se solicita preservarla O si es modo append
            const currentScrollTop = (preserveScrollPosition || append) ? messagesArea.scrollTop : null;
            const currentScrollHeight = (preserveScrollPosition || append) ? messagesArea.scrollHeight : null;

            // Guardar elemento ancla para modo append (como WhatsApp)
            let anchorElement = null;
            let anchorOffsetTop = 0;
            if (append) {
                // Encontrar el primer mensaje visible actualmente
                const allMessages = messagesArea.querySelectorAll('.message');
                for (let msg of allMessages) {
                    const rect = msg.getBoundingClientRect();
                    const containerRect = messagesArea.getBoundingClientRect();
                    // Si el mensaje estÃ¡ visible en el viewport del contenedor
                    if (rect.top >= containerRect.top && rect.top <= containerRect.bottom) {
                        anchorElement = msg;
                        anchorOffsetTop = msg.offsetTop;
                        console.log(`âš“ [ANCHOR] Elemento ancla encontrado: offsetTop=${anchorOffsetTop}px, id=${msg.dataset.messageId}`);
                        break;
                    }
                }

                console.log(`ðŸ“ [APPEND MODE] Guardando posiciÃ³n antes de agregar:`, {
                    scrollTop: currentScrollTop,
                    scrollHeight: currentScrollHeight,
                    clientHeight: messagesArea.clientHeight,
                    mensajes: messages.length,
                    anchorFound: !!anchorElement
                });
            }

            // Verificar si el usuario estÃ¡ cerca del final del chat (Ãºltimos 200px)
            const isNearBottom = (messagesArea.scrollHeight - messagesArea.scrollTop - messagesArea.clientHeight) < 200;

            // 2. Guardar estado de audio ANTES de actualizar contenido
            const audioStates = saveAudioStates();

            // 3. LÃ­mite de 50 mensajes por chat para carga rÃ¡pida (reducido de 100)
            const limitedMessages = messages.length > 50 ? messages.slice(-50) : messages;
            
            // 4. Ordenar mensajes por timestamp para asegurar orden cronolÃ³gico correcto
            const sortedMessages = [...limitedMessages].sort((a, b) => {
                const timestampA = a.timestamp || 0;
                const timestampB = b.timestamp || 0;
                return timestampA - timestampB;
            });

            // 4.5. Filtrar mensajes de API externa
            const filteredMessages = sortedMessages.filter(msg => {
                if (msg.isFromAPI) {
                    console.log(`ðŸš« [FILTER] Filtrando mensaje de API: "${msg.body.substring(0, 30)}"`);
                    return false;
                }
                return true;
            });
            
            if (messages.length > 50) {
                console.log(`âš ï¸ Mensajes limitados: ${messages.length} â†’ 50 (mostrando los Ãºltimos 50)`);
            }
            const apiMessagesCount = sortedMessages.length - filteredMessages.length;
            if (apiMessagesCount > 0) {
                console.log(`ðŸš« Mensajes de API filtrados: ${apiMessagesCount}`);
            }
            console.log(`ðŸ“ Mostrando ${filteredMessages.length} mensajes ordenados cronolÃ³gicamente`);

            // 5. Actualizar contenido del chat con los mensajes filtrados
            const messagesHTML = filteredMessages.map((msg, index) => {
                const messageId = generateMessageId(msg, index);
                const messageClass = msg.fromMe ? 'outgoing' : 'incoming';
                const messageTime = formatTime(msg.timestamp);
                const messageStatus = msg.fromMe ? getMessageStatus(msg.status) : '';

                // Procesar body y media por separado
                let messageContent = '';

                // Si hay mediaUrl, renderizar el elemento multimedia
                if (msg.mediaUrl) {
                    if (msg.type === 'image') {
                        messageContent += `<img src="${msg.mediaUrl}" alt="Imagen" style="max-width: 100%; border-radius: 8px; cursor: pointer; margin-bottom: 5px;" onclick="showImageModal(this.src)" onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDIwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjIwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9IiNmOGY5ZmEiIHN0cm9rZT0iI2RlZTJlNiIvPjx0ZXh0IHg9IjEwMCIgeT0iNTAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBmaWxsPSIjNjY2IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iMC4zZW0iPuKaoCBJbWFnZW4gbm8gZGlzcG9uaWJsZTwvdGV4dD48L3N2Zz4='; this.alt='Imagen no disponible';">`;
                    } else if (msg.type === 'audio' || msg.type === 'ptt') {
                        messageContent += `
                            <audio controls preload="metadata" playsinline data-audio-preserve="true" style="width: 100%; max-width: 400px; margin-bottom: 5px;">
                                <source src="${msg.mediaUrl}" type="audio/ogg">
                                <source src="${msg.mediaUrl}" type="audio/mpeg">
                                Tu navegador no soporta el elemento de audio.
                            </audio>
                        `;
                    }
                }

                // Si hay texto en el body, agregarlo
                if (msg.body && msg.body.trim()) {
                    messageContent += `<div>${formatMessageBody(msg.body)}</div>`;
                }

                // Si no hay contenido, usar el formateo normal del body
                if (!messageContent) {
                    messageContent = formatMessageBody(msg.body);
                }

                return `
                    <div class="message ${messageClass}" data-message-id="${messageId}" data-timestamp="${msg.timestamp}">
                        <div class="message-content">
                            <div class="message-text">${messageContent}</div>
                            <div class="message-time">
                                ${messageTime}
                                ${msg.fromMe ? `<span class="message-status">${messageStatus}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Agregar botÃ³n de cargar historial al inicio si hay mÃ¡s mensajes
            // Si estÃ¡ cargando, mantener el botÃ³n con spinner
            let loadHistoryBtn = '';
            if (hasMoreMessages) {
                if (isLoadingHistory && append) {
                    // Mantener botÃ³n de carga durante append
                    loadHistoryBtn = `
                        <button class="load-history-btn" id="load-history-btn" disabled>
                            <i class="fas fa-spinner fa-spin"></i>
                            Cargando...
                        </button>
                    `;
                } else {
                    // BotÃ³n normal
                    loadHistoryBtn = `
                        <button class="load-history-btn" id="load-history-btn" onclick="loadMoreMessages()">
                            <i class="fas fa-history"></i>
                            Cargar mensajes mÃ¡s antiguos (${totalMessagesInDB - currentMessageOffset} restantes)
                        </button>
                    `;
                }
            }

            console.log(`ðŸ”˜ [BUTTON] hasMoreMessages: ${hasMoreMessages}, isLoadingHistory: ${isLoadingHistory}, botÃ³n generado: ${loadHistoryBtn ? 'SÃ' : 'NO'}`);

            if (append) {
                // MÃ‰TODO MÃXIMA EFECTIVIDAD: Clonar, modificar y reemplazar todo el nodo
                const oldScrollHeight = messagesArea.scrollHeight;

                // Guardar referencia al padre
                const parent = messagesArea.parentNode;
                const nextSibling = messagesArea.nextSibling;

                // Clonar el nodo completo
                const clone = messagesArea.cloneNode(true);

                // Ocultar el original
                messagesArea.style.display = 'none';

                // Modificar el clon (off-screen)
                const oldButton = clone.querySelector('.load-history-btn');
                if (oldButton) oldButton.remove();
                clone.insertAdjacentHTML('afterbegin', loadHistoryBtn + messagesHTML);

                // Calcular diferencia ANTES de insertar
                const tempParent = document.createElement('div');
                tempParent.style.cssText = 'position: absolute; left: -9999px; visibility: hidden;';
                tempParent.appendChild(clone);
                document.body.appendChild(tempParent);

                const newScrollHeight = clone.scrollHeight;
                const heightDifference = newScrollHeight - oldScrollHeight;

                // Ajustar scroll en el clon
                clone.scrollTop = currentScrollTop + heightDifference;

                // Remover del temp
                tempParent.removeChild(clone);
                document.body.removeChild(tempParent);

                // Restaurar display en el clon
                clone.style.display = '';

                // Reemplazar el nodo original con el clon (swap atÃ³mico)
                if (nextSibling) {
                    parent.insertBefore(clone, nextSibling);
                } else {
                    parent.appendChild(clone);
                }
                parent.removeChild(messagesArea);

                console.log(`ðŸ“œ [ATOMIC SWAP] Reemplazo atÃ³mico: ${currentScrollTop}px + ${heightDifference}px = ${clone.scrollTop}px`);
            } else {
                // Modo reemplazo: reemplazar todo el contenido
                messagesArea.innerHTML = loadHistoryBtn + messagesHTML;
            }

            // 5. Corregir URLs multimedia despuÃ©s de actualizar contenido
            fixMultimediaUrls();

            // 6. Restaurar estado de audio DESPUÃ‰S de actualizar contenido
            restoreAudioStates(audioStates);

            // 7. Manejar scroll segÃºn configuraciÃ³n
            if (append) {
                // NO hacer ajustes adicionales - el scroll ya estÃ¡ correcto
                // Los ajustes posteriores causan movimientos visibles
                console.log(`âœ… [SCROLL] PosiciÃ³n final establecida sin ajustes adicionales`);
            } else if (preserveScrollPosition && currentScrollTop !== null && currentScrollHeight !== null) {
                // Mantener posiciÃ³n relativa de scroll
                const newScrollHeight = messagesArea.scrollHeight;
                const heightDifference = newScrollHeight - currentScrollHeight;
                messagesArea.scrollTop = currentScrollTop + heightDifference;
                console.log(`ðŸ“± Scroll preservado: ${currentScrollTop} -> ${messagesArea.scrollTop}`);
            } else if (skipAutoScroll) {
                // Si se solicita omitir auto-scroll, no hacer nada (mantener posiciÃ³n actual)
                console.log(`ðŸš« Auto-scroll desactivado - manteniendo posiciÃ³n actual`);
            } else if (!isNearBottom && currentScrollTop > 100) {
                // Si el usuario estÃ¡ scrolleando hacia arriba viendo historial, NO hacer auto-scroll
                console.log(`ðŸ“œ Usuario viendo historial - NO hacer auto-scroll (posiciÃ³n: ${currentScrollTop}px)`);
            } else {
                // Solo hacer auto-scroll si el usuario estÃ¡ cerca del final o es un chat nuevo
                requestAnimationFrame(() => {
                    const isMobile = window.innerWidth <= 768;
                    if (isMobile) {
                        // Para mÃ³viles, usar mÃºltiples intentos de scroll para asegurar funcionamiento
                        const scrollToBottom = () => {
                            messagesArea.scrollTop = messagesArea.scrollHeight;
                        };

                        scrollToBottom();
                        setTimeout(scrollToBottom, 50);
                        setTimeout(scrollToBottom, 150);

                        console.log(`ðŸ“± Scroll mÃ³vil al final del chat (${filteredMessages.length} mensajes)`);
                    } else {
                        messagesArea.scrollTo({
                            top: messagesArea.scrollHeight,
                            behavior: 'smooth'
                        });
                        console.log(`ðŸ’» Scroll desktop al final del chat (${filteredMessages.length} mensajes)`);
                    }
                });
            }

            // 7. Agregar indicador de que se cargÃ³ todo el historial
            if (filteredMessages.length > 0) {
                const firstMessage = filteredMessages[0];
                const lastMessage = filteredMessages[filteredMessages.length - 1];
                const dateRange = firstMessage.timestamp !== lastMessage.timestamp 
                    ? `${formatTime(firstMessage.timestamp)} - ${formatTime(lastMessage.timestamp)}`
                    : formatTime(firstMessage.timestamp);
                    
                console.log(`âœ… Historial completo cargado: ${sortedMessages.length} mensajes (${dateRange})`);
                
                // Opcional: mostrar indicador visual temporal (solo si no es silencioso)
                if (!silent) {
                    setTimeout(() => {
                        const indicator = document.createElement('div');
                        indicator.style.cssText = `
                            position: absolute;
                            top: 10px;
                            right: 10px;
                            background: rgba(0, 212, 170, 0.9);
                            color: white;
                            padding: 5px 10px;
                            border-radius: 15px;
                            font-size: 0.8em;
                            z-index: 100;
                            pointer-events: none;
                            opacity: 0;
                            transition: opacity 0.3s ease;
                        `;
                        indicator.innerHTML = `ðŸ“š ${sortedMessages.length} mensajes cargados`;
                        messagesArea.parentElement.style.position = 'relative';
                        messagesArea.parentElement.appendChild(indicator);

                        // Fade in y fade out
                        setTimeout(() => indicator.style.opacity = '1', 50);
                        setTimeout(() => {
                            indicator.style.opacity = '0';
                            setTimeout(() => indicator.remove(), 300);
                        }, 2000);
                    }, 100);
                }
            }
        }

        // Flag para prevenir envÃ­os duplicados
        let isSendingMessage = false;

        async function sendMessage() {
            console.log('ðŸ”µ [SEND] FunciÃ³n sendMessage() llamada');

            // Prevenir envÃ­os duplicados
            if (isSendingMessage) {
                console.warn('âš ï¸ [SEND] Ya hay un mensaje siendo enviado, ignorando llamada duplicada');
                return;
            }

            const input = document.getElementById('message-input');
            const message = input.value.trim();

            if ((!message && selectedFiles.length === 0) || !currentChatId) {
                console.log('âŒ [SEND] Mensaje vacÃ­o o sin chat seleccionado, abortando');
                return;
            }

            isSendingMessage = true;
            const sendBtn = document.getElementById('send-btn');
            const originalContent = sendBtn.innerHTML;

            const restoreButton = () => {
                try {
                    sendBtn.innerHTML = originalContent;
                    sendBtn.disabled = false;
                } catch (error) {
                    console.error('Error restaurando botï¿½n:', error);
                }
            };

            try {
                sendBtn.innerHTML = '<div class="loading"></div>';
                sendBtn.disabled = true;

                if (selectedFiles.length > 0) {
                    await sendFiles(message);
                } else if (message) {
                    console.log(`ðŸ“¤ [SEND] Enviando mensaje: "${message}" al chat: ${currentChatId}`);

                    // Crear AbortController para timeout
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => {
                        controller.abort();
                        console.warn('â° PeticiÃ³n cancelada por timeout (15 segundos)');
                    }, 15000);

                    const response = await fetch('/api/send-message', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            chatId: currentChatId,
                            message: message,
                            skipDelay: true  // Indicar que es del panel web, sin delay
                        }),
                        signal: controller.signal
                    });

                    // Limpiar timeout si la peticiÃ³n se completÃ³
                    clearTimeout(timeoutId);

                    if (response.ok) {
                        const data = await response.json();
                        const webMessage = {
                            body: message,
                            fromMe: true,
                            timestamp: Date.now(),
                            status: 'sending',
                            isWebMessage: true
                        };

                        // Agregar al cache de mensajes web pendientes
                        if (!pendingWebMessages.has(currentChatId)) {
                            pendingWebMessages.set(currentChatId, []);
                        }
                        pendingWebMessages.get(currentChatId).push(webMessage);

                        addMessageToUI(webMessage);
                        showNotification('Mensaje enviado', 'success');

                        // Los mensajes enviados desde web ahora se mantienen permanentemente
                        console.log('âœ… [WEB MESSAGE] Mensaje enviado desde web agregado al UI');
                    } else {
                        const errorText = await response.text();
                        console.error('Error en respuesta:', errorText);
                        showNotification('Error enviando mensaje', 'error');
                    }
                }

                input.value = '';
                input.style.height = 'auto';
                clearFiles();

            } catch (error) {
                console.error('Error en sendMessage:', error);
                    showNotification('Error enviando mensaje', 'error');
            } finally {
                restoreButton();
                isSendingMessage = false;
                console.log('âœ… [SEND] Flag isSendingMessage liberado');
            }
        }

        async function sendFiles(caption = '') {
            if (selectedFiles.length === 0) return;

            const formData = new FormData();
            formData.append('chatId', currentChatId);
            if (caption) formData.append('caption', caption);

            selectedFiles.forEach((file, index) => {
                formData.append('files', file);
            });

            try {
                const response = await fetch('/api/send-files', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();

                    selectedFiles.forEach(file => {
                            let content = '';
                            if (file.type.startsWith('image/')) {
                                const imageUrl = URL.createObjectURL(file);
                                content = `<img src="${imageUrl}" alt="${file.name}" style="max-width: 200px; border-radius: 8px;">`;
                            } else {
                            content = `ðŸ“„ ${file.name} (${formatFileSize(file.size)})`;
                            }

                            addMessageToUI({
                                body: content,
                                fromMe: true,
                                timestamp: Date.now(),
                                status: 'sending',
                                isMedia: true
                            });
                    });

                    if (caption) {
                            addMessageToUI({
                                body: caption,
                                fromMe: true,
                                timestamp: Date.now(),
                                status: 'sending'
                            });
                    }

                        showNotification(`${selectedFiles.length} archivo(s) enviado(s)`, 'success');
                } else {
                    const errorData = await response.json().catch(() => ({ error: 'Error desconocido' }));
                    showNotification(`Error enviando archivos: ${errorData.error}`, 'error');
                }
            } catch (error) {
                console.error('Error en sendFiles:', error);
                    showNotification('Error enviando archivos', 'error');
            }
        }

        function addMessageToUI(message) {
            const messagesArea = document.getElementById('messages-area');
            const messageElement = document.createElement('div');
            messageElement.className = `message ${message.fromMe ? 'outgoing' : 'incoming'}`;
            messageElement.dataset.messageId = message.id || `temp_${Date.now()}_${Math.random()}`;
            
            messageElement.innerHTML = `
                <div class="message-content">
                    <div class="message-text">${formatMessageBody(message.body)}</div>
                    <div class="message-time">
                        ${formatTime(message.timestamp)}
                        ${message.fromMe ? `<span class="message-status">${getMessageStatus(message.status)}</span>` : ''}
                    </div>
                </div>
            `;
            
            // Verificar si el mensaje ya existe para evitar duplicados
            const existingMessage = messagesArea.querySelector(`[data-message-id="${messageElement.dataset.messageId}"]`);
            if (existingMessage) {
                console.log('ðŸ”„ Mensaje duplicado detectado, actualizando en lugar de agregar');
                existingMessage.replaceWith(messageElement);
            } else {
                messagesArea.appendChild(messageElement);
            }
            
            // Corregir URLs multimedia del nuevo mensaje
            fixMultimediaUrls();
            
            // Mejorar scroll para mÃ³viles con requestAnimationFrame
            requestAnimationFrame(() => {
                const isMobile = window.innerWidth <= 768;
                if (isMobile) {
                    // En mÃ³viles, usar smooth scroll con comportamiento mÃ¡s confiable
                    messagesArea.scrollTo({
                        top: messagesArea.scrollHeight,
                        behavior: 'smooth'
                    });
                } else {
                    messagesArea.scrollTop = messagesArea.scrollHeight;
                }
                
                // VerificaciÃ³n adicional para asegurar que el scroll funcionÃ³
                setTimeout(() => {
                    if (messagesArea.scrollTop < messagesArea.scrollHeight - messagesArea.clientHeight - 50) {
                        console.log('ðŸ”§ Corrigiendo scroll fallido');
                        messagesArea.scrollTop = messagesArea.scrollHeight;
                    }
                }, 100);
            });
        }

        async function toggleChatMode() {
            if (!currentChatId) return;
            
            try {
                const response = await fetch(`/api/chats/${currentChatId}/toggle-mode`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const chat = chats.get(currentChatId);
                    chat.mode = data.mode;
                    
                    showChatArea(chat);
                    renderChatList();
                    showNotification(`Modo cambiado a ${data.mode === 'bot' ? 'Bot' : 'Humano'}`, 'success');
                }
            } catch (error) {
                console.error('Error toggling mode:', error);
                showNotification('Error cambiando modo', 'error');
            }
        }

        async function endChat() {
            if (!currentChatId) return;
            
            if (!confirm('ï¿½Estï¿½s seguro de que quieres finalizar este chat?')) return;
            
            try {
                const response = await fetch(`/api/chats/${currentChatId}/end`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    chats.delete(currentChatId);
                    currentChatId = null;

                    // Detener auto-refresco cuando no hay chat activo
                    stopSmartMessagePolling();

                    document.getElementById('empty-state').style.display = 'flex';
                    document.getElementById('chat-area').style.display = 'none';

                    renderChatList();
                    showNotification('Chat finalizado', 'success');
                }
            } catch (error) {
                console.error('Error ending chat:', error);
                showNotification('Error finalizando chat', 'error');
            }
        }

        async function markAsRead(chatId) {
            try {
                await fetch(`/api/chats/${chatId}/mark-read`, { method: 'POST' });
                const chat = chats.get(chatId);
                if (chat) {
                    chat.unreadCount = 0;
                    renderChatList();
                }
            } catch (error) {
                console.error('Error marking as read:', error);
            }
        }

        function filterChats() {
            renderChatList();
        }

        async function showQRModal() {
            console.log('=== showQRModal() called ===');

            // Verificar si ya existe un modal QR superpuesto
            let overlayModal = document.getElementById('qr-overlay-modal');

            if (!overlayModal) {
                console.log('ðŸ“± Creando modal QR superpuesto...');

                // Crear modal superpuesto
                overlayModal = document.createElement('div');
                overlayModal.id = 'qr-overlay-modal';
                overlayModal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    animation: modalFadeIn 0.3s ease;
                    backdrop-filter: blur(3px);
                `;

                overlayModal.innerHTML = `
                    <div style="
                        background: white;
                        border-radius: 16px;
                        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                        max-width: 420px;
                        width: 90%;
                        max-height: 90vh;
                        overflow: hidden;
                        position: relative;
                        animation: modalSlideIn 0.4s ease;
                        transform: scale(0.9);
                        animation-fill-mode: forwards;
                    ">
                        <!-- Header -->
                        <div style="
                            background: linear-gradient(135deg, #25d366, #128c7e);
                            color: white;
                            padding: 20px 25px;
                            text-align: center;
                            position: relative;
                        ">
                            <button onclick="hideQROverlayModal()" style="
                                position: absolute;
                                top: 15px;
                                right: 15px;
                                background: rgba(255, 255, 255, 0.2);
                                border: none;
                                color: white;
                                font-size: 24px;
                                cursor: pointer;
                                padding: 5px 10px;
                                border-radius: 50%;
                                transition: all 0.2s ease;
                                width: 40px;
                                height: 40px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-weight: bold;
                            " onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'">
                                Ã—
                            </button>
                            <div style="margin-bottom: 12px;">
                                <i class="fab fa-whatsapp" style="font-size: 36px; opacity: 0.9;"></i>
                            </div>
                            <h2 style="margin: 0 0 8px 0; font-size: 22px; font-weight: 600;">
                                Escanear CÃ³digo QR
                            </h2>
                            <p style="margin: 0; font-size: 14px; opacity: 0.9; line-height: 1.4;">
                                Escanea el cÃ³digo QR con WhatsApp para conectar tu dispositivo
                            </p>
                        </div>

                        <!-- QR Content -->
                        <div style="padding: 30px;">
                            <div id="qr-overlay-code" style="
                                background: #f8f9fa;
                                border-radius: 12px;
                                padding: 25px;
                                margin-bottom: 20px;
                                min-height: 320px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                border: 2px dashed #e0e0e0;
                            ">
                                <div class="loading" style="
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    color: #666;
                                    flex-direction: column;
                                    text-align: center;
                                ">
                                    <div style="
                                        border: 4px solid #f3f3f3;
                                        border-top: 4px solid #25d366;
                                        border-radius: 50%;
                                        width: 45px;
                                        height: 45px;
                                        animation: spin 1s linear infinite;
                                        margin-bottom: 15px;
                                    "></div>
                                    <strong style="font-size: 16px; margin-bottom: 8px;">Cargando cÃ³digo QR...</strong>
                                    <small style="color: #888;">Esto puede tomar unos segundos</small>
                                </div>
                            </div>

                            <!-- Instructions -->
                            <div style="
                                background: linear-gradient(135deg, #e3f2fd, #bbdefb);
                                border-radius: 10px;
                                padding: 18px;
                                font-size: 14px;
                                color: #1976d2;
                                border-left: 4px solid #2196f3;
                            ">
                                <strong style="color: #0d47a1;">ðŸ“± Instrucciones para escanear:</strong><br>
                                <div style="margin-top: 8px; line-height: 1.5;">
                                    1. Abre WhatsApp en tu telÃ©fono<br>
                                    2. Toca â‹® > Dispositivos vinculados<br>
                                    3. Selecciona "Vincular dispositivo"<br>
                                    4. Escanea el cÃ³digo QR de arriba
                                </div>
                            </div>

                            <!-- BotÃ³n de actualizar -->
                            <div style="
                                text-align: center;
                                margin-top: 15px;
                            ">
                                <button onclick="refreshQRImage()" style="
                                    background: linear-gradient(135deg, #25d366, #128c7e);
                                    color: white;
                                    border: none;
                                    padding: 8px 16px;
                                    border-radius: 6px;
                                    font-size: 12px;
                                    cursor: pointer;
                                    transition: all 0.2s ease;
                                    display: flex;
                                    align-items: center;
                                    margin: 0 auto;
                                " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                    <i class="fas fa-sync-alt" style="margin-right: 5px;"></i>
                                    Actualizar QR
                                </button>
                            </div>

                            <!-- Footer -->
                            <div style="
                                text-align: center;
                                margin-top: 15px;
                                padding-top: 15px;
                                border-top: 1px solid #e0e0e0;
                                color: #666;
                                font-size: 12px;
                            ">
                                <i class="fas fa-info-circle" style="margin-right: 5px;"></i>
                                El modal se cerrarÃ¡ automÃ¡ticamente cuando te conectes
                            </div>
                        </div>
                    </div>
                `;

                document.body.appendChild(overlayModal);
                console.log('âœ… Modal QR superpuesto creado');
            }

            // Mostrar el modal
            overlayModal.style.display = 'flex';
            console.log('âœ… Modal QR superpuesto mostrado');

            // Cargar la imagen QR
            setTimeout(() => {
                loadQROverlayImage();
            }, 100);
        }

        function hideQROverlayModal() {
            const modal = document.getElementById('qr-overlay-modal');
            if (modal) {
                modal.style.display = 'none';
                console.log('âœ… Modal QR superpuesto ocultado manualmente');
            }
        }

        // FunciÃ³n para forzar actualizaciÃ³n de la imagen QR
        function refreshQRImage() {
            const qrCodeElement = document.getElementById('qr-overlay-code');
            if (!qrCodeElement) return;

            console.log('ðŸ”„ Forzando actualizaciÃ³n de imagen QR...');

            // Limpiar contenido actual
            qrCodeElement.innerHTML = `
                <div style="
                    text-align: center;
                    color: #666;
                    padding: 20px;
                ">
                    <div style="
                        border: 4px solid #f3f3f3;
                        border-top: 4px solid #25d366;
                        border-radius: 50%;
                        width: 45px;
                        height: 45px;
                        animation: spin 1s linear infinite;
                        margin: 0 auto 15px auto;
                    "></div>
                    <strong>Actualizando cÃ³digo QR...</strong>
                    <br><small>Forzando descarga nueva</small>
                </div>
            `;

            // Usar endpoint de actualizaciÃ³n forzada
            setTimeout(() => {
                loadQROverlayImage(true); // true para forzar actualizaciÃ³n
            }, 1000);
        }

        // FunciÃ³n mejorada para cargar imagen QR con opciÃ³n de forzar
        async function loadQROverlayImage(forceUpdate = false) {
            try {
                const qrCodeElement = document.getElementById('qr-overlay-code');
                if (!qrCodeElement) return;

                const response = await fetch('/api/whatsapp/qr');
                const data = await response.json();

                if (data.success && data.qr) {
                    console.log('ðŸ”— Cargando imagen QR desde /api/whatsapp/qr');
                    console.log('ðŸ“Š QR recibido - Formato: base64 data URL');
                    console.log('ðŸ”„ Modo forzar actualizaciÃ³n:', forceUpdate);

                    // Limpiar cualquier imagen anterior del cache
                    qrCodeElement.innerHTML = '';

                    // Crear contenedor para la imagen
                    const imageContainer = document.createElement('div');
                    imageContainer.style.textAlign = 'center';

                    // Crear la imagen directamente con el data URL
                    const qrImage = document.createElement('img');
                    qrImage.src = data.qr; // Ya viene en formato data:image/png;base64,...
                    qrImage.alt = 'CÃ³digo QR de WhatsApp';
                    qrImage.style.cssText = `
                        max-width: 100%;
                        max-height: 280px;
                        border-radius: 8px;
                        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
                        border: 3px solid white;
                        transition: opacity 0.3s ease;
                    `;

                    // Evento de carga exitosa
                    qrImage.onload = function() {
                        console.log('âœ… Imagen QR cargada exitosamente');
                        qrImage.style.opacity = '1';
                    };

                    // Evento de error
                    qrImage.onerror = function() {
                        console.log('âŒ Error cargando imagen QR');
                        qrCodeElement.innerHTML = '<p style="color: #dc3545;">Error al cargar cÃ³digo QR. Intenta refrescar.</p>';
                    };

                    // Agregar la imagen al contenedor
                    imageContainer.appendChild(qrImage);

                    // Agregar instrucciones
                    const instructions = document.createElement('div');
                    instructions.style.cssText = `
                        margin-top: 15px;
                        font-size: 12px;
                        color: #666;
                    `;
                    instructions.innerHTML = `
                        <i class="fas fa-mobile-alt" style="margin-right: 5px;"></i>
                        Escanea con la cÃ¡mara de WhatsApp
                        <br><small style="color: #999; font-size: 10px;">Actualizado: ${new Date().toLocaleTimeString()}</small>
                        ${forceUpdate ? '<br><small style="color: #28a745; font-size: 10px;">ðŸ”„ ActualizaciÃ³n forzada</small>' : ''}
                    `;
                    imageContainer.appendChild(instructions);

                    // Agregar al elemento principal
                    qrCodeElement.appendChild(imageContainer);

                    console.log('âœ… Imagen QR configurada para carga');
                } else {
                    qrCodeElement.innerHTML = `
                        <div style="
                            text-align: center;
                            color: #666;
                            padding: 20px;
                        ">
                            <i class="fas fa-clock" style="font-size: 32px; margin-bottom: 15px; opacity: 0.5;"></i>
                            <br><strong>Esperando cÃ³digo QR...</strong>
                            <br><small>El cÃ³digo se generarÃ¡ automÃ¡ticamente</small>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('âŒ Error cargando imagen QR:', error);
                const qrCodeElement = document.getElementById('qr-overlay-code');
                if (qrCodeElement) {
                    qrCodeElement.innerHTML = `

                        <div style="
                            text-align: center;
                            color: #dc3545;
                            padding: 20px;
                        ">
                            <i class="fas fa-exclamation-triangle" style="font-size: 32px; margin-bottom: 15px;"></i>
                            <br><strong>Error cargando QR</strong>
                            <br><small>IntÃ©ntalo de nuevo</small>
                        </div>
                    `;
                }
            }
        }

        // Agregar listener para la tecla Escape
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const overlayModal = document.getElementById('qr-overlay-modal');
                if (overlayModal && overlayModal.style.display !== 'none') {
                    hideQROverlayModal();
                    console.log('âœ… Modal QR cerrado con tecla Escape');
                }
            }
        });

        function hideQRModal() {
            const modal = document.getElementById('qr-modal');
            if (modal && !modal.classList.contains('hidden')) {
                modal.classList.add('hidden');
                console.log('QR modal hidden');
            }
        }

        // FunciÃ³n mejorada para ocultar el modal QR con razÃ³n especÃ­fica
        function hideQRModalByConnection() {
            qrModalClosedByConnection = true;
            hideQRModal();

            // TambiÃ©n ocultar el modal superpuesto si existe
            const overlayModal = document.getElementById('qr-overlay-modal');
            if (overlayModal) {
                overlayModal.style.display = 'none';
                console.log('âœ… Modal QR superpuesto ocultado por conexiÃ³n exitosa');
            }

            console.log('QR modal hidden by successful connection');
        }

        function hideQRModalManually() {
            hideQRModal();
            console.log('QR modal hidden manually by user');
        }

        // FunciÃ³n para forzar la ocultaciÃ³n del modal QR si estÃ¡ visible por error
        function forceHideQRModal() {
            const modal = document.getElementById('qr-modal');
            if (modal && !modal.classList.contains('hidden')) {
                modal.classList.add('hidden');
                console.log('QR modal force hidden');
            }
        }

        // FunciÃ³n para mostrar el modal QR forzosamente (para debugging)
        function forceShowQRModal() {
            console.log('Forcing QR modal show...');

            // Primero verificar si existe
            let modal = document.getElementById('qr-modal');

            if (!modal) {
                console.error('âŒ Modal QR not found in DOM - creating emergency modal');

                // Crear modal de emergencia si no existe
                const emergencyModal = document.createElement('div');
                emergencyModal.id = 'qr-modal';
                emergencyModal.className = 'qr-modal';
                emergencyModal.style.cssText = `
                    position: fixed; top: 20px; right: 20px; width: 350px; height: auto;
                    background: white; border-radius: 12px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                    z-index: 1000; border: 2px solid #25d366; overflow: hidden;
                `;

                emergencyModal.innerHTML = `
                    <div style="padding: 20px; text-align: center; background: linear-gradient(135deg, #25d366, #128c7e); color: white; position: relative;">
                        <button onclick="hideQRModalManually()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; color: white; font-size: 20px; cursor: pointer; padding: 5px;">&times;</button>
                        <h3 style="margin: 0 0 10px 0; font-size: 18px;"><i class="fab fa-whatsapp"></i> Modal QR de Emergencia</h3>
                        <p style="margin: 0; font-size: 14px; opacity: 0.9;">Modal creado por emergencia - recarga la pÃ¡gina</p>
                    </div>
                    <div style="padding: 20px;">
                        <div style="text-align: center; padding: 30px; background: #f8f9fa; border-radius: 8px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 24px; color: #dc3545; margin-bottom: 10px;"></i>
                            <br><strong>Modal QR no encontrado</strong>
                            <br><small>Recarga la pÃ¡gina para solucionarlo</small>
                        </div>
                    </div>
                `;

                document.body.appendChild(emergencyModal);
                modal = emergencyModal;
                console.log('âœ… Emergency modal created');
            }

            // Mostrar el modal
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                console.log('âœ… QR modal forced to show');

                // Intentar cargar el QR si hay elementos
                const qrCode = document.getElementById('qr-code');
                if (qrCode) {
                    showQRModal();
                }
            } else {
                console.log('â„¹ï¸ QR modal was already visible');
            }
        }

        // FunciÃ³n para inicializar el botÃ³n QR
        function initializeQRButton() {
            const qrBtn = document.getElementById('qr-btn');
            if (qrBtn) {
                qrBtn.addEventListener('click', function() {
                    console.log('QR button clicked - showing QR modal');
                    showQRModal();
                });
                console.log('âœ… QR button initialized');
            } else {
                console.error('âŒ QR button not found in DOM');
            }
        }

        // FunciÃ³n para inicializar el botÃ³n de escanear QR
        function initializeScanQRButton() {
            const scanQrBtn = document.getElementById('scan-qr-btn');
            if (scanQrBtn) {
                scanQrBtn.addEventListener('click', handleScanQRClick);
                console.log('âœ… Scan QR button initialized');
            } else {
                console.error('âŒ Scan QR button not found in DOM');
            }
        }

        // Variables para el contador de sesiÃ³n
        let sessionDuration = 15 * 60 * 1000; // 15 minutos en milisegundos
        let sessionStartTime = null;
        let sessionTimer = null;
        let sessionWarningShown = false;
        let sessionCriticalShown = false;
        let lastActivityTime = Date.now();

        // FunciÃ³n para inicializar el contador de sesiÃ³n
        function initializeSessionCounter() {
            try {
                const sessionCounter = document.getElementById('session-counter');
                const sessionTime = document.getElementById('session-time');

                if (!sessionCounter || !sessionTime) {
                    console.error('âŒ Session counter elements not found in DOM');
                    console.log('   sessionCounter:', !!sessionCounter);
                    console.log('   sessionTime:', !!sessionTime);

                    // Reintentar despuÃ©s de 2 segundos
                    setTimeout(() => {
                        console.log('ðŸ”„ Retrying session counter initialization...');
                        initializeSessionCounter();
                    }, 2000);
                    return;
                }

                // Limpiar timer anterior si existe
                if (sessionTimer) {
                    console.log('ðŸ§¹ Clearing existing session timer');
                    clearInterval(sessionTimer);
                    sessionTimer = null;
                }

                sessionStartTime = Date.now();
                lastActivityTime = Date.now();
                sessionWarningShown = false;
                sessionCriticalShown = false;

                // Hacer el contador clickeable para extender la sesiÃ³n
                sessionCounter.removeEventListener('click', extendSessionManually); // Prevenir duplicados
                sessionCounter.addEventListener('click', extendSessionManually);
                sessionCounter.style.cursor = 'pointer';
                sessionCounter.title = 'Click para extender la sesiÃ³n';

                // Iniciar el contador
                startSessionTimer();

                // Iniciar el watchdog
                startSessionWatchdog();

                // Configurar detectores de actividad
                setupActivityDetection();

                console.log('âœ… Session counter initialized successfully');
                console.log('   Timer ID:', sessionTimer);
                console.log('   Watchdog ID:', sessionWatchdog);
            } catch (error) {
                console.error('âŒ Error initializing session counter:', error);

                // Reintentar despuÃ©s de 3 segundos
                setTimeout(() => {
                    console.log('ðŸ”„ Retrying after error...');
                    initializeSessionCounter();
                }, 3000);
            }
        }

        // FunciÃ³n para iniciar el temporizador de sesiÃ³n
        function startSessionTimer() {
            // Limpiar cualquier timer existente
            if (sessionTimer) {
                clearInterval(sessionTimer);
                sessionTimer = null;
            }

            console.log('ðŸ• Starting session timer...');

            // Reiniciar el timestamp del watchdog
            lastSessionTimerCheck = Date.now();

            sessionTimer = setInterval(() => {
                try {
                    const elapsed = Date.now() - lastActivityTime;
                    const remaining = sessionDuration - elapsed;

                    if (remaining <= 0) {
                        // SesiÃ³n expirada
                        handleSessionExpired();
                        return;
                    }

                    // Actualizar el contador visual
                    updateSessionCounter(remaining);
                } catch (error) {
                    console.error('âŒ Error in session timer:', error);
                    // NO detener el timer por un error - intentar en el prÃ³ximo ciclo
                }
            }, 1000); // Actualizar cada segundo

            console.log('âœ… Session timer started, ID:', sessionTimer);
        }

        // FunciÃ³n para actualizar el contador visual
        function updateSessionCounter(remainingMs) {
            const sessionTime = document.getElementById('session-time');
            const sessionCounter = document.getElementById('session-counter');

            if (!sessionTime || !sessionCounter) {
                console.warn('âš ï¸ Session counter elements not found in DOM');
                return;
            }

            const minutes = Math.floor(remainingMs / (60 * 1000));
            const seconds = Math.floor((remainingMs % (60 * 1000)) / 1000);

            // Formato MM:SS
            const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            sessionTime.textContent = timeString;

            // Actualizar timestamp para el watchdog
            lastSessionTimerCheck = Date.now();

            // Cambiar colores segÃºn el tiempo restante
            const totalMinutes = sessionDuration / (60 * 1000);
            const remainingMinutes = remainingMs / (60 * 1000);

            // Remover clases anteriores
            sessionCounter.classList.remove('warning', 'critical');

            if (remainingMinutes <= 2) {
                // Menos de 2 minutos - Estado crÃ­tico
                sessionCounter.classList.add('critical');
                if (!sessionCriticalShown) {
                    showNotification('Â¡SesiÃ³n expira en menos de 2 minutos!', 'error');
                    sessionCriticalShown = true;
                }
            } else if (remainingMinutes <= 5) {
                // Menos de 5 minutos - Estado de advertencia
                sessionCounter.classList.add('warning');
                if (!sessionWarningShown) {
                    showNotification('SesiÃ³n expira en menos de 5 minutos', 'warning');
                    sessionWarningShown = true;
                }
            }
        }

        // FunciÃ³n para detectar actividad del usuario
        function setupActivityDetection() {
            const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];

            const resetTimer = () => {
                lastActivityTime = Date.now();
                // Reiniciar banderas de advertencia cuando hay actividad
                if (sessionWarningShown || sessionCriticalShown) {
                    sessionWarningShown = false;
                    sessionCriticalShown = false;
                    console.log('Session timer reset due to user activity');
                }
            };

            events.forEach(event => {
                document.addEventListener(event, resetTimer, true);
            });

            console.log('âœ… Activity detection setup completed');
        }

        // FunciÃ³n para manejar cuando la sesiÃ³n expira
        function handleSessionExpired() {
            console.log('â° Session expired - redirecting to login');

            // Limpiar el temporizador
            if (sessionTimer) {
                clearInterval(sessionTimer);
                sessionTimer = null;
            }

            // Limpiar el watchdog
            if (sessionWatchdog) {
                clearInterval(sessionWatchdog);
                sessionWatchdog = null;
            }

            // Mostrar notificaciÃ³n final
            showNotification('Tu sesiÃ³n ha expirado. SerÃ¡s redirigido al login.', 'error');

            // Esperar 3 segundos antes de redirigir
            setTimeout(() => {
                // Limpiar la sesiÃ³n
                token = null;
                currentUser = null;
                localStorage.removeItem('token');

                // Redirigir al login
                showLoginScreen();
            }, 3000);
        }

        // Variable para el watchdog
        let sessionWatchdog = null;
        let lastSessionTimerCheck = Date.now();

        // FunciÃ³n watchdog para verificar que el timer estÃ© funcionando
        function startSessionWatchdog() {
            // Limpiar cualquier watchdog existente
            if (sessionWatchdog) {
                clearInterval(sessionWatchdog);
                sessionWatchdog = null;
            }

            console.log('ðŸ• Starting session watchdog...');

            sessionWatchdog = setInterval(() => {
                try {
                    // Verificar si el timer sigue funcionando
                    if (!sessionTimer) {
                        console.warn('âš ï¸ Session timer not running, restarting...');
                        startSessionTimer();
                        return;
                    }

                    // Verificar que el DOM tenga los elementos necesarios
                    const sessionTime = document.getElementById('session-time');
                    const sessionCounter = document.getElementById('session-counter');

                    if (!sessionTime || !sessionCounter) {
                        console.warn('âš ï¸ Session counter DOM elements missing');
                        // Intentar reinicializar todo
                        initializeSessionCounter();
                        return;
                    }

                    // Verificar que el tiempo se estÃ© actualizando
                    const currentCheck = Date.now();
                    const timeSinceLastCheck = currentCheck - lastSessionTimerCheck;

                    // Si han pasado mÃ¡s de 5 segundos sin actualizaciÃ³n, hay un problema
                    if (timeSinceLastCheck > 5000) {
                        console.warn('âš ï¸ Session timer appears frozen, restarting...');
                        startSessionTimer();
                    }

                    lastSessionTimerCheck = currentCheck;

                } catch (error) {
                    console.error('âŒ Error in session watchdog:', error);
                }
            }, 10000); // Verificar cada 10 segundos

            console.log('âœ… Session watchdog started');
        }

        // FunciÃ³n para extender manualmente la sesiÃ³n
        function extendSessionManually() {
            console.log('ðŸ”„ Extending session manually...');
            lastActivityTime = Date.now();
            sessionWarningShown = false;
            sessionCriticalShown = false;

            // Actualizar el contador inmediatamente
            const sessionCounter = document.getElementById('session-counter');
            if (sessionCounter) {
                sessionCounter.classList.remove('warning', 'critical');
            }

            showNotification('SesiÃ³n extendida por actividad', 'success');
        }

        // FunciÃ³n para actualizar la visibilidad del botÃ³n QR
        function updateQRButtonVisibility() {
            const qrBtn = document.getElementById('qr-btn');
            if (qrBtn) {
                if (isConnected) {
                    qrBtn.style.display = 'none';
                    console.log('QR button hidden - WhatsApp connected');
                } else {
                    qrBtn.style.display = 'flex';
                    console.log('QR button shown - WhatsApp not connected');
                }
            }
        }

        // FunciÃ³n para actualizar la visibilidad del botÃ³n de escanear QR
        let lastScanQRButtonState = null;

        function updateScanQRButtonVisibility() {
            const scanQrBtn = document.getElementById('scan-qr-btn');
            if (scanQrBtn) {
                const shouldShow = !isConnected;
                
                // Solo actualizar si el estado cambiÃ³
                if (lastScanQRButtonState !== shouldShow) {
                    if (shouldShow) {
                        scanQrBtn.style.display = 'flex';
                        console.log('Scan QR button shown - WhatsApp not connected');
                    } else {
                        scanQrBtn.style.display = 'none';
                        console.log('Scan QR button hidden - WhatsApp connected');
                    }
                    lastScanQRButtonState = shouldShow;
                }
            }
        }

        // FunciÃ³n para manejar el clic en el botÃ³n de escanear QR
        function handleScanQRClick() {
            console.log('ðŸ” === ESCANEAR QR BUTTON CLICKED ===');
            console.log('Current connection status:', isConnected);
            console.log('QR modal closed by connection flag:', qrModalClosedByConnection);

            // Mostrar informaciÃ³n del QR en consola
            fetch('/api/whatsapp/qr')
                .then(response => response.json())
                .then(data => {
                    console.log('ðŸ“± === QR CODE INFORMATION ===');
                    console.log('QR Available:', data.success);
                    if (data.success && data.qr) {
                        console.log('QR recibido como data URL base64');
                        console.log('ðŸ“± Â¡La imagen QR aparecerÃ¡ en la ventana modal!');
                    } else {
                        console.log('No QR data available');
                        if (data.connected) {
                            console.log('âœ… WhatsApp ya estÃ¡ conectado - no se necesita QR');
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching QR data:', error);
                });

            // Mostrar el modal QR
            showQRModal();

            // Mostrar notificaciÃ³n
            showNotification('Escanea el cÃ³digo QR que aparece en la ventana modal', 'info');

            // Iniciar monitoreo de conexiÃ³n
            startQRConnectionMonitoring();
        }

        // Variable para controlar el monitoreo de conexiÃ³n
        let qrConnectionMonitoring = false;

        // FunciÃ³n para monitorear la conexiÃ³n de WhatsApp mientras el modal QR estÃ¡ abierto
        function startQRConnectionMonitoring() {
            if (qrConnectionMonitoring) {
                return; // Ya estÃ¡ monitoreando
            }

            qrConnectionMonitoring = true;
            console.log('ðŸ”„ Starting QR connection monitoring...');

            const monitoringInterval = setInterval(() => {
                const qrModal = document.getElementById('qr-modal');

                // Si el modal ya no estÃ¡ visible, detener el monitoreo
                if (!qrModal || qrModal.classList.contains('hidden')) {
                    clearInterval(monitoringInterval);
                    qrConnectionMonitoring = false;
                    console.log('âœ… QR connection monitoring stopped - modal closed');
                    return;
                }

                // Verificar estado de conexiÃ³n
                fetch('/api/stats')
                    .then(response => response.json())
                    .then(data => {
                        const isWhatsAppReady = data.whatsappListo || data.connected || data.ready;

                        if (isWhatsAppReady && !isConnected) {
                            console.log('ðŸŽ‰ WhatsApp connected! Closing QR modal...');

                            // Actualizar estado
                            isConnected = true;
                            qrModalClosedByConnection = true;

                            // Actualizar botones
                            updateQRButtonVisibility();
                            updateScanQRButtonVisibility();

                            // Mostrar notificaciÃ³n
                            showNotification('Â¡WhatsApp conectado exitosamente!', 'success');

                            // Cerrar modal despuÃ©s de 2 segundos
                            setTimeout(() => {
                                hideQRModalByConnection();
                                clearInterval(monitoringInterval);
                                qrConnectionMonitoring = false;
                                console.log('âœ… QR modal closed automatically after connection');
                            }, 2000);
                        }
                    })
                    .catch(error => {
                        console.error('Error checking connection during QR monitoring:', error);
                    });
            }, 1000); // Verificar cada segundo
        }

        // FunciÃ³n para verificar que el modal QR existe en el DOM
        function checkQRModalInDOM() {
            const modal = document.getElementById('qr-modal');
            const qrCode = document.getElementById('qr-code');

            console.log('=== QR MODAL DOM CHECK ===');
            console.log('Modal element exists:', !!modal);
            console.log('QR code element exists:', !!qrCode);

            if (modal) {
                console.log('Modal classes:', modal.classList.toString());
                console.log('Modal computed style display:', window.getComputedStyle(modal).display);
                console.log('Modal is hidden:', modal.classList.contains('hidden'));
            }

            if (qrCode) {
                console.log('QR code innerHTML:', qrCode.innerHTML.substring(0, 100) + '...');
            }

            // Verificar elementos relacionados
            const allElementsWithQR = Array.from(document.querySelectorAll('[id*="qr"], [class*="qr"]'));
            console.log('Elements with QR in id/class:', allElementsWithQR.map(el => ({id: el.id, class: el.className})));

            return {
                modalExists: !!modal,
                qrCodeExists: !!qrCode,
                modalHidden: modal ? modal.classList.contains('hidden') : null
            };
        }

        // Exponer funciÃ³n de verificaciÃ³n DOM
        window.checkQRModalInDOM = checkQRModalInDOM;

        // FunciÃ³n para verificar el modal QR al cargar la pÃ¡gina
        function verifyQRModalOnLoad() {
            console.log('=== PAGE LOAD - QR MODAL VERIFICATION ===');
            const result = checkQRModalInDOM();

            if (result.modalExists && result.qrCodeExists) {
                console.log('âœ… QR modal components found and ready');
            } else {
                console.error('âŒ QR modal components missing!');
                if (!result.modalExists) console.error('   - Modal element not found');
                if (!result.qrCodeExists) console.error('   - QR code element not found');
            }

            return result;
        }

        // Ejecutar verificaciÃ³n cuando el DOM estÃ© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', verifyQRModalOnLoad);
        } else {
            verifyQRModalOnLoad();
        }

        // TambiÃ©n verificar cuando la ventana estÃ© completamente cargada
        window.addEventListener('load', function() {
            console.log('=== WINDOW LOAD - QR MODAL FINAL CHECK ===');
            setTimeout(verifyQRModalOnLoad, 100); // PequeÃ±o delay para asegurar que todo estÃ© listo
        });

        // FunciÃ³n para actualizar el indicador de estado en el modal QR
        function updateQRStatusIndicator(status, message) {
            const indicator = document.getElementById('qr-status-indicator');
            if (indicator) {
                indicator.innerHTML = message;

                // Cambiar colores segÃºn el estado
                switch(status) {
                    case 'connecting':
                        indicator.style.background = '#fff3cd';
                        indicator.style.color = '#856404';
                        indicator.style.borderColor = '#ffeaa7';
                        break;
                    case 'connected':
                        indicator.style.background = '#d4edda';
                        indicator.style.color = '#155724';
                        indicator.style.borderColor = '#c3e6cb';
                        break;
                    case 'error':
                        indicator.style.background = '#f8d7da';
                        indicator.style.color = '#721c24';
                        indicator.style.borderColor = '#f5c6cb';
                        break;
                }
            }
        }

        // FunciÃ³n de debugging para el modal QR
        function debugQRModal() {
            const modal = document.getElementById('qr-modal');
            const isVisible = modal && !modal.classList.contains('hidden');
            const isConnectedStatus = isConnected;

            console.log('=== DEBUG QR MODAL ===');
            console.log('Modal visible:', isVisible);
            console.log('WhatsApp connected:', isConnectedStatus);
            console.log('QR modal closed by connection:', qrModalClosedByConnection);
            console.log('Modal element:', modal);
            console.log('Modal classes:', modal ? modal.classList.toString() : 'null');
            console.log('Connection check interval running:', true);

            // Verificar estado de conexiÃ³n actual
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    console.log('Current connection status:', data);
                    const isWhatsAppReady = data.whatsappListo || data.connected || data.ready;
                    console.log('Calculated ready status:', isWhatsAppReady);
                })
                .catch(error => console.error('Error fetching connection status:', error));

            return {
                isVisible,
                isConnected: isConnectedStatus,
                qrModalClosedByConnection
            };
        }

        // FunciÃ³n de diagnÃ³stico completa para el modal QR
        function diagnoseQRModal() {
            console.log('ðŸ” === DIAGNÃ“STICO COMPLETO DEL MODAL QR ===');

            const modal = document.getElementById('qr-modal');
            const isVisible = modal && !modal.classList.contains('hidden');
            const indicator = document.getElementById('qr-status-indicator');

            console.log('ðŸ“Š Estado actual:');
            console.log('   - Modal existe:', !!modal);
            console.log('   - Modal visible:', isVisible);
            console.log('   - WhatsApp conectado:', isConnected);
            console.log('   - Flag cerrado por conexiÃ³n:', qrModalClosedByConnection);
            console.log('   - Indicador de estado:', indicator ? indicator.innerHTML : 'No encontrado');
            console.log('   - Modal classes:', modal ? modal.classList.toString() : 'null');

            // Verificar elementos del DOM
            const qrCode = document.getElementById('qr-code');
            console.log('   - QR code element exists:', !!qrCode);
            console.log('   - QR code has content:', qrCode ? qrCode.innerHTML.length > 0 : 'N/A');

            // Verificar conexiÃ³n actual
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    const isWhatsAppReady = data.whatsappListo || data.connected || data.ready;
                    console.log('ðŸ”— Estado de WhatsApp:');
                    console.log('   - whatsappListo:', data.whatsappListo);
                    console.log('   - connected:', data.connected);
                    console.log('   - ready:', data.ready);
                    console.log('   - Calculado ready:', isWhatsAppReady);

                    console.log('ðŸ“‹ DiagnÃ³stico:');
                    if (isWhatsAppReady && isConnected && qrModalClosedByConnection) {
                        console.log('   âœ… TODO CORRECTO: WhatsApp conectado y modal cerrado por conexiÃ³n exitosa');
                    } else if (isWhatsAppReady && !isConnected) {
                        console.log('   âš ï¸  WhatsApp conectado pero isConnected=false (posible problema de sincronizaciÃ³n)');
                        console.log('   ðŸ’¡ SoluciÃ³n: Ejecuta forceConnectionCheck()');
                    } else if (!isWhatsAppReady && isConnected) {
                        console.log('   âš ï¸  isConnected=true pero WhatsApp no estÃ¡ listo (estado inconsistente)');
                        console.log('   ðŸ’¡ SoluciÃ³n: Ejecuta forceConnectionCheck()');
                    } else if (!isModalVisible && !qrModalClosedByConnection) {
                        console.log('   âš ï¸  Modal oculto pero no por conexiÃ³n exitosa (posible cierre manual)');
                        console.log('   ðŸ’¡ SoluciÃ³n: Ejecuta resetQRModalFlag() si necesitas que aparezca de nuevo');
                    } else if (isModalVisible && isWhatsAppReady) {
                        console.log('   âš ï¸  Modal visible pero WhatsApp conectado (deberÃ­a cerrarse)');
                        console.log('   ðŸ’¡ SoluciÃ³n: Ejecuta forceConnectionCheck()');
                    } else if (!isVisible && !qrModalClosedByConnection) {
                        console.log('   âš ï¸  Modal no estÃ¡ visible y no se cerrÃ³ por conexiÃ³n exitosa');
                        console.log('   ðŸ’¡ Posibles causas:');
                        console.log('      - Modal nunca se mostrÃ³ despuÃ©s del login');
                        console.log('      - Error en showQRModal()');
                        console.log('      - Problema de timing');
                        console.log('   ðŸ”§ Soluciones:');
                        console.log('      - Ejecuta checkQRModalInDOM() para verificar elementos');
                        console.log('      - Ejecuta forceShowQRModal() para mostrar forzosamente');
                        console.log('      - Recarga la pÃ¡gina si el modal no existe');
                    } else if (!modal) {
                        console.log('   âŒ CRÃTICO: Modal QR no existe en el DOM');
                        console.log('   ðŸ’¡ SoluciÃ³n: Recarga la pÃ¡gina');
                    } else {
                        console.log('   â“ Estado desconocido - revisa logs anteriores');
                    }

                    console.log('ðŸ› ï¸  Comandos disponibles:');
                    console.log('   - debugQRModal(): Ver estado detallado');
                    console.log('   - checkQRModalInDOM(): Verificar elementos en DOM');
                    console.log('   - forceConnectionCheck(): Forzar verificaciÃ³n de conexiÃ³n');
                    console.log('   - resetQRModalFlag(): Permitir que el modal aparezca de nuevo');
                    console.log('   - forceShowQRModal(): Mostrar modal forzosamente');
                    console.log('   - forceCloseQRModal(): Cerrar modal forzosamente');
                })
                .catch(error => {
                    console.error('âŒ Error al obtener estado de conexiÃ³n:', error);
                });
        }

        // Exponer funciÃ³n de diagnÃ³stico
        window.diagnoseQRModal = diagnoseQRModal;

        // FunciÃ³n para probar el nuevo flujo del botÃ³n QR
        function testQRButtonFlow() {
            console.log('=== TESTING QR BUTTON FLOW ===');

            // Simular secuencia: mostrar botÃ³n â†’ hacer clic â†’ mostrar modal â†’ conectar â†’ cerrar modal y botÃ³n
            console.log('1. Testing QR button initialization...');
            initializeQRButton();

            setTimeout(() => {
                console.log('2. Simulating WhatsApp disconnection (button should appear)...');
                isConnected = false;
                updateQRButtonVisibility();

                setTimeout(() => {
                    console.log('3. Simulating WhatsApp connection (button should disappear)...');
                    isConnected = true;
                    qrModalClosedByConnection = true;
                    updateQRButtonVisibility();
                    console.log('âœ… QR button flow test completed');
                }, 2000);
            }, 1000);
        }

        // Exponer funciÃ³n de prueba del botÃ³n QR
        window.testQRButtonFlow = testQRButtonFlow;

        // Exponer funciÃ³n de debugging globalmente
        window.debugQRModal = debugQRModal;

        // FunciÃ³n para forzar verificaciÃ³n de conexiÃ³n
        function forceConnectionCheck() {
            console.log('Forcing connection check...');
            checkConnectionStatus();
        }

        // FunciÃ³n para forzar cierre del modal QR
        function forceCloseQRModal() {
            console.log('Forcing QR modal close...');
            hideQRModalManually();
        }

        // FunciÃ³n para resetear el flag del modal QR (permitir que aparezca de nuevo)
        function resetQRModalFlag() {
            qrModalClosedByConnection = false;
            console.log('QR modal flag reset - modal can appear again if needed');
        }

        // Exponer funciones adicionales globalmente
        window.forceConnectionCheck = forceConnectionCheck;
        window.forceCloseQRModal = forceCloseQRModal;
        window.resetQRModalFlag = resetQRModalFlag;
        window.forceShowQRModal = forceShowQRModal;

        // FunciÃ³n de prueba para simular conexiÃ³n (solo para debugging)
        function testQRConnection() {
            console.log('=== TESTING QR CONNECTION LOGIC ===');

            // Resetear flag antes de la prueba
            qrModalClosedByConnection = false;

            // Simular estado de conexiÃ³n
            isConnected = true;

            // Verificar si el modal se cierra correctamente
            const qrModal = document.getElementById('qr-modal');
            if (qrModal && !qrModal.classList.contains('hidden')) {
                updateQRStatusIndicator('connected', '<i class="fas fa-check-circle"></i> Â¡WhatsApp conectado! La ventana se cerrarÃ¡ automÃ¡ticamente...');
                showNotification('Â¡WhatsApp conectado exitosamente!', 'success');

                setTimeout(() => {
                    hideQRModalManually(); // Usar cierre manual para pruebas
                    console.log('âœ… Test successful - Modal closed automatically');
                }, 2000);
            } else {
                console.log('â„¹ï¸ Test info - Modal was already hidden');
            }
        }

        // Exponer funciÃ³n de prueba
        window.testQRConnection = testQRConnection;

        // Exponer funciones del botÃ³n de escanear QR
        window.handleScanQRClick = handleScanQRClick;
        window.updateScanQRButtonVisibility = updateScanQRButtonVisibility;

        // FunciÃ³n para probar el flujo completo del modal QR
        function testQRFlow() {
            console.log('=== TESTING COMPLETE QR FLOW ===');

            // Resetear flag antes de la prueba
            qrModalClosedByConnection = false;

            // Simular secuencia: login -> mostrar modal -> conectar -> cerrar modal
            console.log('1. Showing QR modal (simulating login)');
            showQRModal();
            updateQRStatusIndicator('connecting', '<i class="fas fa-spinner fa-spin"></i> Esperando conexiÃ³n de WhatsApp...');

            setTimeout(() => {
                console.log('2. Simulating WhatsApp connection');
                isConnected = true;

                // Simular la lÃ³gica de checkConnectionStatus cuando WhatsApp se conecta
                const qrModal = document.getElementById('qr-modal');
                const isModalVisible = qrModal && !qrModal.classList.contains('hidden');

                if (isModalVisible) {
                    console.log('3. Modal is visible - updating status and scheduling close');
                    updateQRStatusIndicator('connected', '<i class="fas fa-check-circle"></i> Â¡WhatsApp conectado! La ventana se cerrarÃ¡ automÃ¡ticamente...');
                    showNotification('Â¡WhatsApp conectado exitosamente!', 'success');

                    setTimeout(() => {
                        console.log('4. Auto-closing modal after 2 seconds');
                        hideQRModalManually(); // Usar cierre manual para pruebas
                        console.log('âœ… QR flow test completed successfully');
                    }, 2000);
                } else {
                    console.log('âŒ Modal was not visible during connection test');
                }
            }, 3000);
        }

        // Exponer funciÃ³n de prueba de flujo completo
        window.testQRFlow = testQRFlow;

        // FunciÃ³n para probar el botÃ³n de escanear QR
        function testScanQRButton() {
            console.log('=== TESTING SCAN QR BUTTON ===');

            // Simular secuencia: mostrar botÃ³n â†’ hacer clic â†’ mostrar modal â†’ conectar â†’ cerrar modal y botÃ³n
            console.log('1. Testing scan QR button initialization...');
            initializeScanQRButton();

            setTimeout(() => {
                console.log('2. Simulating WhatsApp disconnection (scan QR button should appear)...');
                isConnected = false;
                updateScanQRButtonVisibility();

                setTimeout(() => {
                    console.log('3. Simulating manual QR scan button click...');
                    handleScanQRClick();

                    setTimeout(() => {
                        console.log('4. Simulating WhatsApp connection (scan QR button should disappear)...');
                        isConnected = true;
                        qrModalClosedByConnection = true;
                        updateScanQRButtonVisibility();
                        console.log('âœ… Scan QR button flow test completed');
                    }, 3000);
                }, 2000);
            }, 1000);
        }

        // Exponer funciÃ³n de prueba del botÃ³n de escanear QR
        window.testScanQRButton = testScanQRButton;

        // FunciÃ³n de ayuda para el usuario sobre el botÃ³n de escanear QR
        function helpScanQRButton() {
            console.log('ðŸš€ === AYUDA: BOTÃ“N ESCANEAR QR ===');
            console.log('');
            console.log('ðŸ“ Â¿DÃ³nde estÃ¡ el botÃ³n?');
            console.log('   - En el header, al lado del botÃ³n de informaciÃ³n del usuario');
            console.log('   - Tiene un Ã­cono de cÃ³digo QR y dice "Escanear QR"');
            console.log('   - Color verde con gradiente WhatsApp');
            console.log('');
            console.log('âš¡ Â¿QuÃ© hace cuando lo presionas?');
            console.log('   1. Muestra informaciÃ³n del QR en la consola');
            console.log('   2. Abre la ventana modal con el cÃ³digo QR');
            console.log('   3. Inicia monitoreo automÃ¡tico de conexiÃ³n');
            console.log('   4. Cierra automÃ¡ticamente cuando WhatsApp se conecta');
            console.log('');
            console.log('ðŸ”„ Â¿CuÃ¡ndo aparece/desaparece?');
            console.log('   âœ… Aparece: Cuando WhatsApp estÃ¡ desconectado');
            console.log('   âŒ Desaparece: Cuando WhatsApp estÃ¡ conectado');
            console.log('');
            console.log('ðŸ› ï¸ Comandos Ãºtiles:');
            console.log('   - testScanQRButton(): Probar el flujo completo');
            console.log('   - debugQRModal(): Ver estado actual');
            console.log('   - diagnoseQRModal(): DiagnÃ³stico completo');
            console.log('');
            console.log('ðŸ’¡ Tip: El botÃ³n monitorea la conexiÃ³n cada segundo mientras el modal estÃ¡ abierto');
        }

        // Exponer funciÃ³n de ayuda
        window.helpScanQRButton = helpScanQRButton;

        // FunciÃ³n para interceptar y debuggear el mensaje "no hay sesiÃ³n activa"
        function debugSessionMessage() {
            console.log('ðŸ” === DEBUGGING SESSION MESSAGE ===');
            console.log('Current session state:');
            console.log('- token:', token);
            console.log('- currentUser:', currentUser);
            console.log('- localStorage token:', localStorage.getItem('token'));

            // Interceptar showNotification para capturar el mensaje
            const originalShowNotification = window.showNotification;
            window.showNotification = function(message, type) {
                console.log('ðŸ”” NOTIFICATION INTERCEPTED:', { message, type });

                // Si es el mensaje problemÃ¡tico, mostrar stack trace
                if (message.toLowerCase().includes('sesiÃ³n') ||
                    message.toLowerCase().includes('session') ||
                    message.toLowerCase().includes('activa')) {
                    console.error('âŒ SESSION MESSAGE DETECTED!');
                    console.trace('Stack trace:');
                }

                return originalShowNotification.apply(this, arguments);
            };

            console.log('âœ… Notification interception active');
            console.log('ðŸ’¡ Now try to reproduce the issue and check the console');

            // Verificar sesiÃ³n actual
            if (token) {
                fetch(`/api/session?token=${token}`)
                    .then(response => {
                        console.log('Session verification response status:', response.status);
                        return response.json();
                    })
                    .then(data => {
                        console.log('Session verification data:', data);
                    })
                    .catch(error => {
                        console.error('Session verification error:', error);
                    });
            }

            // Restaurar funciÃ³n original despuÃ©s de 30 segundos
            setTimeout(() => {
                window.showNotification = originalShowNotification;
                console.log('ðŸ”„ Notification interception restored');
            }, 30000);
        }

        // FunciÃ³n para verificar todas las llamadas fetch que incluyen token
        function debugSessionRequests() {
            console.log('ðŸ” === DEBUGGING SESSION REQUESTS ===');

            const originalFetch = window.fetch;
            window.fetch = function(url, options) {
                // Verificar si la llamada requiere sesiÃ³n
                const requiresSession = url.includes('/api/') &&
                    !url.includes('/api/session?') &&
                    !url.includes('/api/login');

                if (requiresSession && !token) {
                    console.error('âŒ INTENTANDO HACER LLAMADA API SIN SESIÃ“N:', url);
                    showNotification('SesiÃ³n no iniciada. Redirigiendo al login...', 'error');
                    setTimeout(() => {
                        localStorage.removeItem('token');
                        token = null;
                        showLoginScreen();
                    }, 1000);
                    return Promise.reject(new Error('No session available'));
                }

                if (url.includes('token') || (options && options.body && options.body.includes('token'))) {
                    console.log('ðŸ“¡ SESSION REQUEST:', { url, method: options?.method });
                }

                return originalFetch.apply(this, arguments)
                    .then(response => {
                        if (url.includes('token') || (options && options.body && options.body.includes('token'))) {
                            console.log('ðŸ“¡ SESSION RESPONSE:', {
                                url,
                                status: response.status,
                                ok: response.ok
                            });

                            if (response.status === 401 || response.status === 403) {
                                console.error('âŒ AUTHENTICATION ERROR DETECTED!');
                                console.trace('Call stack:');
                            }
                        }

                        // Manejar errores de sesiÃ³n en tiempo real
                        if (response.status === 401 || response.status === 403) {
                            console.error(`ðŸš¨ ERROR DE SESIÃ“N (${response.status}) en:`, url);
                            showNotification('SesiÃ³n expirada o invÃ¡lida. Redirigiendo al login...', 'error');
                            setTimeout(() => {
                                localStorage.removeItem('token');
                                token = null;
                                showLoginScreen();
                            }, 2000);
                        }

                        return response;
                    }).catch(error => {
                        console.error('âŒ ERROR EN FETCH:', error);
                        // Si es un error de red y tenemos token, intentar reconectar
                        if (!navigator.onLine && token) {
                            showNotification('Error de conexiÃ³n. Verificando sesiÃ³n...', 'error');
                            setTimeout(() => verifySession(token), 3000);
                        }
                        throw error;
                    });
            };

            console.log('âœ… Session request interception active');

            // Restaurar despuÃ©s de 30 segundos
            setTimeout(() => {
                window.fetch = originalFetch;
                console.log('ðŸ”„ Fetch interception restored');
            }, 30000);
        }

        // FunciÃ³n de ayuda para debugging de sesiÃ³n
        function helpSessionDebugging() {
            console.log('ðŸš¨ === HELP: SESSION DEBUGGING ===');
            console.log('');
            console.log('ðŸ“ Â¿Aparece "no hay sesiÃ³n activa" cada rato?');
            console.log('');
            console.log('ðŸ”§ Pasos para diagnosticar:');
            console.log('1. Ejecuta: debugSessionMessage()');
            console.log('2. Ejecuta: debugSessionRequests()');
            console.log('3. Espera a que aparezca el mensaje');
            console.log('4. Revisa la consola para ver de dÃ³nde viene');
            console.log('');
            console.log('ðŸ’¡ Posibles causas:');
            console.log('- El token expira en el servidor');
            console.log('- Problema de red que interrumpe las peticiones');
            console.log('- El backend estÃ¡ reiniciando o perdiendo sesiones');
            console.log('- Conflicto entre mÃºltiples pestaÃ±as');
            console.log('');
            console.log('ðŸ› ï¸ Soluciones posibles:');
            console.log('- emergencySessionSilence()    â† Silenciar mensajes 30 min');
            console.log('- extendSession()              â† Extender sesiÃ³n manual');
            console.log('- Hacer refresh de la pÃ¡gina (F5)');
            console.log('- Cerrar otras pestaÃ±as de la aplicaciÃ³n');
            console.log('- Verificar la conexiÃ³n de red');
            console.log('- Contactar al administrador del servidor');
        }

        // Exponer funciones de debugging de sesiÃ³n
        window.debugSessionMessage = debugSessionMessage;
        window.debugSessionRequests = debugSessionRequests;
        window.helpSessionDebugging = helpSessionDebugging;

        // FunciÃ³n para extender la sesiÃ³n automÃ¡ticamente
        function extendSession() {
            if (token) {
                console.log('ðŸ”„ Extending session...');
                fetch(`/api/session/extend?token=${token}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            console.log('âœ… Session extended successfully');
                            // Actualizar el token con el nuevo token recibido
                            if (data.token) {
                                token = data.token;
                                localStorage.setItem('chatbot_token', token);
                                console.log('ðŸ”‘ Token updated with extended session');
                            }
                            showNotification('SesiÃ³n extendida', 'success');
                        } else {
                            console.error('âŒ Failed to extend session:', data.message);
                            showNotification('Error extendiendo sesiÃ³n', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error extending session:', error);
                        showNotification('Error de conexiÃ³n al extender sesiÃ³n', 'error');
                    });
            } else {
                console.error('No token available to extend');
            }
        }

        // FunciÃ³n para verificar y renovar sesiÃ³n automÃ¡ticamente
        function startSessionMaintenance() {
            window.sessionMaintenanceActive = true;
            console.log('ðŸ› ï¸ Starting automatic session maintenance...');

            // Verificar sesiÃ³n cada 5 minutos
            setInterval(() => {
                if (token) {
                    fetch(`/api/session?token=${token}`)
                        .then(response => {
                            if (response.status === 401 || response.status === 403) {
                                console.error('âŒ Session expired - redirecting to login');
                                showNotification('SesiÃ³n expirada - redirigiendo al login', 'error');
                                setTimeout(() => {
                                    localStorage.removeItem('token');
                                    showLoginScreen();
                                }, 2000);
                                return;
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data && !data.success) {
                                console.warn('âš ï¸ Session validation failed:', data.message);
                                // Intentar extender la sesiÃ³n
                                extendSession();
                            } else if (data && data.success) {
                                console.log('âœ… Session validated successfully');
                            }
                        })
                        .catch(error => {
                            console.error('Error validating session:', error);
                            // No mostrar error al usuario para evitar spam
                        });
                }
            }, 5 * 60 * 1000); // 5 minutos

            // Extender sesiÃ³n cada 10 minutos si estÃ¡ activa
            setInterval(() => {
                if (token && document.getElementById('main-container').style.display !== 'none') {
                    extendSession();
                }
            }, 10 * 60 * 1000); // 10 minutos

            console.log('âœ… Session maintenance started');
            console.log('â±ï¸  Session will be validated every 5 minutes');
            console.log('ðŸ”„ Session will be extended every 10 minutes');
        }

        // Iniciar mantenimiento de sesiÃ³n al cargar la aplicaciÃ³n
        function initializeSessionMaintenance() {
            if (token) {
                startSessionMaintenance();
            }
        }

        // Exponer funciones de mantenimiento de sesiÃ³n
        window.extendSession = extendSession;
        window.startSessionMaintenance = startSessionMaintenance;
        window.initializeSessionMaintenance = initializeSessionMaintenance;

        // FunciÃ³n de ayuda completa para el problema de sesiÃ³n
        function helpSessionProblem() {
            console.log('ðŸš¨ === SOLUCIÃ“N COMPLETA: PROBLEMA DE SESIÃ“N ===');
            console.log('');
            console.log('ðŸ“ Problema: "no hay sesiÃ³n activa" aparece cada rato');
            console.log('');
            console.log('ðŸ” PASO 1: Diagnosticar el problema');
            console.log('Ejecuta estos comandos en orden:');
            console.log('');
            console.log('1. helpSessionDebugging()     â† InformaciÃ³n general');
            console.log('2. debugSessionMessage()      â† Interceptar mensajes');
            console.log('3. debugSessionRequests()     â† Ver peticiones HTTP');
            console.log('');
            console.log('â±ï¸  Espera 30 segundos despuÃ©s de ejecutar los comandos 2 y 3');
            console.log('   para que se activen y luego reproduce el problema.');
            console.log('');
            console.log('ðŸ› ï¸ PASO 2: Soluciones inmediatas');
            console.log('');
            console.log('A) Si es problema de expiraciÃ³n:');
            console.log('   - extendSession()              â† Extender sesiÃ³n manual');
            console.log('   - startSessionMaintenance()    â† Iniciar mantenimiento automÃ¡tico');
            console.log('');
            console.log('B) Si es problema de red:');
            console.log('   - Verifica tu conexiÃ³n a internet');
            console.log('   - Recarga la pÃ¡gina (F5)');
            console.log('   - Cierra otras pestaÃ±as de la aplicaciÃ³n');
            console.log('');
            console.log('C) Si es problema del servidor:');
            console.log('   - Contacta al administrador del servidor');
            console.log('   - El mantenimiento automÃ¡tico intentarÃ¡ renovar la sesiÃ³n');
            console.log('');
            console.log('âš¡ FUNCIONES DE EMERGENCIA:');
            console.log('- emergencySessionSilence()  â† Silenciar mensajes 30 min');
            console.log('- forceConnectionCheck()     â† Verificar conexiÃ³n forzadamente');
            console.log('- diagnoseQRModal()          â† DiagnÃ³stico completo del sistema');
            console.log('');
            console.log('ðŸ“Š ESTADO ACTUAL DEL SISTEMA:');
            console.log('- Token:', token);
            console.log('- Usuario actual:', currentUser ? currentUser.username : 'null');
            console.log('- Mantenimiento activo:', window.sessionMaintenanceActive || false);
            console.log('');
            console.log('ðŸ’¡ RECUERDA: El sistema ahora tiene mantenimiento automÃ¡tico');
            console.log('   que verifica la sesiÃ³n cada 5 minutos y la extiende cada 10 minutos.');
        }

        // Exponer funciÃ³n de ayuda completa
        window.helpSessionProblem = helpSessionProblem;

        // Funciones para el contador de sesiÃ³n
        function getSessionStatus() {
            const elapsed = Date.now() - lastActivityTime;
            const remaining = sessionDuration - elapsed;
            const remainingMinutes = Math.floor(remaining / (60 * 1000));
            const remainingSeconds = Math.floor((remaining % (60 * 1000)) / 1000);

            console.log('=== SESSION STATUS ===');
            console.log('Session Duration:', Math.floor(sessionDuration / (60 * 1000)), 'minutes');
            console.log('Time Elapsed:', Math.floor(elapsed / (60 * 1000)), 'minutes');
            console.log('Time Remaining:', remainingMinutes, 'minutes', remainingSeconds, 'seconds');
            console.log('Last Activity:', new Date(lastActivityTime).toLocaleTimeString());
            console.log('Session Timer Active:', !!sessionTimer);
            console.log('Warning Shown:', sessionWarningShown);
            console.log('Critical Shown:', sessionCriticalShown);

            return {
                duration: sessionDuration,
                elapsed: elapsed,
                remaining: remaining,
                lastActivity: lastActivityTime,
                timerActive: !!sessionTimer,
                warningShown: sessionWarningShown,
                criticalShown: sessionCriticalShown
            };
        }

        function setSessionDuration(minutes) {
            console.log(`Setting session duration to ${minutes} minutes`);
            sessionDuration = minutes * 60 * 1000;
            lastActivityTime = Date.now(); // Reset timer
            sessionWarningShown = false;
            sessionCriticalShown = false;

            // Actualizar el contador inmediatamente
            const sessionCounter = document.getElementById('session-counter');
            if (sessionCounter) {
                sessionCounter.classList.remove('warning', 'critical');
            }

            showNotification(`DuraciÃ³n de sesiÃ³n cambiada a ${minutes} minutos`, 'info');
        }

        // Exponer funciones del contador de sesiÃ³n
        window.getSessionStatus = getSessionStatus;
        window.setSessionDuration = setSessionDuration;
        window.extendSessionManually = extendSessionManually;

        // FunciÃ³n de ayuda para el contador de sesiÃ³n
        function helpSessionCounter() {
            console.log('â±ï¸ === AYUDA: CONTADOR DE SESIÃ“N ===');
            console.log('');
            console.log('ðŸ“ Â¿DÃ³nde estÃ¡ el contador?');
            console.log('   - En el header, al lado del botÃ³n de informaciÃ³n del usuario');
            console.log('   - Muestra el tiempo restante en formato MM:SS');
            console.log('   - Tiene un Ã­cono de reloj animado');
            console.log('');
            console.log('âš¡ Â¿QuÃ© hace?');
            console.log('   - Cuenta regresiva desde 15 minutos');
            console.log('   - Se reinicia con cualquier actividad del usuario');
            console.log('   - Cambia de color cuando quedan pocos minutos');
            console.log('   - Redirige al login cuando llega a 00:00');
            console.log('');
            console.log('ðŸŽ¨ Colores del contador:');
            console.log('   ðŸ”µ Azul: Tiempo normal (> 5 min)');
            console.log('   ðŸŸ¡ Amarillo: Advertencia (â‰¤ 5 min)');
            console.log('   ðŸ”´ Rojo: CrÃ­tico (â‰¤ 2 min)');
            console.log('');
            console.log('ðŸ–±ï¸ InteracciÃ³n:');
            console.log('   - Click: Extiende la sesiÃ³n manualmente');
            console.log('   - Hover: Muestra "Click para extender la sesiÃ³n"');
            console.log('');
            console.log('ðŸ› ï¸ Comandos Ãºtiles:');
            console.log('   - getSessionStatus(): Ver estado actual');
            console.log('   - setSessionDuration(20): Cambiar a 20 minutos');
            console.log('   - extendSessionManually(): Extender sesiÃ³n');
            console.log('');
            console.log('âš™ï¸ ConfiguraciÃ³n por defecto:');
            console.log('   - DuraciÃ³n: 15 minutos');
            console.log('   - Advertencia: 5 minutos restantes');
            console.log('   - CrÃ­tico: 2 minutos restantes');
            console.log('');
            console.log('ðŸ’¡ Tip: El contador se reinicia automÃ¡ticamente con cualquier actividad');
        }

        // Exponer funciÃ³n de ayuda del contador
        window.helpSessionCounter = helpSessionCounter;

        // FunciÃ³n para verificar que el sistema estÃ© funcionando correctamente
        function verifySystemStatus() {
            console.log('ðŸ” === VERIFICACIÃ“N DEL SISTEMA ===');
            console.log('');

            // Verificar elementos principales
            const elements = {
                'QR Modal': document.getElementById('qr-modal'),
                'Scan QR Button': document.getElementById('scan-qr-btn'),
                'Session Counter': document.getElementById('session-counter'),
                'Messages Area': document.getElementById('messages-area'),
                'Main Container': document.getElementById('main-container')
            };

            console.log('ðŸ“Š Elementos del DOM:');
            Object.entries(elements).forEach(([name, element]) => {
                const exists = !!element;
                const visible = element ? !element.classList.contains('hidden') : false;
                console.log(`   ${exists ? 'âœ…' : 'âŒ'} ${name}: ${exists ? (visible ? 'Visible' : 'Hidden') : 'No encontrado'}`);
            });

            console.log('');
            console.log('âš™ï¸ Estado de la aplicaciÃ³n:');
            console.log(`   - Token: ${token || 'No definido'}`);
            console.log(`   - Usuario actual: ${currentUser ? currentUser.username : 'No definido'}`);
            console.log(`   - Chat actual: ${currentChatId || 'Ninguno'}`);
            console.log(`   - WhatsApp conectado: ${isConnected}`);
            console.log(`   - Contador de sesiÃ³n activo: ${!!sessionTimer}`);

            console.log('');
            console.log('ðŸ› ï¸ Funciones disponibles:');
            console.log('   - helpSessionCounter(): Ayuda del contador de sesiÃ³n');
            console.log('   - getSessionStatus(): Estado actual de la sesiÃ³n');
            console.log('   - debugQRModal(): Debug del modal QR');
            console.log('   - diagnoseQRModal(): DiagnÃ³stico completo');

            return {
                elements: Object.fromEntries(Object.entries(elements).map(([k, v]) => [k, !!v])),
                session: {
                    id: token,
                    user: currentUser?.username,
                    connected: isConnected,
                    counterActive: !!sessionTimer
                }
            };
        }

        // Exponer funciÃ³n de verificaciÃ³n del sistema
        window.verifySystemStatus = verifySystemStatus;

        // FunciÃ³n de ayuda para verificar que el sistema estÃ¡ funcionando correctamente
        function helpSystemStatus() {
            console.log('ðŸ” === ESTADO DEL SISTEMA ===');
            console.log('');
            console.log('âœ… Sistema con preservaciÃ³n completa de audio:');
            console.log('   - ActualizaciÃ³n de chat: Simple y directa');
            console.log('   - ReproducciÃ³n de audio: NO se interrumpe, se reanuda automÃ¡ticamente');
            console.log('   - PreservaciÃ³n de audio: âœ… ACTIVA con reanudaciÃ³n automÃ¡tica');
            console.log('   - Manejo de errores de audio: Detecta y muestra mensajes informativos');
            console.log('   - Scroll: AutomÃ¡tico al final');
            console.log('   - Sin polling inteligente');
            console.log('');
            console.log('âœ… Funcionalidades activas:');
            console.log('   - Contador de sesiÃ³n: âœ… Activo');
            console.log('   - BotÃ³n escanear QR: âœ… Activo');
            console.log('   - Modal QR: âœ… Funcional');
            console.log('   - ActualizaciÃ³n de mensajes: âœ… Simple');
            console.log('   - ðŸŽµ PreservaciÃ³n de audio: âœ… ACTIVA');
            console.log('   - ðŸŽµ Manejo de errores de audio: âœ… Activo');
            console.log('');
            console.log('ðŸ› ï¸ Comandos de verificaciÃ³n:');
            console.log('   - verifySystemStatus(): Verificar elementos del DOM');
            console.log('   - helpSessionCounter(): Ayuda del contador');
            console.log('   - getSessionStatus(): Estado de la sesiÃ³n');
            console.log('   - helpAudioProblem(): Ayuda del sistema de audio');
            console.log('   - debugAudioElements(): Ver estado de audios');
            console.log('   - quickAudioCheck(): VerificaciÃ³n rÃ¡pida de audio');
            console.log('   - testAudioPreservation(): Probar preservaciÃ³n de audio');
            console.log('');
            console.log('ðŸŽ¯ Estado actual:');
            const status = verifySystemStatus();
            console.log('   - Elementos del DOM:', Object.values(status.elements).filter(Boolean).length + '/' + Object.keys(status.elements).length, 'OK');
            console.log('   - SesiÃ³n activa:', status.session.id ? 'âœ…' : 'âŒ');
            console.log('   - Contador activo:', status.session.counterActive ? 'âœ…' : 'âŒ');
        }

        // Exponer funciÃ³n de ayuda del sistema
        window.helpSystemStatus = helpSystemStatus;

        // FunciÃ³n para probar la preservaciÃ³n de audio durante actualizaciones
        function testAudioPreservation() {
            console.log('ðŸŽµ === TESTING AUDIO PRESERVATION ===');

            // Simular que hay un audio reproduciÃ©ndose
            const audioElements = document.querySelectorAll('audio');
            if (audioElements.length === 0) {
                console.log('â„¹ï¸ No se encontraron elementos de audio para probar');
                console.log('ðŸ’¡ Reproduce un audio en el chat y luego ejecuta esta funciÃ³n');
                return;
            }

            console.log(`ðŸŽ§ Encontrados ${audioElements.length} elementos de audio`);

            // Guardar estados actuales
            console.log('1. Guardando estados de audio...');
            const savedStates = saveAudioStates();
            console.log(`   Estados guardados: ${savedStates.size}`);

            // Simular una actualizaciÃ³n del chat
            setTimeout(() => {
                console.log('2. Simulando actualizaciÃ³n del chat...');
                // Recrear el contenido del messagesArea
                const messagesArea = document.getElementById('messages-area');
                const currentContent = messagesArea.innerHTML;
                messagesArea.innerHTML = currentContent; // Recrear mismo contenido

                // Restaurar estados
                setTimeout(() => {
                    console.log('3. Restaurando estados de audio...');
                    restoreAudioStates(savedStates);

                    setTimeout(() => {
                        console.log('âœ… Test de preservaciÃ³n completado');
                        console.log('ðŸŽµ Los audios deberÃ­an mantener su posiciÃ³n sin interrumpirse');
                    }, 200);
                }, 100);
            }, 500);
        }

        // FunciÃ³n para ver el estado actual de todos los audios
        function debugAudioElements() {
            console.log('ðŸ”Š === AUDIO ELEMENTS DEBUG ===');

            const audioElements = document.querySelectorAll('audio');
            console.log(`Total audio elements: ${audioElements.length}`);

            audioElements.forEach((audio, index) => {
                const messageElement = audio.closest('.message');
                const messageId = messageElement?.dataset.messageId || `audio-${index}`;

                console.log(`ðŸŽµ Audio ${index + 1}:`);
                console.log(`   ID: ${messageId}`);
                console.log(`   Src: ${audio.src || 'No source'}`);
                console.log(`   Current time: ${audio.currentTime.toFixed(2)}s`);
                console.log(`   Duration: ${audio.duration.toFixed(2)}s`);
                console.log(`   Is playing: ${!audio.paused}`);
                console.log(`   Volume: ${audio.volume}`);
                console.log(`   Muted: ${audio.muted}`);
                console.log(`   Ready state: ${audio.readyState}`);
                console.log('');
            });

            if (audioElements.length === 0) {
                console.log('â„¹ï¸ No hay elementos de audio en el chat actual');
            }
        }

        // FunciÃ³n de ayuda especÃ­fica para el problema de audio
        function helpAudioProblem() {
            console.log('ðŸŽµ === AYUDA: PROBLEMA DE AUDIO ===');
            console.log('');
            console.log('ðŸ“ Problema: Los audios se cortan durante actualizaciones del chat');
            console.log('');
            console.log('âœ… Estado actual:');
            console.log('   - Sistema de preservaciÃ³n de audio: âœ… ACTIVO');
            console.log('   - Los audios YA NO se interrumpen durante actualizaciones del chat');
            console.log('   - ReanudaciÃ³n automÃ¡tica: âœ… ACTIVA para audios que estaban reproduciÃ©ndose');
            console.log('   - Manejo de errores de audio: âœ… ACTIVO');
            console.log('   - Mensajes informativos para formatos no soportados');
            console.log('');
            console.log('ðŸ› ï¸ Funciones de debugging:');
            console.log('   - debugAudioElements(): Ver estado de todos los audios');
            console.log('   - quickAudioCheck(): VerificaciÃ³n rÃ¡pida');
            console.log('   - testAudioErrors(): Probar manejo de errores');
            console.log('   - checkAudioFormatSupport(): Verificar formatos soportados');
            console.log('');
            console.log('âš™ï¸ Comportamiento actual:');
            console.log('   1. ðŸ’¾ Guardar estado de audios que estÃ¡n reproduciÃ©ndose');
            console.log('   2. ðŸ”„ Actualizar contenido del chat');
            console.log('   3. âœ… Restaurar posiciÃ³n y configuraciÃ³n de audios');
            console.log('   4. â–¶ï¸ Los audios que estaban reproduciÃ©ndose se reanudan AUTOMÃTICAMENTE');
            console.log('   5. âš ï¸ Si hay error, se muestra mensaje informativo');
            console.log('');
            console.log('ðŸ’¡ SituaciÃ³n actual:');
            console.log('   - Los audios YA NO se interrumpen durante actualizaciones');
            console.log('   - Se preserva la posiciÃ³n exacta de reproducciÃ³n');
            console.log('   - Se mantiene volumen, velocidad y configuraciÃ³n');
            console.log('   - Los audios que estaban reproduciÃ©ndose CONTINUAN reproduciÃ©ndose');
            console.log('   - Sin intervenciÃ³n manual del usuario');
            console.log('');
            console.log('ðŸŽ¯ Mejoras implementadas:');
            console.log('   - Sistema completo de preservaciÃ³n de audio');
            console.log('   - ReanudaciÃ³n automÃ¡tica de reproducciÃ³n');
            console.log('   - Mensajes informativos para formatos no soportados');
            console.log('   - DetecciÃ³n automÃ¡tica de errores de audio');
            console.log('   - InformaciÃ³n detallada sobre el tipo de error');
            console.log('   - Recomendaciones para navegadores modernos');
            console.log('   - IDs Ãºnicos para mejor tracking de elementos');
        }

        // Exponer funciones de debugging de audio
        window.debugAudioElements = debugAudioElements;
        window.helpAudioProblem = helpAudioProblem;

        // FunciÃ³n rÃ¡pida para verificar que el audio funciona correctamente
        function quickAudioCheck() {
            console.log('ðŸŽµ === QUICK AUDIO CHECK ===');

            const audioElements = document.querySelectorAll('audio');
            const hasPlayingAudio = Array.from(audioElements).some(audio => !audio.paused);

            console.log(`ðŸ“Š Audio elements found: ${audioElements.length}`);
            console.log(`â–¶ï¸  Audio currently playing: ${hasPlayingAudio ? 'YES' : 'NO'}`);

            if (hasPlayingAudio) {
                console.log('âœ… Audio is playing and will continue playing during chat updates');
                console.log('ðŸ’¡ Test: Send a message while audio is playing to verify automatic continuation');
            } else {
                console.log('â„¹ï¸ No audio is currently playing');
                console.log('ðŸ’¡ Test: Play an audio and then send a message to verify automatic continuation');
            }

            // Mostrar informaciÃ³n adicional
            if (audioElements.length > 0) {
                console.log('ðŸ”§ Audio optimization applied:');
                console.log('   - preload="none" to prevent auto-downloads');
                console.log('   - controls added for better UX');
                console.log('   - âœ… STATE PRESERVATION during chat updates');
                console.log('   - ðŸŽµ Audio playback will continue automatically');
                console.log('   - â–¶ï¸ No user interaction required');
            }

            return {
                audioCount: audioElements.length,
                hasPlayingAudio: hasPlayingAudio,
                optimizationActive: audioElements.length > 0
            };
        }



        // FunciÃ³n para probar errores de audio especÃ­ficamente
        function testAudioErrors() {
            console.log('ðŸ§ª === TESTING AUDIO ERRORS ===');

            const audioElements = document.querySelectorAll('audio');
            console.log(`ðŸŽµ Found ${audioElements.length} audio elements`);

            if (audioElements.length === 0) {
                console.log('â„¹ï¸ No audio elements found. Try sending an audio message first.');
                return;
            }

            // Forzar un error en el primer elemento de audio para probar
            const testAudio = audioElements[0];
            console.log('ðŸ”§ Testing audio error handling...');

            // Crear un elemento de audio con una URL invÃ¡lida para forzar error
            const errorAudio = document.createElement('audio');
            errorAudio.src = 'invalid-audio-url.ogg';
            errorAudio.controls = true;
            errorAudio.preload = 'none';

            // Agregar el contenedor con mensaje de error
            const container = document.createElement('div');
            container.className = 'audio-container';
            container.innerHTML = `
                ${errorAudio.outerHTML}
                <div class="audio-error-message" style="
                    color: #666;
                    font-size: 12px;
                    margin-top: 8px;
                    padding: 8px;
                    background: #f8f9fa;
                    border-radius: 4px;
                    border: 1px solid #dee2e6;
                    display: none;
                ">
                    <strong>âš ï¸ Tu navegador no soporta el elemento de audio.</strong><br>
                    <span style="font-size: 11px;">Formato: audio/ogg - Intenta usar un navegador actualizado como Chrome, Firefox o Edge.</span>
                </div>
            `;

            // Agregar al DOM para probar
            testAudio.parentElement.appendChild(container);

            // Forzar el error
            errorAudio.addEventListener('error', function() {
                console.log('âœ… Audio error handling triggered successfully!');
                console.log('ðŸŽ¯ Error message should be visible now');
            });

            console.log('ðŸ”„ Test completed - check if error message appears');
        }

        // FunciÃ³n para verificar soporte de formatos de audio
        function checkAudioFormatSupport() {
            console.log('ðŸ” === AUDIO FORMAT SUPPORT CHECK ===');

            const audio = document.createElement('audio');
            const formats = [
                { format: 'audio/ogg', ext: 'ogg', name: 'OGG' },
                { format: 'audio/mp3', ext: 'mp3', name: 'MP3' },
                { format: 'audio/wav', ext: 'wav', name: 'WAV' },
                { format: 'audio/mpeg', ext: 'mp3', name: 'MPEG' },
                { format: 'audio/ogg; codecs="vorbis"', ext: 'ogg', name: 'OGG Vorbis' }
            ];

            formats.forEach(format => {
                const support = audio.canPlayType(format.format);
                const supportText = support === 'probably' ? 'âœ… Soportado' :
                                   support === 'maybe' ? 'âš ï¸ Posiblemente soportado' :
                                   'âŒ No soportado';
                console.log(`${supportText} - ${format.name} (${format.format})`);
            });

            console.log('');
            console.log('ðŸ’¡ Recomendaciones:');
            console.log('   - Si OGG no funciona, considera usar MP3 o WAV');
            console.log('   - Usa navegadores modernos para mejor soporte');
        }

        // FunciÃ³n para probar especÃ­ficamente la preservaciÃ³n de audio
        function testAudioPreservation() {
            console.log('ðŸ§ª === TESTING AUDIO PRESERVATION ===');

            const audioElements = document.querySelectorAll('audio');
            const playingAudios = Array.from(audioElements).filter(audio => !audio.paused);

            if (playingAudios.length === 0) {
                console.log('â„¹ï¸ No hay audios reproduciÃ©ndose actualmente');
                console.log('ðŸ’¡ Reproduce un audio primero y luego ejecuta esta funciÃ³n');
                return;
            }

            console.log(`ðŸŽµ Audios reproduciÃ©ndose: ${playingAudios.length}`);
            console.log('ðŸ”„ Simulando actualizaciÃ³n del chat...');

            // Guardar estados actuales
            const savedStates = saveAudioStates();
            console.log(`ðŸ’¾ Estados guardados: ${savedStates.size}`);

            // Simular recreaciÃ³n del contenido
            const messagesArea = document.getElementById('messages-area');
            const currentContent = messagesArea.innerHTML;

            setTimeout(() => {
                // Recrear contenido (esto es lo que harÃ­a displayMessages)
                messagesArea.innerHTML = currentContent;

                setTimeout(() => {
                    // Restaurar estados
                    restoreAudioStates(savedStates);

                    setTimeout(() => {
                        console.log('âœ… Test completado');
                        console.log('ðŸŽµ Los audios deberÃ­an mantener su posiciÃ³n y continuar reproduciÃ©ndose');
                        console.log('ðŸ’¡ Los audios que estaban reproduciÃ©ndose deberÃ­an continuar automÃ¡ticamente');

                        // Verificar que los audios se restauraron correctamente
                        const restoredAudios = document.querySelectorAll('audio');
                        restoredAudios.forEach((audio, index) => {
                            if (audio.currentTime > 0) {
                                const status = !audio.paused ? 'reproduciÃ©ndose' : 'pausado';
                                console.log(`âœ… Audio ${index + 1}: PosiciÃ³n restaurada a ${audio.currentTime.toFixed(2)}s - ${status}`);
                            }
                        });
                    }, 300);
                }, 150);
            }, 500);
        }

        // Exponer funciÃ³n de verificaciÃ³n rÃ¡pida
        window.quickAudioCheck = quickAudioCheck;
        window.testAudioErrors = testAudioErrors;
        window.checkAudioFormatSupport = checkAudioFormatSupport;
        window.testAudioPreservation = testAudioPreservation;

        // FunciÃ³n de emergencia para silenciar mensajes problemÃ¡ticos temporalmente
        function emergencySessionSilence() {
            console.log('ðŸš¨ === EMERGENCY SESSION SILENCE ACTIVATED ===');
            console.log('â° This will temporarily silence session-related notifications for 30 minutes');

            // Silenciar showNotification temporalmente
            const originalShowNotification = window.showNotification;
            window.showNotification = function(message, type) {
                // Solo permitir mensajes crÃ­ticos, bloquear los de sesiÃ³n
                if (message.toLowerCase().includes('sesiÃ³n') ||
                    message.toLowerCase().includes('session') ||
                    message.toLowerCase().includes('expirada') ||
                    message.toLowerCase().includes('expired') ||
                    message.toLowerCase().includes('activa') ||
                    message.toLowerCase().includes('active')) {

                    console.log('ðŸ”‡ Session notification blocked:', message);
                    return; // No mostrar la notificaciÃ³n
                }

                return originalShowNotification.apply(this, arguments);
            };

            // Intentar extender la sesiÃ³n inmediatamente
            if (token) {
                extendSession();
            }

            // Restaurar notificaciones despuÃ©s de 30 minutos
            setTimeout(() => {
                window.showNotification = originalShowNotification;
                console.log('ðŸ”„ Emergency silence ended - notifications restored');
                showNotification('Silencio de emergencia terminado', 'info');
            }, 30 * 60 * 1000); // 30 minutos

            console.log('âœ… Emergency session silence activated');
            console.log('ðŸ’¡ Use helpSessionProblem() for permanent solutions');
        }

        // Exponer funciÃ³n de emergencia
        window.emergencySessionSilence = emergencySessionSilence;

        // FunciÃ³n que muestra todas las herramientas disponibles
        function showAllSessionTools() {
            console.log('ðŸ› ï¸ === TODAS LAS HERRAMIENTAS DE SESIÃ“N ===');
            console.log('');
            console.log('ðŸ” DIAGNÃ“STICO:');
            console.log('  helpSessionProblem()       â† GuÃ­a completa de soluciÃ³n');
            console.log('  debugSessionMessage()      â† Interceptar mensajes de sesiÃ³n');
            console.log('  debugSessionRequests()     â† Ver peticiones HTTP');
            console.log('');
            console.log('ðŸ› ï¸ MANTENIMIENTO:');
            console.log('  extendSession()            â† Extender sesiÃ³n manualmente');
            console.log('  startSessionMaintenance()  â† Iniciar mantenimiento automÃ¡tico');
            console.log('');
            console.log('ðŸš¨ EMERGENCIA:');
            console.log('  emergencySessionSilence()  â† Silenciar mensajes 30 min');
            console.log('');
            console.log('ðŸ”§ GENERAL:');
            console.log('  forceConnectionCheck()     â† Verificar conexiÃ³n forzadamente');
            console.log('  diagnoseQRModal()          â† DiagnÃ³stico del sistema QR');
            console.log('');
            console.log('ðŸ’¡ CONSEJO: Comienza con helpSessionProblem() para una soluciÃ³n paso a paso');
        }

        // Exponer funciÃ³n que muestra todas las herramientas
        window.showAllSessionTools = showAllSessionTools;

        async function refreshQR() {
            try {
                // Actualizar indicador de estado a "generando"
                updateQRStatusIndicator('connecting', '<i class="fas fa-spinner fa-spin"></i> Generando nuevo cÃ³digo QR...');

                await fetch('/api/qr/refresh', { method: 'POST' });
                showNotification('Regenerando cÃ³digo QR...', 'info');

                // Verificar si WhatsApp estÃ¡ conectado antes de mostrar el QR
                setTimeout(async () => {
                    try {
                        const response = await fetch('/api/stats');
                        const data = await response.json();
                        const isWhatsAppReady = data.whatsappListo || data.connected || data.ready;

                        if (!isWhatsAppReady) {
                            // Actualizar indicador a "esperando conexiÃ³n"
                            updateQRStatusIndicator('connecting', '<i class="fas fa-spinner fa-spin"></i> Esperando conexiÃ³n de WhatsApp...');
                            showQRModal();
                        } else {
                            updateQRStatusIndicator('connected', '<i class="fas fa-check-circle"></i> WhatsApp ya estÃ¡ conectado');
                            showNotification('WhatsApp ya estÃ¡ conectado - QR no necesario', 'success');
                            setTimeout(() => hideQRModalManually(), 2000);
                        }
            } catch (error) {
                        console.error('Error checking connection in refreshQR:', error);
                        // En caso de error, mostrar QR como fallback
                        updateQRStatusIndicator('error', '<i class="fas fa-exclamation-triangle"></i> Error generando QR');
                        showQRModal();
                    }
                }, 3000);
            } catch (error) {
                updateQRStatusIndicator('error', '<i class="fas fa-exclamation-triangle"></i> Error regenerando QR');
                showNotification('Error regenerando QR', 'error');
            }
        }

        function setupFileHandling() {
            const attachBtn = document.getElementById('attach-btn');
            const fileInput = document.getElementById('file-input');
            const messageInputArea = document.getElementById('message-input-area');
            const dragOverlay = document.getElementById('drag-overlay');
            const clearFilesBtn = document.getElementById('clear-files-btn');

            if (attachBtn && fileInput) {
                attachBtn.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', (e) => {
                    handleFiles(Array.from(e.target.files));
                });
            }

            if (messageInputArea) {
                messageInputArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    messageInputArea.classList.add('drag-over');
                    if (dragOverlay) dragOverlay.style.display = 'flex';
                });

                messageInputArea.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (!messageInputArea.contains(e.relatedTarget)) {
                        messageInputArea.classList.remove('drag-over');
                        if (dragOverlay) dragOverlay.style.display = 'none';
                    }
                });

                messageInputArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    messageInputArea.classList.remove('drag-over');
                    if (dragOverlay) dragOverlay.style.display = 'none';

                    const files = Array.from(e.dataTransfer.files);
                    handleFiles(files);
                });
            }

            if (clearFilesBtn) {
                clearFilesBtn.addEventListener('click', clearFiles);
            }
        }

        function handleFiles(files) {
            const validFiles = files.filter(file => {
                if (file.size > 50 * 1024 * 1024) {
                    showNotification(`El archivo "${file.name}" es demasiado grande (mï¿½ximo 50MB)`, 'error');
                    return false;
                }
                return true;
            });

            selectedFiles = [...selectedFiles, ...validFiles];
            updateFilePreview();
            
            const previewArea = document.getElementById('file-preview-area');
            if (previewArea && selectedFiles.length > 0) {
                previewArea.style.display = 'block';
            }
        }

        function updateFilePreview() {
            const previewList = document.getElementById('file-preview-list');
            if (!previewList) return;

            previewList.innerHTML = '';

            selectedFiles.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'file-preview-item';
                
                if (file.type.startsWith('image/')) {
                    item.classList.add('image');
                    const img = document.createElement('img');
                    img.className = 'file-preview-image';
                    img.src = URL.createObjectURL(file);
                    item.appendChild(img);
                } else {
                    const icon = document.createElement('div');
                    icon.className = 'file-preview-icon';
                    icon.innerHTML = getFileIcon(file.type);
                    item.appendChild(icon);
                }

                const info = document.createElement('div');
                info.className = 'file-preview-info';
                
                const name = document.createElement('div');
                name.className = 'file-preview-name';
                name.textContent = file.name;
                name.title = file.name;
                
                const size = document.createElement('div');
                size.className = 'file-preview-size';
                size.textContent = formatFileSize(file.size);
                
                info.appendChild(name);
                info.appendChild(size);
                item.appendChild(info);

                const removeBtn = document.createElement('button');
                removeBtn.className = 'file-preview-remove';
                removeBtn.innerHTML = 'ï¿½';
                removeBtn.onclick = () => removeFile(index);
                item.appendChild(removeBtn);

                previewList.appendChild(item);
            });
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFilePreview();
            
            if (selectedFiles.length === 0) {
                const previewArea = document.getElementById('file-preview-area');
                if (previewArea) previewArea.style.display = 'none';
            }
        }

        function clearFiles() {
            selectedFiles = [];
            updateFilePreview();
            const previewArea = document.getElementById('file-preview-area');
            if (previewArea) previewArea.style.display = 'none';
        }

        function getFileIcon(mimeType) {
            if (mimeType.startsWith('image/')) return '<i class="fas fa-image"></i>';
            if (mimeType.startsWith('video/')) return '<i class="fas fa-video"></i>';
            if (mimeType.startsWith('audio/')) return '<i class="fas fa-music"></i>';
            if (mimeType.includes('pdf')) return '<i class="fas fa-file-pdf"></i>';
            if (mimeType.includes('word') || mimeType.includes('document')) return '<i class="fas fa-file-word"></i>';
            if (mimeType.includes('zip') || mimeType.includes('rar')) return '<i class="fas fa-file-archive"></i>';
            return '<i class="fas fa-file"></i>';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Variables para optimizar las actualizaciones de mensajes
        let lastMessagesHash = '';
        let messagePollingInterval = null;
        let pendingWebMessages = new Map(); // Cache de mensajes enviados desde web que aÃºn no estÃ¡n en el servidor
        let userIsScrolling = false; // Detectar si el usuario estÃ¡ navegando
        let scrollTimeout = null;

        function startSmartMessagePolling() {
            if (messagePollingInterval) {
                clearInterval(messagePollingInterval);
            }

            // Auto-refresco cada 5 segundos cuando hay un chat abierto (reducido para mejor UX)
            messagePollingInterval = setInterval(() => {
                if (currentChatId && !userIsScrolling && !isLoadingHistory) {
                    const messagesArea = document.getElementById('messages-area');

                    // Verificar si el usuario estÃ¡ viendo mensajes antiguos (no estÃ¡ al final)
                    const isNearBottom = messagesArea ?
                        (messagesArea.scrollHeight - messagesArea.scrollTop - messagesArea.clientHeight) < 200 : true;

                    // Solo hacer polling si el usuario estÃ¡ cerca del final
                    // Si estÃ¡ viendo historial antiguo, NO actualizar para no interrumpir
                    if (isNearBottom) {
                        // Refresco silencioso sin forzar para preservar scroll
                        loadMessagesSmart(currentChatId, false, true); // false = no forzar, true = silencioso
                    } else {
                        console.log('â¸ï¸ [POLLING] Usuario viendo historial - polling pausado');
                    }
                }
            }, 5000); // Cada 5 segundos

            console.log('ðŸ”„ [POLLING] Auto-refresco activado cada 5 segundos para chat abierto');
        }

        function stopSmartMessagePolling() {
            if (messagePollingInterval) {
                clearInterval(messagePollingInterval);
                messagePollingInterval = null;
                console.log('â¹ï¸ [POLLING] Auto-refresco detenido');
            }
        }

        // Configurar detecciÃ³n de scroll para pausar actualizaciones durante navegaciÃ³n
        function setupScrollDetection() {
            const messagesArea = document.getElementById('messages-area');
            if (!messagesArea) return;

            // Remover listeners anteriores si existen
            messagesArea.removeEventListener('scroll', handleScroll);
            messagesArea.removeEventListener('wheel', handleScroll);
            messagesArea.removeEventListener('touchstart', handleScroll);
            messagesArea.removeEventListener('touchmove', handleScroll);

            // Agregar listeners para detectar navegaciÃ³n
            messagesArea.addEventListener('scroll', handleScroll, { passive: true });
            messagesArea.addEventListener('wheel', handleScroll, { passive: true });
            messagesArea.addEventListener('touchstart', handleScroll, { passive: true });
            messagesArea.addEventListener('touchmove', handleScroll, { passive: true });
        }

        function handleScroll() {
            userIsScrolling = true;

            // Limpiar timeout anterior
            if (scrollTimeout) {
                clearTimeout(scrollTimeout);
            }

            // DespuÃ©s de 3 segundos sin scroll, reanudar actualizaciones
            scrollTimeout = setTimeout(() => {
                userIsScrolling = false;
            }, 3000);
        }

        // Combinar mensajes del servidor con mensajes web pendientes
        function combineMessagesWithPending(serverMessages, chatId) {
            const pendingMessages = pendingWebMessages.get(chatId) || [];

            if (pendingMessages.length === 0) {
                return serverMessages;
            }

            // Crear una copia de los mensajes del servidor
            const combined = [...serverMessages];

            // Agregar mensajes pendientes que no estÃ©n ya en el servidor
            pendingMessages.forEach(pendingMsg => {
                const existsInServer = serverMessages.some(serverMsg =>
                    Math.abs(serverMsg.timestamp - pendingMsg.timestamp) < 5000 && // 5 segundos de tolerancia
                    serverMsg.body === pendingMsg.body &&
                    serverMsg.fromMe === pendingMsg.fromMe
                );

                if (!existsInServer) {
                    combined.push(pendingMsg);
                }
            });

            // Ordenar por timestamp
            return combined.sort((a, b) => a.timestamp - b.timestamp);
        }

        // Limpiar mensajes web que ya han sido sincronizados al servidor
        function cleanupSyncedWebMessages(serverMessages, chatId) {
            const pendingMessages = pendingWebMessages.get(chatId) || [];

            if (pendingMessages.length === 0) {
                return;
            }

            // Filtrar mensajes que ya no estÃ¡n pendientes
            const stillPending = pendingMessages.filter(pendingMsg => {
                const existsInServer = serverMessages.some(serverMsg =>
                    Math.abs(serverMsg.timestamp - pendingMsg.timestamp) < 10000 && // 10 segundos de tolerancia
                    serverMsg.body === pendingMsg.body &&
                    serverMsg.fromMe === pendingMsg.fromMe
                );
                return !existsInServer;
            });

            // Actualizar el cache
            if (stillPending.length === 0) {
                pendingWebMessages.delete(chatId);
            } else {
                pendingWebMessages.set(chatId, stillPending);
            }

            console.log(`ðŸ§¹ [CLEANUP] Chat ${chatId}: ${pendingMessages.length - stillPending.length} mensajes sincronizados, ${stillPending.length} aÃºn pendientes`);
        }

        // FunciÃ³n para cargar mÃ¡s mensajes (historial antiguo)
        async function loadMoreMessages() {
            if (isLoadingHistory || !currentChatId || !hasMoreMessages) {
                console.log('ðŸš« No se puede cargar historial:', { isLoadingHistory, currentChatId, hasMoreMessages });
                return;
            }

            isLoadingHistory = true;
            const btn = document.getElementById('load-history-btn');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cargando...';
            }

            try {
                console.log(`ðŸ“œ Cargando mÃ¡s mensajes antiguos (offset: ${currentMessageOffset})...`);
                await loadMessagesSmart(currentChatId, false, false, currentMessageOffset, true);

            } catch (error) {
                console.error('Error cargando historial:', error);
                showNotification('Error cargando historial', 'error');
            } finally {
                // Restaurar flag ANTES de restaurar el botÃ³n
                isLoadingHistory = false;

                // Esperar un momento para que displayMessages termine completamente
                await new Promise(resolve => setTimeout(resolve, 150));

                // Ahora sÃ­ restaurar el botÃ³n con el estado correcto
                const finalBtn = document.getElementById('load-history-btn');
                if (finalBtn) {
                    if (hasMoreMessages) {
                        finalBtn.disabled = false;
                        finalBtn.innerHTML = `<i class="fas fa-history"></i> Cargar mensajes mÃ¡s antiguos (${totalMessagesInDB - currentMessageOffset} restantes)`;
                        // Re-asignar el onclick explÃ­citamente por si se perdiÃ³
                        finalBtn.onclick = loadMoreMessages;
                        console.log('âœ… BotÃ³n restaurado correctamente con onclick');
                    } else {
                        // Si no hay mÃ¡s mensajes, ocultar el botÃ³n
                        finalBtn.remove();
                        console.log('ðŸš« No hay mÃ¡s mensajes, botÃ³n eliminado');
                    }
                }
            }
        }

        // Lock para evitar llamadas simultÃ¡neas a loadMessagesSmart
        const loadMessagesLocks = new Map();

        // FunciÃ³n inteligente para cargar mensajes solo cuando sea necesario
        async function loadMessagesSmart(chatId, forceReload = false, silent = false, offset = 0, append = false) {
            // Prevenir llamadas simultÃ¡neas al mismo chat
            const lockKey = `${chatId}-${offset}`;
            if (loadMessagesLocks.has(lockKey)) {
                console.log(`â³ [LOCK] Ya hay una carga en progreso para ${chatId} (offset: ${offset}), ignorando llamada duplicada`);
                return;
            }

            loadMessagesLocks.set(lockKey, true);
            let loadingIndicator = null;

            try {
                if (!silent) {
                    console.log(`ðŸ” Verificando mensajes para chat ${chatId}${forceReload ? ' (recarga forzada)' : ''}${offset > 0 ? ` (offset: ${offset})` : ''}${append ? ' [MODO APPEND]' : ''}...`);
                }

                // Mostrar indicador de carga solo para recarga forzada y no silenciosa
                if (forceReload && !silent && !append) {
                    loadingIndicator = showHistoryLoadingIndicator();
                }

                // *** SOLUCION: Siempre usar endpoint de messages que devuelve metadata de paginaciÃ³n ***
                let response;
                let url;

                // Siempre usar el endpoint estÃ¡ndar que carga desde BD con metadata de paginaciÃ³n
                url = `/api/chats/${chatId}/messages?offset=${offset}&limit=50`;
                if (!silent) console.log(`ðŸ”„ [LOAD MESSAGES] Cargando desde BD con paginaciÃ³n (offset: ${offset}): ${url}`);

                response = await fetch(url);
                let data;

                if (!response.ok) {
                    console.warn(`âš ï¸ Endpoint primario fallÃ³ (${response.status}), intentando endpoint alternativo...`);
                    // Si el endpoint de historial falla, intentar el estÃ¡ndar
                    const fallbackUrl = `/api/chats/${chatId}/messages`;
                    console.log(`ðŸ”„ [FALLBACK] Intentando endpoint alternativo: ${fallbackUrl}`);
                    response = await fetch(fallbackUrl);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status} en ambos endpoints`);
                    }
                    data = await response.json();
                } else {
                    data = await response.json();
                    if (!silent) console.log(`âœ… [API SUCCESS] Respuesta exitosa desde: ${data.source || 'unknown'} source`);
                }

                if (!silent) {
                    console.log(`ðŸ“¡ Respuesta API: ${data.messages?.length || 0} mensajes recibidos para chat ${chatId}`);
                    console.log(`ðŸ“Š [API DETAILS] Total: ${data.total || 0}, Source: ${data.source || 'unknown'}, Timestamp: ${data.timestamp}`);
                }

                if (data.success && data.messages) {
                    // Asegurar que tenemos todos los mensajes histÃ³ricos
                    const allMessages = Array.isArray(data.messages) ? data.messages : [];
                    
                    // Log adicional para debugging de historial
                    if (forceReload && allMessages.length > 0 && !silent) {
                        console.log(`ðŸ“š [HISTORIAL COMPLETO] Cargados ${allMessages.length} mensajes desde ${data.source}`);
                        console.log(`   ðŸ“… Rango temporal: ${new Date(allMessages[0]?.timestamp).toLocaleString()} â†’ ${new Date(allMessages[allMessages.length - 1]?.timestamp).toLocaleString()}`);
                        console.log(`   ðŸ“Š DistribuciÃ³n: ${allMessages.filter(m => m.fromMe).length} enviados, ${allMessages.filter(m => !m.fromMe).length} recibidos`);

                        // Mostrar algunos tipos de mensaje
                        const messageTypes = {};
                        allMessages.forEach(msg => {
                            messageTypes[msg.type || 'text'] = (messageTypes[msg.type || 'text'] || 0) + 1;
                        });
                        console.log(`   ðŸ” Tipos de mensaje:`, messageTypes);
                    }
                    
                    // Crear hash mÃ¡s robusto incluyendo todos los mensajes
                    const messagesHash = allMessages.map(msg => {
                        const id = msg.id || msg.messageId || msg.timestamp || Date.now();
                        const body = (msg.body || msg.content || '').substring(0, 100);
                        const fromMe = msg.fromMe || false;
                        const status = msg.status || 'unknown';
                        const timestamp = msg.timestamp || 0;
                        return `${id}-${fromMe}-${body}-${status}-${timestamp}`;
                    }).join('|');

                    if (!silent) {
                        console.log(`ðŸ” Hash actual: ${messagesHash.substring(0, 50)}...`);
                        console.log(`ðŸ” Hash anterior: ${lastMessagesHash ? lastMessagesHash.substring(0, 50) + '...' : 'VACÃO'}`);
                    }

                    // Actualizar solo si hay cambios reales (en modo silencioso no forzar actualizaciÃ³n innecesaria)
                    const hasRealChanges = messagesHash !== lastMessagesHash;
                    const shouldUpdate = hasRealChanges || forceReload;

                    // En modo silencioso, solo actualizar si hay cambios reales para preservar scroll
                    if (shouldUpdate && (!silent || hasRealChanges)) {
                        if (!silent) {
                            if (forceReload) {
                                console.log('ðŸ”„ RECARGA FORZADA - Actualizando todos los mensajes');
                            } else {
                                console.log('ðŸ“ Â¡NUEVOS MENSAJES DETECTADOS! - Actualizando chat en tiempo real');
                            }
                        }

                        // Actualizar el panel de chats para mostrar el Ãºltimo mensaje (solo si no es silencioso)
                        if (!silent && !forceReload) {
                            setTimeout(() => loadChats(), 500);
                        }
                        
                        lastMessagesHash = messagesHash;
                        
                        // *** SOLUCION: Combinar mensajes del servidor con mensajes web pendientes ***
                        const combinedMessages = combineMessagesWithPending(allMessages, chatId);

                        // Para recarga forzada (al seleccionar chat), NO preservar scroll - ir al final
                        // Para actualizaciones periÃ³dicas, SÃ preservar scroll
                        const preserveScroll = !forceReload && combinedMessages.length > 0;

                        // Preparar metadata de paginaciÃ³n
                        const metadata = {
                            hasMore: data.hasMore || false,
                            totalInDB: data.totalInDB || 0,
                            offset: data.offset || 0
                        };

                        displayMessages(combinedMessages, preserveScroll, silent, false, append, metadata);

                        // Limpiar mensajes web que ya aparecen en el servidor
                        cleanupSyncedWebMessages(allMessages, chatId);
                        
                        // *** CACHE: Guardar mensajes en cachÃ© si es la primera carga completa ***
                        if (forceReload && allMessages.length > 0 && !loadedChatsCache.has(chatId)) {
                            // Limitar cachÃ© a mÃ¡ximo 50 mensajes (los mÃ¡s recientes) para carga rÃ¡pida
                            const limitedMessages = allMessages.length > 50 ? allMessages.slice(-50) : allMessages;
                            chatMessagesCache.set(chatId, [...limitedMessages]); // Copia profunda
                            loadedChatsCache.add(chatId);
                            console.log(`ðŸ’¾ Chat ${chatId} agregado al cachÃ© con ${limitedMessages.length} mensajes (lÃ­mite: 50)`);
                        } else if (forceReload && allMessages.length > 0 && loadedChatsCache.has(chatId)) {
                            // Actualizar cachÃ© existente con nuevos mensajes si los hay
                            const cachedMessages = chatMessagesCache.get(chatId) || [];
                            const newMessages = allMessages.filter(newMsg => 
                                !cachedMessages.some(cachedMsg => 
                                    cachedMsg.id === newMsg.id || 
                                    (Math.abs(cachedMsg.timestamp - newMsg.timestamp) < 1000 && 
                                     cachedMsg.body === newMsg.body && 
                                     cachedMsg.fromMe === newMsg.fromMe)
                                )
                            );
                            
                            if (newMessages.length > 0) {
                                const updatedMessages = [...cachedMessages, ...newMessages].sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
                                // Limitar a mÃ¡ximo 50 mensajes (los mÃ¡s recientes) para carga rÃ¡pida
                                const limitedUpdatedMessages = updatedMessages.length > 50 ? updatedMessages.slice(-50) : updatedMessages;
                                chatMessagesCache.set(chatId, limitedUpdatedMessages);
                                console.log(`ðŸ’¾ CachÃ© actualizado para chat ${chatId}: +${newMessages.length} mensajes nuevos (lÃ­mite: 50)`);
                            }
                        } else if (!forceReload && allMessages.length > 0 && loadedChatsCache.has(chatId)) {
                            // ActualizaciÃ³n periÃ³dica: solo agregar mensajes nuevos al cachÃ©
                            const cachedMessages = chatMessagesCache.get(chatId) || [];
                            const newMessages = allMessages.filter(newMsg => 
                                !cachedMessages.some(cachedMsg => 
                                    cachedMsg.id === newMsg.id || 
                                    (Math.abs(cachedMsg.timestamp - newMsg.timestamp) < 1000 && 
                                     cachedMsg.body === newMsg.body && 
                                     cachedMsg.fromMe === newMsg.fromMe)
                                )
                            );
                            
                            if (newMessages.length > 0) {
                                const updatedMessages = [...cachedMessages, ...newMessages].sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
                                // Limitar a mÃ¡ximo 50 mensajes (los mÃ¡s recientes) para carga rÃ¡pida
                                const limitedUpdatedMessages = updatedMessages.length > 50 ? updatedMessages.slice(-50) : updatedMessages;
                                chatMessagesCache.set(chatId, limitedUpdatedMessages);
                                console.log(`ðŸ’¾ CachÃ© actualizado (polling) para chat ${chatId}: +${newMessages.length} mensajes nuevos (lÃ­mite: 50)`);
                            }
                        }
                        
                        // Si es recarga forzada, mostrar notificaciÃ³n de historial cargado (solo una vez por chat)
                        if (forceReload && allMessages.length > 0 && !notificationShownChats.has(chatId)) {
                            notificationShownChats.add(chatId);
                            setTimeout(() => {
                                showHistoryLoadedNotification(allMessages.length);
                            }, 500);
                            console.log(`ðŸ”” NotificaciÃ³n de mensajes cargados mostrada para chat ${chatId} (primera vez)`);
                        } else if (forceReload && allMessages.length > 0 && notificationShownChats.has(chatId)) {
                            console.log(`â¸ï¸ NotificaciÃ³n de mensajes cargados omitida para chat ${chatId} (ya se mostrÃ³ antes)`);
                        }

                        // Actualizar contador de mensajes no leÃ­dos si hay nuevos mensajes
                        const chat = chats.get(chatId);
                        if (chat && allMessages.length > 0) {
                            // Buscar mensajes no leÃ­dos del remitente
                            const unreadMessages = allMessages.filter(msg => 
                                !msg.fromMe && 
                                (msg.isRead === false || !msg.hasOwnProperty('isRead'))
                            );
                            
                            if (unreadMessages.length > 0) {
                                console.log(`ðŸ”„ ${unreadMessages.length} mensajes no leÃ­dos detectados - actualizando contador`);
                                loadChats();
                            }
                        }

                        // Hacer scroll inteligente - SOLO si NO es modo append
                        if (!append) {
                            setTimeout(() => {
                                const messagesArea = document.getElementById('messages-area');
                                if (messagesArea) {
                                    if (forceReload || !preserveScroll) {
                                        // Scroll suave al final para carga inicial o recarga forzada
                                        messagesArea.scrollTo({
                                            top: messagesArea.scrollHeight,
                                            behavior: 'smooth'
                                        });
                                        console.log('ðŸ“± Scroll al final del historial completo');
                                    }
                                }
                            }, 150);
                        } else {
                            console.log('â¸ï¸ Modo append - NO hacer scroll automÃ¡tico');
                        }

                        // Log del historial cargado
                        if (allMessages.length > 0) {
                            const sortedMessages = [...allMessages].sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
                            const firstMsg = sortedMessages[0];
                            const lastMsg = sortedMessages[sortedMessages.length - 1];
                            
                            console.log(`âœ… Historial completo cargado para chat ${chatId}:`);
                            console.log(`   ðŸ“Š Total: ${allMessages.length} mensajes`);
                            console.log(`   ðŸ“… Rango: ${formatTime(firstMsg.timestamp)} - ${formatTime(lastMsg.timestamp)}`);
                            console.log(`   ðŸ“¤ Enviados: ${allMessages.filter(m => m.fromMe).length}`);
                            console.log(`   ðŸ“¥ Recibidos: ${allMessages.filter(m => !m.fromMe).length}`);
                        }

                    } else {
                        console.log('â¸ï¸ Mensajes sin cambios - saltando actualizaciÃ³n para preservar estado de audio/scroll');
                    }
                } else if (data.error) {
                    console.error('âŒ Error en respuesta de API:', data.error);
                    
                    // Si hay error, intentar endpoint de fallback
                    try {
                        console.log('ðŸ”„ Intentando endpoint de fallback...');
                        const fallbackResponse = await fetch(`/api/messages/${chatId}`);
                        if (fallbackResponse.ok) {
                            const fallbackData = await fallbackResponse.json();
                            if (fallbackData.messages) {
                                console.log(`ðŸ“¡ Endpoint fallback exitoso: ${fallbackData.messages.length} mensajes`);
                                displayMessages(fallbackData.messages, false, false); // No silencioso
                            }
                        }
                    } catch (fallbackError) {
                        console.error('âŒ TambiÃ©n fallÃ³ el endpoint de fallback:', fallbackError);
                    }
                } else {
                    console.warn('âš ï¸ Respuesta API sin Ã©xito o sin mensajes:', data);
                }
            } catch (error) {
                console.error('âŒ Error loading messages smart:', error);
                
                // Ocultar indicadores de carga si hay error
                if (loadingIndicator) {
                    hideHistoryLoadingIndicator();
                }
                hideLazyLoadingIndicator();
                
                // Estrategia de recuperaciÃ³n progresiva
                const retryDelay = forceReload ? 5000 : 3000;
                setTimeout(() => {
                    if (currentChatId === chatId) {
                        console.log(`ðŸ”„ Reintentando cargar mensajes despuÃ©s de error en ${retryDelay}ms...`);
                        loadMessagesSmart(chatId, false); // No forzar en reintentos
                    }
                }, retryDelay);
            } finally {
                // Liberar el lock
                loadMessagesLocks.delete(lockKey);

                // Asegurar que todos los indicadores de carga se oculten
                if (loadingIndicator) {
                    setTimeout(() => hideHistoryLoadingIndicator(), 500);
                }
                // TambiÃ©n ocultar el indicador lazy como seguridad
                setTimeout(() => hideLazyLoadingIndicator(), 600);
            }
        }

        let lastConnectionState = null;
        let qrCheckInterval = null;
        let chatsInterval = null;
        let connectionCheckInterval = null;

        // Inicializar WebSockets para comunicaciÃ³n en tiempo real
        function initWebSockets() {
            try {
                console.log('ðŸ”Œ [WEBSOCKET] Inicializando conexiÃ³n Socket.io...');

                // Conectar a Socket.io
                socketIO = io({
                    transports: ['websocket', 'polling'], // Preferir websocket, fallback a polling
                    reconnection: true,
                    reconnectionDelay: 1000,
                    reconnectionAttempts: 10
                });

                // Escuchar eventos
                socketIO.on('connect', () => {
                    console.log('âœ… [WEBSOCKET] Conectado al servidor');
                    useWebSockets = true;
                });

                socketIO.on('disconnect', () => {
                    console.log('âš ï¸ [WEBSOCKET] Desconectado del servidor');
                    useWebSockets = false;
                });

                socketIO.on('connection-status', (data) => {
                    console.log('ðŸ“¡ [WEBSOCKET] Estado de conexiÃ³n:', data);
                    isConnected = data.connected;
                });

                socketIO.on('chats-update', (data) => {
                    console.log('ðŸ“¡ [WEBSOCKET] ActualizaciÃ³n de chats recibida:', data.totalChats, 'chats');
                    if (data.success && data.chats) {
                        updateChatList(data.chats);
                    }
                });

                socketIO.on('reconnect', () => {
                    console.log('ðŸ”„ [WEBSOCKET] Reconectado - Solicitando actualizaciÃ³n');
                    socketIO.emit('request-chats-update');
                });

                console.log('âœ… [WEBSOCKET] Sistema de WebSockets inicializado');
            } catch (error) {
                console.error('âŒ [WEBSOCKET] Error inicializando:', error);
                useWebSockets = false;
            }
        }

        function startPolling() {
            // Chequeo de conexiÃ³n cada 10 segundos
            if (!connectionCheckInterval) {
                connectionCheckInterval = setInterval(checkConnectionStatus, 10000);
            }

            // Chequeo inteligente de chats - solo si WebSockets no estÃ¡ activo
            if (!chatsInterval && !useWebSockets) {
                chatsInterval = setInterval(() => {
                    console.log(`ðŸ”„ [CHAT-INTERVAL] isConnected: ${isConnected}, useWebSockets: ${useWebSockets}`);
                    if (isConnected && !useWebSockets) {
                        loadChats();
                    } else if (useWebSockets) {
                        console.log('âœ… [CHAT-INTERVAL] Usando WebSockets, omitiendo polling');
                    } else {
                        console.log('âš ï¸ [CHAT-INTERVAL] WhatsApp no conectado, omitiendo loadChats');
                    }
                }, 10000); // ActualizaciÃ³n cada 10 segundos (solo como fallback)
                console.log('âœ… Chat interval iniciado correctamente (fallback)');
            } else if (useWebSockets) {
                console.log('âœ… Usando WebSockets - Polling de chats desactivado');
            }

            // Usar funciÃ³n inteligente que solo actualiza cuando hay cambios
            startSmartMessagePolling();

            // VerificaciÃ³n QR optimizada - solo cuando cambie el estado
            if (!qrCheckInterval) {
                qrCheckInterval = setInterval(() => {
                    // Solo procesar si el estado cambiÃ³
                    if (lastConnectionState !== isConnected) {
                        lastConnectionState = isConnected;
                        
                        if (isConnected) {
                            const qrModal = document.getElementById('qr-modal');
                            if (qrModal && !qrModal.classList.contains('hidden')) {
                                const indicator = document.getElementById('qr-status-indicator');
                                const isClosingTransition = indicator && (
                                    indicator.innerHTML.includes('cerrarÃ¡ automÃ¡ticamente') ||
                                    indicator.innerHTML.includes('WhatsApp conectado')
                                );

                                if (!isClosingTransition) {
                                    hideQRModalManually();
                                }
                            }
                        } else {
                            // Solo actualizar botones QR cuando cambie a desconectado
                            updateQRButtonVisibility();
                            updateScanQRButtonVisibility();
                        }
                    }
                }, 15000); // Aumentado a 15 segundos
            }
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();

            // Obtener fecha sin hora para comparar dÃ­as
            const dateOnly = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            const todayOnly = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const diffDays = Math.floor((todayOnly - dateOnly) / 86400000);

            // Hora en formato 24h
            const timeStr = date.toLocaleTimeString('es-ES', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });

            // Hoy: solo hora
            if (diffDays === 0) {
                return timeStr;
            }

            // Ayer: "Ayer" + hora
            if (diffDays === 1) {
                return `Ayer ${timeStr}`;
            }

            // Esta semana (Ãºltimos 7 dÃ­as): dÃ­a de la semana + hora
            if (diffDays < 7) {
                const dayName = date.toLocaleDateString('es-ES', { weekday: 'short' });
                return `${dayName} ${timeStr}`;
            }

            // Este aÃ±o: dÃ­a/mes + hora
            if (date.getFullYear() === now.getFullYear()) {
                const dateStr = date.toLocaleDateString('es-ES', {
                    day: '2-digit',
                    month: '2-digit'
                });
                return `${dateStr} ${timeStr}`;
            }

            // AÃ±o diferente: dÃ­a/mes/aÃ±o + hora
            const dateStr = date.toLocaleDateString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: '2-digit'
            });
            return `${dateStr} ${timeStr}`;
        }

        function getMessageStatus(status) {
            switch (status) {
                case 'sending': return '<span style="color: #999;">â±ï¸</span>';
                case 'sent': return '<span style="color: #999;">âœ“</span>';
                case 'delivered': return '<span style="color: #999;">âœ“âœ“</span>';
                case 'read': return '<span style="color: #34b7f1;">âœ“âœ“</span>';
                default: return '';
            }
        }

        // FunciÃ³n para formatear la preview de mensajes en la lista de chats
        function formatChatPreview(lastMessage) {
            if (!lastMessage) {
                return 'Sin mensajes';
            }

            // Detectar diferentes tipos de multimedia
            if (lastMessage.includes('<img')) {
                return 'ðŸ“· Imagen';
            }
            
            if (lastMessage.includes('<audio') || lastMessage.includes('ðŸŽµ') || lastMessage.includes('Audio del historial') || lastMessage.includes('audio-message-container')) {
                return 'ðŸŽµ Audio';
            }
            
            if (lastMessage.includes('<video') || lastMessage.includes('ðŸŽ¥')) {
                return 'ðŸŽ¥ Video';
            }
            
            if (lastMessage.includes('ðŸ“„') || lastMessage.includes('document')) {
                return 'ðŸ“„ Documento';
            }
            
            if (lastMessage.includes('ðŸ“Ž')) {
                return 'ðŸ“Ž Archivo adjunto';
            }

            // Si es texto normal, limitar longitud y limpiar HTML
            const cleanText = lastMessage
                .replace(/<[^>]*>/g, '') // Remover tags HTML
                .replace(/&nbsp;/g, ' ') // Convertir espacios no separables
                .replace(/&amp;/g, '&') // Convertir entidades HTML
                .replace(/&lt;/g, '<')
                .replace(/&gt;/g, '>')
                .trim();

            // Limitar longitud del texto
            if (cleanText.length > 50) {
                return cleanText.substring(0, 50) + '...';
            }

            return cleanText || 'Sin mensajes';
        }

        function formatMessageBody(body) {
            // Manejar elementos multimedia no disponibles PRIMERO
            if (body && (body.includes('video-unavailable') || body.includes('audio-unavailable') || body.includes('image-unavailable'))) {
                return body; // Retornar tal como estÃ¡, ya estÃ¡ en formato correcto
            }

            // NUEVO: Detectar y convertir data URLs de base64 a elementos HTML
            if (body && body.startsWith('data:')) {
                // Detectar imÃ¡genes
                if (body.startsWith('data:image/')) {
                    console.log('ðŸ–¼ï¸ Detectada imagen en base64 desde BD, convirtiendo a HTML...');
                    return `<img src="${body}" alt="Imagen" style="max-width: 100%; border-radius: 8px; cursor: pointer;" onclick="showImageModal(this.src)" onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDIwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjIwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9IiNmOGY5ZmEiIHN0cm9rZT0iI2RlZTJlNiIvPjx0ZXh0IHg9IjEwMCIgeT0iNTAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBmaWxsPSIjNjY2IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iMC4zZW0iPuKaoCBJbWFnZW4gbm8gZGlzcG9uaWJsZTwvdGV4dD48L3N2Zz4='; this.alt='Imagen no disponible';">`;
                }
                // Detectar audio
                else if (body.startsWith('data:audio/')) {
                    console.log('ðŸŽµ Detectado audio en base64 desde BD, convirtiendo a HTML...');
                    return `
                        <div class="audio-container" style="max-width: 100%;">
                            <audio controls preload="metadata" playsinline data-audio-preserve="true" style="width: 100%; max-width: 400px;">
                                <source src="${body}" type="audio/ogg">
                                <source src="${body}" type="audio/mpeg">
                                Tu navegador no soporta el elemento de audio.
                            </audio>
                        </div>
                    `;
                }
                // Detectar video
                else if (body.startsWith('data:video/')) {
                    console.log('ðŸŽ¥ Detectado video en base64 desde BD, convirtiendo a HTML...');
                    return `
                        <div class="video-container" style="max-width: 100%;">
                            <video controls preload="metadata" playsinline style="max-width: 100%; border-radius: 8px;">
                                <source src="${body}">
                                Tu navegador no soporta el elemento de video.
                            </video>
                        </div>
                    `;
                }
            }

            if (body && (body.includes('<img') || body.includes('<audio') || body.includes('<video') || body.includes('<div class="audio-player"') || body.includes('<div class="video-player"') || body.includes('<div class="audio-message-container"'))) {
                if (body.includes('<img')) {
                    return body.replace(/<img([^>]*?)>/g, '<img$1 onclick="showImageModal(this.src)" style="cursor: pointer;" onerror="this.onerror=null; this.src=\'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDIwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjIwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9IiNmOGY5ZmEiIHN0cm9rZT0iI2RlZTJlNiIvPjx0ZXh0IHg9IjEwMCIgeT0iNTAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBmaWxsPSIjNjY2IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iMC4zZW0iPuKaoCBJbWFnZW4gbm8gZGlzcG9uaWJsZTwvdGV4dD48L3N2Zz4=\'; this.alt=\'Imagen no disponible\'; console.error(\'Error cargando imagen:\', this.dataset.originalSrc || this.src);">');
                }

                // Manejar especÃ­ficamente contenedores de mensajes de audio
                if (body.includes('<div class="audio-message-container"')) {
                    return body; // Retornar tal como estÃ¡, ya estÃ¡ en formato correcto
                }

                // Mejorar elementos de audio para evitar interrupciones y agregar soporte multi-formato
                if (body.includes('<audio')) {
                    return body.replace(/<audio([^>]*?)>([\s\S]*?)<\/audio>/g, (match, attrs, content) => {
                        // Agregar controles si no los tiene
                        let newAttrs = attrs;
                        if (!attrs.includes('controls')) {
                            newAttrs += ' controls';
                        }

                        // Configurar preload para mejor buffering
                        if (!attrs.includes('preload=')) {
                            newAttrs += ' preload="metadata"';
                        }

                        // Agregar atributos para mejor control de preservaciÃ³n y buffering
                        if (!attrs.includes('data-audio-preserve')) {
                            newAttrs += ' data-audio-preserve="true"';
                        }

                        // Configurar buffering optimizado para evitar entrecortamiento
                        if (!attrs.includes('playsinline')) {
                            newAttrs += ' playsinline';
                        }

                        // Agregar manejo de errores
                        if (!attrs.includes('onerror')) {
                            newAttrs += ' onerror="this.style.display=\'none\'; this.nextElementSibling.style.display=\'block\';"';
                        }

                        // Crear elemento audio con soporte multi-formato
                        const audioHtml = `<audio${newAttrs}>${content}</audio>`;

                        // Agregar un mensaje de error personalizado
                        const errorMessage = `
                            <div class="audio-error-message" style="
                                color: #666;
                                font-size: 12px;
                                margin-top: 8px;
                                padding: 8px;
                                background: #f8f9fa;
                                border-radius: 4px;
                                border: 1px solid #dee2e6;
                                display: none;
                            ">
                                <strong>âš ï¸ Tu navegador no soporta el elemento de audio.</strong><br>
                                <span style="font-size: 11px;">Formato: audio/ogg - Intenta usar un navegador actualizado como Chrome, Firefox o Edge.</span>
                            </div>
                        `;

                        return `
                            <div class="audio-container">
                                ${audioHtml}
                                ${errorMessage}
                            </div>
                        `;
                    });
                }

                // Mejorar elementos de video
                if (body.includes('<video')) {
                    return body.replace(/<video([^>]*?)>([\s\S]*?)<\/video>/g, (match, attrs, content) => {
                        // Agregar controles si no los tiene
                        let newAttrs = attrs;
                        if (!attrs.includes('controls')) {
                            newAttrs += ' controls';
                        }
                        
                        // Configurar preload para mejor buffering
                        if (!attrs.includes('preload=')) {
                            newAttrs += ' preload="metadata"';
                        }
                        
                        // Agregar playsinline para mÃ³viles
                        if (!attrs.includes('playsinline')) {
                            newAttrs += ' playsinline';
                        }
                        
                        // Agregar manejo de errores
                        if (!attrs.includes('onerror')) {
                            newAttrs += ' onerror="this.style.display=\'none\'; this.nextElementSibling.style.display=\'block\';"';
                        }
                        
                        const videoHtml = `<video${newAttrs}>${content}</video>`;
                        
                        const errorMessage = `
                            <div class="video-error-message" style="
                                color: #666;
                                font-size: 12px;
                                margin-top: 8px;
                                padding: 8px;
                                background: #f8f9fa;
                                border-radius: 4px;
                                border: 1px solid #dee2e6;
                                display: none;
                            ">
                                <strong>âš ï¸ No se pudo cargar el video.</strong><br>
                                <small>Verifica tu conexiÃ³n o intenta recargar la pÃ¡gina.</small>
                            </div>
                        `;
                        
                        return `
                            <div class="video-container">
                                ${videoHtml}
                                ${errorMessage}
                            </div>
                        `;
                    });
                }

                return body;
            }
            
            // Si el body contiene HTML escapado, intentar "des-escaparlo"
            if (body && (body.includes('&lt;div') || body.includes('&lt;img') || body.includes('&lt;audio') || body.includes('&lt;video'))) {
                console.log('ðŸ› DEBUG - HTML escapado detectado, des-escapando...');
                console.log('ðŸ› DEBUG - Body original:', body.substring(0, 200) + '...');
                
                const unescapedBody = body
                    .replace(/&lt;/g, '<')
                    .replace(/&gt;/g, '>')
                    .replace(/&quot;/g, '"')
                    .replace(/&#x27;/g, "'")
                    .replace(/&#39;/g, "'")
                    .replace(/&amp;/g, '&');
                    
                console.log('ðŸ› DEBUG - HTML des-escapado:', unescapedBody.substring(0, 200) + '...');
                
                // Intentar procesar el HTML des-escapado
                if (unescapedBody.includes('<div class="video-unavailable"') || unescapedBody.includes('<div class="audio-unavailable"') || unescapedBody.includes('<div class="image-unavailable"')) {
                    console.log('ðŸ› DEBUG - Retornando HTML des-escapado');
                    return unescapedBody;
                }
            }
            
            return escapeHtml(body || '');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // FunciÃ³n para corregir URLs multimedia al protocolo correcto
        function fixMultimediaUrls() {
            const currentProtocol = window.location.protocol;
            const currentHost = window.location.host;
            
            console.log(`ðŸ”§ Corrigiendo URLs multimedia a ${currentProtocol}//${currentHost}`);
            
            // Corregir URLs de imÃ¡genes
            document.querySelectorAll('img[src^="/"]').forEach(img => {
                if (!img.src.startsWith(currentProtocol)) {
                    const relativePath = img.getAttribute('src');
                    const newUrl = `${currentProtocol}//${currentHost}${relativePath}`;
                    console.log(`ðŸ–¼ï¸ Corrigiendo imagen: ${img.src} -> ${newUrl}`);
                    img.src = newUrl;
                }
            });
            
            // Corregir URLs de audios
            document.querySelectorAll('audio source[src^="/"], audio[src^="/"]').forEach(source => {
                const srcAttr = source.getAttribute('src');
                if (srcAttr && srcAttr.startsWith('/')) {
                    const newUrl = `${currentProtocol}//${currentHost}${srcAttr}`;
                    console.log(`ðŸŽµ Corrigiendo audio: ${srcAttr} -> ${newUrl}`);
                    source.src = newUrl;
                    // Recargar el audio parent si existe
                    if (source.parentElement && source.parentElement.tagName === 'AUDIO') {
                        source.parentElement.load();
                    }
                }
            });
            
            // Corregir URLs de videos
            document.querySelectorAll('video source[src^="/"], video[src^="/"]').forEach(source => {
                const srcAttr = source.getAttribute('src');
                if (srcAttr && srcAttr.startsWith('/')) {
                    const newUrl = `${currentProtocol}//${currentHost}${srcAttr}`;
                    console.log(`ðŸŽ¥ Corrigiendo video: ${srcAttr} -> ${newUrl}`);
                    source.src = newUrl;
                    // Recargar el video parent si existe
                    if (source.parentElement && source.parentElement.tagName === 'VIDEO') {
                        source.parentElement.load();
                    }
                }
            });
        }

        // FunciÃ³n para manejar errores de elementos de audio y mejorar buffering
        function setupAudioErrorHandling() {
            // Usar delegaciÃ³n de eventos para manejar elementos de audio dinÃ¡micos
            document.addEventListener('error', function(e) {
                if (e.target && e.target.tagName === 'AUDIO') {
                    handleAudioError(e.target);
                }
            }, true);

            // TambiÃ©n manejar el evento 'abort' y 'error' especÃ­ficamente para audio
            document.addEventListener('DOMNodeInserted', function(e) {
                if (e.target && e.target.querySelectorAll) {
                    const audioElements = e.target.querySelectorAll('audio');
                    audioElements.forEach(audio => {
                        if (!audio.hasAttribute('data-error-handled')) {
                            audio.setAttribute('data-error-handled', 'true');

                            // Manejar errores
                            audio.addEventListener('error', function() {
                                handleAudioError(audio);
                            });

                            // Mejorar buffering agregando eventos de carga
                            audio.addEventListener('loadstart', function() {
                                console.log('ðŸŽµ Audio: Iniciando carga...');
                            });

                            audio.addEventListener('canplay', function() {
                                console.log('ðŸŽµ Audio: Listo para reproducir');
                            });

                            audio.addEventListener('waiting', function() {
                                console.log('ðŸŽµ Audio: Esperando datos...');
                                // Intentar reanudar automÃ¡ticamente si estÃ¡ pausado por buffering
                                if (audio.paused && audio.readyState < 4) {
                                    audio.play().catch(err => console.log('No se pudo reanudar:', err));
                                }
                            });

                            audio.addEventListener('playing', function() {
                                console.log('ðŸŽµ Audio: Reproduciendo correctamente');
                            });

                            // Optimizar buffering para conexiones lentas
                            audio.addEventListener('timeupdate', function() {
                                // Si hay menos de 5 segundos de buffer, intentar cargar mÃ¡s datos
                                if (audio.buffered.length > 0) {
                                    const bufferedEnd = audio.buffered.end(audio.buffered.length - 1);
                                    const currentTime = audio.currentTime;
                                    if (bufferedEnd - currentTime < 5 && !audio.paused) {
                                        // Forzar carga de mÃ¡s datos si es necesario
                                        audio.preload = 'auto';
                                    }
                                }
                            });
                        }
                    });
                }
            });
        }

        // FunciÃ³n adicional para optimizar buffering de audio
        function optimizeAudioBuffering() {
            console.log('ðŸ”§ Optimizando configuraciÃ³n de buffering de audio...');

            // Configurar propiedades de audio para mejor rendimiento
            const audioElements = document.querySelectorAll('audio');
            audioElements.forEach(audio => {
                // Configurar tamaÃ±o de buffer para evitar entrecortamiento
                if (audio.readyState > 0) {
                    // Establecer propiedades para mejor reproducciÃ³n
                    audio.autoplay = false; // Evitar reproducciÃ³n automÃ¡tica problemÃ¡tica
                    audio.volume = audio.volume || 1.0; // Asegurar volumen adecuado

                    // Optimizar para conexiones lentas
                    if ('mozPreserveDrawingBuffer' in audio) {
                        audio.mozPreserveDrawingBuffer = true;
                    }
                }
            });

            console.log('âœ… OptimizaciÃ³n de buffering completada');
        }

        // FunciÃ³n para forzar actualizaciÃ³n de mensajes (Ãºtil para debugging)
        function forceMessageUpdate() {
            console.log('ðŸ”„ Forzando actualizaciÃ³n de mensajes...');
            lastMessagesHash = ''; // Reset hash to force update
            if (currentChatId) {
                loadMessagesSmart(currentChatId);
            }
        }

        // FunciÃ³n de diagnÃ³stico para verificar el estado del tiempo real
        function diagnoseRealtime() {
            console.log('ðŸ” === DIAGNÃ“STICO TIEMPO REAL ===');
            console.log(`   Chat actual: ${currentChatId || 'Ninguno'}`);
            console.log(`   Ãšltimo hash de mensajes: ${lastMessagesHash ? lastMessagesHash.substring(0, 50) + '...' : 'VacÃ­o'}`);
            console.log(`   Polling activo: ${messagePollingInterval ? 'SÃ­' : 'No'}`);
            console.log(`   Chats cargados: ${chats.size}`);

            if (currentChatId) {
                console.log('   ðŸ“¡ Probando conexiÃ³n a API...');
                loadMessagesSmart(currentChatId).then(() => {
                    console.log('   âœ… API responde correctamente');
                }).catch(error => {
                    console.error('   âŒ Error en API:', error);
                });
            }

            console.log('   ðŸ’¡ Sugerencias:');
            console.log('      - Si no se actualizan los mensajes, usa forceMessageUpdate()');
            console.log('      - Usa testAPIEndpoints() para verificar ambos endpoints');
            console.log('      - Revisa la consola del navegador para errores detallados');
            console.log('      - El sistema verifica cada 3 segundos automÃ¡ticamente');
        }

        // FunciÃ³n para probar ambos endpoints de API
        async function testAPIEndpoints() {
            if (!currentChatId) {
                console.error('âŒ No hay chat seleccionado');
                return;
            }

            console.log('ðŸ§ª === PRUEBA DE ENDPOINTS API ===');

            // Probar endpoint correcto
            try {
                console.log('ðŸ“¡ Probando /api/chats/${chatId}/messages...');
                const response1 = await fetch(`/api/chats/${currentChatId}/messages`);
                if (response1.ok) {
                    const data1 = await response1.json();
                    console.log('âœ… /api/chats/${chatId}/messages funciona:', data1.messages?.length || 0, 'mensajes');
                } else {
                    console.error('âŒ /api/chats/${chatId}/messages fallÃ³:', response1.status);
                }
            } catch (error) {
                console.error('âŒ Error en /api/chats/${chatId}/messages:', error);
            }

            // Probar endpoint alternativo
            try {
                console.log('ðŸ“¡ Probando /api/chats/.../messages...');
                const response2 = await fetch(`/api/chats/${currentChatId}/messages`);
                if (response2.ok) {
                    const data2 = await response2.json();
                    console.log('âœ… /api/chats/.../messages funciona:', data2.messages?.length || 0, 'mensajes');
                } else {
                    console.error('âŒ /api/chats/.../messages fallÃ³:', response2.status);
                }
            } catch (error) {
                console.error('âŒ Error en /api/chats/.../messages:', error);
            }
        }

        // FunciÃ³n para monitoreo en tiempo real (Ãºtil para debugging)
        let realtimeMonitor = null;
        function startRealtimeMonitor() {
            if (realtimeMonitor) {
                clearInterval(realtimeMonitor);
            }

            console.log('ðŸ”¬ Iniciando monitor en tiempo real...');
            realtimeMonitor = setInterval(() => {
                if (currentChatId) {
                    console.log(`ðŸ” [MONITOR] Chat: ${currentChatId} | Hash: ${lastMessagesHash ? 'ACTIVO' : 'VACÃO'} | Polling: ${messagePollingInterval ? 'ON' : 'OFF'}`);
                } else {
                    console.log('ðŸ” [MONITOR] Sin chat seleccionado');
                }
            }, 5000); // Log cada 5 segundos
        }

        function stopRealtimeMonitor() {
            if (realtimeMonitor) {
                clearInterval(realtimeMonitor);
                realtimeMonitor = null;
                console.log('â¹ï¸ Monitor en tiempo real detenido');
            }
        }

        // FunciÃ³n de diagnÃ³stico para problemas de sesiÃ³n
        function diagnoseSession() {
            console.log('ðŸ” === DIAGNÃ“STICO DE SESIÃ“N ===');
            console.log(`   token: ${token ? 'PRESENTE' : 'FALTANTE'}`);
            console.log(`   localStorage token: ${localStorage.getItem('token') ? 'PRESENTE' : 'FALTANTE'}`);
            console.log(`   currentUser: ${currentUser ? currentUser.username : 'NULO'}`);
            console.log(`   Estado de red: ${navigator.onLine ? 'ONLINE' : 'OFFLINE'}`);

            if (token) {
                console.log('   ðŸ” Probando validaciÃ³n de sesiÃ³n...');
                validateSession().then(isValid => {
                    console.log(`   âœ… ValidaciÃ³n: ${isValid ? 'VÃLIDA' : 'INVÃLIDA'}`);
                }).catch(error => {
                    console.error('   âŒ Error en validaciÃ³n:', error);
                });
            } else {
                console.error('   âŒ NO HAY SESSIONID - Problema de autenticaciÃ³n');
                console.log('   ðŸ’¡ Sugerencias:');
                console.log('      - Verifica que hayas iniciado sesiÃ³n');
                console.log('      - Revisa la consola del navegador para errores de login');
                console.log('      - Intenta refrescar la pÃ¡gina');
            }

            console.log('   ðŸ’¡ Si persiste el problema:');
            console.log('      - Usa clearSession() para limpiar datos corruptos');
            console.log('      - Revisa que la API /api/session estÃ© funcionando');
        }

        // FunciÃ³n para desmarcar todos los chats como pendientes
        async function clearAllChats() {
            // Mostrar confirmaciÃ³n al usuario
            const confirmed = confirm(
                'ðŸ”„ Â¿Deseas desmarcar TODOS los chats pendientes?\n\n' +
                'Esta acciÃ³n:\n' +
                'â€¢ OcultarÃ¡ todos los chats de la lista actual\n' +
                'â€¢ Los chats seguirÃ¡n existiendo pero no aparecerÃ¡n como pendientes\n' +
                'â€¢ Solo se mostrarÃ¡n nuevos mensajes entrantes\n\n' +
                'Â¿Continuar?'
            );

            if (!confirmed) {
                console.log('ðŸš« Desmarcado de chats cancelado por el usuario');
                return;
            }

            try {
                console.log('ðŸ”„ Desmarcando todos los chats como pendientes...');
                showNotification('Desmarcando todos los chats pendientes...', 'info');

                const response = await fetch('/api/unmark-all-pending', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    console.log(`âœ… ${result.details.unmarked} chats desmarcados como pendientes exitosamente`);
                    showNotification(`âœ… ${result.details.unmarked} chats desmarcados como pendientes`, 'success');

                    // Limpiar la lista actual (se ocultarÃ¡n todos los chats)
                    const chatsList = document.getElementById('chat-list');
                    if (chatsList) {
                        chatsList.innerHTML = `
                            <div style="padding: 20px; text-align: center; color: #8b949e;">
                                <i class="fas fa-check-circle" style="font-size: 2em; margin-bottom: 10px;"></i>
                                <p>Todos los chats han sido desmarcados como pendientes</p>
                                <small style="color: #666;">Solo aparecerÃ¡n nuevos mensajes entrantes</small>
                            </div>
                        `;
                    }

                    // Limpiar Ã¡rea de mensajes
                    const messagesArea = document.getElementById('messages-area');
                    if (messagesArea) {
                        messagesArea.innerHTML = '';
                    }

                    // Recargar la lista de chats (deberÃ­a estar vacÃ­a ahora)
                    setTimeout(() => {
                        loadChats();
                    }, 1000);

                } else {
                    console.error('âŒ Error desmarcando chats:', result.message);
                    showNotification('âŒ Error desmarcando chats: ' + result.message, 'error');
                }

            } catch (error) {
                console.error('âŒ Error en la solicitud de desmarcado:', error);
                showNotification('âŒ Error al desmarcar chats', 'error');
            }
        }

        // FunciÃ³n para limpiar mensajes (eliminar parte inferior) - mantenida para compatibilidad
        function clearBottomMessages() {
            const messagesArea = document.getElementById('messages-area');
            if (messagesArea) {
                const messages = messagesArea.querySelectorAll('.message');
                if (messages.length > 10) {
                    // Mantener solo los primeros 10 mensajes, eliminar el resto
                    for (let i = 10; i < messages.length; i++) {
                        messages[i].remove();
                    }
                    console.log(`ðŸ§¹ Se eliminaron ${messages.length - 10} mensajes de la parte inferior`);
                    showNotification(`Mensajes antiguos eliminados (mantenidos los Ãºltimos 10)`, 'info');
                }
            }
        }

        // FunciÃ³n para limpiar datos de sesiÃ³n corruptos
        function clearSession() {
            console.log('ðŸ§¹ Limpiando datos de sesiÃ³n...');
            localStorage.removeItem('token');
            token = null;
            currentUser = null;
            showNotification('SesiÃ³n limpiada. Redirigiendo al login...', 'info');
            setTimeout(() => showLoginScreen(), 1000);
        }

        // Llamar a la optimizaciÃ³n cuando se cargue la pÃ¡gina
        window.addEventListener('load', function() {
            setTimeout(optimizeAudioBuffering, 1000); // Esperar 1 segundo para que se carguen los elementos
        });

        function handleAudioError(audioElement) {
            const container = audioElement.closest('.audio-container');
            if (container) {
                const errorMessage = container.querySelector('.audio-error-message');
                if (errorMessage) {
                    errorMessage.style.display = 'block';

                    // Intentar detectar el tipo de error mÃ¡s especÃ­ficamente
                    let errorType = 'desconocido';
                    if (audioElement.error) {
                        switch (audioElement.error.code) {
                            case MediaError.MEDIA_ERR_ABORTED:
                                errorType = 'abortado';
                                break;
                            case MediaError.MEDIA_ERR_NETWORK:
                                errorType = 'de red';
                                break;
                            case MediaError.MEDIA_ERR_DECODE:
                                errorType = 'de decodificaciÃ³n';
                                break;
                            case MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED:
                                errorType = 'formato no soportado';
                                break;
                        }
                    }

                    // Obtener informaciÃ³n del formato
                    let formatInfo = '';
                    if (audioElement.src) {
                        const url = new URL(audioElement.src);
                        const pathname = url.pathname;
                        const extension = pathname.substring(pathname.lastIndexOf('.') + 1).toLowerCase();
                        formatInfo = `Formato: audio/${extension}`;
                    }

                    // Actualizar el mensaje de error con informaciÃ³n mÃ¡s detallada
                    const errorText = errorMessage.querySelector('span');
                    if (errorText) {
                        errorText.innerHTML = `${formatInfo} - Error: ${errorType}.<br>Intenta usar un navegador actualizado como Chrome, Firefox o Edge.`;
                    }

                    console.log(`ðŸŽµ Audio error: ${errorType} - ${formatInfo}`);
                }
            }
        }

        function showImageModal(imageSrc) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.9); display: flex; justify-content: center; 
                align-items: center; z-index: 10000; cursor: pointer;
            `;
            
            const img = document.createElement('img');
            img.src = imageSrc;
            img.style.cssText = `
                max-width: 95%; max-height: 95%; border-radius: 12px; 
                object-fit: contain; cursor: pointer;
            `;
            
            const closeBtn = document.createElement('div');
            closeBtn.innerHTML = '?';
            closeBtn.style.cssText = `
                position: absolute; top: 20px; right: 30px; color: white; 
                font-size: 30px; cursor: pointer; background: rgba(0,0,0,0.5); 
                border-radius: 50%; width: 40px; height: 40px; display: flex; 
                justify-content: center; align-items: center;
            `;
            
            modal.appendChild(img);
            modal.appendChild(closeBtn);
            document.body.appendChild(modal);
            
            img.onclick = function(e) { e.stopPropagation(); };
            modal.onclick = closeBtn.onclick = function() {
                        document.body.removeChild(modal);
            };
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.getElementById('notifications').appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            
                setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // FUNCIONES PARA Nï¿½MEROS OMITIDOS
        // ===== FUNCIONES PARA DASHBOARD DE SALUD DEL BOT =====
        async function showHealthDashboard() {
            const modal = document.getElementById('health-dashboard-modal');
            if (modal) {
                modal.classList.remove('hidden');
                await loadHealthData();
                // Auto-refresh cada 5 segundos mientras estÃ¡ abierto
                if (window.healthRefreshInterval) clearInterval(window.healthRefreshInterval);
                window.healthRefreshInterval = setInterval(loadHealthData, 5000);
            }
        }

        function closeHealthDashboard() {
            const modal = document.getElementById('health-dashboard-modal');
            if (modal) {
                modal.classList.add('hidden');
                if (window.healthRefreshInterval) {
                    clearInterval(window.healthRefreshInterval);
                    window.healthRefreshInterval = null;
                }
            }
        }

        async function loadHealthData() {
            try {
                const response = await fetch('/api/bot-health');
                const data = await response.json();

                // Actualizar estado general
                const statusBadge = document.getElementById('health-status-badge');
                if (data.whatsappListo) {
                    statusBadge.textContent = 'âœ“ OPERATIVO';
                    statusBadge.style.background = 'rgba(76, 175, 80, 0.9)';
                } else {
                    statusBadge.textContent = 'âœ— DESCONECTADO';
                    statusBadge.style.background = 'rgba(244, 67, 54, 0.9)';
                }

                document.getElementById('health-whatsapp-state').textContent = data.estado;
                document.getElementById('health-uptime').textContent = `${data.tiempoActivo.horas}h`;
                document.getElementById('health-active-chats').textContent = data.chatsActivos;

                // Actualizar mensajes
                document.getElementById('health-success-count').textContent = data.mensajes.exitosos;
                document.getElementById('health-success-rate').textContent = `${data.mensajes.tasaExito}% tasa de Ã©xito`;
                document.getElementById('health-error-count').textContent = data.mensajes.fallidos;
                document.getElementById('health-error-rate').textContent = `${data.mensajes.tasaError}% tasa de error`;

                // Actualizar lÃ­mites diarios
                document.getElementById('health-daily-count').textContent =
                    `${data.limites.mensajesHoy} / ${data.limites.maxDiario}`;
                document.getElementById('health-daily-bar').style.width = `${data.limites.porcentajeDiario}%`;
                document.getElementById('health-daily-percentage').textContent = `${data.limites.porcentajeDiario}%`;

                // Cambiar color de barra segÃºn porcentaje
                const dailyBar = document.getElementById('health-daily-bar');
                if (parseFloat(data.limites.porcentajeDiario) > 80) {
                    dailyBar.style.background = 'linear-gradient(90deg, #f56565, #c53030)';
                } else if (parseFloat(data.limites.porcentajeDiario) > 60) {
                    dailyBar.style.background = 'linear-gradient(90deg, #ed8936, #dd6b20)';
                } else {
                    dailyBar.style.background = 'linear-gradient(90deg, #4299e1, #3182ce)';
                }

                // Actualizar lÃ­mites por hora
                document.getElementById('health-hourly-count').textContent =
                    `${data.limites.mensajesHora} / ${data.limites.maxHora}`;
                document.getElementById('health-hourly-bar').style.width = `${data.limites.porcentajeHora}%`;
                document.getElementById('health-hourly-percentage').textContent = `${data.limites.porcentajeHora}%`;

                const hourlyBar = document.getElementById('health-hourly-bar');
                if (parseFloat(data.limites.porcentajeHora) > 80) {
                    hourlyBar.style.background = 'linear-gradient(90deg, #f56565, #c53030)';
                } else if (parseFloat(data.limites.porcentajeHora) > 60) {
                    hourlyBar.style.background = 'linear-gradient(90deg, #ed8936, #dd6b20)';
                } else {
                    hourlyBar.style.background = 'linear-gradient(90deg, #48bb78, #38a169)';
                }

                // Actualizar alertas
                const alertsContainer = document.getElementById('health-alerts-container');
                const alertsList = document.getElementById('health-alerts-list');
                if (data.alertas && data.alertas.length > 0) {
                    alertsContainer.style.display = 'block';
                    alertsList.innerHTML = data.alertas.map(alerta =>
                        `<div style="margin: 5px 0;">â€¢ ${alerta}</div>`
                    ).join('');

                    // Mostrar punto de alerta en el botÃ³n
                    updateHealthButtonAlert(true);
                } else {
                    alertsContainer.style.display = 'none';
                    updateHealthButtonAlert(false);
                }

                // Actualizar Ãºltimo error
                const lastErrorContainer = document.getElementById('health-last-error-container');
                const lastErrorDetails = document.getElementById('health-last-error-details');
                if (data.ultimoError) {
                    lastErrorContainer.style.display = 'block';
                    lastErrorDetails.innerHTML = `
                        <strong>Chat:</strong> ${data.ultimoError.chatId}<br>
                        <strong>Mensaje:</strong> ${data.ultimoError.mensaje}<br>
                        <strong>Fecha:</strong> ${new Date(data.ultimoError.timestamp).toLocaleString('es')}
                    `;
                } else {
                    lastErrorContainer.style.display = 'none';
                }

                // Actualizar mensajes del chatbot
                const chatbotMessagesContainer = document.getElementById('health-chatbot-messages');
                if (data.mensajesChatbot && data.mensajesChatbot.length > 0) {
                    chatbotMessagesContainer.innerHTML = data.mensajesChatbot.map(msg => {
                        const fecha = new Date(msg.timestamp).toLocaleString('es', {
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        const isEntrante = msg.tipo === 'entrante';
                        const bgColor = isEntrante ? '#e3f2fd' : '#f1f8e9';
                        const icon = isEntrante ? 'fa-arrow-down' : 'fa-arrow-up';
                        const iconColor = isEntrante ? '#2196f3' : '#4caf50';
                        const label = isEntrante ? 'Entrante' : 'Saliente';

                        return `
                            <div style="background: ${bgColor}; border-left: 4px solid ${iconColor}; padding: 12px; margin-bottom: 10px; border-radius: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <i class="fas ${icon}" style="color: ${iconColor};"></i>
                                        <strong style="color: #2d3748; font-size: 0.9em;">${label}</strong>
                                        <span style="color: #4a5568; font-size: 0.85em;">${msg.nombre || msg.chatId.substring(0, 15)}</span>
                                    </div>
                                    <span style="color: #718096; font-size: 0.8em;">${fecha}</span>
                                </div>
                                <div style="color: #4a5568; font-size: 0.9em; margin-left: 28px;">${msg.mensaje}</div>
                            </div>
                        `;
                    }).join('');
                } else {
                    chatbotMessagesContainer.innerHTML = `
                        <div style="text-align: center; color: #718096; padding: 40px;">
                            <i class="fas fa-inbox" style="font-size: 3em; opacity: 0.3; margin-bottom: 10px;"></i>
                            <div>No hay mensajes recientes</div>
                        </div>
                    `;
                }

            } catch (error) {
                console.error('Error cargando datos de salud:', error);
            }
        }

        function updateHealthButtonAlert(hasAlert) {
            const healthBtn = document.querySelector('.btn-health');
            if (!healthBtn) return;

            let alertDot = healthBtn.querySelector('.alert-dot');
            if (hasAlert) {
                if (!alertDot) {
                    alertDot = document.createElement('span');
                    alertDot.className = 'alert-dot';
                    healthBtn.appendChild(alertDot);
                }
            } else {
                if (alertDot) {
                    alertDot.remove();
                }
            }
        }

        async function refreshHealthDashboard() {
            const btn = event.target.closest('button');
            const icon = btn.querySelector('i');

            // AnimaciÃ³n del Ã­cono
            icon.style.animation = 'spin 1s linear';
            await loadHealthData();
            setTimeout(() => {
                icon.style.animation = '';
            }, 1000);
        }

        // Agregar animaciÃ³n de spin
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);

        async function showOmittedModal() {
            const modal = document.getElementById('omitted-modal');
            if (modal) {
                modal.classList.remove('hidden');
                await loadOmittedNumbers();
            }
        }

        function closeOmittedModal() {
            const modal = document.getElementById('omitted-modal');
            if (modal) {
                modal.classList.add('hidden');
                document.getElementById('omitted-number').value = '';
                document.getElementById('omitted-reason').value = '';

                // Limpiar bÃºsqueda
                const searchInput = document.getElementById('omitted-search');
                const clearButton = document.getElementById('omitted-clear-search');
                if (searchInput) searchInput.value = '';
                if (clearButton) clearButton.style.display = 'none';
            }
        }

        async function loadOmittedNumbers() {
            try {
                const response = await fetch(`/api/omitted-numbers?token=${token}`);
                const data = await response.json();

                if (data.success) {
                    displayOmittedNumbers(data.numeros);
                } else {
                    showNotification('Error cargando nï¿½meros omitidos', 'error');
                }
            } catch (error) {
                console.error('Error cargando nï¿½meros omitidos:', error);
                showNotification('Error de conexiï¿½n', 'error');
            }
        }

        // Variable global para almacenar todos los nÃºmeros omitidos
        let allOmittedNumbers = [];

        function displayOmittedNumbers(numeros) {
            // Guardar todos los nÃºmeros para el filtrado
            allOmittedNumbers = numeros || [];

            const omittedList = document.getElementById('omitted-list');
            if (!omittedList) return;

            if (!numeros || numeros.length === 0) {
                omittedList.innerHTML = `
                    <div class="omitted-no-results">
                        <i class="fas fa-inbox"></i>
                        <p>No hay nÃºmeros omitidos registrados</p>
                    </div>
                `;
                updateOmittedSearchStats(0, 0);
                return;
            }

            renderOmittedNumbers(numeros);
            updateOmittedSearchStats(numeros.length, allOmittedNumbers.length);
        }

        function renderOmittedNumbers(numeros) {
            const omittedList = document.getElementById('omitted-list');
            if (!omittedList) return;

            if (numeros.length === 0) {
                omittedList.innerHTML = `
                    <div class="omitted-no-results">
                        <i class="fas fa-search"></i>
                        <p>No se encontraron nÃºmeros que coincidan con la bÃºsqueda</p>
                        <small style="margin-top: 10px; display: block;">Intenta con otros tÃ©rminos de bÃºsqueda</small>
                    </div>
                `;
                return;
            }

            omittedList.innerHTML = numeros.map(numero => `
                <div class="omitted-item" data-id="${numero.id}">
                    <button class="delete-btn" onclick="eliminarNumeroOmitido(${numero.id})" title="Eliminar nÃºmero">
                        <i class="fas fa-trash"></i>
                    </button>
                    <div class="numero">${numero.numero}</div>
                    <div class="motivo">${numero.motivo || 'Sin motivo especificado'}</div>
                    <div class="meta">
                        <span>Agregado por: ${numero.creado_por}</span>
                        <span>${formatDate(numero.fecha_creacion)}</span>
                    </div>
                </div>
            `).join('');
        }

        function filterOmittedNumbers() {
            const searchInput = document.getElementById('omitted-search');
            const clearButton = document.getElementById('omitted-clear-search');

            if (!searchInput) return;

            const searchTerm = searchInput.value.toLowerCase().trim();

            // Mostrar/ocultar botÃ³n de limpiar
            if (searchTerm.length > 0) {
                clearButton.style.display = 'flex';
            } else {
                clearButton.style.display = 'none';
            }

            // Filtrar nÃºmeros
            let filteredNumbers = allOmittedNumbers;

            if (searchTerm.length > 0) {
                filteredNumbers = allOmittedNumbers.filter(numero => {
                    const numeroStr = numero.numero.toLowerCase();
                    const motivoStr = (numero.motivo || '').toLowerCase();
                    const creadoPorStr = numero.creado_por.toLowerCase();

                    return numeroStr.includes(searchTerm) ||
                           motivoStr.includes(searchTerm) ||
                           creadoPorStr.includes(searchTerm);
                });
            }

            renderOmittedNumbers(filteredNumbers);
            updateOmittedSearchStats(filteredNumbers.length, allOmittedNumbers.length);
        }

        function clearOmittedSearch() {
            const searchInput = document.getElementById('omitted-search');
            const clearButton = document.getElementById('omitted-clear-search');

            if (searchInput) {
                searchInput.value = '';
                searchInput.focus();
            }

            if (clearButton) {
                clearButton.style.display = 'none';
            }

            // Mostrar todos los nÃºmeros
            renderOmittedNumbers(allOmittedNumbers);
            updateOmittedSearchStats(allOmittedNumbers.length, allOmittedNumbers.length);
        }

        function updateOmittedSearchStats(showing, total) {
            const statsElement = document.getElementById('omitted-search-stats');
            if (!statsElement) return;

            if (total === 0) {
                statsElement.textContent = '';
                return;
            }

            if (showing === total) {
                statsElement.textContent = `Mostrando ${total} nÃºmero${total !== 1 ? 's' : ''}`;
            } else {
                statsElement.textContent = `Mostrando ${showing} de ${total} nÃºmero${total !== 1 ? 's' : ''}`;
            }
        }

        function handleOmittedSearchKeydown(event) {
            // Escape para limpiar bÃºsqueda
            if (event.key === 'Escape') {
                clearOmittedSearch();
                event.preventDefault();
            }
        }

        // FunciÃ³n para detectar y corregir problemas de scroll en mÃ³viles
        function fixMobileScrollIssues() {
            const messagesArea = document.getElementById('messages-area');
            if (!messagesArea) return;
            
            const isMobile = window.innerWidth <= 768;
            if (!isMobile) return;
            
            // Verificar si hay problemas de scroll
            const totalHeight = messagesArea.scrollHeight;
            const visibleHeight = messagesArea.clientHeight;
            const currentScroll = messagesArea.scrollTop;
            const maxScroll = totalHeight - visibleHeight;
            
            // Si hay contenido que no es visible y no estamos al final
            if (maxScroll > 0 && currentScroll < maxScroll - 100) {
                console.log('ðŸ”§ Detectado problema de scroll en mÃ³vil, corrigiendo...');
                
                // Intentar mÃºltiples mÃ©todos de scroll
                messagesArea.scrollTop = totalHeight;
                
                setTimeout(() => {
                    messagesArea.scrollTo(0, totalHeight);
                }, 50);
                
                setTimeout(() => {
                    messagesArea.scrollIntoView({ block: 'end', behavior: 'smooth' });
                }, 100);
            }
        }
        
        // Detectar cuando se agregan nuevos elementos al chat
        let scrollObserver;
        function initMobileScrollObserver() {
            const messagesArea = document.getElementById('messages-area');
            if (!messagesArea || scrollObserver) return;
            
            const isMobile = window.innerWidth <= 768;
            if (!isMobile) return;
            
            scrollObserver = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                        // Se agregaron nuevos mensajes, verificar scroll
                        setTimeout(fixMobileScrollIssues, 200);
                    }
                });
            });
            
            scrollObserver.observe(messagesArea, {
                childList: true,
                subtree: true
            });
            
            console.log('ðŸ‘ï¸ Observer de scroll mÃ³vil iniciado');
        }

        async function agregarNumeroOmitido() {
            const numero = document.getElementById('omitted-number').value.trim();
            const motivo = document.getElementById('omitted-reason').value.trim();

            if (!numero) {
                showNotification('Por favor ingresa un nï¿½mero', 'error');
                return;
            }

            if (!/^\d+$/.test(numero)) {
                showNotification('El nï¿½mero solo debe contener dï¿½gitos', 'error');
                return;
            }

            try {
                const response = await fetch('/api/omitted-numbers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ numero, motivo, token })
                });

                const data = await response.json();

                if (data.success) {
                    showNotification(data.message, 'success');
                    document.getElementById('omitted-number').value = '';
                    document.getElementById('omitted-reason').value = '';
                    await loadOmittedNumbers();
                } else {
                    showNotification(data.message, 'error');
                }
            } catch (error) {
                console.error('Error agregando nï¿½mero omitido:', error);
                showNotification('Error de conexiï¿½n', 'error');
            }
        }

        async function eliminarNumeroOmitido(id) {
            if (!confirm('ï¿½Estï¿½s seguro de que quieres eliminar este nï¿½mero omitido?')) return;

            try {
                const response = await fetch(`/api/omitted-numbers/${id}?token=${token}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showNotification(data.message, 'success');
                    await loadOmittedNumbers();
                } else {
                    showNotification(data.message, 'error');
                }
            } catch (error) {
                console.error('Error eliminando nï¿½mero omitido:', error);
                showNotification('Error de conexiï¿½n', 'error');
            }
        }

        // FUNCIONES PARA ADMINISTRACIï¿½N DE USUARIOS
        async function showUsersAdminModal() {
            const modal = document.getElementById('users-admin-modal');
            if (modal) {
                modal.classList.remove('hidden');
                await loadUsersAdmin();
            }
        }

        function closeUsersAdminModal() {
            const modal = document.getElementById('users-admin-modal');
            if (modal) modal.classList.add('hidden');
        }

        async function loadUsersAdmin() {
            try {
                // Validar sesiÃ³n antes de la operaciÃ³n
                const sessionValid = await validateSession();
                if (!sessionValid) return;

                if (!currentUser || currentUser.rol !== 'admin') {
                    showNotification('Acceso denegado: Solo administradores pueden ver esta informaciï¿½n', 'error');
                    return;
                }

                const response = await fetch(`/api/users?token=${token}`);
                
                if (!response.ok) {
                    if (response.status === 403) {
                        showNotification('Acceso denegado', 'error');
                        return;
                    }
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    displayUsersAdmin(data.users || []);
                } else {
                    showNotification(data.message || 'Error cargando usuarios', 'error');
                }
            } catch (error) {
                console.error('Error cargando usuarios:', error);
                showNotification(`Error de conexiï¿½n: ${error.message}`, 'error');
            }
        }

        function displayUsersAdmin(users) {
            const usersList = document.getElementById('users-admin-list');
            if (!usersList) return;

            if (!users || users.length === 0) {
                usersList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No hay usuarios registrados</p>';
                return;
            }

            usersList.innerHTML = users.map(user => `
                <div class="omitted-item">
                    <div class="user-actions" style="position: absolute; top: 10px; right: 10px; display: flex; gap: 8px;">
                        <button class="edit-btn" onclick="editarUsuario(${user.id}, '${user.username}', '${user.nombre}', '${user.rol}')" ${(user.username === 'admin' || user.username === 'api_user' || user.username === 'api') ? 'style="display:none;"' : ''} title="Editar usuario">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-btn" onclick="eliminarUsuarioAdmin(${user.id})" ${(user.username === 'admin' || user.username === 'api_user' || user.username === 'api') ? 'style="display:none;"' : ''} title="Eliminar usuario">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="numero">ðŸ‘¤ ${user.username}</div>
                    <div class="motivo">${user.nombre} - Rol: ${user.rol === 'admin' ? 'Administrador' : user.rol === 'api' ? 'API Especial' : 'Soporte'}</div>
                    <div class="meta">Creado: ${formatDate(user.fecha_creacion)}</div>
                </div>
            `).join('');
        }

        async function eliminarUsuarioAdmin(id) {
            if (!confirm('ï¿½Estï¿½s seguro de que quieres eliminar este usuario?')) return;

            try {
                const response = await fetch(`/api/users/${id}?token=${token}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showNotification(data.message, 'success');
                    await loadUsersAdmin();
                } else {
                    showNotification(data.message, 'error');
                }
            } catch (error) {
                console.error('Error eliminando usuario:', error);
                showNotification('Error de conexiï¿½n', 'error');
            }
        }

        function editarUsuario(id, username, nombre, rol) {
            document.getElementById('edit-user-id').value = id;
            document.getElementById('edit-user-username').value = username;
            document.getElementById('edit-user-nombre').value = nombre;
            document.getElementById('edit-user-role').value = rol;
            document.getElementById('edit-user-password').value = '';

            const modal = document.getElementById('edit-user-modal');
            if (modal) {
                modal.classList.remove('hidden');
            }
        }

        function closeEditUserModal() {
            const modal = document.getElementById('edit-user-modal');
            if (modal) {
                modal.classList.add('hidden');
                document.getElementById('edit-user-id').value = '';
                document.getElementById('edit-user-username').value = '';
                document.getElementById('edit-user-password').value = '';
                document.getElementById('edit-user-nombre').value = '';
                document.getElementById('edit-user-role').value = 'soporte';
            }
        }

        function showAddUserModal() {
            const modal = document.getElementById('add-user-modal');
            if (modal) {
                modal.classList.remove('hidden');
                document.getElementById('new-user-username').value = '';
                document.getElementById('new-user-password').value = '';
                document.getElementById('new-user-nombre').value = '';
                document.getElementById('new-user-role').value = 'soporte';
            }
        }

        function closeAddUserModal() {
            const modal = document.getElementById('add-user-modal');
            if (modal) {
                modal.classList.add('hidden');
                document.getElementById('new-user-username').value = '';
                document.getElementById('new-user-password').value = '';
                document.getElementById('new-user-nombre').value = '';
                document.getElementById('new-user-role').value = 'soporte';
            }
        }

        async function agregarUsuario() {
            const username = document.getElementById('new-user-username').value.trim();
            const password = document.getElementById('new-user-password').value.trim();
            const nombre = document.getElementById('new-user-nombre').value.trim();
            const rol = document.getElementById('new-user-role').value;

            if (!username || !password || !nombre) {
                showNotification('Por favor completa todos los campos obligatorios', 'error');
                return;
            }

            if (!/^[a-zA-Z0-9_]+$/.test(username)) {
                showNotification('El nombre de usuario solo puede contener letras, nï¿½meros y guiones bajos', 'error');
                return;
            }

            if (password.length < 6) {
                showNotification('La contraseï¿½a debe tener al menos 6 caracteres', 'error');
                return;
            }

            try {
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, nombre, rol, token })
                });

                if (!response.ok) {
                    if (response.status === 403) {
                        showNotification('Acceso denegado: Solo administradores pueden crear usuarios', 'error');
                        return;
                    }
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    showNotification(data.message, 'success');
                    closeAddUserModal();
                    await loadUsersAdmin();
                } else {
                    showNotification(data.message || 'Error creando usuario', 'error');
                }
            } catch (error) {
                console.error('Error creando usuario:', error);
                showNotification('Error de conexiï¿½n al servidor', 'error');
            }
        }

        async function actualizarUsuario() {
            const id = document.getElementById('edit-user-id').value;
            const username = document.getElementById('edit-user-username').value.trim();
            const password = document.getElementById('edit-user-password').value.trim();
            const nombre = document.getElementById('edit-user-nombre').value.trim();
            const rol = document.getElementById('edit-user-role').value;

            if (!username || !nombre) {
                showNotification('Por favor completa los campos obligatorios', 'error');
                return;
            }

            if (!/^[a-zA-Z0-9_]+$/.test(username)) {
                showNotification('El nombre de usuario solo puede contener letras, nï¿½meros y guiones bajos', 'error');
                return;
            }

            if (password && password.length < 6) {
                showNotification('La contraseï¿½a debe tener al menos 6 caracteres', 'error');
                return;
            }

            try {
                const updateData = { username, nombre, rol, token };
                if (password) updateData.password = password;

                const response = await fetch(`/api/users/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });

                if (!response.ok) {
                    if (response.status === 403) {
                        showNotification('Acceso denegado: Solo administradores pueden editar usuarios', 'error');
                        return;
                    }
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    showNotification(data.message, 'success');
                    closeEditUserModal();
                    await loadUsersAdmin();
                } else {
                    showNotification(data.message || 'Error actualizando usuario', 'error');
                }
            } catch (error) {
                console.error('Error actualizando usuario:', error);
                showNotification('Error de conexiï¿½n al servidor', 'error');
            }
        }

        // FUNCIONES PARA LOGS DE API
        async function showLogsAPIModal() {
            const modal = document.getElementById('logs-api-modal');
            if (modal) {
                modal.classList.remove('hidden');
                await loadLogsAPI();
            }
        }

        function closeLogsAPIModal() {
            const modal = document.getElementById('logs-api-modal');
            if (modal) modal.classList.add('hidden');
        }

        async function loadLogsAPI() {
            try {
                // Validar sesiÃ³n antes de la operaciÃ³n
                const sessionValid = await validateSession();
                if (!sessionValid) return;

                const response = await fetch(`/api/logs-api?token=${token}&limit=100`);
                
                if (!response.ok) {
                    if (response.status === 403) {
                        showNotification('Acceso denegado', 'error');
                        return;
                    }
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    displayLogsAPI(data.logs || []);
                } else {
                    showNotification(data.message || 'Error cargando logs', 'error');
                }
            } catch (error) {
                console.error('Error cargando logs API:', error);
                showNotification('Error de conexiï¿½n al servidor', 'error');
            }
        }

        function displayLogsAPI(logs) {
            const logsList = document.getElementById('logs-api-list');
            if (!logsList) return;

            if (!logs || logs.length === 0) {
                logsList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No hay logs registrados</p>';
                return;
            }

            logsList.innerHTML = logs.map(log => {
                const estadoIcon = getEstadoIcon(log.estado);
                const estadoColor = getEstadoColor(log.estado);
                
                return `
                <div class="omitted-item">
                    <div class="numero">
                        ${estadoIcon} ${log.numero_destino}
                        <span style="background: ${estadoColor}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; margin-left: 10px;">
                            ${getEstadoText(log.estado)}
                        </span>
                    </div>
                    <div class="motivo">
                        <strong>IP:</strong> ${log.ip_origen} ï¿½ 
                        <strong>Mensaje:</strong> ${log.mensaje.length > 100 ? log.mensaje.substring(0, 100) + '...' : log.mensaje}
                    </div>
                    <div class="meta">
                        ${formatDate(log.fecha_envio)}
                    </div>
                </div>
            `;
            }).join('');
        }

        function getEstadoIcon(estado) {
            switch(estado) {
                case 'enviado': return 'âœ“âœ“';
                case 'error_envio': return 'âŒ';
                case 'error_parametros': return 'âš ï¸';
                case 'error_whatsapp_no_listo': return 'âš ï¸';
                case 'error_excepcion': return 'âŒ';
                default: return 'âš ï¸';
            }
        }

        function getEstadoColor(estado) {
            switch(estado) {
                case 'enviado': return '#28a745';
                case 'error_envio': return '#dc3545';
                case 'error_parametros': return '#ffc107';
                case 'error_whatsapp_no_listo': return '#17a2b8';
                case 'error_excepcion': return '#6f42c1';
                default: return '#6c757d';
            }
        }

        function getEstadoText(estado) {
            switch(estado) {
                case 'enviado': return 'Enviado';
                case 'error_envio': return 'Error Envï¿½o';
                case 'error_parametros': return 'Error Parï¿½metros';
                case 'error_whatsapp_no_listo': return 'WhatsApp No Listo';
                case 'error_excepcion': return 'Error Excepciï¿½n';
                default: return estado;
            }
        }

        // FUNCIONES PARA NUEVO CHAT
        function showNewChatModal() {
            const modal = document.getElementById('new-chat-modal');
            if (modal) {
                modal.classList.remove('hidden');
                const phoneInput = document.getElementById('new-chat-phone');
                const messageInput = document.getElementById('new-chat-message');
                
                phoneInput.value = '';
                messageInput.value = '';
                
                // Agregar validaciÃ³n en tiempo real para solo nÃºmeros
                phoneInput.oninput = function() {
                    this.value = this.value.replace(/[^0-9]/g, '');
                    if (this.value.length > 10) {
                        this.value = this.value.slice(0, 10);
                    }
                };
                
                // Agregar enter para enviar
                messageInput.onkeypress = function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        createNewChat();
                    }
                };
                
                setTimeout(() => phoneInput.focus(), 300);
            }
        }

        function closeNewChatModal() {
            const modal = document.getElementById('new-chat-modal');
            if (modal) {
                modal.classList.add('hidden');
                document.getElementById('new-chat-phone').value = '';
                document.getElementById('new-chat-message').value = '';
            }
        }

        async function createNewChat(event) {
            if (event) {
                event.preventDefault();
            }
            
            const numero = document.getElementById('new-chat-phone').value.trim();
            let mensaje = document.getElementById('new-chat-message').value.trim();
            
            if (!numero) {
                showNotification('Por favor ingresa un nï¿½mero de telï¿½fono', 'error');
                return;
            }

            if (!/^[0-9]{10}$/.test(numero)) {
                showNotification('El nï¿½mero debe contener solo dï¿½gitos (10-15 caracteres)', 'error');
                return;
            }

            // Validar que empiece con 3 (nÃºmeros mÃ³viles en Colombia)
            if (!numero.startsWith('3')) {
                showNotification('El nÃºmero mÃ³vil debe comenzar con 3', 'error');
                return;
            }

            if (!mensaje) {
                mensaje = 'Buenos dï¿½as, Bienvenido a SOLUCNET';
            }

            // Validar que tengamos un token vÃ¡lido
            if (!token) {
                showNotification('âŒ No hay token de autorizaciÃ³n. Por favor, inicia sesiÃ³n nuevamente.', 'error');
                return;
            }

            try {
                console.log('ðŸ”„ Creando nuevo chat:', {
                    numeroIngresado: numero,
                    chatId: '57' + numero + '@c.us',
                    mensaje: mensaje,
                    token: token ? 'PRESENTE' : 'AUSENTE'
                });

                // Verificar estado de WhatsApp antes de enviar
                console.log('ðŸ” Verificando estado de WhatsApp...');
                try {
                    const statusResponse = await fetch('/api/stats', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (statusResponse.ok) {
                        const statusData = await statusResponse.json();
                        console.log('ðŸ“Š Estado WhatsApp:', statusData);
                        
                        if (!statusData.whatsappListo) {
                            showNotification('âš ï¸ WhatsApp no estÃ¡ conectado. Por favor, escanea el cÃ³digo QR primero.', 'warning');
                            return;
                        }
                    }
                } catch (statusError) {
                    console.warn('No se pudo verificar estado de WhatsApp:', statusError);
                    // Continuar de todas formas
                }

                // Crear AbortController para timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    controller.abort();
                    console.warn('â° PeticiÃ³n cancelada por timeout (30 segundos)');
                }, 30000);

                const response = await fetch('/api/send-message', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        chatId: '57' + numero + '@c.us',
                        message: mensaje
                    }),
                    signal: controller.signal
                });
                
                // Limpiar timeout si la peticiÃ³n se completÃ³
                clearTimeout(timeoutId);

                let data;
                try {
                    data = await response.json();
                    console.log('ðŸ“¡ Respuesta del servidor:', data);
                } catch (parseError) {
                    console.error('Error parsing JSON response:', parseError);
                    throw new Error(`HTTP ${response.status} - Error parsing server response`);
                }

                if (response.ok && data.success) {
                    showNotification(`âœ… Mensaje enviado exitosamente a +57${numero}`, 'success');
                    closeNewChatModal();
                    loadUsersAdmin();
                    setTimeout(() => selectChat(`57${numero}@c.us`), 1000);
                } else {
                    let errorMsg = 'Error enviando mensaje';
                    
                    if (response.status === 500) {
                        errorMsg = 'Error interno del servidor. Verifica que WhatsApp estÃ© conectado.';
                        console.error('HTTP 500 - Server Error:', data);
                    } else if (response.status === 401) {
                        errorMsg = 'Token de autorizaciÃ³n invÃ¡lido. Reinicia sesiÃ³n.';
                    } else if (response.status === 404) {
                        errorMsg = 'Endpoint no encontrado. Verifica la configuraciÃ³n del servidor.';
                    } else {
                        errorMsg = data.message || data.error || `Error HTTP ${response.status}`;
                    }
                    
                    showNotification(`âŒ ${errorMsg}`, 'error');
                    console.error('Error detallado:', {
                        status: response.status,
                        statusText: response.statusText,
                        data: data,
                        chatId: '57' + numero + '@c.us'
                    });
                }
            } catch (error) {
                console.error('Error creando nuevo chat:', error);
                
                let errorMessage = 'Error de conexiÃ³n al servidor';
                
                if (error.name === 'AbortError') {
                    errorMessage = 'â° La peticiÃ³n fue cancelada por timeout (30s). El servidor tardÃ³ demasiado en responder.';
                } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMessage = 'ðŸ”Œ Error de red - servidor no responde. Verifica tu conexiÃ³n.';
                } else if (error.message.includes('interrupted')) {
                    errorMessage = 'âš ï¸ PeticiÃ³n interrumpida - intenta de nuevo';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'ðŸ”Œ No se pudo conectar al servidor. Verifica que estÃ© funcionando.';
                } else if (error.message) {
                    errorMessage = `âŒ Error: ${error.message}`;
                }
                
                console.error('Detalles del error:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                
                showNotification(errorMessage, 'error');
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // FunciÃ³n para recuperar mensajes tras reconexiÃ³n de WhatsApp
        async function recoverMessagesAfterReconnection() {
            try {
                console.log('ðŸ”„ [RECOVERY] Iniciando recuperaciÃ³n de mensajes tras reconexiÃ³n...');
                
                const response = await fetch('/api/recovery/messages');
                const data = await response.json();
                
                if (data.success && data.recoveredChats && data.recoveredChats.length > 0) {
                    console.log(`ðŸ”„ [RECOVERY] ${data.totalChats} chats con mensajes recuperados`);
                    
                    // Actualizar lista de chats para mostrar los chats con mensajes recuperados
                    loadChats();
                    
                    // Si hay un chat actualmente seleccionado, refrescar sus mensajes
                    if (currentChatId) {
                        const chatRecuperado = data.recoveredChats.find(chat => chat.chatId === currentChatId);
                        if (chatRecuperado) {
                            console.log(`ðŸ”„ [RECOVERY] Refrescando chat activo: ${currentChatId}`);
                            loadMessagesSmart(currentChatId, true); // Forzar recarga completa
                        }
                    }
                    
                    // Mostrar notificaciÃ³n de recuperaciÃ³n exitosa
                    const totalMessages = data.recoveredChats.reduce((sum, chat) => sum + chat.totalRecovered, 0);
                    showNotification(`ðŸ”„ Recuperados ${totalMessages} mensajes de ${data.totalChats} conversaciones activas`, 'success');
                    
                } else {
                    console.log('ðŸ”„ [RECOVERY] No hay mensajes para recuperar');
                }
                
            } catch (error) {
                console.error('âŒ [RECOVERY] Error recuperando mensajes:', error);
                showNotification('âš ï¸ Error al recuperar mensajes tras reconexiÃ³n', 'warning');
            }
        }

        // Agregar headers de autenticaciï¿½n a las peticiones
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            if (token && args[0].startsWith('/api/')) {
                if (!args[1]) args[1] = {};
                if (!args[1].headers) args[1].headers = {};
                args[1].headers['Authorization'] = `Bearer ${token}`;
            }
            return originalFetch.apply(this, args);
        };
    </script>
</body>
</html>