<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOLUCNET - Panel de Control WhatsApp</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            height: 100vh;
            overflow: hidden;
            font-size: 14px;
        }

        /* Variables CSS para facilitar ajustes */
        :root {
            --sidebar-width-desktop: 350px;
            --sidebar-width-tablet: 280px;
            --sidebar-width-mobile: 250px;
            --header-height-desktop: 60px;
            --header-height-mobile: 50px;
            --primary-color: #00d4aa;
            --secondary-color: #17a2b8;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --success-color: #28a745;
            --border-radius: 8px;
        }

        .container {
            display: flex;
            height: calc(100vh - var(--header-height-desktop));
            margin-top: var(--header-height-desktop);
        }

        /* ===============================================
           HEADER PRINCIPAL - OPTIMIZADO PARA TODOS LOS TAMA�OS
           =============================================== */

        .main-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height-desktop);
            background: rgba(255, 255, 255, 0.95);
            border-bottom: 1px solid #e1e8ed;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 0;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .header-logo {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar-toggle-btn {
            background: #2a2f3a;
            color: #8b949e;
            border: none;
            padding: 6px 10px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 32px;
            height: 32px;
            flex-shrink: 0;
        }

        .sidebar-toggle-btn:hover {
            background: #3e4651;
            color: #ffffff;
        }

        .sidebar-toggle-btn.slide-right {
            transform: translateX(100px);
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            box-shadow: 0 4px 15px rgba(0, 212, 170, 0.4);
        }

        .user-info-btn {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.8em;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
            max-width: 120px;
            overflow: hidden;
        }

        .user-info-btn:hover {
            background: linear-gradient(135deg, #148496, #00b894);
            transform: translateY(-1px);
        }

        #user-name {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-role {
            font-size: 0.7em;
            opacity: 0.9;
            font-weight: 400;
        }

        .logout-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.8em;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .logout-btn:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        .qr-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(37, 211, 102, 0.1);
            border: 1px solid rgba(37, 211, 102, 0.3);
            border-radius: 8px;
            color: #25d366;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 8px;
        }

        .qr-btn:hover {
            background: rgba(37, 211, 102, 0.2);
            border-color: rgba(37, 211, 102, 0.5);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(37, 211, 102, 0.3);
        }

        .qr-btn i {
            font-size: 16px;
        }

        .qr-btn span {
            font-size: 14px;
        }

        .scan-qr-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #25d366, #128c7e);
            border: 1px solid rgba(37, 211, 102, 0.3);
            border-radius: 8px;
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 8px;
        }

        .scan-qr-btn:hover {
            background: linear-gradient(135deg, #128c7e, #075e54);
            border-color: rgba(37, 211, 102, 0.5);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.4);
        }

        .scan-qr-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(37, 211, 102, 0.3);
        }

        .scan-qr-btn i {
            font-size: 16px;
        }

        .scan-qr-btn span {
            font-size: 13px;
            white-space: nowrap;
        }

        .session-counter {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: linear-gradient(135deg, #17a2b8, #138496);
            border: 1px solid rgba(23, 162, 184, 0.3);
            border-radius: 8px;
            color: white;
            font-weight: 500;
            cursor: default;
            margin-right: 8px;
            font-family: 'Courier New', monospace;
            min-width: 80px;
        }

        .session-counter.warning {
            background: linear-gradient(135deg, #fd7e14, #e8680e);
            animation: pulse-warning 2s infinite;
        }

        .session-counter.critical {
            background: linear-gradient(135deg, #dc3545, #c82333);
            animation: pulse-critical 1s infinite;
        }

        @keyframes pulse-warning {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes pulse-critical {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .session-counter i {
            font-size: 14px;
            animation: clock-tick 1s infinite;
        }

        @keyframes clock-tick {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(5deg); }
        }

        .session-counter span {
            font-size: 13px;
            font-weight: bold;
            letter-spacing: 1px;
        }

        /* ===============================================
           SIDEBAR - COMPLETAMENTE RESPONSIVE
           =============================================== */

        .sidebar {
            width: var(--sidebar-width-desktop);
            background: #2a2f3a;
            color: white;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #3e4651;
            height: 100%;
            transition: all 0.3s ease;
        }

        .sidebar.hidden {
            width: 0;
            padding: 0;
            border: none;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 15px;
            background: #1e2329;
            border-bottom: 1px solid #3e4651;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .sidebar-header:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .sidebar-header h1 {
            font-size: 1.2em;
            margin-bottom: 5px;
            color: var(--primary-color);
        }

        .status {
            display: flex;
            align-items: center;
            font-size: 0.8em;
            color: #8b949e;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online {
            background: var(--success-color);
            box-shadow: 0 0 6px rgba(40, 167, 69, 0.5);
        }

        .status-offline {
            background: var(--danger-color);
            box-shadow: 0 0 6px rgba(220, 53, 69, 0.5);
        }

        /* Panel Buttons */
        .panel-buttons {
            display: flex;
            gap: 8px;
            padding: 15px;
            border-bottom: 1px solid #3e4651;
            flex-wrap: wrap;
        }

        .panel-btn {
            flex: 1;
            min-width: 80px;
            padding: 10px 8px;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8em;
            text-align: center;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .panel-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-omitted {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        }

        .btn-logs {
            background: linear-gradient(135deg, #6c5ce7, #a55eea);
        }

        .btn-admin {
            background: linear-gradient(135deg, #9c88ff, #6c5ce7);
        }

        .panel-btn i {
            font-size: 1em;
            margin-bottom: 2px;
        }

        .panel-btn span {
            font-size: 0.7em;
            line-height: 1;
        }

        /* New Chat Button */
        .new-chat-btn {
            width: 100%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .new-chat-btn:hover {
            background: linear-gradient(135deg, #00b894, #148496);
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0, 212, 170, 0.3);
        }

        /* Chat Filters */
        .chat-filters {
            padding: 10px 15px;
            border-bottom: 1px solid #3e4651;
        }

        .filter-buttons {
            display: flex;
            gap: 4px;
        }

        .filter-btn {
            flex: 1;
            padding: 6px 8px;
            background: #3e4651;
            border: none;
            border-radius: var(--border-radius);
            color: #8b949e;
            cursor: pointer;
            font-size: 0.7em;
            transition: all 0.3s ease;
            text-align: center;
        }

        .filter-btn.active {
            background: var(--primary-color);
            color: white;
        }

        .filter-btn:hover {
            background: #4a5568;
        }

        .filter-btn.active:hover {
            background: #00b894;
        }

        /* Chat List */
        .chat-list {
            flex: 1;
            overflow-y: auto;
        }

        .chat-item {
            padding: 12px 15px;
            border-bottom: 1px solid #3e4651;
            cursor: pointer;
            transition: background 0.2s ease;
            position: relative;
        }

        .chat-item:hover {
            background: #3e4651;
        }

        .chat-item.active {
            background: var(--primary-color);
            color: white;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .chat-name {
            font-weight: 600;
            font-size: 0.9em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-time {
            font-size: 0.7em;
            color: #8b949e;
            flex-shrink: 0;
        }

        .chat-preview {
            font-size: 0.8em;
            color: #8b949e;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-mode {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.6em;
            font-weight: bold;
        }

        .mode-bot {
            background: #007bff;
            color: white;
        }

        .mode-human {
            background: var(--success-color);
            color: white;
        }

        /* ===============================================
           �REA PRINCIPAL - RESPONSIVE
           =============================================== */

        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            height: 100%;
            overflow: hidden;
            min-width: 0;
        }

        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #8b949e;
            text-align: center;
            padding: 20px;
        }

        .empty-state i {
            font-size: 3em;
            margin-bottom: 15px;
            color: #e1e8ed;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #1a1a1a;
            font-size: 1.2em;
        }

        .empty-state p {
            font-size: 0.9em;
            line-height: 1.4;
        }

        /* Chat Area */
        .chat-area {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .chat-header-main {
            padding: 10px 15px;
            background: white;
            border-bottom: 1px solid #e1e8ed;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            min-height: 50px;
        }

        .back-to-sidebar-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            display: none;
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-title {
            font-size: 1em;
            font-weight: 600;
            color: #1a1a1a;
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-subtitle {
            font-size: 0.8em;
            color: #8b949e;
            margin-top: 2px;
        }

        .chat-actions {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }

        .action-btn {
            padding: 6px 10px;
            border: 1px solid #e1e8ed;
            background: white;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .action-btn:hover {
            background: #f8f9fa;
        }

        .action-btn.primary {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .action-btn.danger {
            background: var(--danger-color);
            color: white;
            border-color: var(--danger-color);
        }

        /* Messages Area */
        .messages-area {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #f0f2f5;
            min-height: 0;
        }

        .message {
            margin-bottom: 10px;
            display: flex;
            align-items: flex-start;
        }

        .message.outgoing {
            justify-content: flex-end;
        }

        .message-content {
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            font-size: 0.9em;
        }

        .message.incoming .message-content {
            background: white;
            border: 1px solid #e1e8ed;
            margin-right: 20px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .message.outgoing .message-content {
            background: var(--primary-color);
            color: white;
            margin-left: 20px;
        }

        .message-time {
            font-size: 0.7em;
            opacity: 0.7;
            margin-top: 4px;
            text-align: right;
        }

        /* Message Input Area */
        .message-input-area {
            padding: 10px 15px;
            background: white;
            border-top: 1px solid #e1e8ed;
            flex-shrink: 0;
        }

        .message-input-container {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            width: 100%;
        }

        .message-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #e1e8ed;
            border-radius: 20px;
            font-size: 0.9em;
            outline: none;
            resize: none;
            max-height: 80px;
            min-height: 36px;
            line-height: 1.4;
            font-family: inherit;
        }

        .message-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 212, 170, 0.2);
        }

        .attach-btn {
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 0.9em;
            flex-shrink: 0;
        }

        .attach-btn:hover {
            background: #5a6268;
        }

        .audio-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9em;
            flex-shrink: 0;
        }

        .audio-btn:hover {
            background: #c82333;
        }

        .audio-btn.recording {
            background: #ff4757;
            animation: pulse-recording 1s infinite;
        }

        @keyframes pulse-recording {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .send-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1em;
            transition: background 0.2s ease;
            flex-shrink: 0;
        }

        .send-btn:hover {
            background: #00b894;
        }

        .send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* ===============================================
           LOGIN SCREEN - RESPONSIVE
           =============================================== */

        .login-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.5s ease;
            padding: 15px;
        }

        .login-card {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-header h2 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.6em;
        }

        .login-header p {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 20px;
        }

        .login-form .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .login-form label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
            font-size: 0.9em;
        }

        .login-form input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 0.9em;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        .login-form input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 212, 170, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--primary-color), #00b894);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 212, 170, 0.3);
        }

        .login-error {
            background: #f8d7da;
            color: #721c24;
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 15px;
            border: 1px solid #f5c6cb;
            display: none;
            font-size: 0.8em;
        }

        .login-info {
            background: #d1ecf1;
            color: #0c5460;
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #bee5eb;
            font-size: 0.8em;
            text-align: left;
        }

        /* ===============================================
           MODALES - COMPLETAMENTE RESPONSIVE
           =============================================== */

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            animation: fadeIn 0.3s ease;
            padding: 15px;
        }

        .omitted-modal, .users-admin-modal, .logs-api-modal, .new-chat-modal,
        .edit-user-modal, .add-user-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            animation: fadeIn 0.3s ease;
            padding: 15px;
        }

        .omitted-modal.hidden, .users-admin-modal.hidden, .logs-api-modal.hidden,
        .new-chat-modal.hidden, .edit-user-modal.hidden, .add-user-modal.hidden {
            display: none;
        }

        .omitted-content, .new-chat-content {
            background: linear-gradient(145deg, #ffffff, #f8f9fa);
            padding: 20px;
            border-radius: 15px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            animation: modalSlideIn 0.4s ease;
        }

        .omitted-header, .new-chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f3f4;
        }

        .omitted-header h3, .new-chat-header h3 {
            margin: 0;
            color: #2d3748;
            font-size: 1.3em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .close-modal {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            border-radius: 8px;
            width: 32px;
            height: 32px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-modal:hover {
            background: linear-gradient(135deg, #ff5252, #d84315);
            transform: translateY(-2px);
        }

        /* Form Styles */
        .omitted-form, .new-chat-form {
            margin-bottom: 20px;
        }

        .omitted-form .form-row, .new-chat-form > div {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: flex-end;
        }

        .omitted-form input, .omitted-form textarea, .omitted-form select,
        .new-chat-form input, .new-chat-form textarea {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.9em;
            transition: all 0.3s ease;
            background: white;
        }

        .omitted-form input:focus, .omitted-form textarea:focus,
        .new-chat-form input:focus, .new-chat-form textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 212, 170, 0.1);
            outline: none;
        }

        .omitted-form textarea, .new-chat-form textarea {
            resize: vertical;
            min-height: 60px;
        }

        .new-chat-actions, .omitted-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 15px;
        }

        .btn-new-chat, .btn-cancel {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-new-chat {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .btn-cancel {
            background: #6c757d;
            color: white;
        }

        /* Lista Items */
        .omitted-list {
            padding-right: 5px;
            max-height: 400px;
            overflow-y: auto;
        }

        .omitted-item {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
            transition: all 0.3s ease;
        }

        .omitted-item:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .omitted-item .delete-btn, .omitted-item .edit-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            border: none;
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 0.7em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .omitted-item .delete-btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
        }

        .omitted-item .edit-btn {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            right: 50px;
        }

        .omitted-item .numero {
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 6px;
            font-size: 1em;
            padding-right: 60px;
        }

        .omitted-item .motivo {
            color: #4a5568;
            margin-bottom: 8px;
            line-height: 1.4;
            font-size: 0.9em;
        }

        .omitted-item .meta {
            color: #718096;
            font-size: 0.8em;
            font-style: italic;
        }

        /* File handling */
        .file-preview-area {
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            padding: 8px;
            max-height: 150px;
            overflow-y: auto;
        }

        .file-preview-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 8px;
        }

        .file-preview-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 150px;
            position: relative;
            font-size: 0.8em;
        }

        .file-preview-item.image {
            flex-direction: column;
            align-items: center;
            width: 100px;
        }

        .file-preview-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
        }

        .file-preview-remove {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Notification System */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 16px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 10002;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            font-size: 0.9em;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: var(--success-color);
        }

        .notification.error {
            background: var(--danger-color);
        }

        .notification.info {
            background: var(--secondary-color);
        }

        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #e1e8ed;
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        /* Scrollbar personalizado */
        .chat-list::-webkit-scrollbar,
        .messages-area::-webkit-scrollbar,
        .omitted-list::-webkit-scrollbar {
            width: 4px;
        }

        .chat-list::-webkit-scrollbar-track,
        .messages-area::-webkit-scrollbar-track,
        .omitted-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-list::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 2px;
        }

        .messages-area::-webkit-scrollbar-thumb,
        .omitted-list::-webkit-scrollbar-thumb {
            background: #e1e8ed;
            border-radius: 2px;
        }

        /* ===============================================
           RESPONSIVE BREAKPOINTS - OPTIMIZADO PARA TODOS LOS TAMA�OS
           =============================================== */

        /* Pantallas grandes (1200px+) */
        @media (min-width: 1200px) {
            .sidebar {
                width: var(--sidebar-width-desktop);
            }
            
            .header-logo {
                font-size: 1.4em;
            }
            
            .omitted-content, .new-chat-content {
                max-width: 750px;
                padding: 35px;
            }
        }

        /* Laptops y tablets horizontales (769px - 1199px) */
        @media (min-width: 769px) and (max-width: 1199px) {
            .sidebar {
                width: var(--sidebar-width-tablet);
            }
            
            .panel-buttons {
                display: grid;
                grid-template-columns: 1fr 1fr 1fr;
                gap: 6px;
            }
            
            .panel-btn {
                padding: 8px 6px;
                font-size: 0.75em;
                min-height: 50px;
            }
            
            .omitted-content, .new-chat-content {
                width: 90%;
                max-width: 650px;
                padding: 25px;
            }
        }

        /* Tablets verticales y m�viles grandes (481px - 768px) */
        @media (min-width: 481px) and (max-width: 768px) {
            :root {
                --header-height-desktop: var(--header-height-mobile);
            }
            
            .container {
                flex-direction: column;
                height: calc(100vh - var(--header-height-mobile));
                margin-top: var(--header-height-mobile);
            }
            
            .main-header {
                height: var(--header-height-mobile);
                padding: 0 12px;
            }
            
            .header-logo {
                font-size: 1em;
            }
            
            .user-info-btn, .logout-btn, .qr-btn, .scan-qr-btn, .session-counter {
                padding: 5px 8px;
                font-size: 0.75em;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                max-height: 100px;
                transition: max-height 0.3s ease;
                overflow: hidden;
            }
            
            .sidebar.expanded {
                max-height: calc(100vh - var(--header-height-mobile));
                height: auto;
                position: fixed;
                top: var(--header-height-mobile);
                left: 0;
                z-index: 999;
            }
            
            .sidebar.hidden {
                max-height: 0;
                width: 100%;
            }
            
            .sidebar-header::after {
                content: '?';
                color: #8b949e;
                font-size: 0.6em;
                margin-left: auto;
            }
            
            .sidebar.expanded .sidebar-header::after {
                transform: rotate(180deg);
            }
            
            .panel-buttons {
                display: grid;
                grid-template-columns: 1fr 1fr 1fr;
                gap: 6px;
                padding: 12px;
            }
            
            .panel-btn {
                padding: 8px 4px;
                font-size: 0.7em;
                min-height: 45px;
            }
            
            .main-area {
                flex: 1;
                height: calc(100vh - var(--header-height-mobile) - 100px);
            }
            
            .sidebar.expanded ~ .main-area {
                height: 0;
                overflow: hidden;
            }
            
            .omitted-content, .new-chat-content {
                width: 95%;
                padding: 20px;
                max-height: 85vh;
            }
            
            .login-card {
                padding: 25px;
                max-width: 350px;
            }
        }

        /* M�viles (200px - 480px) */
        @media (max-width: 480px) {
            :root {
                --header-height-mobile: 45px;
            }
            
            body {
                font-size: 12px;
            }
            
            .container {
                height: calc(100vh - var(--header-height-mobile));
                margin-top: var(--header-height-mobile);
            }
            
            .main-header {
                height: var(--header-height-mobile);
                padding: 0 8px;
            }
            
            .header-left {
                gap: 6px;
            }
            
            .header-right {
                gap: 4px;
            }
            
            .header-logo {
                font-size: 0.9em;
            }
            
            .header-logo i {
                font-size: 0.9em;
            }
            
            .sidebar-toggle-btn {
                width: 28px;
                height: 28px;
                padding: 4px;
                font-size: 0.8em;
            }
            
            .sidebar-toggle-btn.slide-right {
                transform: translateX(80px);
            }
            
            .user-info-btn {
                padding: 4px 6px;
                font-size: 0.7em;
                max-width: 80px;
            }
            
            .user-info-btn #user-name {
                display: none;
            }
            
            .user-info-btn .user-role {
                display: none;
            }
            
            .logout-btn {
                padding: 4px 6px;
                font-size: 0.7em;
            }
            
            .logout-btn span {
                display: none;
            }
            
            /* Sidebar m�vil optimizado */
            .sidebar {
                width: 100%;
                height: auto;
                max-height: 80px;
                transition: max-height 0.3s ease;
                overflow: hidden;
                background: #2a2f3a;
            }
            
            .sidebar.expanded {
                max-height: calc(100vh - var(--header-height-mobile));
                position: fixed;
                top: var(--header-height-mobile);
                left: 0;
                z-index: 999;
                overflow-y: auto;
            }
            
            .sidebar.hidden {
                max-height: 0;
            }
            
            .sidebar-header {
                padding: 10px 12px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .sidebar-header h1 {
                font-size: 1em;
            }
            
            .status {
                font-size: 0.7em;
            }
            
            .panel-buttons {
                display: grid;
                grid-template-columns: 1fr 1fr 1fr;
                gap: 4px;
                padding: 8px;
                opacity: 0;
                max-height: 0;
                overflow: hidden;
                transition: all 0.3s ease;
            }
            
            .sidebar.expanded .panel-buttons {
                opacity: 1;
                max-height: 70px;
            }
            
            .panel-btn {
                padding: 6px 3px;
                font-size: 0.6em;
                min-height: 35px;
                border-radius: 4px;
            }
            
            .panel-btn i {
                font-size: 0.9em;
            }
            
            .panel-btn span {
                font-size: 0.6em;
            }
            
            .new-chat-btn {
                margin: 8px;
                padding: 8px 12px;
                font-size: 0.8em;
                opacity: 0;
                max-height: 0;
                overflow: hidden;
                transition: all 0.3s ease;
            }
            
            .sidebar.expanded .new-chat-btn {
                opacity: 1;
                max-height: 50px;
            }
            
            .chat-filters {
                padding: 6px 8px;
                opacity: 0;
                max-height: 0;
                overflow: hidden;
                transition: all 0.3s ease;
            }
            
            .sidebar.expanded .chat-filters {
                opacity: 1;
                max-height: 50px;
            }
            
            .filter-btn {
                padding: 4px 6px;
                font-size: 0.6em;
                border-radius: 4px;
            }
            
            .chat-list {
                opacity: 0;
                max-height: 0;
                overflow: hidden;
                transition: all 0.3s ease;
            }
            
            .sidebar.expanded .chat-list {
                opacity: 1;
                max-height: calc(100vh - 280px);
                overflow-y: auto;
            }
            
            .chat-item {
                padding: 8px 12px;
                font-size: 0.8em;
            }
            
            .chat-name {
                font-size: 0.85em;
            }
            
            .chat-time {
                font-size: 0.65em;
            }
            
            .chat-preview {
                font-size: 0.7em;
            }
            
            /* Main area m�vil */
            .main-area {
                flex: 1;
                height: calc(100vh - var(--header-height-mobile) - 80px);
            }
            
            .sidebar.expanded ~ .main-area {
                height: 0;
                overflow: hidden;
            }
            
            .empty-state {
                padding: 15px;
            }
            
            .empty-state i {
                font-size: 2.5em;
            }
            
            .empty-state h3 {
                font-size: 1.1em;
            }
            
            .empty-state p {
                font-size: 0.8em;
            }
            
            /* Chat area m�vil */
            .chat-header-main {
                padding: 8px 12px;
                min-height: 40px;
            }
            
            .back-to-sidebar-btn {
                display: flex;
                padding: 4px 8px;
                font-size: 0.8em;
                margin-right: 8px;
            }
            
            .chat-title {
                font-size: 0.9em;
            }
            
            .chat-subtitle {
                font-size: 0.7em;
            }
            
            .chat-actions {
                gap: 4px;
            }
            
            .action-btn {
                padding: 4px 8px;
                font-size: 0.7em;
                border-radius: 4px;
            }
            
            .action-btn i {
                display: none;
            }
            
            /* Messages m�vil */
            .messages-area {
                padding: 8px;
                font-size: 0.85em;
            }
            
            .message-content {
                max-width: 90%;
                padding: 6px 10px;
                font-size: 0.85em;
            }
            
            .message.incoming .message-content {
                margin-right: 15px;
            }
            
            .message.outgoing .message-content {
                margin-left: 15px;
            }
            
            .message-time {
                font-size: 0.65em;
            }
            
            /* Input area m�vil */
            .message-input-area {
                padding: 8px;
            }
            
            .message-input-container {
                gap: 6px;
            }
            
            .message-input {
                padding: 6px 10px;
                font-size: 14px; /* Evita zoom en iOS */
                border-radius: 18px;
                min-height: 32px;
            }
            
            .attach-btn {
                width: 28px;
                height: 28px;
                font-size: 0.8em;
            }

            .audio-btn {
                width: 28px;
                height: 28px;
                font-size: 0.8em;
            }
            
            .send-btn {
                width: 32px;
                height: 32px;
                font-size: 0.9em;
            }
            
            /* Modales m�vil */
            .omitted-modal, .users-admin-modal, .logs-api-modal, .new-chat-modal,
            .edit-user-modal, .add-user-modal {
                padding: 8px;
                align-items: flex-start;
            }
            
            .omitted-content, .new-chat-content {
                width: 100%;
                max-width: none;
                height: 100vh;
                max-height: 100vh;
                border-radius: 0;
                padding: 15px;
                overflow-y: auto;
            }
            
            .omitted-header, .new-chat-header {
                margin-bottom: 15px;
                padding-bottom: 10px;
            }
            
            .omitted-header h3, .new-chat-header h3 {
                font-size: 1.1em;
            }
            
            .close-modal {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }
            
            /* Formularios m�vil */
            .omitted-form .form-row, .new-chat-form > div {
                flex-direction: column;
                gap: 8px;
            }
            
            .omitted-form input, .omitted-form textarea, .omitted-form select,
            .new-chat-form input, .new-chat-form textarea {
                padding: 10px 12px;
                font-size: 14px; /* Evita zoom en iOS */
                border-radius: 8px;
                min-height: 40px;
            }
            
            .omitted-form textarea, .new-chat-form textarea {
                min-height: 80px;
            }
            
            .new-chat-actions, .omitted-actions {
                flex-direction: column;
                gap: 8px;
                margin-top: 15px;
            }
            
            .btn-new-chat, .btn-cancel {
                width: 100%;
                padding: 12px 16px;
                font-size: 14px;
                min-height: 44px;
            }
            
            /* Lista items m�vil */
            .omitted-list {
                max-height: 300px;
                font-size: 0.85em;
            }
            
            .omitted-item {
                padding: 10px;
                margin-bottom: 8px;
            border-radius: 8px;
            }
            
            .omitted-item .delete-btn, .omitted-item .edit-btn {
                top: 8px;
                right: 8px;
                padding: 4px 8px;
                font-size: 0.65em;
            }
            
            .omitted-item .edit-btn {
                right: 40px;
            }
            
            .omitted-item .numero {
                font-size: 0.9em;
                padding-right: 70px;
            }
            
            .omitted-item .motivo {
                font-size: 0.8em;
            }
            
            .omitted-item .meta {
                font-size: 0.7em;
            }
            
            /* Login m�vil */
        .login-card {
                padding: 20px;
                margin: 10px;
                border-radius: 15px;
        }

        .login-header h2 {
                font-size: 1.4em;
        }

        .login-form input {
                padding: 12px;
                font-size: 14px; /* Evita zoom en iOS */
        }

        .login-btn {
            padding: 14px;
                font-size: 14px;
                min-height: 48px;
        }

        .login-info {
                font-size: 0.75em;
            }
            
            /* Notificaciones m�vil */
            .notification {
                top: 10px;
                right: 10px;
                left: 10px;
                transform: translateY(-100px);
                font-size: 0.8em;
                padding: 10px 12px;
            }
            
            .notification.show {
                transform: translateY(0);
            }
        }

        /* M�viles muy peque�os (200px - 320px) */
        @media (max-width: 320px) {
            :root {
                --header-height-mobile: 40px;
            }
            
            body {
                font-size: 11px;
            }
            
            .main-header {
                height: var(--header-height-mobile);
                padding: 0 6px;
            }
            
            .header-logo {
                font-size: 0.8em;
            }
            
            .sidebar-toggle-btn {
                width: 24px;
                height: 24px;
                font-size: 0.7em;
            }
            
            .sidebar-toggle-btn.slide-right {
                transform: translateX(60px);
            }
            
            .user-info-btn, .logout-btn, .qr-btn, .scan-qr-btn, .session-counter {
                padding: 3px 5px;
                font-size: 0.65em;
                min-width: 24px;
            }
            
            .sidebar {
                max-height: 70px;
            }
            
            .sidebar-header {
                padding: 8px 10px;
            }
            
            .sidebar-header h1 {
            font-size: 0.9em;
            }
            
            .status {
                font-size: 0.65em;
            }
            
            .panel-btn {
                padding: 4px 2px;
                font-size: 0.55em;
                min-height: 30px;
            }
            
            .panel-btn span {
                font-size: 0.5em;
            }
            
            .main-area {
                height: calc(100vh - var(--header-height-mobile) - 70px);
            }
            
            .chat-header-main {
                padding: 6px 8px;
                min-height: 35px;
            }
            
            .chat-title {
                font-size: 0.8em;
            }
            
            .chat-subtitle {
                font-size: 0.65em;
            }
            
            .action-btn {
                padding: 3px 6px;
                font-size: 0.65em;
            }
            
            .messages-area {
                padding: 6px;
                font-size: 0.8em;
            }
            
            .message-content {
                padding: 5px 8px;
                font-size: 0.8em;
            }
            
            .message-input-area {
                padding: 6px;
            }
            
            .message-input {
                padding: 5px 8px;
                min-height: 28px;
                font-size: 13px;
            }
            
            .attach-btn {
                width: 24px;
                height: 24px;
            }

            .audio-btn {
                width: 24px;
                height: 24px;
            }
            
            .send-btn {
                width: 28px;
                height: 28px;
            }
            
            .login-card {
                padding: 15px;
                margin: 5px;
            }
            
            .login-header h2 {
            font-size: 1.2em;
            }
            
            .login-form input {
                padding: 10px;
                font-size: 13px;
            }
            
            .login-btn {
                padding: 12px;
                font-size: 13px;
                min-height: 42px;
            }
            
            .omitted-content, .new-chat-content {
                padding: 12px;
            }
            
            .omitted-header h3, .new-chat-header h3 {
                font-size: 1em;
            }
            
            .close-modal {
                width: 24px;
                height: 24px;
                font-size: 10px;
            }
        }

        /* Orientaci�n landscape en m�viles */
        @media (max-width: 768px) and (orientation: landscape) {
            .main-header {
                height: 40px;
                padding: 0 10px;
            }
            
            .container {
                margin-top: 40px;
                height: calc(100vh - 40px);
            }
            
            .sidebar {
                max-height: 60px;
            }
            
            .sidebar.expanded {
                max-height: calc(100vh - 40px);
            }
            
            .main-area {
                height: calc(100vh - 40px - 60px);
            }
            
            .header-logo {
                font-size: 0.9em;
            }
            
            .empty-state i {
                font-size: 2em;
            }
            
            .empty-state h3 {
                font-size: 1em;
            }
        }

        /* Mejoras de accesibilidad */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Alto contraste */
        @media (prefers-contrast: high) {
            .sidebar {
                border-right: 3px solid #000;
            }
            
            .message-content {
                border: 2px solid #000;
            }
            
            .login-form input:focus,
            .message-input:focus {
                border: 3px solid #000;
                box-shadow: 0 0 0 2px #fff, 0 0 0 4px #000;
            }
        }

        /* Tema oscuro del sistema */
        @media (prefers-color-scheme: dark) {
            .login-container {
                background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
            }
            
            .empty-state {
                color: #a0aec0;
            }
            
            .main-header {
                background: rgba(45, 55, 72, 0.95);
                border-bottom-color: #4a5568;
            }
        }

        /* Estilos para mensajes de audio enviados */
        .audio-message-container {
            background: #f0f2f5;
            border-radius: 12px;
            padding: 12px;
            margin: 4px 0;
            border-left: 4px solid #0084ff;
            max-width: 280px;
        }
        
        .message.outgoing .audio-message-container {
            background: #dcf8c6;
            border-left-color: #25d366;
        }
        
        .audio-message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
        }
        
        .message.outgoing .audio-message-header {
            color: #2e7d32;
        }
        
        .sent-audio-player {
            width: 100%;
            height: 40px;
            border-radius: 8px;
            outline: none;
        }
        
        .sent-audio-player::-webkit-media-controls-panel {
            background-color: transparent;
        }
        
        .sent-audio-player::-webkit-media-controls-play-button,
        .sent-audio-player::-webkit-media-controls-pause-button {
            background-color: #0084ff;
            border-radius: 50%;
        }
        
        .message.outgoing .sent-audio-player::-webkit-media-controls-play-button,
        .message.outgoing .sent-audio-player::-webkit-media-controls-pause-button {
            background-color: #25d366;
        }
    </style>
</head>
<body>
    <!-- Pantalla de login -->
    <div class="login-container" id="login-container">
        <div class="login-card">
            <div class="login-header">
                <h2><i class="fab fa-whatsapp"></i> SOLUCNET</h2>
                <p>Panel de Control WhatsApp</p>
            </div>

            <form class="login-form" id="login-form">
                <div class="form-group">
                    <label for="username">Usuario</label>
                    <input type="text" id="username" name="username" required autocomplete="username">
                </div>

                <div class="form-group">
                    <label for="password">Contrase�a</label>
                    <input type="password" id="password" name="password" required autocomplete="current-password">
                </div>

                <div class="login-error" id="login-error"></div>

                <button type="submit" class="login-btn" id="login-btn">
                    <i class="fas fa-sign-in-alt"></i> Iniciar Sesi�n
                </button>
            </form>

            <div class="login-info">
                <strong>Usuarios disponibles:</strong><br>
                � Usuario: <strong>admin</strong> / Contrase�a: <strong>admin123</strong> (Administrador)<br>
                � Usuario: <strong>soporte</strong> / Contrase�a: <strong>soporte123</strong> (Soporte)
            </div>
        </div>
    </div>

    <!-- Contenedor principal de la aplicaci�n -->
    <div class="container" id="main-container" style="display: none;">
        <!-- Header principal -->
        <div class="main-header">
            <div class="header-left">
                <button class="sidebar-toggle-btn" id="sidebar-toggle-btn" title="Mostrar/Ocultar Panel">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="header-logo">
                    <i class="fab fa-whatsapp"></i>
                    SOLUCNET
                </div>
            </div>
            <div class="header-right">
                <button class="user-info-btn" id="user-info-btn" title="Informaci�n del Usuario">
                    <i class="fas fa-user"></i>
                    <span id="user-name">Usuario</span>
                    <span id="user-role" class="user-role">Rol</span>
                </button>
                <div class="session-counter" id="session-counter" title="Tiempo restante de sesión">
                    <i class="fas fa-clock"></i>
                    <span id="session-time">15:00</span>
                </div>
                <button class="scan-qr-btn" id="scan-qr-btn" title="Escanear código QR de WhatsApp">
                    <i class="fas fa-qrcode"></i>
                    <span>Escanear QR</span>
                </button>
                <button class="logout-btn" id="logout-btn" title="Cerrar sesi�n">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Salir</span>
                </button>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header" onclick="toggleSidebar()">
                <div>
                    <h1><i class="fab fa-whatsapp"></i> SOLUCNET</h1>
                    <div class="status">
                        <span class="status-indicator status-offline" id="connection-status"></span>
                        <span id="status-text">Conectando...</span>
                    </div>
                    </div>
                </div>
                
            <!-- Botones del panel -->
                <div class="panel-buttons">
                <button class="panel-btn btn-omitted" onclick="showOmittedModal()" title="N�meros Omitidos">
                        <i class="fas fa-ban"></i>
                        <span>Omitidos</span>
                    </button>
                    <button class="panel-btn btn-logs" onclick="showLogsAPIModal()" title="Logs de API">
                        <i class="fas fa-list"></i>
                        <span>Logs</span>
                    </button>
                    <button class="panel-btn btn-admin" onclick="showUsersAdminModal()" title="Administrar Usuarios">
                        <i class="fas fa-users-cog"></i>
                        <span>Usuarios</span>
                    </button>
                </div>
                
            <!-- Bot�n Nuevo Chat -->
            <button class="new-chat-btn" onclick="showNewChatModal()" title="Iniciar nueva conversaci�n">
                    <i class="fas fa-plus"></i>
                    Nuevo Chat
                </button>
                
                <!-- Filtros de Chat -->
                <div class="chat-filters">
                    <div class="filter-buttons">
                        <button class="filter-btn active" data-filter="all">
                            <i class="fas fa-comments"></i> Todos
                        </button>
                        <button class="filter-btn" data-filter="bot">
                            <i class="fas fa-robot"></i> Bot
                        </button>
                        <button class="filter-btn" data-filter="human">
                            <i class="fas fa-user"></i> Humano
                        </button>
                </div>
            </div>
            
            <!-- Lista de Chats -->
            <div class="chat-list" id="chat-list">
                <!-- Los chats se cargar�n aqu� din�micamente -->
            </div>
        </div>

        <!-- �rea principal -->
        <div class="main-area">
            <!-- Estado vac�o por defecto -->
            <div class="empty-state" id="empty-state">
                <i class="fab fa-whatsapp"></i>
                <h3>Panel de Control WhatsApp</h3>
                <p>Selecciona un chat para comenzar a ver y enviar mensajes</p>
                <p style="margin-top: 15px; font-size: 0.85em;">
                    <strong>Modos disponibles:</strong><br>
                    ?? <span style="color: #007bff;">Bot</span> - Conversaciones autom�ticas<br>
                    ?? <span style="color: #28a745;">Humano</span> - Intervenci�n manual
                </p>
            </div>

            <!-- �rea de chat (oculta por defecto) -->
            <div class="chat-area" id="chat-area" style="display: none;">
                <div class="chat-header-main">
                    <button class="back-to-sidebar-btn" id="back-to-sidebar-btn" onclick="showSidebarFromChat()" title="Volver al Panel">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div class="chat-info">
                        <div class="chat-title" id="current-chat-name">Cliente</div>
                        <div class="chat-subtitle" id="current-chat-subtitle">En l�nea</div>
                </div>
                    <div class="chat-actions">
                        <button class="action-btn" id="toggle-mode-btn">
                            <i class="fas fa-exchange-alt"></i> <span>Cambiar Modo</span>
                        </button>
                        <button class="action-btn danger" id="end-chat-btn">
                            <i class="fas fa-times"></i> <span>Finalizar</span>
                        </button>
                    </div>
                </div>

                <div class="messages-area" id="messages-area">
                    <!-- Los mensajes se cargar�n aqu� -->
            </div>

                <div class="message-input-area" id="message-input-area">
                    <!-- �rea de preview de archivos -->
                    <div class="file-preview-area" id="file-preview-area" style="display: none;">
                        <div class="file-preview-list" id="file-preview-list">
                            <!-- Previews de archivos aparecer�n aqu� -->
                </div>
                        <button class="clear-files-btn" id="clear-files-btn">
                            <i class="fas fa-times"></i> Limpiar
                        </button>
                    </div>
                    
                    <div class="message-input-container">
                        <button class="attach-btn" id="attach-btn" title="Adjuntar archivo">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <button class="audio-btn" id="audio-btn" title="Grabar audio">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <input type="file" id="file-input" style="display: none;" multiple 
                               accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt,.zip,.rar">
                        <textarea 
                            class="message-input" 
                            id="message-input" 
                            placeholder="Escribe un mensaje..."
                            rows="1"
                        ></textarea>
                        <button class="send-btn" id="send-btn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    
                    <!-- Overlay para drag and drop -->
                    <div class="drag-overlay" id="drag-overlay" style="display: none;">
                        <div class="drag-content">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Suelta los archivos aqu� para enviarlos</p>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        </div>

       
    <style>
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Asegurar que el modal QR sea visible sobre otros elementos */
    .qr-modal {
        backdrop-filter: blur(5px);
        border: 2px solid rgba(37, 211, 102, 0.3);
    }

    /* Animación de entrada para el modal QR */
    .qr-modal:not(.hidden) {
        animation: slideInFromRight 0.3s ease-out;
    }

    /* Animación de salida para el modal QR */
    .qr-modal.hidden {
        animation: slideOutToRight 0.2s ease-in;
    }

    @keyframes slideInFromRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes slideOutToRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
    </style>

    <!-- Modal para n�meros omitidos -->
    <div class="omitted-modal hidden" id="omitted-modal">
        <div class="omitted-content">
            <div class="omitted-header">
                <h3><i class="fas fa-user-slash"></i> N�meros Omitidos</h3>
                <button class="close-modal" onclick="closeOmittedModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="omitted-form">
                <h4 style="margin: 0 0 15px 0; color: #2d3748; font-size: 1.1em;">Agregar nuevo n�mero omitido</h4>
                <div class="form-row">
                    <input type="text" id="omitted-number" placeholder="N�mero (ej: 573001234567)" maxlength="20">
                    <button class="panel-btn btn-omitted" onclick="agregarNumeroOmitido()" style="flex-shrink: 0;">
                        <i class="fas fa-plus"></i> Agregar
                    </button>
                </div>
                <textarea id="omitted-reason" placeholder="Motivo por el cual se omite este n�mero (opcional)" rows="2"></textarea>
            </div>

            <div class="omitted-list" id="omitted-list">
                <!-- Lista de n�meros omitidos se cargar� aqu� -->
            </div>
        </div>
    </div>

    <!-- Modal para administraci�n de usuarios -->
    <div class="users-admin-modal hidden" id="users-admin-modal">
        <div class="omitted-content" style="max-width: 700px;">
            <div class="omitted-header">
                <h3><i class="fas fa-users-cog"></i> Administraci�n de Usuarios</h3>
                <button class="close-modal" onclick="closeUsersAdminModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Bot�n para agregar nuevo usuario -->
            <div style="text-align: center; margin: 15px 0; padding: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px;">
                <button class="panel-btn" onclick="showAddUserModal()" style="background: white; color: #667eea; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all 0.3s ease;">
                    <i class="fas fa-user-plus"></i> Agregar Nuevo Usuario
                </button>
            </div>

            <div class="omitted-list" id="users-admin-list">
                <!-- Lista de usuarios se cargar� aqu� -->
            </div>
        </div>
    </div>

    <!-- Modal para editar usuarios -->
    <div class="edit-user-modal hidden" id="edit-user-modal">
        <div class="omitted-content" style="max-width: 500px;">
            <div class="omitted-header">
                <h3><i class="fas fa-user-edit"></i> Editar Usuario</h3>
                <button class="close-modal" onclick="closeEditUserModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="omitted-form">
                <input type="hidden" id="edit-user-id">
                <input type="text" id="edit-user-username" placeholder="Nombre de usuario" maxlength="50" style="width: 100%; margin-bottom: 10px;">
                <input type="password" id="edit-user-password" placeholder="Nueva contrase�a (opcional)" maxlength="100" style="width: 100%; margin-bottom: 10px;">
                <select id="edit-user-role" style="width: 100%; margin-bottom: 10px; padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px;">
                        <option value="soporte">Soporte</option>
                        <option value="admin">Administrador</option>
                    </select>
                <input type="text" id="edit-user-nombre" placeholder="Nombre completo" style="width: 100%; margin-bottom: 15px;">
                <div style="text-align: center;">
                    <button class="panel-btn btn-admin" onclick="actualizarUsuario()" style="padding: 10px 25px; font-size: 0.9em;">
                        <i class="fas fa-save"></i> Actualizar Usuario
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para agregar nuevos usuarios -->
    <div class="add-user-modal hidden" id="add-user-modal">
        <div class="omitted-content" style="max-width: 500px;">
            <div class="omitted-header">
                <h3><i class="fas fa-user-plus"></i> Agregar Nuevo Usuario</h3>
                <button class="close-modal" onclick="closeAddUserModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="omitted-form">
                <input type="text" id="new-user-username" placeholder="Nombre de usuario" maxlength="50" style="width: 100%; margin-bottom: 10px;">
                <input type="password" id="new-user-password" placeholder="Contrase�a" maxlength="100" style="width: 100%; margin-bottom: 10px;">
                <select id="new-user-role" style="width: 100%; margin-bottom: 10px; padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px;">
                        <option value="soporte">Soporte</option>
                        <option value="admin">Administrador</option>
                    </select>
                <input type="text" id="new-user-nombre" placeholder="Nombre completo" style="width: 100%; margin-bottom: 15px;">
                <div style="text-align: center;">
                    <button class="panel-btn btn-admin" onclick="agregarUsuario()" style="padding: 10px 25px; font-size: 0.9em; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white; border-radius: 8px;">
                        <i class="fas fa-save"></i> Crear Usuario
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para nuevo chat -->
    <div class="new-chat-modal hidden" id="new-chat-modal">
        <div class="omitted-content" style="max-width: 400px;">
            <div class="omitted-header">
                <h3><i class="fas fa-plus"></i> Nuevo Chat</h3>
                <button class="close-modal" onclick="closeNewChatModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="omitted-form">
                <div style="margin-bottom: 15px;">
                    <label for="new-chat-phone" style="display: block; margin-bottom: 5px; font-weight: bold;">Número de teléfono:</label>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <span style="padding: 8px 12px; background: #f8f9fa; border: 2px solid #e2e8f0; border-radius: 8px 0 0 8px; color: #666;">+57</span>
                        <input type="tel" id="new-chat-phone" placeholder="3001234567" maxlength="10" 
                               style="flex: 1; padding: 8px 12px; border: 2px solid #e2e8f0; border-left: none; border-radius: 0 8px 8px 0;">
                    </div>
                    <small style="color: #666; font-size: 0.8em;">Solo ingresa los 10 dígitos del número móvil</small>
                </div>

                <div style="margin-bottom: 15px;">
                    <label for="new-chat-message" style="display: block; margin-bottom: 5px; font-weight: bold;">Mensaje inicial:</label>
                    <textarea id="new-chat-message" placeholder="Escribe el primer mensaje..." rows="3"
                              style="width: 100%; padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px; resize: vertical; min-height: 60px;"></textarea>
                </div>

                <div style="text-align: center; display: flex; gap: 10px;">
                    <button class="panel-btn" onclick="closeNewChatModal()" 
                            style="flex: 1; padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px;">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button class="panel-btn btn-admin" onclick="createNewChat()" id="create-chat-btn"
                            style="flex: 1; padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 8px;">
                        <i class="fas fa-paper-plane"></i> Enviar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para logs de API -->
    <div class="logs-api-modal hidden" id="logs-api-modal">
        <div class="omitted-content" style="max-width: 900px;">
            <div class="omitted-header">
                <h3><i class="fas fa-history"></i> Logs de API</h3>
                <button class="close-modal" onclick="closeLogsAPIModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <select id="logs-filter-estado" onchange="loadLogsAPI()" style="padding: 6px 10px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 0.8em;">
                        <option value="">Todos los estados</option>
                        <option value="enviado">Enviado</option>
                        <option value="error_envio">Error de env�o</option>
                        <option value="error_parametros">Error de par�metros</option>
                        <option value="error_whatsapp_no_listo">WhatsApp no listo</option>
                        <option value="error_excepcion">Error de excepci�n</option>
                    </select>
                    <button class="panel-btn btn-logs" onclick="loadLogsAPI()" style="padding: 6px 12px; font-size: 0.8em;">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                </div>
                <div style="font-size: 0.8em; color: #666;">
                    �ltimos 100 registros
                </div>
            </div>

            <div class="omitted-list" id="logs-api-list">
                <!-- Lista de logs se cargar� aqu� -->
            </div>
        </div>
    </div>

    <!-- Modal para nuevo chat -->
    <div class="new-chat-modal hidden" id="new-chat-modal">
        <div class="new-chat-content">
            <div class="new-chat-header">
                <h3><i class="fas fa-comment-dots"></i> Nuevo Chat</h3>
                <button class="close-modal" onclick="closeNewChatModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form class="new-chat-form" onsubmit="createNewChat(event)">
                <div>
                    <label for="new-chat-number" style="display: block; margin-bottom: 6px; font-weight: 600; color: #4a5568; font-size: 0.9em;">
                        N�mero de tel�fono <span style="color: #e53e3e;">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="new-chat-number" 
                        placeholder="Ej: 573001234567" 
                        required
                        pattern="[0-9]{10,15}"
                        title="Ingresa un n�mero v�lido (solo d�gitos, 10-15 caracteres)"
                    >
                    <small style="color: #718096; font-size: 0.75em; display: block; margin-top: 4px;">
                        Formato: c�digo pa�s + n�mero (sin espacios ni s�mbolos)
                    </small>
                </div>
                
                <div>
                    <label for="new-chat-message" style="display: block; margin-bottom: 6px; font-weight: 600; color: #4a5568; font-size: 0.9em;">
                        Mensaje inicial (opcional)
                    </label>
                    <textarea 
                        id="new-chat-message" 
                        placeholder="Si no escribes nada, se enviar�: 'Buenos d�as, Bienvenido a SOLUCNET'"
                        rows="3"
                    ></textarea>
                </div>

                <div class="new-chat-actions">
                    <button type="button" class="btn-cancel" onclick="closeNewChatModal()">
                        Cancelar
                    </button>
                    <button type="submit" class="btn-new-chat">
                        <i class="fas fa-paper-plane"></i>
                        Crear Chat
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- �rea de notificaciones -->
    <div id="notifications"></div>

    <script>
        // Variables globales
        let currentChatId = null;
        let chats = new Map();
        let currentFilter = 'all';
        let socket = null;
        let isConnected = false;
        let qrModalClosedByConnection = false; // Flag para saber si el modal se cerró por conexión exitosa
        let currentUser = null;
        let token = null;
        let selectedFiles = [];

        // Inicializaci�n
        document.addEventListener('DOMContentLoaded', function() {
            checkExistingSession();
            setupLoginEvents();
        });

        function checkExistingSession() {
            const savedToken = localStorage.getItem('token');
            console.log('🔍 Checking existing session...');
            console.log('📋 Saved token in localStorage:', savedToken ? 'EXISTS' : 'NULL');
            
            if (savedToken) {
                console.log('✅ Token found, verifying session...');
                verifySession(savedToken);
            } else {
                console.log('❌ No token found, showing login screen');
                showLoginScreen();
            }
        }

        function showLoginScreen() {
            const loginContainer = document.getElementById('login-container');
            const mainContainer = document.getElementById('main-container');
            
            if (loginContainer) loginContainer.style.display = 'flex';
            if (mainContainer) mainContainer.style.display = 'none';
        }

        function setupLoginEvents() {
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }

            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
            }
        }

        async function handleLogin(e) {
            e.preventDefault();

            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const loginBtn = document.getElementById('login-btn');

            if (!username || !password) {
                showLoginError('Por favor ingresa usuario y contrase�a');
                return;
            }

            try {
                loginBtn.disabled = true;
                loginBtn.innerHTML = '<div class="loading"></div> Iniciando...';

                console.log('🔐 Iniciando proceso de login...');
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                console.log('📡 Respuesta del servidor:', response.status);

                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('Credenciales incorrectas');
                    } else if (response.status === 403) {
                        throw new Error('Acceso denegado');
                    } else if (response.status >= 500) {
                        throw new Error('Error del servidor. Intenta más tarde');
                    } else {
                        throw new Error(`Error HTTP ${response.status}`);
                    }
                }

                const data = await response.json();
                console.log('📋 Datos de respuesta:', data);

                if (data.success && data.token) {
                    console.log('=== LOGIN SUCCESSFUL - Starting QR modal sequence ===');
                    currentUser = data.user;
                    token = data.token;
                    localStorage.setItem('token', token);

                    // Validar la sesión antes de mostrar la app
                    console.log('🔍 Validando sesión después del login...');
                    const sessionValid = await validateSession();
                    if (!sessionValid) {
                        throw new Error('Sesión no pudo ser validada después del login');
                    }

                    // Resetear flag para permitir mostrar el modal QR en esta nueva sesión
                    qrModalClosedByConnection = false;
                    console.log('QR modal flag reset to:', qrModalClosedByConnection);

                    // Inicializar los botones QR, contador de sesión y manejo de errores de audio
                    console.log('Initializing QR buttons, session counter and audio error handling...');
                    initializeQRButton();
                    initializeScanQRButton();
                    initializeSessionCounter();
                    setupAudioErrorHandling();

                    // Verificar que el modal QR esté oculto después del login
                    setTimeout(() => {
                        const qrModal = document.getElementById('qr-modal');
                        if (qrModal && !qrModal.classList.contains('hidden')) {
                            console.error('❌ QR modal is visible after login - this should not happen!');
                            console.log('QR modal classes:', qrModal.classList.toString());
                            // Forzar ocultar el modal
                            qrModal.classList.add('hidden');
                            console.log('✅ QR modal forced hidden after login');
                        } else {
                            console.log('✅ QR modal correctly hidden after login');
                        }
                    }, 500);
                    
                    showMainApp();
                    initializeApp();
                    setupEventListeners();
                    startPolling();

                    // Iniciar mantenimiento automático de sesión
                    initializeSessionMaintenance();
                    
                    showNotification('Sesi�n iniciada correctamente', 'success');
                } else {
                    showLoginError(data.message || 'Error de autenticaci�n');
                }
            } catch (error) {
                console.error('❌ Error en login:', error);
                showLoginError(error.message || 'Error de conexión. Intenta nuevamente.');

                // Limpiar datos corruptos si es necesario
                localStorage.removeItem('token');
                token = null;
                currentUser = null;
            } finally {
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Iniciar Sesi�n';
            }
        }

        function showLoginError(message) {
            const loginError = document.getElementById('login-error');
            if (loginError) {
                loginError.textContent = message;
                loginError.style.display = 'block';
                setTimeout(() => loginError.style.display = 'none', 5000);
            }
        }

        // Función para validar sesión antes de operaciones críticas
        async function validateSession() {
            if (!token) {
                console.error('❌ No hay token para validar');
                showNotification('Sesión no iniciada', 'error');
                showLoginScreen();
                return false;
            }

            try {
                console.log('🔍 Validando sesión activa...');
                const response = await fetch(`/api/session?token=${token}`);
                const data = await response.json();

                if (data.success && data.user) {
                    console.log('✅ Sesión válida:', data.user.username);
                    currentUser = data.user;
                    return true;
                } else {
                    console.error('❌ Sesión inválida o expirada');
                    showNotification('Sesión expirada. Redirigiendo al login...', 'error');
                    localStorage.removeItem('token');
                    token = null;
                    showLoginScreen();
                    return false;
                }
            } catch (error) {
                console.error('❌ Error validando sesión:', error);
                showNotification('Error de conexión. Verificando sesión...', 'error');
                // Intentar reconectar en 3 segundos
                setTimeout(() => {
                    if (token) validateSession();
                }, 3000);
                return false;
            }
        }

        async function verifySession(savedToken) {
            try {
                console.log('🔐 Verificando sesión en inicialización...');
                console.log('🎫 Token to verify:', savedToken.substring(0, 20) + '...');
                const response = await fetch(`/api/session?token=${savedToken}`);
                console.log('📡 Response status:', response.status);
                const data = await response.json();
                console.log('📋 Response data:', data);

                if (data.success) {
                    currentUser = data.user;
                    // Asignar el token a la variable global
                    token = savedToken;
                    window.token = savedToken;
                    console.log('✅ Sesión verificada exitosamente:', data.user.username);
                    console.log('🎫 Token assigned to global scope:', savedToken.substring(0, 20) + '...');

                    // Validar sesión completa antes de mostrar la app
                    const isValid = await validateSession();
                    if (isValid) {
                        showMainApp();
                        initializeApp();
                        setupEventListeners();
                        startPolling();
                        // Iniciar mantenimiento automático de sesión
                        initializeSessionMaintenance();
                    }
                } else {
                    console.error('❌ Verificación de sesión fallida');
                    console.error('📋 Failed response data:', data);
                    localStorage.removeItem('token');
                    showLoginScreen();
                }
            } catch (error) {
                console.error('❌ Error verificando sesión:', error);
                console.error('📋 Error details:', error.message);
                localStorage.removeItem('token');
                showLoginScreen();
            }
        }

        function showMainApp() {
            const loginContainer = document.getElementById('login-container');
            const mainContainer = document.getElementById('main-container');

            if (loginContainer) loginContainer.style.display = 'none';
            if (mainContainer) mainContainer.style.display = 'flex';

            updateUserInfo();
        }

        function updateUserInfo() {
            const userName = document.getElementById('user-name');
            const userRole = document.getElementById('user-role');

            if (userName && currentUser) {
                userName.textContent = currentUser.nombre;
            }

            if (userRole && currentUser) {
                userRole.textContent = `(${currentUser.rol === 'admin' ? 'Administrador' : 'Soporte'})`;
            }
        }

        async function handleLogout() {
            try {
                if (token) {
                    await fetch('/api/logout', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token })
                    });
                }
            } catch (error) {
                console.error('Error en logout:', error);
            } finally {
                currentUser = null;
                token = null;
                localStorage.removeItem('token');

                const loginContainer = document.getElementById('login-container');
                const mainContainer = document.getElementById('main-container');

                if (loginContainer) loginContainer.style.display = 'flex';
                if (mainContainer) mainContainer.style.display = 'none';

                document.getElementById('username').value = '';
                document.getElementById('password').value = '';

                showNotification('Sesi�n cerrada correctamente', 'info');
            }
        }

        function initializeApp() {
            // NO ocultar el modal QR aquí - debe mantenerse visible hasta que WhatsApp se conecte
            // El modal QR se muestra en handleLogin() antes de inicializar la app

            // Inicializar manejo de errores de audio
            setupAudioErrorHandling();

            // Verificar conexión después de un pequeño delay
            setTimeout(() => {
                checkConnectionStatus();
            }, 1000);
            loadChats();
        }

        function setupEventListeners() {
            if (window.eventListenersSetup) return;
            window.eventListenersSetup = true;

            // Filtros de chat
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.dataset.filter;
                    filterChats();
                });
            });

            // Manejo de archivos
            setupFileHandling();

            // Env�o de mensajes
            const messageInput = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');

            if (messageInput) {
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 100) + 'px';
            });
            }

            if (sendBtn) {
                sendBtn.addEventListener('click', sendMessage);
            }

            // Configurar grabación de audio
            setupAudioRecording();

            // Botones de acci�n
            const toggleModeBtn = document.getElementById('toggle-mode-btn');
            const endChatBtn = document.getElementById('end-chat-btn');
            const userInfoBtn = document.getElementById('user-info-btn');
            const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');

            if (toggleModeBtn) toggleModeBtn.addEventListener('click', toggleChatMode);
            if (endChatBtn) endChatBtn.addEventListener('click', endChat);
            if (userInfoBtn) userInfoBtn.addEventListener('click', showUserInfo);
            if (sidebarToggleBtn) sidebarToggleBtn.addEventListener('click', toggleSidebar);
        }

        // Funci�n para toggle del sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('sidebar-toggle-btn');
            const icon = toggleBtn.querySelector('i');
            const chatArea = document.getElementById('chat-area');

            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('expanded');

                if (sidebar.classList.contains('expanded')) {
                    toggleBtn.classList.add('slide-right');
                    icon.className = 'fas fa-arrow-left';
                    toggleBtn.title = 'Ocultar Panel';

                    if (chatArea && chatArea.classList.contains('fullscreen')) {
                        chatArea.classList.remove('fullscreen');
                    }
                } else {
                    toggleBtn.classList.remove('slide-right');
                    icon.className = 'fas fa-bars';
                    toggleBtn.title = 'Mostrar Panel';
                }
            } else {
                sidebar.classList.toggle('hidden');

                if (sidebar.classList.contains('hidden')) {
                    icon.className = 'fas fa-arrow-right';
                    toggleBtn.title = 'Mostrar Panel';
                } else {
                    icon.className = 'fas fa-bars';
                    toggleBtn.title = 'Ocultar Panel';
                }
            }
        }

        // ===== FUNCIONALIDAD DE GRABACIÓN DE AUDIO =====
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let recordingStartTime = null;

        function setupAudioRecording() {
            const audioBtn = document.getElementById('audio-btn');
            if (!audioBtn) return;

            audioBtn.addEventListener('click', toggleAudioRecording);
        }

        async function toggleAudioRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        async function startRecording() {
            try {
                console.log('🎤 Iniciando grabación de audio...');
                
                // Solicitar permisos de micrófono
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 44100
                    } 
                });

                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm;codecs=opus'
                });

                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    handleRecordingComplete();
                    // Detener el stream
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                isRecording = true;
                recordingStartTime = Date.now();

                // Actualizar UI
                const audioBtn = document.getElementById('audio-btn');
                audioBtn.classList.add('recording');
                audioBtn.innerHTML = '<i class="fas fa-stop"></i>';
                audioBtn.title = 'Detener grabación';

                showNotification('🎤 Grabando audio... Click para detener', 'info');

            } catch (error) {
                console.error('Error iniciando grabación:', error);
                showNotification('❌ Error accediendo al micrófono. Verifica permisos.', 'error');
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                console.log('⏹️ Deteniendo grabación...');
                mediaRecorder.stop();
                isRecording = false;

                // Actualizar UI
                const audioBtn = document.getElementById('audio-btn');
                audioBtn.classList.remove('recording');
                audioBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                audioBtn.title = 'Grabar audio';
            }
        }

        async function handleRecordingComplete() {
            try {
                const recordingDuration = Date.now() - recordingStartTime;
                console.log(`🎵 Grabación completada. Duración: ${recordingDuration}ms`);

                if (recordingDuration < 1000) {
                    showNotification('⚠️ La grabación debe durar al menos 1 segundo', 'warning');
                    return;
                }

                // Crear blob de audio
                const audioBlob = new Blob(audioChunks, { 
                    type: 'audio/webm;codecs=opus' 
                });

                console.log('📁 Audio blob creado:', {
                    size: audioBlob.size,
                    type: audioBlob.type
                });

                // Mostrar vista previa del audio antes de enviar
                showAudioPreview(audioBlob);

            } catch (error) {
                console.error('Error procesando audio:', error);
                showNotification('❌ Error procesando el audio grabado', 'error');
            }
        }

        function showAudioPreview(audioBlob) {
            console.log('🔊 Mostrando vista previa de audio');
            
            // Crear URL del blob para reproducción
            const audioUrl = URL.createObjectURL(audioBlob);
            const duration = Math.round((Date.now() - recordingStartTime) / 1000);
            
            // Crear elemento de vista previa
            const previewContainer = document.createElement('div');
            previewContainer.className = 'audio-preview-container';
            previewContainer.innerHTML = `
                <div class="audio-preview-header">
                    <i class="fas fa-microphone"></i>
                    <span>Audio grabado (${duration}s)</span>
                    <button class="audio-preview-close" onclick="cancelAudioPreview()">&times;</button>
                </div>
                <div class="audio-preview-content">
                    <audio controls class="audio-preview-player">
                        <source src="${audioUrl}" type="audio/webm">
                        Tu navegador no soporta la reproducción de audio.
                    </audio>
                    <div class="audio-preview-actions">
                        <button class="audio-preview-btn cancel" onclick="cancelAudioPreview()">
                            <i class="fas fa-trash"></i> Descartar
                        </button>
                        <button class="audio-preview-btn send" onclick="confirmSendAudio()">
                            <i class="fas fa-paper-plane"></i> Enviar
                        </button>
                    </div>
                </div>
            `;
            
            // Agregar estilos
            const style = document.createElement('style');
            style.textContent = `
                .audio-preview-container {
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: white;
                    border-radius: 12px;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                    z-index: 10000;
                    min-width: 350px;
                    max-width: 400px;
                    width: 90%;
                    max-height: 90vh;
                    overflow: hidden;
                }
                
                @media (max-width: 480px) {
                    .audio-preview-container {
                        min-width: 300px;
                        width: 95%;
                        max-width: none;
                    }
                    
                    .audio-preview-content {
                        padding: 16px !important;
                    }
                    
                    .audio-preview-actions {
                        flex-direction: column;
                        gap: 8px !important;
                    }
                    
                    .audio-preview-btn {
                        width: 100%;
                        justify-content: center;
                    }
                }
                
                .audio-preview-header {
                    background: #0084ff;
                    color: white;
                    padding: 12px 16px;
                    border-radius: 12px 12px 0 0;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    font-weight: 500;
                }
                
                .audio-preview-close {
                    margin-left: auto;
                    background: none;
                    border: none;
                    color: white;
                    font-size: 20px;
                    cursor: pointer;
                    padding: 0;
                    width: 24px;
                    height: 24px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }
                
                .audio-preview-close:hover {
                    background: rgba(255,255,255,0.2);
                }
                
                .audio-preview-content {
                    padding: 20px;
                }
                
                .audio-preview-player {
                    width: 100%;
                    margin-bottom: 16px;
                    border-radius: 6px;
                }
                
                .audio-preview-actions {
                    display: flex;
                    gap: 12px;
                    justify-content: center;
                }
                
                .audio-preview-btn {
                    padding: 10px 20px;
                    border: none;
                    border-radius: 6px;
                    font-weight: 500;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 6px;
                    transition: all 0.2s ease;
                }
                
                .audio-preview-btn.cancel {
                    background: #f44336;
                    color: white;
                }
                
                .audio-preview-btn.cancel:hover {
                    background: #d32f2f;
                }
                
                .audio-preview-btn.send {
                    background: #4caf50;
                    color: white;
                }
                
                .audio-preview-btn.send:hover {
                    background: #388e3c;
                }
                
                .audio-preview-overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    z-index: 9999;
                }
            `;
            
            // Crear overlay de fondo
            const overlay = document.createElement('div');
            overlay.className = 'audio-preview-overlay';
            overlay.onclick = () => cancelAudioPreview();
            
            // Agregar elementos al DOM
            document.head.appendChild(style);
            document.body.appendChild(overlay);
            document.body.appendChild(previewContainer);
            
            // Guardar referencias globales
            window.currentAudioBlob = audioBlob;
            window.currentAudioUrl = audioUrl;
            window.currentPreviewContainer = previewContainer;
            window.currentPreviewOverlay = overlay;
            window.currentPreviewStyle = style;
            
            // Agregar listener para cerrar con Escape
            const escapeHandler = (e) => {
                if (e.key === 'Escape') {
                    cancelAudioPreview();
                }
            };
            document.addEventListener('keydown', escapeHandler);
            window.currentEscapeHandler = escapeHandler;
            
            // Focus en el primer botón y configurar eventos de audio
            setTimeout(() => {
                const firstBtn = previewContainer.querySelector('.audio-preview-btn');
                if (firstBtn) firstBtn.focus();
                
                // Configurar eventos del reproductor de audio
                const audioPlayer = previewContainer.querySelector('.audio-preview-player');
                if (audioPlayer) {
                    audioPlayer.addEventListener('play', () => {
                        console.log('▶️ Reproduciendo audio grabado');
                    });
                    
                    audioPlayer.addEventListener('pause', () => {
                        console.log('⏸️ Audio pausado');
                    });
                    
                    audioPlayer.addEventListener('ended', () => {
                        console.log('⏹️ Reproducción terminada');
                    });
                }
            }, 100);
        }

        function cancelAudioPreview() {
            console.log('❌ Cancelando vista previa de audio');
            
            // Limpiar URL del blob
            if (window.currentAudioUrl) {
                URL.revokeObjectURL(window.currentAudioUrl);
            }
            
            // Remover elementos del DOM
            if (window.currentPreviewContainer) {
                window.currentPreviewContainer.remove();
            }
            if (window.currentPreviewOverlay) {
                window.currentPreviewOverlay.remove();
            }
            if (window.currentPreviewStyle) {
                window.currentPreviewStyle.remove();
            }
            
            // Remover listener del teclado
            if (window.currentEscapeHandler) {
                document.removeEventListener('keydown', window.currentEscapeHandler);
            }
            
            // Limpiar referencias
            window.currentAudioBlob = null;
            window.currentAudioUrl = null;
            window.currentPreviewContainer = null;
            window.currentPreviewOverlay = null;
            window.currentPreviewStyle = null;
            window.currentEscapeHandler = null;
            
            showNotification('🗑️ Audio descartado', 'info');
        }

        function confirmSendAudio() {
            console.log('✅ Confirmando envío de audio');
            
            const audioBlob = window.currentAudioBlob;
            
            // Limpiar vista previa
            cancelAudioPreview();
            
            // Enviar audio
            if (audioBlob) {
                sendAudioMessage(audioBlob);
            }
        }

        async function sendAudioMessage(audioBlob) {
            if (!currentChatId) {
                showNotification('❌ No hay chat seleccionado', 'error');
                return;
            }

            try {
                console.log('📤 Enviando audio a:', currentChatId);

                // Crear FormData con el audio
                const formData = new FormData();
                const audioFile = new File([audioBlob], `audio_${Date.now()}.webm`, {
                    type: 'audio/webm;codecs=opus'
                });
                
                formData.append('audio', audioFile);
                formData.append('chatId', currentChatId);

                // Crear AbortController para timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    controller.abort();
                    console.warn('⏰ Envío de audio cancelado por timeout (60 segundos)');
                }, 60000);

                showNotification('📤 Enviando audio...', 'info');

                const response = await fetch('/api/send-audio', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData,
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (response.ok) {
                    const data = await response.json();
                    console.log('✅ Audio enviado exitosamente:', data);
                    showNotification('✅ Audio enviado correctamente', 'success');
                    
                    // Recargar mensajes después de un momento
                    setTimeout(() => {
                        if (currentChatId) {
                            loadMessagesSmart(currentChatId);
                        }
                    }, 1000);

                } else {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('❌ Error enviando audio:', response.status, errorData);
                    showNotification(`❌ Error enviando audio: ${errorData.message || response.status}`, 'error');
                }

            } catch (error) {
                console.error('Error enviando audio:', error);
                
                let errorMessage = '❌ Error enviando audio';
                if (error.name === 'AbortError') {
                    errorMessage = '⏰ Timeout enviando audio - el archivo era demasiado grande o la conexión lenta';
                } else if (error.message) {
                    errorMessage = `❌ Error: ${error.message}`;
                }
                
                showNotification(errorMessage, 'error');
            }
        }

        function showSidebarFromChat() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('sidebar-toggle-btn');
            const icon = toggleBtn.querySelector('i');
            const chatArea = document.getElementById('chat-area');

            sidebar.classList.remove('hidden');
            sidebar.classList.add('expanded');

            toggleBtn.classList.add('slide-right');
            icon.className = 'fas fa-arrow-left';
            toggleBtn.title = 'Ocultar Panel';

            if (chatArea && chatArea.classList.contains('fullscreen')) {
                chatArea.classList.remove('fullscreen');
            }
        }

        function showUserInfo() {
            const userName = document.getElementById('user-name').textContent;
            const userRole = document.getElementById('user-role').textContent;

            const modalHTML = `
                <div class="modal-overlay">
                    <div style="background: white; border-radius: 20px; width: 90%; max-width: 400px; overflow: hidden; animation: modalSlideIn 0.3s ease;">
                        <div style="background: linear-gradient(135deg, #17a2b8, #00d4aa); color: white; padding: 20px; display: flex; align-items: center; justify-content: space-between;">
                            <h3 style="margin: 0; font-size: 1.2em; display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-user"></i> Informaci�n del Usuario
                            </h3>
                            <button onclick="closeUserInfoModal()" style="background: rgba(255, 255, 255, 0.2); border: none; color: white; padding: 8px; border-radius: 6px; cursor: pointer;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div style="padding: 30px; text-align: center;">
                            <div style="font-size: 4em; color: #17a2b8; margin-bottom: 20px;">
                                <i class="fas fa-user-circle"></i>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #e9ecef;">
                                    <label style="font-weight: 600; color: #495057; font-size: 0.9em;">Nombre:</label>
                                    <span style="font-weight: 500; color: #212529;">${userName}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #e9ecef;">
                                    <label style="font-weight: 600; color: #495057; font-size: 0.9em;">Rol:</label>
                                    <span style="background: linear-gradient(135deg, #00d4aa, #17a2b8); color: white; padding: 4px 12px; border-radius: 15px; font-size: 0.8em; font-weight: 600;">${userRole}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0;">
                                    <label style="font-weight: 600; color: #495057; font-size: 0.9em;">Estado:</label>
                                    <span style="display: flex; align-items: center; gap: 5px; color: #28a745; font-weight: 600; font-size: 0.9em;">
                                        <i class="fas fa-circle" style="font-size: 0.7em;"></i> Conectado
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeUserInfoModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) modal.remove();
        }

        // Cerrar modal al hacer clic fuera
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal-overlay')) {
                closeUserInfoModal();
            }
        });

        // Cerrar modal con tecla Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeUserInfoModal();
                closeOmittedModal();
                closeUsersAdminModal();
                closeLogsAPIModal();
                closeNewChatModal();
                closeEditUserModal();
                closeAddUserModal();
            }
        });

        async function checkConnectionStatus() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();

                console.log('Connection status response:', data); // Debug log
                
                const statusIndicator = document.getElementById('connection-status');
                const statusText = document.getElementById('status-text');
                
                // Verificar múltiples indicadores de conexión
                const isWhatsAppReady = data.whatsappListo || data.connected || data.ready;
                console.log('WhatsApp ready status:', isWhatsAppReady); // Debug log

                if (isWhatsAppReady) {
                    statusIndicator.className = 'status-indicator status-online';
                    statusText.textContent = 'WhatsApp Conectado';
                    isConnected = true;

                    // Marcar que WhatsApp está conectado para futuras referencias
                    qrModalClosedByConnection = true;

                    // Actualizar visibilidad de los botones QR (ocultarlos)
                    updateQRButtonVisibility();
                    updateScanQRButtonVisibility();

                    // Verificar si el modal QR está visible
                    const qrModal = document.getElementById('qr-modal');
                    const isModalVisible = qrModal && !qrModal.classList.contains('hidden');

                    if (isModalVisible) {
                        // Actualizar indicador de estado
                        updateQRStatusIndicator('connected', '<i class="fas fa-check-circle"></i> ¡WhatsApp conectado! La ventana se cerrará automáticamente...');

                        // Mostrar notificación de conexión exitosa
                        showNotification('¡WhatsApp conectado exitosamente!', 'success');

                        // Cerrar el modal después de 2 segundos para dar tiempo a que el usuario vea la confirmación
                        setTimeout(() => {
                            hideQRModalByConnection();
                        }, 2000);
                    } else {
                        console.log('WhatsApp connected - QR modal was not visible');
                        // Asegurar que el modal esté cerrado por si acaso
                        hideQRModalByConnection();
                    }

                    console.log('WhatsApp connected - hiding QR modal');
                    console.log('Connection data:', {
                        whatsappListo: data.whatsappListo,
                        connected: data.connected,
                        ready: data.ready,
                        hasSession: data.hasSession,
                        sessionActive: data.sessionActive
                    });
                } else {
                    statusIndicator.className = 'status-indicator status-offline';
                    statusText.textContent = 'WhatsApp Desconectado';
                    isConnected = false;

                    // Actualizar visibilidad de los botones QR
                    updateQRButtonVisibility();
                    updateScanQRButtonVisibility();

                    console.log('WhatsApp disconnected - connection data:', {
                        whatsappListo: data.whatsappListo,
                        connected: data.connected,
                        ready: data.ready,
                        hasSession: data.hasSession,
                        sessionActive: data.sessionActive
                    });

                    // No mostrar automáticamente el modal QR - solo mostrar el botón
                    console.log('QR button available for manual QR display');
                }
            } catch (error) {
                console.error('Error checking connection:', error);
                const statusIndicator = document.getElementById('connection-status');
                const statusText = document.getElementById('status-text');
                statusIndicator.className = 'status-indicator status-offline';
                statusText.textContent = 'Error de Conexión';

                // Verificar si el modal QR ya está visible
                const qrModal = document.getElementById('qr-modal');
                const isModalVisible = qrModal && !qrModal.classList.contains('hidden');

                if (!isModalVisible) {
                    // Actualizar indicador de estado a error y mostrar modal
                    updateQRStatusIndicator('error', '<i class="fas fa-exclamation-triangle"></i> Error de conexión - Reintentando...');
                    showQRModal();
                } else {
                    // Solo actualizar el indicador si el modal ya está visible
                    updateQRStatusIndicator('error', '<i class="fas fa-exclamation-triangle"></i> Error de conexión - Reintentando...');
                }
            }
        }

        async function loadChats() {
            try {
                const response = await fetch('/api/chats');
                if (response.ok) {
                    const data = await response.json();
                    updateChatList(data.chats || []);
                }
            } catch (error) {
                console.error('Error loading chats:', error);
            }
        }

        function updateChatList(chatData) {
            const chatList = document.getElementById('chat-list');
            
            chatData.forEach(chat => {
                chats.set(chat.id, chat);
            });

            renderChatList();
        }

        function renderChatList() {
            const chatList = document.getElementById('chat-list');
            const filteredChats = Array.from(chats.values()).filter(chat => {
                if (currentFilter === 'all') return true;
                return chat.mode === currentFilter;
            });

            if (filteredChats.length === 0) {
                chatList.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #8b949e;">
                        <i class="fas fa-comments" style="font-size: 2em; margin-bottom: 10px;"></i>
                        <p>No hay chats ${currentFilter === 'all' ? '' : 'en modo ' + currentFilter}</p>
                    </div>
                `;
                return;
            }

            chatList.innerHTML = filteredChats.map(chat => `
                <div class="chat-item ${chat.id === currentChatId ? 'active' : ''}" 
                     onclick="selectChat('${chat.id}')">
                    <div class="chat-mode mode-${chat.mode}">${chat.mode === 'bot' ? 'BOT' : 'HUMANO'}</div>
                    ${chat.unreadCount > 0 ? `<div style="position: absolute; top: 8px; right: 8px; background: #dc3545; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 0.7em; display: flex; align-items: center; justify-content: center; font-weight: bold;">${chat.unreadCount}</div>` : ''}
                    <div class="chat-header">
                        <div class="chat-name">${chat.name}</div>
                        <div class="chat-time">${formatTime(chat.lastActivity)}</div>
                    </div>
                    <div class="chat-preview">${chat.lastMessage || 'Sin mensajes'}</div>
                </div>
            `).join('');
        }

        function selectChat(chatId) {
            // Reiniciar hash de mensajes cuando se cambia de chat para permitir actualizaciones en tiempo real
            lastMessagesHash = '';
            currentChatId = chatId;
            const chat = chats.get(chatId);

            if (!chat) return;

            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('sidebar');
                const toggleBtn = document.getElementById('sidebar-toggle-btn');
                const icon = toggleBtn.querySelector('i');

                sidebar.classList.remove('expanded');
                sidebar.classList.add('hidden');
                toggleBtn.classList.remove('slide-right');
                icon.className = 'fas fa-bars';
                toggleBtn.title = 'Mostrar Panel';

                document.getElementById('chat-area').classList.add('fullscreen');
            }

            renderChatList();
            showChatArea(chat);
            loadMessages(chatId);

            if (chat.unreadCount > 0) {
                markAsRead(chatId);
            }

            // Forzar una verificación inmediata de mensajes después de seleccionar el chat
            setTimeout(() => {
                if (currentChatId === chatId) {
                    console.log(`🚀 Iniciando verificación inmediata para chat ${chatId}`);
                    loadMessagesSmart(chatId);
                }
            }, 1000);

            // Asegurar que el polling esté activo
            if (!messagePollingInterval) {
                console.log('⚠️ Polling no estaba activo, reiniciando...');
                startSmartMessagePolling();
            }
        }

        function showChatArea(chat) {
            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('chat-area').style.display = 'flex';
            
            document.getElementById('current-chat-name').textContent = chat.name;
            document.getElementById('current-chat-subtitle').textContent = 
                `Modo ${chat.mode === 'bot' ? 'Bot' : 'Humano'} � ${chat.phone}`;
                
            const toggleBtn = document.getElementById('toggle-mode-btn');
            toggleBtn.innerHTML = chat.mode === 'bot' ? 
                '<i class="fas fa-user"></i> <span>Cambiar a Humano</span>' : 
                '<i class="fas fa-robot"></i> <span>Cambiar a Bot</span>';
        }

        async function loadMessages(chatId) {
            try {
                const response = await fetch(`/api/chats/${chatId}/messages`);
                if (response.ok) {
                const data = await response.json();
                    displayMessages(data.messages || []);
                }
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }



        // Función para generar IDs únicos para mensajes
        function generateMessageId(msg, index) {
            if (msg.id) return msg.id;
            if (msg.timestamp) return `msg-${msg.timestamp}-${index}`;
            return `msg-${Date.now()}-${index}`;
        }

        // Función para guardar el estado de los elementos de audio
        function saveAudioStates() {
            const audioElements = document.querySelectorAll('audio');
            const audioStates = new Map();

            audioElements.forEach((audio, index) => {
                const messageElement = audio.closest('.message');
                if (messageElement) {
                    const messageId = messageElement.dataset.messageId || `audio-${index}`;

                    // Guardar estado de TODOS los audios que tengan progreso
                    if (audio.currentTime > 0) {
                        // Verificar más precisamente si el audio está realmente reproduciéndose
                        const isActuallyPlaying = !audio.paused && audio.readyState >= 2 && !audio.ended;

                        audioStates.set(messageId, {
                            currentTime: audio.currentTime,
                            isPlaying: isActuallyPlaying,
                            volume: audio.volume,
                            muted: audio.muted,
                            src: audio.src,
                            duration: audio.duration,
                            playbackRate: audio.playbackRate,
                            timestamp: Date.now(),
                            readyState: audio.readyState,
                            ended: audio.ended
                        });

                        if (isActuallyPlaying) {
                            console.log(`💾 Audio guardado: ${messageId} - Tiempo: ${audio.currentTime.toFixed(2)}s - Reproduciéndose activamente`);
                        } else if (!audio.paused) {
                            console.log(`💾 Audio guardado: ${messageId} - Tiempo: ${audio.currentTime.toFixed(2)}s - Cargando...`);
                        } else {
                            console.log(`💾 Audio guardado: ${messageId} - Tiempo: ${audio.currentTime.toFixed(2)}s - Pausado`);
                        }
                    }
                }
            });

            console.log(`🎵 Estados de audio guardados: ${audioStates.size} elementos`);
            return audioStates;
        }

        // Función para restaurar el estado de los elementos de audio
        function restoreAudioStates(audioStates) {
            setTimeout(() => {
                const audioElements = document.querySelectorAll('audio');
                let restoredCount = 0;

                audioElements.forEach((audio, index) => {
                    const messageElement = audio.closest('.message');
                    if (messageElement) {
                        const messageId = messageElement.dataset.messageId || `audio-${index}`;
                        const savedState = audioStates.get(messageId);

                        if (savedState && savedState.src === audio.src) {
                            // Restaurar propiedades básicas
                            audio.currentTime = savedState.currentTime;
                            audio.volume = savedState.volume;
                            audio.muted = savedState.muted;
                            audio.playbackRate = savedState.playbackRate || 1;

                            restoredCount++;

                            if (savedState.isPlaying) {
                                // Reanudar reproducción automáticamente con un pequeño delay
                                setTimeout(() => {
                                    audio.play().then(() => {
                                        console.log(`▶️ Audio reanudado automáticamente: ${messageId} - Posición: ${audio.currentTime.toFixed(2)}s`);
                                    }).catch(error => {
                                        console.log(`⚠️ No se pudo reanudar audio automáticamente: ${messageId} - Error: ${error.message}`);
                                        console.log(`💡 El usuario puede hacer clic en play para continuar reproduciendo`);
                                    });
                                }, 50);

                                console.log(`🔄 Audio restaurado y reanudándose: ${messageId} - Posición: ${audio.currentTime.toFixed(2)}s`);
                            } else {
                                console.log(`✅ Audio restaurado: ${messageId} - Posición: ${audio.currentTime.toFixed(2)}s - Estaba pausado`);
                            }
                        }
                    }
                });

                if (restoredCount > 0) {
                    console.log(`🎵 Estados de audio restaurados: ${restoredCount} elementos`);
                    console.log(`▶️ Los audios que estaban reproduciéndose se reanudan automáticamente`);
                    console.log(`💡 Si no se reanudan, verifica la configuración de autoplay del navegador`);
                } else {
                    console.log(`ℹ️ No se encontraron audios para restaurar`);
                }
            }, 150);
        }

        function displayMessages(messages) {
            const messagesArea = document.getElementById('messages-area');

            if (!messages || messages.length === 0) {
                messagesArea.innerHTML = '';
                return;
            }

            // 1. Guardar estado de audio ANTES de actualizar contenido
            const audioStates = saveAudioStates();

            // 2. Actualizar contenido del chat
            messagesArea.innerHTML = messages.map((msg, index) => {
                const messageId = generateMessageId(msg, index);
                return `
                    <div class="message ${msg.fromMe ? 'outgoing' : 'incoming'}" data-message-id="${messageId}">
                    <div class="message-content">
                        <div class="message-text">${formatMessageBody(msg.body)}</div>
                        <div class="message-time">
                            ${formatTime(msg.timestamp)}
                            ${msg.fromMe ? `<span class="message-status">${getMessageStatus(msg.status)}</span>` : ''}
                        </div>
                    </div>
                </div>
                `;
            }).join('');

            // 3. Restaurar estado de audio DESPUÉS de actualizar contenido
            restoreAudioStates(audioStates);

            // 4. Hacer scroll al final
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();

            if ((!message && selectedFiles.length === 0) || !currentChatId) return;

            const sendBtn = document.getElementById('send-btn');
            const originalContent = sendBtn.innerHTML;

            const restoreButton = () => {
                try {
                    sendBtn.innerHTML = originalContent;
                    sendBtn.disabled = false;
                } catch (error) {
                    console.error('Error restaurando bot�n:', error);
                }
            };

            try {
                sendBtn.innerHTML = '<div class="loading"></div>';
                sendBtn.disabled = true;

                if (selectedFiles.length > 0) {
                    await sendFiles(message);
                } else if (message) {
                    const response = await fetch('/api/send-message', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            chatId: currentChatId,
                            message: message
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                            addMessageToUI({
                                body: message,
                                fromMe: true,
                                timestamp: Date.now(),
                                status: 'sending'
                            });
                            showNotification('Mensaje enviado', 'success');
                    } else {
                        const errorText = await response.text();
                        console.error('Error en respuesta:', errorText);
                        showNotification('Error enviando mensaje', 'error');
                    }
                }

                input.value = '';
                input.style.height = 'auto';
                clearFiles();

            } catch (error) {
                console.error('Error en sendMessage:', error);
                    showNotification('Error enviando mensaje', 'error');
            } finally {
                restoreButton();
            }
        }

        async function sendFiles(caption = '') {
            if (selectedFiles.length === 0) return;

            const formData = new FormData();
            formData.append('chatId', currentChatId);
            if (caption) formData.append('caption', caption);

            selectedFiles.forEach((file, index) => {
                formData.append('files', file);
            });

            try {
                const response = await fetch('/api/send-files', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();

                    selectedFiles.forEach(file => {
                            let content = '';
                            if (file.type.startsWith('image/')) {
                                const imageUrl = URL.createObjectURL(file);
                                content = `<img src="${imageUrl}" alt="${file.name}" style="max-width: 200px; border-radius: 8px;">`;
                            } else {
                            content = `?? ${file.name} (${formatFileSize(file.size)})`;
                            }

                            addMessageToUI({
                                body: content,
                                fromMe: true,
                                timestamp: Date.now(),
                                status: 'sending',
                                isMedia: true
                            });
                    });

                    if (caption) {
                            addMessageToUI({
                                body: caption,
                                fromMe: true,
                                timestamp: Date.now(),
                                status: 'sending'
                            });
                    }

                        showNotification(`${selectedFiles.length} archivo(s) enviado(s)`, 'success');
                } else {
                    const errorData = await response.json().catch(() => ({ error: 'Error desconocido' }));
                    showNotification(`Error enviando archivos: ${errorData.error}`, 'error');
                }
            } catch (error) {
                console.error('Error en sendFiles:', error);
                    showNotification('Error enviando archivos', 'error');
            }
        }

        function addMessageToUI(message) {
            const messagesArea = document.getElementById('messages-area');
            const messageElement = document.createElement('div');
            messageElement.className = `message ${message.fromMe ? 'outgoing' : 'incoming'}`;
            
            messageElement.innerHTML = `
                <div class="message-content">
                    <div class="message-text">${formatMessageBody(message.body)}</div>
                    <div class="message-time">
                        ${formatTime(message.timestamp)}
                        ${message.fromMe ? `<span class="message-status">${getMessageStatus(message.status)}</span>` : ''}
                    </div>
                </div>
            `;
            
            messagesArea.appendChild(messageElement);
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        async function toggleChatMode() {
            if (!currentChatId) return;
            
            try {
                const response = await fetch(`/api/chats/${currentChatId}/toggle-mode`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const chat = chats.get(currentChatId);
                    chat.mode = data.mode;
                    
                    showChatArea(chat);
                    renderChatList();
                    showNotification(`Modo cambiado a ${data.mode === 'bot' ? 'Bot' : 'Humano'}`, 'success');
                }
            } catch (error) {
                console.error('Error toggling mode:', error);
                showNotification('Error cambiando modo', 'error');
            }
        }

        async function endChat() {
            if (!currentChatId) return;
            
            if (!confirm('�Est�s seguro de que quieres finalizar este chat?')) return;
            
            try {
                const response = await fetch(`/api/chats/${currentChatId}/end`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    chats.delete(currentChatId);
                    currentChatId = null;
                    
                    document.getElementById('empty-state').style.display = 'flex';
                    document.getElementById('chat-area').style.display = 'none';
                    
                    renderChatList();
                    showNotification('Chat finalizado', 'success');
                }
            } catch (error) {
                console.error('Error ending chat:', error);
                showNotification('Error finalizando chat', 'error');
            }
        }

        async function markAsRead(chatId) {
            try {
                await fetch(`/api/chats/${chatId}/mark-read`, { method: 'POST' });
                const chat = chats.get(chatId);
                if (chat) {
                    chat.unreadCount = 0;
                    renderChatList();
                }
            } catch (error) {
                console.error('Error marking as read:', error);
            }
        }

        function filterChats() {
            renderChatList();
        }

        async function showQRModal() {
            console.log('=== showQRModal() called ===');

            // Verificar si ya existe un modal QR superpuesto
            let overlayModal = document.getElementById('qr-overlay-modal');

            if (!overlayModal) {
                console.log('📱 Creando modal QR superpuesto...');

                // Crear modal superpuesto
                overlayModal = document.createElement('div');
                overlayModal.id = 'qr-overlay-modal';
                overlayModal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    animation: modalFadeIn 0.3s ease;
                    backdrop-filter: blur(3px);
                `;

                overlayModal.innerHTML = `
                    <div style="
                        background: white;
                        border-radius: 16px;
                        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                        max-width: 420px;
                        width: 90%;
                        max-height: 90vh;
                        overflow: hidden;
                        position: relative;
                        animation: modalSlideIn 0.4s ease;
                        transform: scale(0.9);
                        animation-fill-mode: forwards;
                    ">
                        <!-- Header -->
                        <div style="
                            background: linear-gradient(135deg, #25d366, #128c7e);
                            color: white;
                            padding: 20px 25px;
                            text-align: center;
                            position: relative;
                        ">
                            <button onclick="hideQROverlayModal()" style="
                                position: absolute;
                                top: 15px;
                                right: 15px;
                                background: rgba(255, 255, 255, 0.2);
                                border: none;
                                color: white;
                                font-size: 24px;
                                cursor: pointer;
                                padding: 5px 10px;
                                border-radius: 50%;
                                transition: all 0.2s ease;
                                width: 40px;
                                height: 40px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-weight: bold;
                            " onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'">
                                ×
                            </button>
                            <div style="margin-bottom: 12px;">
                                <i class="fab fa-whatsapp" style="font-size: 36px; opacity: 0.9;"></i>
                            </div>
                            <h2 style="margin: 0 0 8px 0; font-size: 22px; font-weight: 600;">
                                Escanear Código QR
                            </h2>
                            <p style="margin: 0; font-size: 14px; opacity: 0.9; line-height: 1.4;">
                                Escanea el código QR con WhatsApp para conectar tu dispositivo
                            </p>
                        </div>

                        <!-- QR Content -->
                        <div style="padding: 30px;">
                            <div id="qr-overlay-code" style="
                                background: #f8f9fa;
                                border-radius: 12px;
                                padding: 25px;
                                margin-bottom: 20px;
                                min-height: 320px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                border: 2px dashed #e0e0e0;
                            ">
                                <div class="loading" style="
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    color: #666;
                                    flex-direction: column;
                                    text-align: center;
                                ">
                                    <div style="
                                        border: 4px solid #f3f3f3;
                                        border-top: 4px solid #25d366;
                                        border-radius: 50%;
                                        width: 45px;
                                        height: 45px;
                                        animation: spin 1s linear infinite;
                                        margin-bottom: 15px;
                                    "></div>
                                    <strong style="font-size: 16px; margin-bottom: 8px;">Cargando código QR...</strong>
                                    <small style="color: #888;">Esto puede tomar unos segundos</small>
                                </div>
                            </div>

                            <!-- Instructions -->
                            <div style="
                                background: linear-gradient(135deg, #e3f2fd, #bbdefb);
                                border-radius: 10px;
                                padding: 18px;
                                font-size: 14px;
                                color: #1976d2;
                                border-left: 4px solid #2196f3;
                            ">
                                <strong style="color: #0d47a1;">📱 Instrucciones para escanear:</strong><br>
                                <div style="margin-top: 8px; line-height: 1.5;">
                                    1. Abre WhatsApp en tu teléfono<br>
                                    2. Toca ⋮ > Dispositivos vinculados<br>
                                    3. Selecciona "Vincular dispositivo"<br>
                                    4. Escanea el código QR de arriba
                                </div>
                            </div>

                            <!-- Botón de actualizar -->
                            <div style="
                                text-align: center;
                                margin-top: 15px;
                            ">
                                <button onclick="refreshQRImage()" style="
                                    background: linear-gradient(135deg, #25d366, #128c7e);
                                    color: white;
                                    border: none;
                                    padding: 8px 16px;
                                    border-radius: 6px;
                                    font-size: 12px;
                                    cursor: pointer;
                                    transition: all 0.2s ease;
                                    display: flex;
                                    align-items: center;
                                    margin: 0 auto;
                                " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                    <i class="fas fa-sync-alt" style="margin-right: 5px;"></i>
                                    Actualizar QR
                                </button>
                            </div>

                            <!-- Footer -->
                            <div style="
                                text-align: center;
                                margin-top: 15px;
                                padding-top: 15px;
                                border-top: 1px solid #e0e0e0;
                                color: #666;
                                font-size: 12px;
                            ">
                                <i class="fas fa-info-circle" style="margin-right: 5px;"></i>
                                El modal se cerrará automáticamente cuando te conectes
                            </div>
                        </div>
                    </div>
                `;

                document.body.appendChild(overlayModal);
                console.log('✅ Modal QR superpuesto creado');
            }

            // Mostrar el modal
            overlayModal.style.display = 'flex';
            console.log('✅ Modal QR superpuesto mostrado');

            // Cargar la imagen QR
            setTimeout(() => {
                loadQROverlayImage();
            }, 100);
        }

        async function loadQROverlayImage() {
            try {
                const qrCodeElement = document.getElementById('qr-overlay-code');
                if (!qrCodeElement) return;

                const response = await fetch('/api/qr');
                const data = await response.json();

                if (data.hasQR && data.qr) {
                    // Forzar actualización agresiva del cache
                    const timestamp = Date.now() + Math.random();
                    const cacheBuster = `t=${timestamp}&r=${Math.random().toString(36).substring(7)}`;
                    const qrImageUrl = `/api/qr-image?${cacheBuster}`;

                    console.log('🔗 Cargando imagen QR con cache buster:', qrImageUrl);
                    console.log('📊 QR Data:', data.qr.substring(0, 30) + '...');

                    // Limpiar cualquier imagen anterior del cache
                    qrCodeElement.innerHTML = '';

                    // Crear contenedor para la imagen
                    const imageContainer = document.createElement('div');
                    imageContainer.style.textAlign = 'center';

                    // Crear la imagen con eventos para forzar actualización
                    const qrImage = document.createElement('img');
                    qrImage.src = qrImageUrl;
                    qrImage.alt = 'Código QR de WhatsApp';
                    qrImage.style.cssText = `
                        max-width: 100%;
                        max-height: 280px;
                        border-radius: 8px;
                        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
                        border: 3px solid white;
                        transition: opacity 0.3s ease;
                    `;

                    // Evento de carga exitosa
                    qrImage.onload = function() {
                        console.log('✅ Imagen QR cargada exitosamente');
                        qrImage.style.opacity = '1';
                    };

                    // Evento de error - fallback a servicio externo
                    qrImage.onerror = function() {
                        console.log('❌ Error cargando imagen local, usando fallback...');
                        const fallbackUrl = `https://api.qrserver.com/v1/create-qr-code/?size=280x280&data=${encodeURIComponent(data.qr)}&${cacheBuster}`;
                        qrImage.src = fallbackUrl;
                    };

                    // Agregar la imagen al contenedor
                    imageContainer.appendChild(qrImage);

                    // Agregar instrucciones
                    const instructions = document.createElement('div');
                    instructions.style.cssText = `
                        margin-top: 15px;
                        font-size: 12px;
                        color: #666;
                    `;
                    instructions.innerHTML = `
                        <i class="fas fa-mobile-alt" style="margin-right: 5px;"></i>
                        Escanea con la cámara de WhatsApp
                        <br><small style="color: #999; font-size: 10px;">Actualizado: ${new Date().toLocaleTimeString()}</small>
                    `;
                    imageContainer.appendChild(instructions);

                    // Agregar al elemento principal
                    qrCodeElement.appendChild(imageContainer);

                    console.log('✅ Imagen QR configurada para carga');
                } else {
                    qrCodeElement.innerHTML = `
                        <div style="
                            text-align: center;
                            color: #666;
                            padding: 20px;
                        ">
                            <i class="fas fa-clock" style="font-size: 32px; margin-bottom: 15px; opacity: 0.5;"></i>
                            <br><strong>Esperando código QR...</strong>
                            <br><small>El código se generará automáticamente</small>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('❌ Error cargando imagen QR:', error);
                const qrCodeElement = document.getElementById('qr-overlay-code');
                if (qrCodeElement) {
                    qrCodeElement.innerHTML = `
                        <div style="
                            text-align: center;
                            color: #dc3545;
                            padding: 20px;
                        ">
                            <i class="fas fa-exclamation-triangle" style="font-size: 32px; margin-bottom: 15px;"></i>
                            <br><strong>Error cargando QR</strong>
                            <br><small>Inténtalo de nuevo</small>
                        </div>
                    `;
                }
            }
        }

        function hideQROverlayModal() {
            const modal = document.getElementById('qr-overlay-modal');
            if (modal) {
                modal.style.display = 'none';
                console.log('✅ Modal QR superpuesto ocultado manualmente');
            }
        }

        // Función para forzar actualización de la imagen QR
        function refreshQRImage() {
            const qrCodeElement = document.getElementById('qr-overlay-code');
            if (!qrCodeElement) return;

            console.log('🔄 Forzando actualización de imagen QR...');

            // Limpiar contenido actual
            qrCodeElement.innerHTML = `
                <div style="
                    text-align: center;
                    color: #666;
                    padding: 20px;
                ">
                    <div style="
                        border: 4px solid #f3f3f3;
                        border-top: 4px solid #25d366;
                        border-radius: 50%;
                        width: 45px;
                        height: 45px;
                        animation: spin 1s linear infinite;
                        margin: 0 auto 15px auto;
                    "></div>
                    <strong>Actualizando código QR...</strong>
                    <br><small>Forzando descarga nueva</small>
                </div>
            `;

            // Usar endpoint de actualización forzada
            setTimeout(() => {
                loadQROverlayImage(true); // true para forzar actualización
            }, 1000);
        }

        // Función mejorada para cargar imagen QR con opción de forzar
        async function loadQROverlayImage(forceUpdate = false) {
            try {
                const qrCodeElement = document.getElementById('qr-overlay-code');
                if (!qrCodeElement) return;

                const response = await fetch('/api/qr');
                const data = await response.json();

                if (data.hasQR && data.qr) {
                    // Forzar actualización agresiva del cache
                    const timestamp = Date.now() + Math.random();
                    const cacheBuster = `t=${timestamp}&r=${Math.random().toString(36).substring(7)}`;

                    // Usar endpoint de actualización forzada si se solicita
                    const qrImageUrl = forceUpdate
                        ? `/api/qr-image/force?${cacheBuster}`
                        : `/api/qr-image?${cacheBuster}`;

                    console.log('🔗 Cargando imagen QR:', qrImageUrl);
                    console.log('📊 QR Data:', data.qr.substring(0, 30) + '...');
                    console.log('🔄 Modo forzar actualización:', forceUpdate);

                    // Limpiar cualquier imagen anterior del cache
                    qrCodeElement.innerHTML = '';

                    // Crear contenedor para la imagen
                    const imageContainer = document.createElement('div');
                    imageContainer.style.textAlign = 'center';

                    // Crear la imagen con eventos para forzar actualización
                    const qrImage = document.createElement('img');
                    qrImage.src = qrImageUrl;
                    qrImage.alt = 'Código QR de WhatsApp';
                    qrImage.style.cssText = `
                        max-width: 100%;
                        max-height: 280px;
                        border-radius: 8px;
                        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
                        border: 3px solid white;
                        transition: opacity 0.3s ease;
                    `;

                    // Evento de carga exitosa
                    qrImage.onload = function() {
                        console.log('✅ Imagen QR cargada exitosamente');
                        qrImage.style.opacity = '1';
                    };

                    // Evento de error - fallback a servicio externo
                    qrImage.onerror = function() {
                        console.log('❌ Error cargando imagen local, usando fallback...');
                        const fallbackUrl = `https://api.qrserver.com/v1/create-qr-code/?size=280x280&data=${encodeURIComponent(data.qr)}&${cacheBuster}`;
                        qrImage.src = fallbackUrl;
                    };

                    // Agregar la imagen al contenedor
                    imageContainer.appendChild(qrImage);

                    // Agregar instrucciones
                    const instructions = document.createElement('div');
                    instructions.style.cssText = `
                        margin-top: 15px;
                        font-size: 12px;
                        color: #666;
                    `;
                    instructions.innerHTML = `
                        <i class="fas fa-mobile-alt" style="margin-right: 5px;"></i>
                        Escanea con la cámara de WhatsApp
                        <br><small style="color: #999; font-size: 10px;">Actualizado: ${new Date().toLocaleTimeString()}</small>
                        ${forceUpdate ? '<br><small style="color: #28a745; font-size: 10px;">🔄 Actualización forzada</small>' : ''}
                    `;
                    imageContainer.appendChild(instructions);

                    // Agregar al elemento principal
                    qrCodeElement.appendChild(imageContainer);

                    console.log('✅ Imagen QR configurada para carga');
                } else {
                    qrCodeElement.innerHTML = `
                        <div style="
                            text-align: center;
                            color: #666;
                            padding: 20px;
                        ">
                            <i class="fas fa-clock" style="font-size: 32px; margin-bottom: 15px; opacity: 0.5;"></i>
                            <br><strong>Esperando código QR...</strong>
                            <br><small>El código se generará automáticamente</small>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('❌ Error cargando imagen QR:', error);
                const qrCodeElement = document.getElementById('qr-overlay-code');
                if (qrCodeElement) {
                    qrCodeElement.innerHTML = `

                        <div style="
                            text-align: center;
                            color: #dc3545;
                            padding: 20px;
                        ">
                            <i class="fas fa-exclamation-triangle" style="font-size: 32px; margin-bottom: 15px;"></i>
                            <br><strong>Error cargando QR</strong>
                            <br><small>Inténtalo de nuevo</small>
                        </div>
                    `;
                }
            }
        }

        // Agregar listener para la tecla Escape
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const overlayModal = document.getElementById('qr-overlay-modal');
                if (overlayModal && overlayModal.style.display !== 'none') {
                    hideQROverlayModal();
                    console.log('✅ Modal QR cerrado con tecla Escape');
                }
            }
        });

        function hideQRModal() {
            const modal = document.getElementById('qr-modal');
            if (modal && !modal.classList.contains('hidden')) {
                modal.classList.add('hidden');
                console.log('QR modal hidden');
            }
        }

        // Función mejorada para ocultar el modal QR con razón específica
        function hideQRModalByConnection() {
            qrModalClosedByConnection = true;
            hideQRModal();

            // También ocultar el modal superpuesto si existe
            const overlayModal = document.getElementById('qr-overlay-modal');
            if (overlayModal) {
                overlayModal.style.display = 'none';
                console.log('✅ Modal QR superpuesto ocultado por conexión exitosa');
            }

            console.log('QR modal hidden by successful connection');
        }

        function hideQRModalManually() {
            hideQRModal();
            console.log('QR modal hidden manually by user');
        }

        // Función para forzar la ocultación del modal QR si está visible por error
        function forceHideQRModal() {
            const modal = document.getElementById('qr-modal');
            if (modal && !modal.classList.contains('hidden')) {
                modal.classList.add('hidden');
                console.log('QR modal force hidden');
            }
        }

        // Función para mostrar el modal QR forzosamente (para debugging)
        function forceShowQRModal() {
            console.log('Forcing QR modal show...');

            // Primero verificar si existe
            let modal = document.getElementById('qr-modal');

            if (!modal) {
                console.error('❌ Modal QR not found in DOM - creating emergency modal');

                // Crear modal de emergencia si no existe
                const emergencyModal = document.createElement('div');
                emergencyModal.id = 'qr-modal';
                emergencyModal.className = 'qr-modal';
                emergencyModal.style.cssText = `
                    position: fixed; top: 20px; right: 20px; width: 350px; height: auto;
                    background: white; border-radius: 12px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                    z-index: 1000; border: 2px solid #25d366; overflow: hidden;
                `;

                emergencyModal.innerHTML = `
                    <div style="padding: 20px; text-align: center; background: linear-gradient(135deg, #25d366, #128c7e); color: white; position: relative;">
                        <button onclick="hideQRModalManually()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; color: white; font-size: 20px; cursor: pointer; padding: 5px;">&times;</button>
                        <h3 style="margin: 0 0 10px 0; font-size: 18px;"><i class="fab fa-whatsapp"></i> Modal QR de Emergencia</h3>
                        <p style="margin: 0; font-size: 14px; opacity: 0.9;">Modal creado por emergencia - recarga la página</p>
                    </div>
                    <div style="padding: 20px;">
                        <div style="text-align: center; padding: 30px; background: #f8f9fa; border-radius: 8px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 24px; color: #dc3545; margin-bottom: 10px;"></i>
                            <br><strong>Modal QR no encontrado</strong>
                            <br><small>Recarga la página para solucionarlo</small>
                        </div>
                    </div>
                `;

                document.body.appendChild(emergencyModal);
                modal = emergencyModal;
                console.log('✅ Emergency modal created');
            }

            // Mostrar el modal
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                console.log('✅ QR modal forced to show');

                // Intentar cargar el QR si hay elementos
                const qrCode = document.getElementById('qr-code');
                if (qrCode) {
                    showQRModal();
                }
            } else {
                console.log('ℹ️ QR modal was already visible');
            }
        }

        // Función para inicializar el botón QR
        function initializeQRButton() {
            const qrBtn = document.getElementById('qr-btn');
            if (qrBtn) {
                qrBtn.addEventListener('click', function() {
                    console.log('QR button clicked - showing QR modal');
                    showQRModal();
                });
                console.log('✅ QR button initialized');
            } else {
                console.error('❌ QR button not found in DOM');
            }
        }

        // Función para inicializar el botón de escanear QR
        function initializeScanQRButton() {
            const scanQrBtn = document.getElementById('scan-qr-btn');
            if (scanQrBtn) {
                scanQrBtn.addEventListener('click', handleScanQRClick);
                console.log('✅ Scan QR button initialized');
            } else {
                console.error('❌ Scan QR button not found in DOM');
            }
        }

        // Variables para el contador de sesión
        let sessionDuration = 15 * 60 * 1000; // 15 minutos en milisegundos
        let sessionStartTime = null;
        let sessionTimer = null;
        let sessionWarningShown = false;
        let sessionCriticalShown = false;
        let lastActivityTime = Date.now();

        // Función para inicializar el contador de sesión
        function initializeSessionCounter() {
            const sessionCounter = document.getElementById('session-counter');
            if (sessionCounter) {
                sessionStartTime = Date.now();
                lastActivityTime = Date.now();
                sessionWarningShown = false;
                sessionCriticalShown = false;

                // Hacer el contador clickeable para extender la sesión
                sessionCounter.addEventListener('click', extendSessionManually);
                sessionCounter.style.cursor = 'pointer';
                sessionCounter.title = 'Click para extender la sesión';

                // Iniciar el contador
                startSessionTimer();

                // Configurar detectores de actividad
                setupActivityDetection();

                console.log('✅ Session counter initialized');
            } else {
                console.error('❌ Session counter element not found in DOM');
            }
        }

        // Función para iniciar el temporizador de sesión
        function startSessionTimer() {
            if (sessionTimer) {
                clearInterval(sessionTimer);
            }

            sessionTimer = setInterval(() => {
                const elapsed = Date.now() - lastActivityTime;
                const remaining = sessionDuration - elapsed;

                if (remaining <= 0) {
                    // Sesión expirada
                    handleSessionExpired();
                    return;
                }

                // Actualizar el contador visual
                updateSessionCounter(remaining);
            }, 1000); // Actualizar cada segundo
        }

        // Función para actualizar el contador visual
        function updateSessionCounter(remainingMs) {
            const sessionTime = document.getElementById('session-time');
            const sessionCounter = document.getElementById('session-counter');

            if (!sessionTime || !sessionCounter) return;

            const minutes = Math.floor(remainingMs / (60 * 1000));
            const seconds = Math.floor((remainingMs % (60 * 1000)) / 1000);

            // Formato MM:SS
            const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            sessionTime.textContent = timeString;

            // Cambiar colores según el tiempo restante
            const totalMinutes = sessionDuration / (60 * 1000);
            const remainingMinutes = remainingMs / (60 * 1000);

            // Remover clases anteriores
            sessionCounter.classList.remove('warning', 'critical');

            if (remainingMinutes <= 2) {
                // Menos de 2 minutos - Estado crítico
                sessionCounter.classList.add('critical');
                if (!sessionCriticalShown) {
                    showNotification('¡Sesión expira en menos de 2 minutos!', 'error');
                    sessionCriticalShown = true;
                }
            } else if (remainingMinutes <= 5) {
                // Menos de 5 minutos - Estado de advertencia
                sessionCounter.classList.add('warning');
                if (!sessionWarningShown) {
                    showNotification('Sesión expira en menos de 5 minutos', 'warning');
                    sessionWarningShown = true;
                }
            }
        }

        // Función para detectar actividad del usuario
        function setupActivityDetection() {
            const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];

            const resetTimer = () => {
                lastActivityTime = Date.now();
                // Reiniciar banderas de advertencia cuando hay actividad
                if (sessionWarningShown || sessionCriticalShown) {
                    sessionWarningShown = false;
                    sessionCriticalShown = false;
                    console.log('Session timer reset due to user activity');
                }
            };

            events.forEach(event => {
                document.addEventListener(event, resetTimer, true);
            });

            console.log('✅ Activity detection setup completed');
        }

        // Función para manejar cuando la sesión expira
        function handleSessionExpired() {
            console.log('⏰ Session expired - redirecting to login');

            // Limpiar el temporizador
            if (sessionTimer) {
                clearInterval(sessionTimer);
                sessionTimer = null;
            }

            // Mostrar notificación final
            showNotification('Tu sesión ha expirado. Serás redirigido al login.', 'error');

            // Esperar 3 segundos antes de redirigir
            setTimeout(() => {
                // Limpiar la sesión
                token = null;
                currentUser = null;
                localStorage.removeItem('token');

                // Redirigir al login
                showLoginScreen();
            }, 3000);
        }

        // Función para extender manualmente la sesión
        function extendSessionManually() {
            console.log('🔄 Extending session manually...');
            lastActivityTime = Date.now();
            sessionWarningShown = false;
            sessionCriticalShown = false;

            // Actualizar el contador inmediatamente
            const sessionCounter = document.getElementById('session-counter');
            if (sessionCounter) {
                sessionCounter.classList.remove('warning', 'critical');
            }

            showNotification('Sesión extendida por actividad', 'success');
        }

        // Función para actualizar la visibilidad del botón QR
        function updateQRButtonVisibility() {
            const qrBtn = document.getElementById('qr-btn');
            if (qrBtn) {
                if (isConnected) {
                    qrBtn.style.display = 'none';
                    console.log('QR button hidden - WhatsApp connected');
                } else {
                    qrBtn.style.display = 'flex';
                    console.log('QR button shown - WhatsApp not connected');
                }
            }
        }

        // Función para actualizar la visibilidad del botón de escanear QR
        function updateScanQRButtonVisibility() {
            const scanQrBtn = document.getElementById('scan-qr-btn');
            if (scanQrBtn) {
                if (isConnected) {
                    scanQrBtn.style.display = 'none';
                    console.log('Scan QR button hidden - WhatsApp connected');
                } else {
                    scanQrBtn.style.display = 'flex';
                    console.log('Scan QR button shown - WhatsApp not connected');
                }
            }
        }

        // Función para manejar el clic en el botón de escanear QR
        function handleScanQRClick() {
            console.log('🔍 === ESCANEAR QR BUTTON CLICKED ===');
            console.log('Current connection status:', isConnected);
            console.log('QR modal closed by connection flag:', qrModalClosedByConnection);

            // Mostrar información del QR en consola
            fetch('/api/qr')
                .then(response => response.json())
                .then(data => {
                    console.log('📱 === QR CODE INFORMATION ===');
                    console.log('QR Available:', data.hasQR);
                    if (data.hasQR && data.qr) {
                        console.log('QR Data:', data.qr);
                        console.log('🔗 QR Local URL:', `/api/qr-image?t=${Date.now()}`);
                        console.log('🌐 QR External URL:', `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(data.qr)}`);
                        console.log('📱 ¡La imagen QR aparecerá en la ventana modal!');
                    } else {
                        console.log('No QR data available');
                    }
                })
                .catch(error => {
                    console.error('Error fetching QR data:', error);
                });

            // Mostrar el modal QR
            showQRModal();

            // Mostrar notificación
            showNotification('Escanea el código QR que aparece en la ventana modal', 'info');

            // Iniciar monitoreo de conexión
            startQRConnectionMonitoring();
        }

        // Variable para controlar el monitoreo de conexión
        let qrConnectionMonitoring = false;

        // Función para monitorear la conexión de WhatsApp mientras el modal QR está abierto
        function startQRConnectionMonitoring() {
            if (qrConnectionMonitoring) {
                return; // Ya está monitoreando
            }

            qrConnectionMonitoring = true;
            console.log('🔄 Starting QR connection monitoring...');

            const monitoringInterval = setInterval(() => {
                const qrModal = document.getElementById('qr-modal');

                // Si el modal ya no está visible, detener el monitoreo
                if (!qrModal || qrModal.classList.contains('hidden')) {
                    clearInterval(monitoringInterval);
                    qrConnectionMonitoring = false;
                    console.log('✅ QR connection monitoring stopped - modal closed');
                    return;
                }

                // Verificar estado de conexión
                fetch('/api/stats')
                    .then(response => response.json())
                    .then(data => {
                        const isWhatsAppReady = data.whatsappListo || data.connected || data.ready;

                        if (isWhatsAppReady && !isConnected) {
                            console.log('🎉 WhatsApp connected! Closing QR modal...');

                            // Actualizar estado
                            isConnected = true;
                            qrModalClosedByConnection = true;

                            // Actualizar botones
                            updateQRButtonVisibility();
                            updateScanQRButtonVisibility();

                            // Mostrar notificación
                            showNotification('¡WhatsApp conectado exitosamente!', 'success');

                            // Cerrar modal después de 2 segundos
                            setTimeout(() => {
                                hideQRModalByConnection();
                                clearInterval(monitoringInterval);
                                qrConnectionMonitoring = false;
                                console.log('✅ QR modal closed automatically after connection');
                            }, 2000);
                        }
                    })
                    .catch(error => {
                        console.error('Error checking connection during QR monitoring:', error);
                    });
            }, 1000); // Verificar cada segundo
        }

        // Función para verificar que el modal QR existe en el DOM
        function checkQRModalInDOM() {
            const modal = document.getElementById('qr-modal');
            const qrCode = document.getElementById('qr-code');

            console.log('=== QR MODAL DOM CHECK ===');
            console.log('Modal element exists:', !!modal);
            console.log('QR code element exists:', !!qrCode);

            if (modal) {
                console.log('Modal classes:', modal.classList.toString());
                console.log('Modal computed style display:', window.getComputedStyle(modal).display);
                console.log('Modal is hidden:', modal.classList.contains('hidden'));
            }

            if (qrCode) {
                console.log('QR code innerHTML:', qrCode.innerHTML.substring(0, 100) + '...');
            }

            // Verificar elementos relacionados
            const allElementsWithQR = Array.from(document.querySelectorAll('[id*="qr"], [class*="qr"]'));
            console.log('Elements with QR in id/class:', allElementsWithQR.map(el => ({id: el.id, class: el.className})));

            return {
                modalExists: !!modal,
                qrCodeExists: !!qrCode,
                modalHidden: modal ? modal.classList.contains('hidden') : null
            };
        }

        // Exponer función de verificación DOM
        window.checkQRModalInDOM = checkQRModalInDOM;

        // Función para verificar el modal QR al cargar la página
        function verifyQRModalOnLoad() {
            console.log('=== PAGE LOAD - QR MODAL VERIFICATION ===');
            const result = checkQRModalInDOM();

            if (result.modalExists && result.qrCodeExists) {
                console.log('✅ QR modal components found and ready');
            } else {
                console.error('❌ QR modal components missing!');
                if (!result.modalExists) console.error('   - Modal element not found');
                if (!result.qrCodeExists) console.error('   - QR code element not found');
            }

            return result;
        }

        // Ejecutar verificación cuando el DOM esté listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', verifyQRModalOnLoad);
        } else {
            verifyQRModalOnLoad();
        }

        // También verificar cuando la ventana esté completamente cargada
        window.addEventListener('load', function() {
            console.log('=== WINDOW LOAD - QR MODAL FINAL CHECK ===');
            setTimeout(verifyQRModalOnLoad, 100); // Pequeño delay para asegurar que todo esté listo
        });

        // Función para actualizar el indicador de estado en el modal QR
        function updateQRStatusIndicator(status, message) {
            const indicator = document.getElementById('qr-status-indicator');
            if (indicator) {
                indicator.innerHTML = message;

                // Cambiar colores según el estado
                switch(status) {
                    case 'connecting':
                        indicator.style.background = '#fff3cd';
                        indicator.style.color = '#856404';
                        indicator.style.borderColor = '#ffeaa7';
                        break;
                    case 'connected':
                        indicator.style.background = '#d4edda';
                        indicator.style.color = '#155724';
                        indicator.style.borderColor = '#c3e6cb';
                        break;
                    case 'error':
                        indicator.style.background = '#f8d7da';
                        indicator.style.color = '#721c24';
                        indicator.style.borderColor = '#f5c6cb';
                        break;
                }
            }
        }

        // Función de debugging para el modal QR
        function debugQRModal() {
            const modal = document.getElementById('qr-modal');
            const isVisible = modal && !modal.classList.contains('hidden');
            const isConnectedStatus = isConnected;

            console.log('=== DEBUG QR MODAL ===');
            console.log('Modal visible:', isVisible);
            console.log('WhatsApp connected:', isConnectedStatus);
            console.log('QR modal closed by connection:', qrModalClosedByConnection);
            console.log('Modal element:', modal);
            console.log('Modal classes:', modal ? modal.classList.toString() : 'null');
            console.log('Connection check interval running:', true);

            // Verificar estado de conexión actual
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    console.log('Current connection status:', data);
                    const isWhatsAppReady = data.whatsappListo || data.connected || data.ready;
                    console.log('Calculated ready status:', isWhatsAppReady);
                })
                .catch(error => console.error('Error fetching connection status:', error));

            return {
                isVisible,
                isConnected: isConnectedStatus,
                qrModalClosedByConnection
            };
        }

        // Función de diagnóstico completa para el modal QR
        function diagnoseQRModal() {
            console.log('🔍 === DIAGNÓSTICO COMPLETO DEL MODAL QR ===');

            const modal = document.getElementById('qr-modal');
            const isVisible = modal && !modal.classList.contains('hidden');
            const indicator = document.getElementById('qr-status-indicator');

            console.log('📊 Estado actual:');
            console.log('   - Modal existe:', !!modal);
            console.log('   - Modal visible:', isVisible);
            console.log('   - WhatsApp conectado:', isConnected);
            console.log('   - Flag cerrado por conexión:', qrModalClosedByConnection);
            console.log('   - Indicador de estado:', indicator ? indicator.innerHTML : 'No encontrado');
            console.log('   - Modal classes:', modal ? modal.classList.toString() : 'null');

            // Verificar elementos del DOM
            const qrCode = document.getElementById('qr-code');
            console.log('   - QR code element exists:', !!qrCode);
            console.log('   - QR code has content:', qrCode ? qrCode.innerHTML.length > 0 : 'N/A');

            // Verificar conexión actual
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    const isWhatsAppReady = data.whatsappListo || data.connected || data.ready;
                    console.log('🔗 Estado de WhatsApp:');
                    console.log('   - whatsappListo:', data.whatsappListo);
                    console.log('   - connected:', data.connected);
                    console.log('   - ready:', data.ready);
                    console.log('   - Calculado ready:', isWhatsAppReady);

                    console.log('📋 Diagnóstico:');
                    if (isWhatsAppReady && isConnected && qrModalClosedByConnection) {
                        console.log('   ✅ TODO CORRECTO: WhatsApp conectado y modal cerrado por conexión exitosa');
                    } else if (isWhatsAppReady && !isConnected) {
                        console.log('   ⚠️  WhatsApp conectado pero isConnected=false (posible problema de sincronización)');
                        console.log('   💡 Solución: Ejecuta forceConnectionCheck()');
                    } else if (!isWhatsAppReady && isConnected) {
                        console.log('   ⚠️  isConnected=true pero WhatsApp no está listo (estado inconsistente)');
                        console.log('   💡 Solución: Ejecuta forceConnectionCheck()');
                    } else if (!isModalVisible && !qrModalClosedByConnection) {
                        console.log('   ⚠️  Modal oculto pero no por conexión exitosa (posible cierre manual)');
                        console.log('   💡 Solución: Ejecuta resetQRModalFlag() si necesitas que aparezca de nuevo');
                    } else if (isModalVisible && isWhatsAppReady) {
                        console.log('   ⚠️  Modal visible pero WhatsApp conectado (debería cerrarse)');
                        console.log('   💡 Solución: Ejecuta forceConnectionCheck()');
                    } else if (!isVisible && !qrModalClosedByConnection) {
                        console.log('   ⚠️  Modal no está visible y no se cerró por conexión exitosa');
                        console.log('   💡 Posibles causas:');
                        console.log('      - Modal nunca se mostró después del login');
                        console.log('      - Error en showQRModal()');
                        console.log('      - Problema de timing');
                        console.log('   🔧 Soluciones:');
                        console.log('      - Ejecuta checkQRModalInDOM() para verificar elementos');
                        console.log('      - Ejecuta forceShowQRModal() para mostrar forzosamente');
                        console.log('      - Recarga la página si el modal no existe');
                    } else if (!modal) {
                        console.log('   ❌ CRÍTICO: Modal QR no existe en el DOM');
                        console.log('   💡 Solución: Recarga la página');
                    } else {
                        console.log('   ❓ Estado desconocido - revisa logs anteriores');
                    }

                    console.log('🛠️  Comandos disponibles:');
                    console.log('   - debugQRModal(): Ver estado detallado');
                    console.log('   - checkQRModalInDOM(): Verificar elementos en DOM');
                    console.log('   - forceConnectionCheck(): Forzar verificación de conexión');
                    console.log('   - resetQRModalFlag(): Permitir que el modal aparezca de nuevo');
                    console.log('   - forceShowQRModal(): Mostrar modal forzosamente');
                    console.log('   - forceCloseQRModal(): Cerrar modal forzosamente');
                })
                .catch(error => {
                    console.error('❌ Error al obtener estado de conexión:', error);
                });
        }

        // Exponer función de diagnóstico
        window.diagnoseQRModal = diagnoseQRModal;

        // Función para probar el nuevo flujo del botón QR
        function testQRButtonFlow() {
            console.log('=== TESTING QR BUTTON FLOW ===');

            // Simular secuencia: mostrar botón → hacer clic → mostrar modal → conectar → cerrar modal y botón
            console.log('1. Testing QR button initialization...');
            initializeQRButton();

            setTimeout(() => {
                console.log('2. Simulating WhatsApp disconnection (button should appear)...');
                isConnected = false;
                updateQRButtonVisibility();

                setTimeout(() => {
                    console.log('3. Simulating WhatsApp connection (button should disappear)...');
                    isConnected = true;
                    qrModalClosedByConnection = true;
                    updateQRButtonVisibility();
                    console.log('✅ QR button flow test completed');
                }, 2000);
            }, 1000);
        }

        // Exponer función de prueba del botón QR
        window.testQRButtonFlow = testQRButtonFlow;

        // Exponer función de debugging globalmente
        window.debugQRModal = debugQRModal;

        // Función para forzar verificación de conexión
        function forceConnectionCheck() {
            console.log('Forcing connection check...');
            checkConnectionStatus();
        }

        // Función para forzar cierre del modal QR
        function forceCloseQRModal() {
            console.log('Forcing QR modal close...');
            hideQRModalManually();
        }

        // Función para resetear el flag del modal QR (permitir que aparezca de nuevo)
        function resetQRModalFlag() {
            qrModalClosedByConnection = false;
            console.log('QR modal flag reset - modal can appear again if needed');
        }

        // Exponer funciones adicionales globalmente
        window.forceConnectionCheck = forceConnectionCheck;
        window.forceCloseQRModal = forceCloseQRModal;
        window.resetQRModalFlag = resetQRModalFlag;
        window.forceShowQRModal = forceShowQRModal;

        // Función de prueba para simular conexión (solo para debugging)
        function testQRConnection() {
            console.log('=== TESTING QR CONNECTION LOGIC ===');

            // Resetear flag antes de la prueba
            qrModalClosedByConnection = false;

            // Simular estado de conexión
            isConnected = true;

            // Verificar si el modal se cierra correctamente
            const qrModal = document.getElementById('qr-modal');
            if (qrModal && !qrModal.classList.contains('hidden')) {
                updateQRStatusIndicator('connected', '<i class="fas fa-check-circle"></i> ¡WhatsApp conectado! La ventana se cerrará automáticamente...');
                showNotification('¡WhatsApp conectado exitosamente!', 'success');

                setTimeout(() => {
                    hideQRModalManually(); // Usar cierre manual para pruebas
                    console.log('✅ Test successful - Modal closed automatically');
                }, 2000);
            } else {
                console.log('ℹ️ Test info - Modal was already hidden');
            }
        }

        // Exponer función de prueba
        window.testQRConnection = testQRConnection;

        // Exponer funciones del botón de escanear QR
        window.handleScanQRClick = handleScanQRClick;
        window.updateScanQRButtonVisibility = updateScanQRButtonVisibility;

        // Función para probar el flujo completo del modal QR
        function testQRFlow() {
            console.log('=== TESTING COMPLETE QR FLOW ===');

            // Resetear flag antes de la prueba
            qrModalClosedByConnection = false;

            // Simular secuencia: login -> mostrar modal -> conectar -> cerrar modal
            console.log('1. Showing QR modal (simulating login)');
            showQRModal();
            updateQRStatusIndicator('connecting', '<i class="fas fa-spinner fa-spin"></i> Esperando conexión de WhatsApp...');

            setTimeout(() => {
                console.log('2. Simulating WhatsApp connection');
                isConnected = true;

                // Simular la lógica de checkConnectionStatus cuando WhatsApp se conecta
                const qrModal = document.getElementById('qr-modal');
                const isModalVisible = qrModal && !qrModal.classList.contains('hidden');

                if (isModalVisible) {
                    console.log('3. Modal is visible - updating status and scheduling close');
                    updateQRStatusIndicator('connected', '<i class="fas fa-check-circle"></i> ¡WhatsApp conectado! La ventana se cerrará automáticamente...');
                    showNotification('¡WhatsApp conectado exitosamente!', 'success');

                    setTimeout(() => {
                        console.log('4. Auto-closing modal after 2 seconds');
                        hideQRModalManually(); // Usar cierre manual para pruebas
                        console.log('✅ QR flow test completed successfully');
                    }, 2000);
                } else {
                    console.log('❌ Modal was not visible during connection test');
                }
            }, 3000);
        }

        // Exponer función de prueba de flujo completo
        window.testQRFlow = testQRFlow;

        // Función para probar el botón de escanear QR
        function testScanQRButton() {
            console.log('=== TESTING SCAN QR BUTTON ===');

            // Simular secuencia: mostrar botón → hacer clic → mostrar modal → conectar → cerrar modal y botón
            console.log('1. Testing scan QR button initialization...');
            initializeScanQRButton();

            setTimeout(() => {
                console.log('2. Simulating WhatsApp disconnection (scan QR button should appear)...');
                isConnected = false;
                updateScanQRButtonVisibility();

                setTimeout(() => {
                    console.log('3. Simulating manual QR scan button click...');
                    handleScanQRClick();

                    setTimeout(() => {
                        console.log('4. Simulating WhatsApp connection (scan QR button should disappear)...');
                        isConnected = true;
                        qrModalClosedByConnection = true;
                        updateScanQRButtonVisibility();
                        console.log('✅ Scan QR button flow test completed');
                    }, 3000);
                }, 2000);
            }, 1000);
        }

        // Exponer función de prueba del botón de escanear QR
        window.testScanQRButton = testScanQRButton;

        // Función de ayuda para el usuario sobre el botón de escanear QR
        function helpScanQRButton() {
            console.log('🚀 === AYUDA: BOTÓN ESCANEAR QR ===');
            console.log('');
            console.log('📍 ¿Dónde está el botón?');
            console.log('   - En el header, al lado del botón de información del usuario');
            console.log('   - Tiene un ícono de código QR y dice "Escanear QR"');
            console.log('   - Color verde con gradiente WhatsApp');
            console.log('');
            console.log('⚡ ¿Qué hace cuando lo presionas?');
            console.log('   1. Muestra información del QR en la consola');
            console.log('   2. Abre la ventana modal con el código QR');
            console.log('   3. Inicia monitoreo automático de conexión');
            console.log('   4. Cierra automáticamente cuando WhatsApp se conecta');
            console.log('');
            console.log('🔄 ¿Cuándo aparece/desaparece?');
            console.log('   ✅ Aparece: Cuando WhatsApp está desconectado');
            console.log('   ❌ Desaparece: Cuando WhatsApp está conectado');
            console.log('');
            console.log('🛠️ Comandos útiles:');
            console.log('   - testScanQRButton(): Probar el flujo completo');
            console.log('   - debugQRModal(): Ver estado actual');
            console.log('   - diagnoseQRModal(): Diagnóstico completo');
            console.log('');
            console.log('💡 Tip: El botón monitorea la conexión cada segundo mientras el modal está abierto');
        }

        // Exponer función de ayuda
        window.helpScanQRButton = helpScanQRButton;

        // Función para interceptar y debuggear el mensaje "no hay sesión activa"
        function debugSessionMessage() {
            console.log('🔍 === DEBUGGING SESSION MESSAGE ===');
            console.log('Current session state:');
            console.log('- token:', token);
            console.log('- currentUser:', currentUser);
            console.log('- localStorage token:', localStorage.getItem('token'));

            // Interceptar showNotification para capturar el mensaje
            const originalShowNotification = window.showNotification;
            window.showNotification = function(message, type) {
                console.log('🔔 NOTIFICATION INTERCEPTED:', { message, type });

                // Si es el mensaje problemático, mostrar stack trace
                if (message.toLowerCase().includes('sesión') ||
                    message.toLowerCase().includes('session') ||
                    message.toLowerCase().includes('activa')) {
                    console.error('❌ SESSION MESSAGE DETECTED!');
                    console.trace('Stack trace:');
                }

                return originalShowNotification.apply(this, arguments);
            };

            console.log('✅ Notification interception active');
            console.log('💡 Now try to reproduce the issue and check the console');

            // Verificar sesión actual
            if (token) {
                fetch(`/api/session?token=${token}`)
                    .then(response => {
                        console.log('Session verification response status:', response.status);
                        return response.json();
                    })
                    .then(data => {
                        console.log('Session verification data:', data);
                    })
                    .catch(error => {
                        console.error('Session verification error:', error);
                    });
            }

            // Restaurar función original después de 30 segundos
            setTimeout(() => {
                window.showNotification = originalShowNotification;
                console.log('🔄 Notification interception restored');
            }, 30000);
        }

        // Función para verificar todas las llamadas fetch que incluyen token
        function debugSessionRequests() {
            console.log('🔍 === DEBUGGING SESSION REQUESTS ===');

            const originalFetch = window.fetch;
            window.fetch = function(url, options) {
                // Verificar si la llamada requiere sesión
                const requiresSession = url.includes('/api/') &&
                    !url.includes('/api/session?') &&
                    !url.includes('/api/login');

                if (requiresSession && !token) {
                    console.error('❌ INTENTANDO HACER LLAMADA API SIN SESIÓN:', url);
                    showNotification('Sesión no iniciada. Redirigiendo al login...', 'error');
                    setTimeout(() => {
                        localStorage.removeItem('token');
                        token = null;
                        showLoginScreen();
                    }, 1000);
                    return Promise.reject(new Error('No session available'));
                }

                if (url.includes('token') || (options && options.body && options.body.includes('token'))) {
                    console.log('📡 SESSION REQUEST:', { url, method: options?.method });
                }

                return originalFetch.apply(this, arguments)
                    .then(response => {
                        if (url.includes('token') || (options && options.body && options.body.includes('token'))) {
                            console.log('📡 SESSION RESPONSE:', {
                                url,
                                status: response.status,
                                ok: response.ok
                            });

                            if (response.status === 401 || response.status === 403) {
                                console.error('❌ AUTHENTICATION ERROR DETECTED!');
                                console.trace('Call stack:');
                            }
                        }

                        // Manejar errores de sesión en tiempo real
                        if (response.status === 401 || response.status === 403) {
                            console.error(`🚨 ERROR DE SESIÓN (${response.status}) en:`, url);
                            showNotification('Sesión expirada o inválida. Redirigiendo al login...', 'error');
                            setTimeout(() => {
                                localStorage.removeItem('token');
                                token = null;
                                showLoginScreen();
                            }, 2000);
                        }

                        return response;
                    }).catch(error => {
                        console.error('❌ ERROR EN FETCH:', error);
                        // Si es un error de red y tenemos token, intentar reconectar
                        if (!navigator.onLine && token) {
                            showNotification('Error de conexión. Verificando sesión...', 'error');
                            setTimeout(() => verifySession(token), 3000);
                        }
                        throw error;
                    });
            };

            console.log('✅ Session request interception active');

            // Restaurar después de 30 segundos
            setTimeout(() => {
                window.fetch = originalFetch;
                console.log('🔄 Fetch interception restored');
            }, 30000);
        }

        // Función de ayuda para debugging de sesión
        function helpSessionDebugging() {
            console.log('🚨 === HELP: SESSION DEBUGGING ===');
            console.log('');
            console.log('📝 ¿Aparece "no hay sesión activa" cada rato?');
            console.log('');
            console.log('🔧 Pasos para diagnosticar:');
            console.log('1. Ejecuta: debugSessionMessage()');
            console.log('2. Ejecuta: debugSessionRequests()');
            console.log('3. Espera a que aparezca el mensaje');
            console.log('4. Revisa la consola para ver de dónde viene');
            console.log('');
            console.log('💡 Posibles causas:');
            console.log('- El token expira en el servidor');
            console.log('- Problema de red que interrumpe las peticiones');
            console.log('- El backend está reiniciando o perdiendo sesiones');
            console.log('- Conflicto entre múltiples pestañas');
            console.log('');
            console.log('🛠️ Soluciones posibles:');
            console.log('- emergencySessionSilence()    ← Silenciar mensajes 30 min');
            console.log('- extendSession()              ← Extender sesión manual');
            console.log('- Hacer refresh de la página (F5)');
            console.log('- Cerrar otras pestañas de la aplicación');
            console.log('- Verificar la conexión de red');
            console.log('- Contactar al administrador del servidor');
        }

        // Exponer funciones de debugging de sesión
        window.debugSessionMessage = debugSessionMessage;
        window.debugSessionRequests = debugSessionRequests;
        window.helpSessionDebugging = helpSessionDebugging;

        // Función para extender la sesión automáticamente
        function extendSession() {
            if (token) {
                console.log('🔄 Extending session...');
                fetch(`/api/session/extend?token=${token}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            console.log('✅ Session extended successfully');
                            showNotification('Sesión extendida', 'success');
                        } else {
                            console.error('❌ Failed to extend session:', data.message);
                            showNotification('Error extendiendo sesión', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error extending session:', error);
                        showNotification('Error de conexión al extender sesión', 'error');
                    });
            } else {
                console.error('No token available to extend');
            }
        }

        // Función para verificar y renovar sesión automáticamente
        function startSessionMaintenance() {
            window.sessionMaintenanceActive = true;
            console.log('🛠️ Starting automatic session maintenance...');

            // Verificar sesión cada 5 minutos
            setInterval(() => {
                if (token) {
                    fetch(`/api/session?token=${token}`)
                        .then(response => {
                            if (response.status === 401 || response.status === 403) {
                                console.error('❌ Session expired - redirecting to login');
                                showNotification('Sesión expirada - redirigiendo al login', 'error');
                                setTimeout(() => {
                                    localStorage.removeItem('token');
                                    showLoginScreen();
                                }, 2000);
                                return;
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data && !data.success) {
                                console.warn('⚠️ Session validation failed:', data.message);
                                // Intentar extender la sesión
                                extendSession();
                            } else if (data && data.success) {
                                console.log('✅ Session validated successfully');
                            }
                        })
                        .catch(error => {
                            console.error('Error validating session:', error);
                            // No mostrar error al usuario para evitar spam
                        });
                }
            }, 5 * 60 * 1000); // 5 minutos

            // Extender sesión cada 10 minutos si está activa
            setInterval(() => {
                if (token && document.getElementById('main-container').style.display !== 'none') {
                    extendSession();
                }
            }, 10 * 60 * 1000); // 10 minutos

            console.log('✅ Session maintenance started');
            console.log('⏱️  Session will be validated every 5 minutes');
            console.log('🔄 Session will be extended every 10 minutes');
        }

        // Iniciar mantenimiento de sesión al cargar la aplicación
        function initializeSessionMaintenance() {
            if (token) {
                startSessionMaintenance();
            }
        }

        // Exponer funciones de mantenimiento de sesión
        window.extendSession = extendSession;
        window.startSessionMaintenance = startSessionMaintenance;
        window.initializeSessionMaintenance = initializeSessionMaintenance;

        // Función de ayuda completa para el problema de sesión
        function helpSessionProblem() {
            console.log('🚨 === SOLUCIÓN COMPLETA: PROBLEMA DE SESIÓN ===');
            console.log('');
            console.log('📝 Problema: "no hay sesión activa" aparece cada rato');
            console.log('');
            console.log('🔍 PASO 1: Diagnosticar el problema');
            console.log('Ejecuta estos comandos en orden:');
            console.log('');
            console.log('1. helpSessionDebugging()     ← Información general');
            console.log('2. debugSessionMessage()      ← Interceptar mensajes');
            console.log('3. debugSessionRequests()     ← Ver peticiones HTTP');
            console.log('');
            console.log('⏱️  Espera 30 segundos después de ejecutar los comandos 2 y 3');
            console.log('   para que se activen y luego reproduce el problema.');
            console.log('');
            console.log('🛠️ PASO 2: Soluciones inmediatas');
            console.log('');
            console.log('A) Si es problema de expiración:');
            console.log('   - extendSession()              ← Extender sesión manual');
            console.log('   - startSessionMaintenance()    ← Iniciar mantenimiento automático');
            console.log('');
            console.log('B) Si es problema de red:');
            console.log('   - Verifica tu conexión a internet');
            console.log('   - Recarga la página (F5)');
            console.log('   - Cierra otras pestañas de la aplicación');
            console.log('');
            console.log('C) Si es problema del servidor:');
            console.log('   - Contacta al administrador del servidor');
            console.log('   - El mantenimiento automático intentará renovar la sesión');
            console.log('');
            console.log('⚡ FUNCIONES DE EMERGENCIA:');
            console.log('- emergencySessionSilence()  ← Silenciar mensajes 30 min');
            console.log('- forceConnectionCheck()     ← Verificar conexión forzadamente');
            console.log('- diagnoseQRModal()          ← Diagnóstico completo del sistema');
            console.log('');
            console.log('📊 ESTADO ACTUAL DEL SISTEMA:');
            console.log('- Token:', token);
            console.log('- Usuario actual:', currentUser ? currentUser.username : 'null');
            console.log('- Mantenimiento activo:', window.sessionMaintenanceActive || false);
            console.log('');
            console.log('💡 RECUERDA: El sistema ahora tiene mantenimiento automático');
            console.log('   que verifica la sesión cada 5 minutos y la extiende cada 10 minutos.');
        }

        // Exponer función de ayuda completa
        window.helpSessionProblem = helpSessionProblem;

        // Funciones para el contador de sesión
        function getSessionStatus() {
            const elapsed = Date.now() - lastActivityTime;
            const remaining = sessionDuration - elapsed;
            const remainingMinutes = Math.floor(remaining / (60 * 1000));
            const remainingSeconds = Math.floor((remaining % (60 * 1000)) / 1000);

            console.log('=== SESSION STATUS ===');
            console.log('Session Duration:', Math.floor(sessionDuration / (60 * 1000)), 'minutes');
            console.log('Time Elapsed:', Math.floor(elapsed / (60 * 1000)), 'minutes');
            console.log('Time Remaining:', remainingMinutes, 'minutes', remainingSeconds, 'seconds');
            console.log('Last Activity:', new Date(lastActivityTime).toLocaleTimeString());
            console.log('Session Timer Active:', !!sessionTimer);
            console.log('Warning Shown:', sessionWarningShown);
            console.log('Critical Shown:', sessionCriticalShown);

            return {
                duration: sessionDuration,
                elapsed: elapsed,
                remaining: remaining,
                lastActivity: lastActivityTime,
                timerActive: !!sessionTimer,
                warningShown: sessionWarningShown,
                criticalShown: sessionCriticalShown
            };
        }

        function setSessionDuration(minutes) {
            console.log(`Setting session duration to ${minutes} minutes`);
            sessionDuration = minutes * 60 * 1000;
            lastActivityTime = Date.now(); // Reset timer
            sessionWarningShown = false;
            sessionCriticalShown = false;

            // Actualizar el contador inmediatamente
            const sessionCounter = document.getElementById('session-counter');
            if (sessionCounter) {
                sessionCounter.classList.remove('warning', 'critical');
            }

            showNotification(`Duración de sesión cambiada a ${minutes} minutos`, 'info');
        }

        // Exponer funciones del contador de sesión
        window.getSessionStatus = getSessionStatus;
        window.setSessionDuration = setSessionDuration;
        window.extendSessionManually = extendSessionManually;

        // Función de ayuda para el contador de sesión
        function helpSessionCounter() {
            console.log('⏱️ === AYUDA: CONTADOR DE SESIÓN ===');
            console.log('');
            console.log('📍 ¿Dónde está el contador?');
            console.log('   - En el header, al lado del botón de información del usuario');
            console.log('   - Muestra el tiempo restante en formato MM:SS');
            console.log('   - Tiene un ícono de reloj animado');
            console.log('');
            console.log('⚡ ¿Qué hace?');
            console.log('   - Cuenta regresiva desde 15 minutos');
            console.log('   - Se reinicia con cualquier actividad del usuario');
            console.log('   - Cambia de color cuando quedan pocos minutos');
            console.log('   - Redirige al login cuando llega a 00:00');
            console.log('');
            console.log('🎨 Colores del contador:');
            console.log('   🔵 Azul: Tiempo normal (> 5 min)');
            console.log('   🟡 Amarillo: Advertencia (≤ 5 min)');
            console.log('   🔴 Rojo: Crítico (≤ 2 min)');
            console.log('');
            console.log('🖱️ Interacción:');
            console.log('   - Click: Extiende la sesión manualmente');
            console.log('   - Hover: Muestra "Click para extender la sesión"');
            console.log('');
            console.log('🛠️ Comandos útiles:');
            console.log('   - getSessionStatus(): Ver estado actual');
            console.log('   - setSessionDuration(20): Cambiar a 20 minutos');
            console.log('   - extendSessionManually(): Extender sesión');
            console.log('');
            console.log('⚙️ Configuración por defecto:');
            console.log('   - Duración: 15 minutos');
            console.log('   - Advertencia: 5 minutos restantes');
            console.log('   - Crítico: 2 minutos restantes');
            console.log('');
            console.log('💡 Tip: El contador se reinicia automáticamente con cualquier actividad');
        }

        // Exponer función de ayuda del contador
        window.helpSessionCounter = helpSessionCounter;

        // Función para verificar que el sistema esté funcionando correctamente
        function verifySystemStatus() {
            console.log('🔍 === VERIFICACIÓN DEL SISTEMA ===');
            console.log('');

            // Verificar elementos principales
            const elements = {
                'QR Modal': document.getElementById('qr-modal'),
                'Scan QR Button': document.getElementById('scan-qr-btn'),
                'Session Counter': document.getElementById('session-counter'),
                'Messages Area': document.getElementById('messages-area'),
                'Main Container': document.getElementById('main-container')
            };

            console.log('📊 Elementos del DOM:');
            Object.entries(elements).forEach(([name, element]) => {
                const exists = !!element;
                const visible = element ? !element.classList.contains('hidden') : false;
                console.log(`   ${exists ? '✅' : '❌'} ${name}: ${exists ? (visible ? 'Visible' : 'Hidden') : 'No encontrado'}`);
            });

            console.log('');
            console.log('⚙️ Estado de la aplicación:');
            console.log(`   - Token: ${token || 'No definido'}`);
            console.log(`   - Usuario actual: ${currentUser ? currentUser.username : 'No definido'}`);
            console.log(`   - Chat actual: ${currentChatId || 'Ninguno'}`);
            console.log(`   - WhatsApp conectado: ${isConnected}`);
            console.log(`   - Contador de sesión activo: ${!!sessionTimer}`);

            console.log('');
            console.log('🛠️ Funciones disponibles:');
            console.log('   - helpSessionCounter(): Ayuda del contador de sesión');
            console.log('   - getSessionStatus(): Estado actual de la sesión');
            console.log('   - debugQRModal(): Debug del modal QR');
            console.log('   - diagnoseQRModal(): Diagnóstico completo');

            return {
                elements: Object.fromEntries(Object.entries(elements).map(([k, v]) => [k, !!v])),
                session: {
                    id: token,
                    user: currentUser?.username,
                    connected: isConnected,
                    counterActive: !!sessionTimer
                }
            };
        }

        // Exponer función de verificación del sistema
        window.verifySystemStatus = verifySystemStatus;

        // Función de ayuda para verificar que el sistema está funcionando correctamente
        function helpSystemStatus() {
            console.log('🔍 === ESTADO DEL SISTEMA ===');
            console.log('');
            console.log('✅ Sistema con preservación completa de audio:');
            console.log('   - Actualización de chat: Simple y directa');
            console.log('   - Reproducción de audio: NO se interrumpe, se reanuda automáticamente');
            console.log('   - Preservación de audio: ✅ ACTIVA con reanudación automática');
            console.log('   - Manejo de errores de audio: Detecta y muestra mensajes informativos');
            console.log('   - Scroll: Automático al final');
            console.log('   - Sin polling inteligente');
            console.log('');
            console.log('✅ Funcionalidades activas:');
            console.log('   - Contador de sesión: ✅ Activo');
            console.log('   - Botón escanear QR: ✅ Activo');
            console.log('   - Modal QR: ✅ Funcional');
            console.log('   - Actualización de mensajes: ✅ Simple');
            console.log('   - 🎵 Preservación de audio: ✅ ACTIVA');
            console.log('   - 🎵 Manejo de errores de audio: ✅ Activo');
            console.log('');
            console.log('🛠️ Comandos de verificación:');
            console.log('   - verifySystemStatus(): Verificar elementos del DOM');
            console.log('   - helpSessionCounter(): Ayuda del contador');
            console.log('   - getSessionStatus(): Estado de la sesión');
            console.log('   - helpAudioProblem(): Ayuda del sistema de audio');
            console.log('   - debugAudioElements(): Ver estado de audios');
            console.log('   - quickAudioCheck(): Verificación rápida de audio');
            console.log('   - testAudioPreservation(): Probar preservación de audio');
            console.log('');
            console.log('🎯 Estado actual:');
            const status = verifySystemStatus();
            console.log('   - Elementos del DOM:', Object.values(status.elements).filter(Boolean).length + '/' + Object.keys(status.elements).length, 'OK');
            console.log('   - Sesión activa:', status.session.id ? '✅' : '❌');
            console.log('   - Contador activo:', status.session.counterActive ? '✅' : '❌');
        }

        // Exponer función de ayuda del sistema
        window.helpSystemStatus = helpSystemStatus;

        // Función para probar la preservación de audio durante actualizaciones
        function testAudioPreservation() {
            console.log('🎵 === TESTING AUDIO PRESERVATION ===');

            // Simular que hay un audio reproduciéndose
            const audioElements = document.querySelectorAll('audio');
            if (audioElements.length === 0) {
                console.log('ℹ️ No se encontraron elementos de audio para probar');
                console.log('💡 Reproduce un audio en el chat y luego ejecuta esta función');
                return;
            }

            console.log(`🎧 Encontrados ${audioElements.length} elementos de audio`);

            // Guardar estados actuales
            console.log('1. Guardando estados de audio...');
            const savedStates = saveAudioStates();
            console.log(`   Estados guardados: ${savedStates.size}`);

            // Simular una actualización del chat
            setTimeout(() => {
                console.log('2. Simulando actualización del chat...');
                // Recrear el contenido del messagesArea
                const messagesArea = document.getElementById('messages-area');
                const currentContent = messagesArea.innerHTML;
                messagesArea.innerHTML = currentContent; // Recrear mismo contenido

                // Restaurar estados
                setTimeout(() => {
                    console.log('3. Restaurando estados de audio...');
                    restoreAudioStates(savedStates);

                    setTimeout(() => {
                        console.log('✅ Test de preservación completado');
                        console.log('🎵 Los audios deberían mantener su posición sin interrumpirse');
                    }, 200);
                }, 100);
            }, 500);
        }

        // Función para ver el estado actual de todos los audios
        function debugAudioElements() {
            console.log('🔊 === AUDIO ELEMENTS DEBUG ===');

            const audioElements = document.querySelectorAll('audio');
            console.log(`Total audio elements: ${audioElements.length}`);

            audioElements.forEach((audio, index) => {
                const messageElement = audio.closest('.message');
                const messageId = messageElement?.dataset.messageId || `audio-${index}`;

                console.log(`🎵 Audio ${index + 1}:`);
                console.log(`   ID: ${messageId}`);
                console.log(`   Src: ${audio.src || 'No source'}`);
                console.log(`   Current time: ${audio.currentTime.toFixed(2)}s`);
                console.log(`   Duration: ${audio.duration.toFixed(2)}s`);
                console.log(`   Is playing: ${!audio.paused}`);
                console.log(`   Volume: ${audio.volume}`);
                console.log(`   Muted: ${audio.muted}`);
                console.log(`   Ready state: ${audio.readyState}`);
                console.log('');
            });

            if (audioElements.length === 0) {
                console.log('ℹ️ No hay elementos de audio en el chat actual');
            }
        }

        // Función de ayuda específica para el problema de audio
        function helpAudioProblem() {
            console.log('🎵 === AYUDA: PROBLEMA DE AUDIO ===');
            console.log('');
            console.log('📝 Problema: Los audios se cortan durante actualizaciones del chat');
            console.log('');
            console.log('✅ Estado actual:');
            console.log('   - Sistema de preservación de audio: ✅ ACTIVO');
            console.log('   - Los audios YA NO se interrumpen durante actualizaciones del chat');
            console.log('   - Reanudación automática: ✅ ACTIVA para audios que estaban reproduciéndose');
            console.log('   - Manejo de errores de audio: ✅ ACTIVO');
            console.log('   - Mensajes informativos para formatos no soportados');
            console.log('');
            console.log('🛠️ Funciones de debugging:');
            console.log('   - debugAudioElements(): Ver estado de todos los audios');
            console.log('   - quickAudioCheck(): Verificación rápida');
            console.log('   - testAudioErrors(): Probar manejo de errores');
            console.log('   - checkAudioFormatSupport(): Verificar formatos soportados');
            console.log('');
            console.log('⚙️ Comportamiento actual:');
            console.log('   1. 💾 Guardar estado de audios que están reproduciéndose');
            console.log('   2. 🔄 Actualizar contenido del chat');
            console.log('   3. ✅ Restaurar posición y configuración de audios');
            console.log('   4. ▶️ Los audios que estaban reproduciéndose se reanudan AUTOMÁTICAMENTE');
            console.log('   5. ⚠️ Si hay error, se muestra mensaje informativo');
            console.log('');
            console.log('💡 Situación actual:');
            console.log('   - Los audios YA NO se interrumpen durante actualizaciones');
            console.log('   - Se preserva la posición exacta de reproducción');
            console.log('   - Se mantiene volumen, velocidad y configuración');
            console.log('   - Los audios que estaban reproduciéndose CONTINUAN reproduciéndose');
            console.log('   - Sin intervención manual del usuario');
            console.log('');
            console.log('🎯 Mejoras implementadas:');
            console.log('   - Sistema completo de preservación de audio');
            console.log('   - Reanudación automática de reproducción');
            console.log('   - Mensajes informativos para formatos no soportados');
            console.log('   - Detección automática de errores de audio');
            console.log('   - Información detallada sobre el tipo de error');
            console.log('   - Recomendaciones para navegadores modernos');
            console.log('   - IDs únicos para mejor tracking de elementos');
        }

        // Exponer funciones de debugging de audio
        window.debugAudioElements = debugAudioElements;
        window.helpAudioProblem = helpAudioProblem;

        // Función rápida para verificar que el audio funciona correctamente
        function quickAudioCheck() {
            console.log('🎵 === QUICK AUDIO CHECK ===');

            const audioElements = document.querySelectorAll('audio');
            const hasPlayingAudio = Array.from(audioElements).some(audio => !audio.paused);

            console.log(`📊 Audio elements found: ${audioElements.length}`);
            console.log(`▶️  Audio currently playing: ${hasPlayingAudio ? 'YES' : 'NO'}`);

            if (hasPlayingAudio) {
                console.log('✅ Audio is playing and will continue playing during chat updates');
                console.log('💡 Test: Send a message while audio is playing to verify automatic continuation');
            } else {
                console.log('ℹ️ No audio is currently playing');
                console.log('💡 Test: Play an audio and then send a message to verify automatic continuation');
            }

            // Mostrar información adicional
            if (audioElements.length > 0) {
                console.log('🔧 Audio optimization applied:');
                console.log('   - preload="none" to prevent auto-downloads');
                console.log('   - controls added for better UX');
                console.log('   - ✅ STATE PRESERVATION during chat updates');
                console.log('   - 🎵 Audio playback will continue automatically');
                console.log('   - ▶️ No user interaction required');
            }

            return {
                audioCount: audioElements.length,
                hasPlayingAudio: hasPlayingAudio,
                optimizationActive: audioElements.length > 0
            };
        }



        // Función para probar errores de audio específicamente
        function testAudioErrors() {
            console.log('🧪 === TESTING AUDIO ERRORS ===');

            const audioElements = document.querySelectorAll('audio');
            console.log(`🎵 Found ${audioElements.length} audio elements`);

            if (audioElements.length === 0) {
                console.log('ℹ️ No audio elements found. Try sending an audio message first.');
                return;
            }

            // Forzar un error en el primer elemento de audio para probar
            const testAudio = audioElements[0];
            console.log('🔧 Testing audio error handling...');

            // Crear un elemento de audio con una URL inválida para forzar error
            const errorAudio = document.createElement('audio');
            errorAudio.src = 'invalid-audio-url.ogg';
            errorAudio.controls = true;
            errorAudio.preload = 'none';

            // Agregar el contenedor con mensaje de error
            const container = document.createElement('div');
            container.className = 'audio-container';
            container.innerHTML = `
                ${errorAudio.outerHTML}
                <div class="audio-error-message" style="
                    color: #666;
                    font-size: 12px;
                    margin-top: 8px;
                    padding: 8px;
                    background: #f8f9fa;
                    border-radius: 4px;
                    border: 1px solid #dee2e6;
                    display: none;
                ">
                    <strong>⚠️ Tu navegador no soporta el elemento de audio.</strong><br>
                    <span style="font-size: 11px;">Formato: audio/ogg - Intenta usar un navegador actualizado como Chrome, Firefox o Edge.</span>
                </div>
            `;

            // Agregar al DOM para probar
            testAudio.parentElement.appendChild(container);

            // Forzar el error
            errorAudio.addEventListener('error', function() {
                console.log('✅ Audio error handling triggered successfully!');
                console.log('🎯 Error message should be visible now');
            });

            console.log('🔄 Test completed - check if error message appears');
        }

        // Función para verificar soporte de formatos de audio
        function checkAudioFormatSupport() {
            console.log('🔍 === AUDIO FORMAT SUPPORT CHECK ===');

            const audio = document.createElement('audio');
            const formats = [
                { format: 'audio/ogg', ext: 'ogg', name: 'OGG' },
                { format: 'audio/mp3', ext: 'mp3', name: 'MP3' },
                { format: 'audio/wav', ext: 'wav', name: 'WAV' },
                { format: 'audio/mpeg', ext: 'mp3', name: 'MPEG' },
                { format: 'audio/ogg; codecs="vorbis"', ext: 'ogg', name: 'OGG Vorbis' }
            ];

            formats.forEach(format => {
                const support = audio.canPlayType(format.format);
                const supportText = support === 'probably' ? '✅ Soportado' :
                                   support === 'maybe' ? '⚠️ Posiblemente soportado' :
                                   '❌ No soportado';
                console.log(`${supportText} - ${format.name} (${format.format})`);
            });

            console.log('');
            console.log('💡 Recomendaciones:');
            console.log('   - Si OGG no funciona, considera usar MP3 o WAV');
            console.log('   - Usa navegadores modernos para mejor soporte');
        }

        // Función para probar específicamente la preservación de audio
        function testAudioPreservation() {
            console.log('🧪 === TESTING AUDIO PRESERVATION ===');

            const audioElements = document.querySelectorAll('audio');
            const playingAudios = Array.from(audioElements).filter(audio => !audio.paused);

            if (playingAudios.length === 0) {
                console.log('ℹ️ No hay audios reproduciéndose actualmente');
                console.log('💡 Reproduce un audio primero y luego ejecuta esta función');
                return;
            }

            console.log(`🎵 Audios reproduciéndose: ${playingAudios.length}`);
            console.log('🔄 Simulando actualización del chat...');

            // Guardar estados actuales
            const savedStates = saveAudioStates();
            console.log(`💾 Estados guardados: ${savedStates.size}`);

            // Simular recreación del contenido
            const messagesArea = document.getElementById('messages-area');
            const currentContent = messagesArea.innerHTML;

            setTimeout(() => {
                // Recrear contenido (esto es lo que haría displayMessages)
                messagesArea.innerHTML = currentContent;

                setTimeout(() => {
                    // Restaurar estados
                    restoreAudioStates(savedStates);

                    setTimeout(() => {
                        console.log('✅ Test completado');
                        console.log('🎵 Los audios deberían mantener su posición y continuar reproduciéndose');
                        console.log('💡 Los audios que estaban reproduciéndose deberían continuar automáticamente');

                        // Verificar que los audios se restauraron correctamente
                        const restoredAudios = document.querySelectorAll('audio');
                        restoredAudios.forEach((audio, index) => {
                            if (audio.currentTime > 0) {
                                const status = !audio.paused ? 'reproduciéndose' : 'pausado';
                                console.log(`✅ Audio ${index + 1}: Posición restaurada a ${audio.currentTime.toFixed(2)}s - ${status}`);
                            }
                        });
                    }, 300);
                }, 150);
            }, 500);
        }

        // Exponer función de verificación rápida
        window.quickAudioCheck = quickAudioCheck;
        window.testAudioErrors = testAudioErrors;
        window.checkAudioFormatSupport = checkAudioFormatSupport;
        window.testAudioPreservation = testAudioPreservation;

        // Función de emergencia para silenciar mensajes problemáticos temporalmente
        function emergencySessionSilence() {
            console.log('🚨 === EMERGENCY SESSION SILENCE ACTIVATED ===');
            console.log('⏰ This will temporarily silence session-related notifications for 30 minutes');

            // Silenciar showNotification temporalmente
            const originalShowNotification = window.showNotification;
            window.showNotification = function(message, type) {
                // Solo permitir mensajes críticos, bloquear los de sesión
                if (message.toLowerCase().includes('sesión') ||
                    message.toLowerCase().includes('session') ||
                    message.toLowerCase().includes('expirada') ||
                    message.toLowerCase().includes('expired') ||
                    message.toLowerCase().includes('activa') ||
                    message.toLowerCase().includes('active')) {

                    console.log('🔇 Session notification blocked:', message);
                    return; // No mostrar la notificación
                }

                return originalShowNotification.apply(this, arguments);
            };

            // Intentar extender la sesión inmediatamente
            if (token) {
                extendSession();
            }

            // Restaurar notificaciones después de 30 minutos
            setTimeout(() => {
                window.showNotification = originalShowNotification;
                console.log('🔄 Emergency silence ended - notifications restored');
                showNotification('Silencio de emergencia terminado', 'info');
            }, 30 * 60 * 1000); // 30 minutos

            console.log('✅ Emergency session silence activated');
            console.log('💡 Use helpSessionProblem() for permanent solutions');
        }

        // Exponer función de emergencia
        window.emergencySessionSilence = emergencySessionSilence;

        // Función que muestra todas las herramientas disponibles
        function showAllSessionTools() {
            console.log('🛠️ === TODAS LAS HERRAMIENTAS DE SESIÓN ===');
            console.log('');
            console.log('🔍 DIAGNÓSTICO:');
            console.log('  helpSessionProblem()       ← Guía completa de solución');
            console.log('  debugSessionMessage()      ← Interceptar mensajes de sesión');
            console.log('  debugSessionRequests()     ← Ver peticiones HTTP');
            console.log('');
            console.log('🛠️ MANTENIMIENTO:');
            console.log('  extendSession()            ← Extender sesión manualmente');
            console.log('  startSessionMaintenance()  ← Iniciar mantenimiento automático');
            console.log('');
            console.log('🚨 EMERGENCIA:');
            console.log('  emergencySessionSilence()  ← Silenciar mensajes 30 min');
            console.log('');
            console.log('🔧 GENERAL:');
            console.log('  forceConnectionCheck()     ← Verificar conexión forzadamente');
            console.log('  diagnoseQRModal()          ← Diagnóstico del sistema QR');
            console.log('');
            console.log('💡 CONSEJO: Comienza con helpSessionProblem() para una solución paso a paso');
        }

        // Exponer función que muestra todas las herramientas
        window.showAllSessionTools = showAllSessionTools;

        async function refreshQR() {
            try {
                // Actualizar indicador de estado a "generando"
                updateQRStatusIndicator('connecting', '<i class="fas fa-spinner fa-spin"></i> Generando nuevo código QR...');

                await fetch('/api/qr/refresh', { method: 'POST' });
                showNotification('Regenerando código QR...', 'info');

                // Verificar si WhatsApp está conectado antes de mostrar el QR
                setTimeout(async () => {
                    try {
                        const response = await fetch('/api/stats');
                        const data = await response.json();
                        const isWhatsAppReady = data.whatsappListo || data.connected || data.ready;

                        if (!isWhatsAppReady) {
                            // Actualizar indicador a "esperando conexión"
                            updateQRStatusIndicator('connecting', '<i class="fas fa-spinner fa-spin"></i> Esperando conexión de WhatsApp...');
                            showQRModal();
                        } else {
                            updateQRStatusIndicator('connected', '<i class="fas fa-check-circle"></i> WhatsApp ya está conectado');
                            showNotification('WhatsApp ya está conectado - QR no necesario', 'success');
                            setTimeout(() => hideQRModalManually(), 2000);
                        }
            } catch (error) {
                        console.error('Error checking connection in refreshQR:', error);
                        // En caso de error, mostrar QR como fallback
                        updateQRStatusIndicator('error', '<i class="fas fa-exclamation-triangle"></i> Error generando QR');
                        showQRModal();
                    }
                }, 3000);
            } catch (error) {
                updateQRStatusIndicator('error', '<i class="fas fa-exclamation-triangle"></i> Error regenerando QR');
                showNotification('Error regenerando QR', 'error');
            }
        }

        function setupFileHandling() {
            const attachBtn = document.getElementById('attach-btn');
            const fileInput = document.getElementById('file-input');
            const messageInputArea = document.getElementById('message-input-area');
            const dragOverlay = document.getElementById('drag-overlay');
            const clearFilesBtn = document.getElementById('clear-files-btn');

            if (attachBtn && fileInput) {
                attachBtn.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', (e) => {
                    handleFiles(Array.from(e.target.files));
                });
            }

            if (messageInputArea) {
                messageInputArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    messageInputArea.classList.add('drag-over');
                    if (dragOverlay) dragOverlay.style.display = 'flex';
                });

                messageInputArea.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (!messageInputArea.contains(e.relatedTarget)) {
                        messageInputArea.classList.remove('drag-over');
                        if (dragOverlay) dragOverlay.style.display = 'none';
                    }
                });

                messageInputArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    messageInputArea.classList.remove('drag-over');
                    if (dragOverlay) dragOverlay.style.display = 'none';

                    const files = Array.from(e.dataTransfer.files);
                    handleFiles(files);
                });
            }

            if (clearFilesBtn) {
                clearFilesBtn.addEventListener('click', clearFiles);
            }
        }

        function handleFiles(files) {
            const validFiles = files.filter(file => {
                if (file.size > 50 * 1024 * 1024) {
                    showNotification(`El archivo "${file.name}" es demasiado grande (m�ximo 50MB)`, 'error');
                    return false;
                }
                return true;
            });

            selectedFiles = [...selectedFiles, ...validFiles];
            updateFilePreview();
            
            const previewArea = document.getElementById('file-preview-area');
            if (previewArea && selectedFiles.length > 0) {
                previewArea.style.display = 'block';
            }
        }

        function updateFilePreview() {
            const previewList = document.getElementById('file-preview-list');
            if (!previewList) return;

            previewList.innerHTML = '';

            selectedFiles.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'file-preview-item';
                
                if (file.type.startsWith('image/')) {
                    item.classList.add('image');
                    const img = document.createElement('img');
                    img.className = 'file-preview-image';
                    img.src = URL.createObjectURL(file);
                    item.appendChild(img);
                } else {
                    const icon = document.createElement('div');
                    icon.className = 'file-preview-icon';
                    icon.innerHTML = getFileIcon(file.type);
                    item.appendChild(icon);
                }

                const info = document.createElement('div');
                info.className = 'file-preview-info';
                
                const name = document.createElement('div');
                name.className = 'file-preview-name';
                name.textContent = file.name;
                name.title = file.name;
                
                const size = document.createElement('div');
                size.className = 'file-preview-size';
                size.textContent = formatFileSize(file.size);
                
                info.appendChild(name);
                info.appendChild(size);
                item.appendChild(info);

                const removeBtn = document.createElement('button');
                removeBtn.className = 'file-preview-remove';
                removeBtn.innerHTML = '�';
                removeBtn.onclick = () => removeFile(index);
                item.appendChild(removeBtn);

                previewList.appendChild(item);
            });
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFilePreview();
            
            if (selectedFiles.length === 0) {
                const previewArea = document.getElementById('file-preview-area');
                if (previewArea) previewArea.style.display = 'none';
            }
        }

        function clearFiles() {
            selectedFiles = [];
            updateFilePreview();
            const previewArea = document.getElementById('file-preview-area');
            if (previewArea) previewArea.style.display = 'none';
        }

        function getFileIcon(mimeType) {
            if (mimeType.startsWith('image/')) return '<i class="fas fa-image"></i>';
            if (mimeType.startsWith('video/')) return '<i class="fas fa-video"></i>';
            if (mimeType.startsWith('audio/')) return '<i class="fas fa-music"></i>';
            if (mimeType.includes('pdf')) return '<i class="fas fa-file-pdf"></i>';
            if (mimeType.includes('word') || mimeType.includes('document')) return '<i class="fas fa-file-word"></i>';
            if (mimeType.includes('zip') || mimeType.includes('rar')) return '<i class="fas fa-file-archive"></i>';
            return '<i class="fas fa-file"></i>';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Variables para optimizar las actualizaciones de mensajes
        let lastMessagesHash = '';
        let messagePollingInterval = null;

        function startSmartMessagePolling() {
            if (messagePollingInterval) {
                clearInterval(messagePollingInterval);
            }

            messagePollingInterval = setInterval(() => {
                if (currentChatId) {
                    loadMessagesSmart(currentChatId);
                }
            }, 3000); // Verificar cada 3 segundos para mejor tiempo real
        }

        // Función inteligente para cargar mensajes solo cuando sea necesario
        async function loadMessagesSmart(chatId) {
            try {
                console.log(`🔍 Verificando mensajes para chat ${chatId}...`);

                // Usar directamente el endpoint correcto
                let response = await fetch(`/api/chats/${chatId}/messages`);
                let data;

                if (!response.ok) {
                    console.warn(`⚠️ Endpoint /api/chats/${chatId}/messages falló (${response.status})`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    data = await response.json();
                    data = { success: true, messages: data.messages || [] };
                } else {
                    data = await response.json();
                }

                console.log(`📡 Respuesta API: ${data.messages?.length || 0} mensajes recibidos`);

                if (data.success && data.messages) {
                    // Crear un hash más robusto que incluya más información del mensaje
                    const messagesHash = data.messages.map(msg =>
                        `${msg.id || msg.timestamp}-${msg.fromMe || false}-${msg.body?.substring(0, 100)}-${msg.status || 'unknown'}`
                    ).join('|');

                    console.log(`🔍 Hash actual: ${messagesHash.substring(0, 50)}...`);
                    console.log(`🔍 Hash anterior: ${lastMessagesHash ? lastMessagesHash.substring(0, 50) + '...' : 'VACÍO'}`);

                    // Solo actualizar si hay cambios reales
                    if (messagesHash !== lastMessagesHash) {
                        console.log('📝 ¡NUEVOS MENSAJES DETECTADOS! - Actualizando chat en tiempo real');
                        lastMessagesHash = messagesHash;
                        displayMessages(data.messages);

                        // Actualizar contador de mensajes no leídos si hay nuevos mensajes
                        const chat = chats.get(chatId);
                        if (chat && data.messages.length > 0) {
                            const lastMessage = data.messages[data.messages.length - 1];
                            if (lastMessage && !lastMessage.fromMe && !lastMessage.isRead) {
                                console.log('🔄 Actualizando contador de mensajes no leídos');
                                loadChats();
                            }
                        }

                        // Hacer scroll al final si es un mensaje nuevo
                        setTimeout(() => {
                            const messagesArea = document.getElementById('messages-area');
                            if (messagesArea) {
                                messagesArea.scrollTop = messagesArea.scrollHeight;
                            }
                        }, 100);

                    } else {
                        console.log('⏸️ Mensajes sin cambios - saltando actualización para preservar audio');
                    }
                } else if (data.error) {
                    console.error('❌ Error en respuesta de API:', data.error);
                }
            } catch (error) {
                console.error('❌ Error loading messages smart:', error);
                // Intentar reconectar después de un error
                setTimeout(() => {
                    if (currentChatId === chatId) {
                        console.log('🔄 Reintentando cargar mensajes después de error...');
                        loadMessagesSmart(chatId);
                    }
                }, 3000);
            }
        }

        function startPolling() {
            setInterval(checkConnectionStatus, 10000);
            setInterval(loadChats, 5000);
            // Usar función inteligente que solo actualiza cuando hay cambios
            startSmartMessagePolling();

            // Verificar periódicamente que el modal QR esté en el estado correcto
            setInterval(() => {
                console.log(`Periodic QR check - isConnected: ${isConnected}, qrModalClosedByConnection: ${qrModalClosedByConnection}`);

                if (isConnected) {
                    const qrModal = document.getElementById('qr-modal');
                    if (qrModal && !qrModal.classList.contains('hidden')) {
                        // Verificar si hay una transición de cierre programada o si el modal debe cerrarse
                        const indicator = document.getElementById('qr-status-indicator');
                        const isClosingTransition = indicator && (
                            indicator.innerHTML.includes('cerrará automáticamente') ||
                            indicator.innerHTML.includes('WhatsApp conectado')
                        );

                        if (!isClosingTransition) {
                            console.log('Auto-hiding QR modal - WhatsApp connected');
                            hideQRModalManually();
                        } else {
                            console.log('QR modal auto-close already scheduled or in transition, skipping auto-hide');
                        }
                    }
                } else {
                    // Si WhatsApp no está conectado, actualizar los botones QR
                    console.log('WhatsApp not connected - QR buttons should be visible');
                    updateQRButtonVisibility();
                    updateScanQRButtonVisibility();
                }
            }, 5000);
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'Ahora';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m`;
            if (diff < 86400000) return date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            return date.toLocaleDateString('es-ES');
        }

        function getMessageStatus(status) {
            switch (status) {
                case 'sending': return '?';
                case 'sent': return '?';
                case 'delivered': return '??';
                case 'read': return '??';
                default: return '';
            }
        }

        function formatMessageBody(body) {
            if (body && (body.includes('<img') || body.includes('<audio') || body.includes('<video') || body.includes('<div class="audio-player"') || body.includes('<div class="video-player"') || body.includes('<div class="audio-message-container"'))) {
                if (body.includes('<img')) {
                    return body.replace(/<img([^>]*?)>/g, '<img$1 onclick="showImageModal(this.src)" style="cursor: pointer;">');
                }

                // Manejar específicamente contenedores de mensajes de audio
                if (body.includes('<div class="audio-message-container"')) {
                    return body; // Retornar tal como está, ya está en formato correcto
                }

                // Mejorar elementos de audio para evitar interrupciones y agregar soporte multi-formato
                if (body.includes('<audio')) {
                    return body.replace(/<audio([^>]*?)>([\s\S]*?)<\/audio>/g, (match, attrs, content) => {
                        // Agregar controles si no los tiene
                        let newAttrs = attrs;
                        if (!attrs.includes('controls')) {
                            newAttrs += ' controls';
                        }

                        // Configurar preload para mejor buffering
                        if (!attrs.includes('preload=')) {
                            newAttrs += ' preload="metadata"';
                        }

                        // Agregar atributos para mejor control de preservación y buffering
                        if (!attrs.includes('data-audio-preserve')) {
                            newAttrs += ' data-audio-preserve="true"';
                        }

                        // Configurar buffering optimizado para evitar entrecortamiento
                        if (!attrs.includes('playsinline')) {
                            newAttrs += ' playsinline';
                        }

                        // Crear elemento audio con soporte multi-formato
                        const audioHtml = `<audio${newAttrs}>${content}</audio>`;

                        // Agregar un mensaje de error personalizado
                        const errorMessage = `
                            <div class="audio-error-message" style="
                                color: #666;
                                font-size: 12px;
                                margin-top: 8px;
                                padding: 8px;
                                background: #f8f9fa;
                                border-radius: 4px;
                                border: 1px solid #dee2e6;
                                display: none;
                            ">
                                <strong>⚠️ Tu navegador no soporta el elemento de audio.</strong><br>
                                <span style="font-size: 11px;">Formato: audio/ogg - Intenta usar un navegador actualizado como Chrome, Firefox o Edge.</span>
                            </div>
                        `;

                        return `
                            <div class="audio-container">
                                ${audioHtml}
                                ${errorMessage}
                            </div>
                        `;
                    });
                }

                return body;
            }
            return escapeHtml(body || '');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Función para manejar errores de elementos de audio y mejorar buffering
        function setupAudioErrorHandling() {
            // Usar delegación de eventos para manejar elementos de audio dinámicos
            document.addEventListener('error', function(e) {
                if (e.target && e.target.tagName === 'AUDIO') {
                    handleAudioError(e.target);
                }
            }, true);

            // También manejar el evento 'abort' y 'error' específicamente para audio
            document.addEventListener('DOMNodeInserted', function(e) {
                if (e.target && e.target.querySelectorAll) {
                    const audioElements = e.target.querySelectorAll('audio');
                    audioElements.forEach(audio => {
                        if (!audio.hasAttribute('data-error-handled')) {
                            audio.setAttribute('data-error-handled', 'true');

                            // Manejar errores
                            audio.addEventListener('error', function() {
                                handleAudioError(audio);
                            });

                            // Mejorar buffering agregando eventos de carga
                            audio.addEventListener('loadstart', function() {
                                console.log('🎵 Audio: Iniciando carga...');
                            });

                            audio.addEventListener('canplay', function() {
                                console.log('🎵 Audio: Listo para reproducir');
                            });

                            audio.addEventListener('waiting', function() {
                                console.log('🎵 Audio: Esperando datos...');
                                // Intentar reanudar automáticamente si está pausado por buffering
                                if (audio.paused && audio.readyState < 4) {
                                    audio.play().catch(err => console.log('No se pudo reanudar:', err));
                                }
                            });

                            audio.addEventListener('playing', function() {
                                console.log('🎵 Audio: Reproduciendo correctamente');
                            });

                            // Optimizar buffering para conexiones lentas
                            audio.addEventListener('timeupdate', function() {
                                // Si hay menos de 5 segundos de buffer, intentar cargar más datos
                                if (audio.buffered.length > 0) {
                                    const bufferedEnd = audio.buffered.end(audio.buffered.length - 1);
                                    const currentTime = audio.currentTime;
                                    if (bufferedEnd - currentTime < 5 && !audio.paused) {
                                        // Forzar carga de más datos si es necesario
                                        audio.preload = 'auto';
                                    }
                                }
                            });
                        }
                    });
                }
            });
        }

        // Función adicional para optimizar buffering de audio
        function optimizeAudioBuffering() {
            console.log('🔧 Optimizando configuración de buffering de audio...');

            // Configurar propiedades de audio para mejor rendimiento
            const audioElements = document.querySelectorAll('audio');
            audioElements.forEach(audio => {
                // Configurar tamaño de buffer para evitar entrecortamiento
                if (audio.readyState > 0) {
                    // Establecer propiedades para mejor reproducción
                    audio.autoplay = false; // Evitar reproducción automática problemática
                    audio.volume = audio.volume || 1.0; // Asegurar volumen adecuado

                    // Optimizar para conexiones lentas
                    if ('mozPreserveDrawingBuffer' in audio) {
                        audio.mozPreserveDrawingBuffer = true;
                    }
                }
            });

            console.log('✅ Optimización de buffering completada');
        }

        // Función para forzar actualización de mensajes (útil para debugging)
        function forceMessageUpdate() {
            console.log('🔄 Forzando actualización de mensajes...');
            lastMessagesHash = ''; // Reset hash to force update
            if (currentChatId) {
                loadMessagesSmart(currentChatId);
            }
        }

        // Función de diagnóstico para verificar el estado del tiempo real
        function diagnoseRealtime() {
            console.log('🔍 === DIAGNÓSTICO TIEMPO REAL ===');
            console.log(`   Chat actual: ${currentChatId || 'Ninguno'}`);
            console.log(`   Último hash de mensajes: ${lastMessagesHash ? lastMessagesHash.substring(0, 50) + '...' : 'Vacío'}`);
            console.log(`   Polling activo: ${messagePollingInterval ? 'Sí' : 'No'}`);
            console.log(`   Chats cargados: ${chats.size}`);

            if (currentChatId) {
                console.log('   📡 Probando conexión a API...');
                loadMessagesSmart(currentChatId).then(() => {
                    console.log('   ✅ API responde correctamente');
                }).catch(error => {
                    console.error('   ❌ Error en API:', error);
                });
            }

            console.log('   💡 Sugerencias:');
            console.log('      - Si no se actualizan los mensajes, usa forceMessageUpdate()');
            console.log('      - Usa testAPIEndpoints() para verificar ambos endpoints');
            console.log('      - Revisa la consola del navegador para errores detallados');
            console.log('      - El sistema verifica cada 3 segundos automáticamente');
        }

        // Función para probar ambos endpoints de API
        async function testAPIEndpoints() {
            if (!currentChatId) {
                console.error('❌ No hay chat seleccionado');
                return;
            }

            console.log('🧪 === PRUEBA DE ENDPOINTS API ===');

            // Probar endpoint correcto
            try {
                console.log('📡 Probando /api/chats/${chatId}/messages...');
                const response1 = await fetch(`/api/chats/${currentChatId}/messages`);
                if (response1.ok) {
                    const data1 = await response1.json();
                    console.log('✅ /api/chats/${chatId}/messages funciona:', data1.messages?.length || 0, 'mensajes');
                } else {
                    console.error('❌ /api/chats/${chatId}/messages falló:', response1.status);
                }
            } catch (error) {
                console.error('❌ Error en /api/chats/${chatId}/messages:', error);
            }

            // Probar endpoint alternativo
            try {
                console.log('📡 Probando /api/chats/.../messages...');
                const response2 = await fetch(`/api/chats/${currentChatId}/messages`);
                if (response2.ok) {
                    const data2 = await response2.json();
                    console.log('✅ /api/chats/.../messages funciona:', data2.messages?.length || 0, 'mensajes');
                } else {
                    console.error('❌ /api/chats/.../messages falló:', response2.status);
                }
            } catch (error) {
                console.error('❌ Error en /api/chats/.../messages:', error);
            }
        }

        // Función para monitoreo en tiempo real (útil para debugging)
        let realtimeMonitor = null;
        function startRealtimeMonitor() {
            if (realtimeMonitor) {
                clearInterval(realtimeMonitor);
            }

            console.log('🔬 Iniciando monitor en tiempo real...');
            realtimeMonitor = setInterval(() => {
                if (currentChatId) {
                    console.log(`🔍 [MONITOR] Chat: ${currentChatId} | Hash: ${lastMessagesHash ? 'ACTIVO' : 'VACÍO'} | Polling: ${messagePollingInterval ? 'ON' : 'OFF'}`);
                } else {
                    console.log('🔍 [MONITOR] Sin chat seleccionado');
                }
            }, 5000); // Log cada 5 segundos
        }

        function stopRealtimeMonitor() {
            if (realtimeMonitor) {
                clearInterval(realtimeMonitor);
                realtimeMonitor = null;
                console.log('⏹️ Monitor en tiempo real detenido');
            }
        }

        // Función de diagnóstico para problemas de sesión
        function diagnoseSession() {
            console.log('🔍 === DIAGNÓSTICO DE SESIÓN ===');
            console.log(`   token: ${token ? 'PRESENTE' : 'FALTANTE'}`);
            console.log(`   localStorage token: ${localStorage.getItem('token') ? 'PRESENTE' : 'FALTANTE'}`);
            console.log(`   currentUser: ${currentUser ? currentUser.username : 'NULO'}`);
            console.log(`   Estado de red: ${navigator.onLine ? 'ONLINE' : 'OFFLINE'}`);

            if (token) {
                console.log('   🔍 Probando validación de sesión...');
                validateSession().then(isValid => {
                    console.log(`   ✅ Validación: ${isValid ? 'VÁLIDA' : 'INVÁLIDA'}`);
                }).catch(error => {
                    console.error('   ❌ Error en validación:', error);
                });
            } else {
                console.error('   ❌ NO HAY SESSIONID - Problema de autenticación');
                console.log('   💡 Sugerencias:');
                console.log('      - Verifica que hayas iniciado sesión');
                console.log('      - Revisa la consola del navegador para errores de login');
                console.log('      - Intenta refrescar la página');
            }

            console.log('   💡 Si persiste el problema:');
            console.log('      - Usa clearSession() para limpiar datos corruptos');
            console.log('      - Revisa que la API /api/session esté funcionando');
        }

        // Función para limpiar datos de sesión corruptos
        function clearSession() {
            console.log('🧹 Limpiando datos de sesión...');
            localStorage.removeItem('token');
            token = null;
            currentUser = null;
            showNotification('Sesión limpiada. Redirigiendo al login...', 'info');
            setTimeout(() => showLoginScreen(), 1000);
        }

        // Llamar a la optimización cuando se cargue la página
        window.addEventListener('load', function() {
            setTimeout(optimizeAudioBuffering, 1000); // Esperar 1 segundo para que se carguen los elementos
        });

        function handleAudioError(audioElement) {
            const container = audioElement.closest('.audio-container');
            if (container) {
                const errorMessage = container.querySelector('.audio-error-message');
                if (errorMessage) {
                    errorMessage.style.display = 'block';

                    // Intentar detectar el tipo de error más específicamente
                    let errorType = 'desconocido';
                    if (audioElement.error) {
                        switch (audioElement.error.code) {
                            case MediaError.MEDIA_ERR_ABORTED:
                                errorType = 'abortado';
                                break;
                            case MediaError.MEDIA_ERR_NETWORK:
                                errorType = 'de red';
                                break;
                            case MediaError.MEDIA_ERR_DECODE:
                                errorType = 'de decodificación';
                                break;
                            case MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED:
                                errorType = 'formato no soportado';
                                break;
                        }
                    }

                    // Obtener información del formato
                    let formatInfo = '';
                    if (audioElement.src) {
                        const url = new URL(audioElement.src);
                        const pathname = url.pathname;
                        const extension = pathname.substring(pathname.lastIndexOf('.') + 1).toLowerCase();
                        formatInfo = `Formato: audio/${extension}`;
                    }

                    // Actualizar el mensaje de error con información más detallada
                    const errorText = errorMessage.querySelector('span');
                    if (errorText) {
                        errorText.innerHTML = `${formatInfo} - Error: ${errorType}.<br>Intenta usar un navegador actualizado como Chrome, Firefox o Edge.`;
                    }

                    console.log(`🎵 Audio error: ${errorType} - ${formatInfo}`);
                }
            }
        }

        function showImageModal(imageSrc) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.9); display: flex; justify-content: center; 
                align-items: center; z-index: 10000; cursor: pointer;
            `;
            
            const img = document.createElement('img');
            img.src = imageSrc;
            img.style.cssText = `
                max-width: 95%; max-height: 95%; border-radius: 12px; 
                object-fit: contain; cursor: pointer;
            `;
            
            const closeBtn = document.createElement('div');
            closeBtn.innerHTML = '?';
            closeBtn.style.cssText = `
                position: absolute; top: 20px; right: 30px; color: white; 
                font-size: 30px; cursor: pointer; background: rgba(0,0,0,0.5); 
                border-radius: 50%; width: 40px; height: 40px; display: flex; 
                justify-content: center; align-items: center;
            `;
            
            modal.appendChild(img);
            modal.appendChild(closeBtn);
            document.body.appendChild(modal);
            
            img.onclick = function(e) { e.stopPropagation(); };
            modal.onclick = closeBtn.onclick = function() {
                        document.body.removeChild(modal);
            };
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.getElementById('notifications').appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            
                setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // FUNCIONES PARA N�MEROS OMITIDOS
        async function showOmittedModal() {
            const modal = document.getElementById('omitted-modal');
            if (modal) {
                modal.classList.remove('hidden');
                await loadOmittedNumbers();
            }
        }

        function closeOmittedModal() {
            const modal = document.getElementById('omitted-modal');
            if (modal) {
                modal.classList.add('hidden');
                document.getElementById('omitted-number').value = '';
                document.getElementById('omitted-reason').value = '';
            }
        }

        async function loadOmittedNumbers() {
            try {
                const response = await fetch(`/api/omitted-numbers?token=${token}`);
                const data = await response.json();

                if (data.success) {
                    displayOmittedNumbers(data.numeros);
                } else {
                    showNotification('Error cargando n�meros omitidos', 'error');
                }
            } catch (error) {
                console.error('Error cargando n�meros omitidos:', error);
                showNotification('Error de conexi�n', 'error');
            }
        }

        function displayOmittedNumbers(numeros) {
            const omittedList = document.getElementById('omitted-list');
            if (!omittedList) return;

            if (!numeros || numeros.length === 0) {
                omittedList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No hay n�meros omitidos registrados</p>';
                return;
            }

            omittedList.innerHTML = numeros.map(numero => `
                <div class="omitted-item">
                    <button class="delete-btn" onclick="eliminarNumeroOmitido(${numero.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                    <div class="numero">?? ${numero.numero}</div>
                    <div class="motivo">${numero.motivo || 'Sin motivo especificado'}</div>
                    <div class="meta">Agregado por: ${numero.creado_por} � ${formatDate(numero.fecha_creacion)}</div>
                </div>
            `).join('');
        }

        async function agregarNumeroOmitido() {
            const numero = document.getElementById('omitted-number').value.trim();
            const motivo = document.getElementById('omitted-reason').value.trim();

            if (!numero) {
                showNotification('Por favor ingresa un n�mero', 'error');
                return;
            }

            if (!/^\d+$/.test(numero)) {
                showNotification('El n�mero solo debe contener d�gitos', 'error');
                return;
            }

            try {
                const response = await fetch('/api/omitted-numbers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ numero, motivo, token })
                });

                const data = await response.json();

                if (data.success) {
                    showNotification(data.message, 'success');
                    document.getElementById('omitted-number').value = '';
                    document.getElementById('omitted-reason').value = '';
                    await loadOmittedNumbers();
                } else {
                    showNotification(data.message, 'error');
                }
            } catch (error) {
                console.error('Error agregando n�mero omitido:', error);
                showNotification('Error de conexi�n', 'error');
            }
        }

        async function eliminarNumeroOmitido(id) {
            if (!confirm('�Est�s seguro de que quieres eliminar este n�mero omitido?')) return;

            try {
                const response = await fetch(`/api/omitted-numbers/${id}?token=${token}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showNotification(data.message, 'success');
                    await loadOmittedNumbers();
                } else {
                    showNotification(data.message, 'error');
                }
            } catch (error) {
                console.error('Error eliminando n�mero omitido:', error);
                showNotification('Error de conexi�n', 'error');
            }
        }

        // FUNCIONES PARA ADMINISTRACI�N DE USUARIOS
        async function showUsersAdminModal() {
            const modal = document.getElementById('users-admin-modal');
            if (modal) {
                modal.classList.remove('hidden');
                await loadUsersAdmin();
            }
        }

        function closeUsersAdminModal() {
            const modal = document.getElementById('users-admin-modal');
            if (modal) modal.classList.add('hidden');
        }

        async function loadUsersAdmin() {
            try {
                // Validar sesión antes de la operación
                const sessionValid = await validateSession();
                if (!sessionValid) return;

                if (!currentUser || currentUser.rol !== 'admin') {
                    showNotification('Acceso denegado: Solo administradores pueden ver esta informaci�n', 'error');
                    return;
                }

                const response = await fetch(`/api/users?token=${token}`);
                
                if (!response.ok) {
                    if (response.status === 403) {
                        showNotification('Acceso denegado', 'error');
                        return;
                    }
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    displayUsersAdmin(data.users || []);
                } else {
                    showNotification(data.message || 'Error cargando usuarios', 'error');
                }
            } catch (error) {
                console.error('Error cargando usuarios:', error);
                showNotification(`Error de conexi�n: ${error.message}`, 'error');
            }
        }

        function displayUsersAdmin(users) {
            const usersList = document.getElementById('users-admin-list');
            if (!usersList) return;

            if (!users || users.length === 0) {
                usersList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No hay usuarios registrados</p>';
                return;
            }

            usersList.innerHTML = users.map(user => `
                <div class="omitted-item">
                    <div class="user-actions" style="position: absolute; top: 10px; right: 10px; display: flex; gap: 8px;">
                        <button class="edit-btn" onclick="editarUsuario(${user.id}, '${user.username}', '${user.nombre}', '${user.rol}')" ${(user.username === 'admin' || user.username === 'api_user' || user.username === 'api') ? 'style="display:none;"' : ''} title="Editar usuario">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-btn" onclick="eliminarUsuarioAdmin(${user.id})" ${(user.username === 'admin' || user.username === 'api_user' || user.username === 'api') ? 'style="display:none;"' : ''} title="Eliminar usuario">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="numero">?? ${user.username}</div>
                    <div class="motivo">${user.nombre} - Rol: ${user.rol === 'admin' ? 'Administrador' : user.rol === 'api' ? 'API Especial' : 'Soporte'}</div>
                    <div class="meta">Creado: ${formatDate(user.fecha_creacion)}</div>
                </div>
            `).join('');
        }

        async function eliminarUsuarioAdmin(id) {
            if (!confirm('�Est�s seguro de que quieres eliminar este usuario?')) return;

            try {
                const response = await fetch(`/api/users/${id}?token=${token}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showNotification(data.message, 'success');
                    await loadUsersAdmin();
                } else {
                    showNotification(data.message, 'error');
                }
            } catch (error) {
                console.error('Error eliminando usuario:', error);
                showNotification('Error de conexi�n', 'error');
            }
        }

        function editarUsuario(id, username, nombre, rol) {
            document.getElementById('edit-user-id').value = id;
            document.getElementById('edit-user-username').value = username;
            document.getElementById('edit-user-nombre').value = nombre;
            document.getElementById('edit-user-role').value = rol;
            document.getElementById('edit-user-password').value = '';

            const modal = document.getElementById('edit-user-modal');
            if (modal) {
                modal.classList.remove('hidden');
            }
        }

        function closeEditUserModal() {
            const modal = document.getElementById('edit-user-modal');
            if (modal) {
                modal.classList.add('hidden');
                document.getElementById('edit-user-id').value = '';
                document.getElementById('edit-user-username').value = '';
                document.getElementById('edit-user-password').value = '';
                document.getElementById('edit-user-nombre').value = '';
                document.getElementById('edit-user-role').value = 'soporte';
            }
        }

        function showAddUserModal() {
            const modal = document.getElementById('add-user-modal');
            if (modal) {
                modal.classList.remove('hidden');
                document.getElementById('new-user-username').value = '';
                document.getElementById('new-user-password').value = '';
                document.getElementById('new-user-nombre').value = '';
                document.getElementById('new-user-role').value = 'soporte';
            }
        }

        function closeAddUserModal() {
            const modal = document.getElementById('add-user-modal');
            if (modal) {
                modal.classList.add('hidden');
                document.getElementById('new-user-username').value = '';
                document.getElementById('new-user-password').value = '';
                document.getElementById('new-user-nombre').value = '';
                document.getElementById('new-user-role').value = 'soporte';
            }
        }

        async function agregarUsuario() {
            const username = document.getElementById('new-user-username').value.trim();
            const password = document.getElementById('new-user-password').value.trim();
            const nombre = document.getElementById('new-user-nombre').value.trim();
            const rol = document.getElementById('new-user-role').value;

            if (!username || !password || !nombre) {
                showNotification('Por favor completa todos los campos obligatorios', 'error');
                return;
            }

            if (!/^[a-zA-Z0-9_]+$/.test(username)) {
                showNotification('El nombre de usuario solo puede contener letras, n�meros y guiones bajos', 'error');
                return;
            }

            if (password.length < 6) {
                showNotification('La contrase�a debe tener al menos 6 caracteres', 'error');
                return;
            }

            try {
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, nombre, rol, token })
                });

                if (!response.ok) {
                    if (response.status === 403) {
                        showNotification('Acceso denegado: Solo administradores pueden crear usuarios', 'error');
                        return;
                    }
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    showNotification(data.message, 'success');
                    closeAddUserModal();
                    await loadUsersAdmin();
                } else {
                    showNotification(data.message || 'Error creando usuario', 'error');
                }
            } catch (error) {
                console.error('Error creando usuario:', error);
                showNotification('Error de conexi�n al servidor', 'error');
            }
        }

        async function actualizarUsuario() {
            const id = document.getElementById('edit-user-id').value;
            const username = document.getElementById('edit-user-username').value.trim();
            const password = document.getElementById('edit-user-password').value.trim();
            const nombre = document.getElementById('edit-user-nombre').value.trim();
            const rol = document.getElementById('edit-user-role').value;

            if (!username || !nombre) {
                showNotification('Por favor completa los campos obligatorios', 'error');
                return;
            }

            if (!/^[a-zA-Z0-9_]+$/.test(username)) {
                showNotification('El nombre de usuario solo puede contener letras, n�meros y guiones bajos', 'error');
                return;
            }

            if (password && password.length < 6) {
                showNotification('La contrase�a debe tener al menos 6 caracteres', 'error');
                return;
            }

            try {
                const updateData = { username, nombre, rol, token };
                if (password) updateData.password = password;

                const response = await fetch(`/api/users/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });

                if (!response.ok) {
                    if (response.status === 403) {
                        showNotification('Acceso denegado: Solo administradores pueden editar usuarios', 'error');
                        return;
                    }
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    showNotification(data.message, 'success');
                    closeEditUserModal();
                    await loadUsersAdmin();
                } else {
                    showNotification(data.message || 'Error actualizando usuario', 'error');
                }
            } catch (error) {
                console.error('Error actualizando usuario:', error);
                showNotification('Error de conexi�n al servidor', 'error');
            }
        }

        // FUNCIONES PARA LOGS DE API
        async function showLogsAPIModal() {
            const modal = document.getElementById('logs-api-modal');
            if (modal) {
                modal.classList.remove('hidden');
                await loadLogsAPI();
            }
        }

        function closeLogsAPIModal() {
            const modal = document.getElementById('logs-api-modal');
            if (modal) modal.classList.add('hidden');
        }

        async function loadLogsAPI() {
            try {
                // Validar sesión antes de la operación
                const sessionValid = await validateSession();
                if (!sessionValid) return;

                const response = await fetch(`/api/logs-api?token=${token}&limit=100`);
                
                if (!response.ok) {
                    if (response.status === 403) {
                        showNotification('Acceso denegado', 'error');
                        return;
                    }
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    displayLogsAPI(data.logs || []);
                } else {
                    showNotification(data.message || 'Error cargando logs', 'error');
                }
            } catch (error) {
                console.error('Error cargando logs API:', error);
                showNotification('Error de conexi�n al servidor', 'error');
            }
        }

        function displayLogsAPI(logs) {
            const logsList = document.getElementById('logs-api-list');
            if (!logsList) return;

            if (!logs || logs.length === 0) {
                logsList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No hay logs registrados</p>';
                return;
            }

            logsList.innerHTML = logs.map(log => {
                const estadoIcon = getEstadoIcon(log.estado);
                const estadoColor = getEstadoColor(log.estado);
                
                return `
                <div class="omitted-item">
                    <div class="numero">
                        ${estadoIcon} ${log.numero_destino}
                        <span style="background: ${estadoColor}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; margin-left: 10px;">
                            ${getEstadoText(log.estado)}
                        </span>
                    </div>
                    <div class="motivo">
                        <strong>IP:</strong> ${log.ip_origen} � 
                        <strong>Mensaje:</strong> ${log.mensaje.length > 100 ? log.mensaje.substring(0, 100) + '...' : log.mensaje}
                    </div>
                    <div class="meta">
                        ${formatDate(log.fecha_envio)}
                    </div>
                </div>
            `;
            }).join('');
        }

        function getEstadoIcon(estado) {
            switch(estado) {
                case 'enviado': return '?';
                case 'error_envio': return '?';
                case 'error_parametros': return '??';
                case 'error_whatsapp_no_listo': return '??';
                case 'error_excepcion': return '??';
                default: return '??';
            }
        }

        function getEstadoColor(estado) {
            switch(estado) {
                case 'enviado': return '#28a745';
                case 'error_envio': return '#dc3545';
                case 'error_parametros': return '#ffc107';
                case 'error_whatsapp_no_listo': return '#17a2b8';
                case 'error_excepcion': return '#6f42c1';
                default: return '#6c757d';
            }
        }

        function getEstadoText(estado) {
            switch(estado) {
                case 'enviado': return 'Enviado';
                case 'error_envio': return 'Error Env�o';
                case 'error_parametros': return 'Error Par�metros';
                case 'error_whatsapp_no_listo': return 'WhatsApp No Listo';
                case 'error_excepcion': return 'Error Excepci�n';
                default: return estado;
            }
        }

        // FUNCIONES PARA NUEVO CHAT
        function showNewChatModal() {
            const modal = document.getElementById('new-chat-modal');
            if (modal) {
                modal.classList.remove('hidden');
                const phoneInput = document.getElementById('new-chat-phone');
                const messageInput = document.getElementById('new-chat-message');
                
                phoneInput.value = '';
                messageInput.value = '';
                
                // Agregar validación en tiempo real para solo números
                phoneInput.oninput = function() {
                    this.value = this.value.replace(/[^0-9]/g, '');
                    if (this.value.length > 10) {
                        this.value = this.value.slice(0, 10);
                    }
                };
                
                // Agregar enter para enviar
                messageInput.onkeypress = function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        createNewChat();
                    }
                };
                
                setTimeout(() => phoneInput.focus(), 300);
            }
        }

        function closeNewChatModal() {
            const modal = document.getElementById('new-chat-modal');
            if (modal) {
                modal.classList.add('hidden');
                document.getElementById('new-chat-phone').value = '';
                document.getElementById('new-chat-message').value = '';
            }
        }

        async function createNewChat(event) {
            if (event) {
                event.preventDefault();
            }
            
            const numero = document.getElementById('new-chat-phone').value.trim();
            let mensaje = document.getElementById('new-chat-message').value.trim();
            
            if (!numero) {
                showNotification('Por favor ingresa un n�mero de tel�fono', 'error');
                return;
            }

            if (!/^[0-9]{10}$/.test(numero)) {
                showNotification('El n�mero debe contener solo d�gitos (10-15 caracteres)', 'error');
                return;
            }

            // Validar que empiece con 3 (números móviles en Colombia)
            if (!numero.startsWith('3')) {
                showNotification('El número móvil debe comenzar con 3', 'error');
                return;
            }

            if (!mensaje) {
                mensaje = 'Buenos d�as, Bienvenido a SOLUCNET';
            }

            // Validar que tengamos un token válido
            if (!token) {
                showNotification('❌ No hay token de autorización. Por favor, inicia sesión nuevamente.', 'error');
                return;
            }

            try {
                console.log('🔄 Creando nuevo chat:', {
                    numeroIngresado: numero,
                    chatId: '57' + numero + '@c.us',
                    mensaje: mensaje,
                    token: token ? 'PRESENTE' : 'AUSENTE'
                });

                // Verificar estado de WhatsApp antes de enviar
                console.log('🔍 Verificando estado de WhatsApp...');
                try {
                    const statusResponse = await fetch('/api/stats', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (statusResponse.ok) {
                        const statusData = await statusResponse.json();
                        console.log('📊 Estado WhatsApp:', statusData);
                        
                        if (!statusData.whatsappListo) {
                            showNotification('⚠️ WhatsApp no está conectado. Por favor, escanea el código QR primero.', 'warning');
                            return;
                        }
                    }
                } catch (statusError) {
                    console.warn('No se pudo verificar estado de WhatsApp:', statusError);
                    // Continuar de todas formas
                }

                // Crear AbortController para timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    controller.abort();
                    console.warn('⏰ Petición cancelada por timeout (30 segundos)');
                }, 30000);

                const response = await fetch('/api/send-message', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        chatId: '57' + numero + '@c.us',
                        message: mensaje
                    }),
                    signal: controller.signal
                });
                
                // Limpiar timeout si la petición se completó
                clearTimeout(timeoutId);

                let data;
                try {
                    data = await response.json();
                    console.log('📡 Respuesta del servidor:', data);
                } catch (parseError) {
                    console.error('Error parsing JSON response:', parseError);
                    throw new Error(`HTTP ${response.status} - Error parsing server response`);
                }

                if (response.ok && data.success) {
                    showNotification(`✅ Mensaje enviado exitosamente a +57${numero}`, 'success');
                    closeNewChatModal();
                    loadUsersAdmin();
                    setTimeout(() => selectChat(`57${numero}@c.us`), 1000);
                } else {
                    let errorMsg = 'Error enviando mensaje';
                    
                    if (response.status === 500) {
                        errorMsg = 'Error interno del servidor. Verifica que WhatsApp esté conectado.';
                        console.error('HTTP 500 - Server Error:', data);
                    } else if (response.status === 401) {
                        errorMsg = 'Token de autorización inválido. Reinicia sesión.';
                    } else if (response.status === 404) {
                        errorMsg = 'Endpoint no encontrado. Verifica la configuración del servidor.';
                    } else {
                        errorMsg = data.message || data.error || `Error HTTP ${response.status}`;
                    }
                    
                    showNotification(`❌ ${errorMsg}`, 'error');
                    console.error('Error detallado:', {
                        status: response.status,
                        statusText: response.statusText,
                        data: data,
                        chatId: '57' + numero + '@c.us'
                    });
                }
            } catch (error) {
                console.error('Error creando nuevo chat:', error);
                
                let errorMessage = 'Error de conexión al servidor';
                
                if (error.name === 'AbortError') {
                    errorMessage = '⏰ La petición fue cancelada por timeout (30s). El servidor tardó demasiado en responder.';
                } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMessage = '🔌 Error de red - servidor no responde. Verifica tu conexión.';
                } else if (error.message.includes('interrupted')) {
                    errorMessage = '⚠️ Petición interrumpida - intenta de nuevo';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = '🔌 No se pudo conectar al servidor. Verifica que esté funcionando.';
                } else if (error.message) {
                    errorMessage = `❌ Error: ${error.message}`;
                }
                
                console.error('Detalles del error:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                
                showNotification(errorMessage, 'error');
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Agregar headers de autenticaci�n a las peticiones
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            if (token && args[0].startsWith('/api/')) {
                if (!args[1]) args[1] = {};
                if (!args[1].headers) args[1].headers = {};
                args[1].headers['Authorization'] = `Bearer ${token}`;
            }
            return originalFetch.apply(this, args);
        };
    </script>
</body>
</html>