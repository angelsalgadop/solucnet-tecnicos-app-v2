<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Sistema de Visitas Técnicas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Leaflet CSS para mapas -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <style>
        .navbar-brand {
            font-weight: bold;
        }
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            border: none;
        }
        .status-programada { background-color: #fef3c7; color: #92400e; }
        .status-asignada { background-color: #dbeafe; color: #1e40af; }
        .status-en_progreso { background-color: #fed7aa; color: #c2410c; }
        .status-completada { background-color: #dcfce7; color: #166534; }
        .status-cancelada { background-color: #fecaca; color: #991b1b; }
        .cliente-card {
            cursor: pointer;
            transition: all 0.2s;
        }
        .cliente-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .cliente-seleccionado {
            border: 2px solid #667eea;
            background-color: #f8fafc;
        }
        .visita-card {
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }
        .search-container {
            position: relative;
        }
        .loading-spinner {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
        }

        /* Estilos para mejorar legibilidad de reportes */
        .reporte-card {
            background-color: #ffffff !important;
            border: 1px solid #e0e0e0;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .reporte-card .card-header {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
            color: white !important;
            font-weight: bold;
            border-bottom: 2px solid #e0e0e0;
        }

        .reporte-card .card-body {
            background-color: #ffffff !important;
            color: #333333 !important;
            line-height: 1.6;
        }

        .reporte-card .card-body p {
            color: #333333 !important;
            margin-bottom: 8px;
        }

        .reporte-card .card-body strong {
            color: #2c3e50 !important;
            font-weight: 600;
        }

        .reporte-card .badge {
            font-size: 0.85rem;
            padding: 0.4em 0.6em;
        }

        .reporte-card .text-muted {
            color: #6c757d !important;
            font-size: 0.9rem;
        }

        /* Estilos para órdenes de técnicos */
        .orden-card {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .orden-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .orden-card .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            padding: 0.75rem 1rem;
        }

        .orden-card .card-body {
            padding: 1rem;
        }

        .badge.bg-warning {
            background-color: #fd7e14 !important;
            color: white;
        }

        /* Estilos para headers ordenables */
        #tablaVisitasSinAsignar th[onclick] {
            user-select: none;
            transition: background-color 0.2s ease;
        }

        #tablaVisitasSinAsignar th[onclick]:hover {
            background-color: #f8f9fa;
        }

        #tablaVisitasSinAsignar th .fas {
            margin-left: 5px;
            color: #6c757d;
        }

        /* Mejoras para la tabla de visitas sin asignar */
        #tablaVisitasSinAsignar {
            font-size: 0.85rem;
            margin-bottom: 0;
            width: 100% !important;
            table-layout: fixed !important;
        }

        #tablaVisitasSinAsignar td {
            padding: 12px 8px;
            vertical-align: middle;
            border-top: 1px solid #dee2e6;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        #tablaVisitasSinAsignar th {
            padding: 10px 8px;
            font-weight: 600;
            background-color: #212529 !important;
            color: white !important;
            border-bottom: 2px solid #dee2e6;
            border-top: none;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        /* Contenedor de tabla sin scroll */
        .tabla-sin-scroll {
            overflow: visible !important;
            width: 100% !important;
        }

        #tablaVisitasSinAsignar tbody tr {
            transition: all 0.2s ease;
        }

        #tablaVisitasSinAsignar tbody tr:hover {
            background-color: #f8f9fa !important;
            transform: scale(1.01);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        #tablaVisitasSinAsignar .btn {
            padding: 8px 12px;
            margin: 0 2px;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        #tablaVisitasSinAsignar .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        #tablaVisitasSinAsignar .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }

        #tablaVisitasSinAsignar .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            color: white;
        }

        #tablaVisitasSinAsignar .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            border: none;
        }

        #tablaVisitasSinAsignar .text-wrap {
            line-height: 1.4;
        }

        #tablaVisitasSinAsignar .badge {
            font-size: 0.75rem;
            padding: 0.5em 0.75em;
        }

        /* Dropdown mejorado */
        #tablaVisitasSinAsignar .dropdown-menu {
            min-width: 180px;
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        #tablaVisitasSinAsignar .dropdown-item {
            padding: 8px 16px;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        #tablaVisitasSinAsignar .dropdown-item:hover {
            background-color: #f8f9fa;
            transform: translateX(5px);
        }

        #tablaVisitasSinAsignar .dropdown-item.text-danger:hover {
            background-color: #fee;
            color: #dc3545 !important;
        }

        /* Timeline para modal de progreso */
        .timeline {
            position: relative;
            padding-left: 30px;
        }

        .timeline-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            position: relative;
        }

        .timeline-item i {
            position: absolute;
            left: -35px;
            font-size: 1.2rem;
        }

        .timeline-item span {
            font-weight: 500;
            margin-right: 10px;
        }

        .timeline-item small {
            margin-left: auto;
        }

        /* Responsive mejoras */
        @media (max-width: 1200px) {
            #tablaVisitasSinAsignar {
                font-size: 0.8rem;
            }

            #tablaVisitasSinAsignar td {
                padding: 10px 6px;
            }

            #tablaVisitasSinAsignar .btn {
                padding: 6px 8px;
                font-size: 0.8rem;
            }

            #tablaVisitasSinAsignar .d-flex {
                flex-direction: column;
                gap: 4px !important;
            }
        }

        /* Estados de visitas mejorados */
        .status-programada {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
        }
        .status-asignada {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
        }
        .status-en_progreso {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        .status-completada {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: white;
        }
        .status-cancelada {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        /* Botón Cliente Nuevo mejorado */
        .btn-nuevo-cliente {
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 50%, #c084fc 100%);
            border: none;
            color: white;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.3);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .btn-nuevo-cliente:hover {
            background: linear-gradient(135deg, #6d28d9 0%, #9333ea 50%, #a855f7 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(124, 58, 237, 0.4);
            color: white;
        }

        .btn-nuevo-cliente:active {
            transform: translateY(0px);
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.3);
        }

        .btn-nuevo-cliente::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn-nuevo-cliente:hover::before {
            left: 100%;
        }

        .btn-nuevo-cliente i {
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .btn-nuevo-cliente span {
            position: relative;
            z-index: 1;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        /* Botón Asignar Técnico masivo */
        .btn-asignar-masivo {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 50%, #b45309 100%);
            border: none;
            color: white;
            font-weight: 600;
            letter-spacing: 0.3px;
            padding: 10px 18px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .btn-asignar-masivo:hover:not(:disabled) {
            background: linear-gradient(135deg, #d97706 0%, #b45309 50%, #92400e 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
            color: white;
        }

        .btn-asignar-masivo:active:not(:disabled) {
            transform: translateY(0px);
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }

        .btn-asignar-masivo:disabled {
            background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
            box-shadow: none;
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-asignar-masivo::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn-asignar-masivo:hover:not(:disabled)::before {
            left: 100%;
        }

        .btn-asignar-masivo i,
        .btn-asignar-masivo span {
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        /* Botón Cambio Masivo de Fecha */
        .btn-cambio-fecha-masivo {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 50%, #0e7490 100%);
            border: none;
            color: white;
            font-weight: 600;
            letter-spacing: 0.3px;
            padding: 10px 18px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(6, 182, 212, 0.3);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .btn-cambio-fecha-masivo:hover:not(:disabled) {
            background: linear-gradient(135deg, #0891b2 0%, #0e7490 50%, #155e75 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(6, 182, 212, 0.4);
            color: white;
        }

        .btn-cambio-fecha-masivo:active:not(:disabled) {
            transform: translateY(0px);
            box-shadow: 0 4px 15px rgba(6, 182, 212, 0.3);
        }

        .btn-cambio-fecha-masivo:disabled {
            background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
            box-shadow: none;
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-cambio-fecha-masivo::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn-cambio-fecha-masivo:hover:not(:disabled)::before {
            left: 100%;
        }

        .btn-cambio-fecha-masivo i,
        .btn-cambio-fecha-masivo span {
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        /* Estilos para tarjetas de estadísticas clickeables */
        .stat-card {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .stat-card:active {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .stat-card:hover::before {
            left: 100%;
        }

        /* =================================== */
        /* ESTILOS RESPONSIVOS PARA MÓVILES */
        /* =================================== */

        /* Media query para dispositivos móviles y tablets pequeñas */
        @media (max-width: 768px) {

            /* Navbar más compacta */
            .navbar {
                padding: 0.25rem 0.5rem;
            }

            .navbar-brand {
                font-size: 1rem;
            }

            /* Container principal más compacto */
            .container-fluid {
                padding: 0.5rem;
            }

            /* Pestañas de navegación más compactas */
            .nav-tabs .nav-link {
                padding: 0.5rem 0.75rem;
                font-size: 0.85rem;
                border-radius: 0.25rem 0.25rem 0 0;
            }

            .nav-tabs .nav-link i {
                font-size: 0.8rem;
                margin-right: 0.25rem;
            }

            /* Cards más compactas */
            .card {
                margin-bottom: 1rem;
                border-radius: 0.5rem;
            }

            .card-header {
                padding: 0.75rem;
                font-size: 0.9rem;
            }

            .card-body {
                padding: 0.75rem;
            }

            /* Botones más compactos */
            .btn {
                padding: 0.375rem 0.5rem;
                font-size: 0.8rem;
                border-radius: 0.375rem;
            }

            .btn-sm {
                padding: 0.25rem 0.375rem;
                font-size: 0.75rem;
            }

            /* Formularios más compactos */
            .form-control {
                padding: 0.375rem 0.5rem;
                font-size: 0.85rem;
            }

            .form-label {
                font-size: 0.8rem;
                margin-bottom: 0.25rem;
                font-weight: 600;
            }

            /* Grid más compacto para móviles */
            .row {
                margin-left: -0.5rem;
                margin-right: -0.5rem;
            }

            .col, .col-1, .col-2, .col-3, .col-4, .col-5, .col-6,
            .col-7, .col-8, .col-9, .col-10, .col-11, .col-12,
            .col-md-1, .col-md-2, .col-md-3, .col-md-4, .col-md-5, .col-md-6,
            .col-md-7, .col-md-8, .col-md-9, .col-md-10, .col-md-11, .col-md-12 {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }

            /* Modales optimizados para móvil */
            .modal-dialog {
                margin: 0.5rem;
                max-width: calc(100% - 1rem);
            }

            .modal-content {
                border-radius: 0.5rem;
            }

            .modal-header {
                padding: 0.75rem;
                border-bottom: 1px solid #dee2e6;
            }

            .modal-body {
                padding: 0.75rem;
                max-height: 70vh;
                overflow-y: auto;
            }

            .modal-footer {
                padding: 0.75rem;
                border-top: 1px solid #dee2e6;
            }

            /* Tablas responsivas */
            .table-responsive {
                border-radius: 0.5rem;
                box-shadow: none;
            }

            .table {
                font-size: 0.75rem;
                margin-bottom: 0;
            }

            .table th {
                padding: 0.5rem 0.25rem;
                font-size: 0.7rem;
                font-weight: 600;
                border-top: none;
                white-space: nowrap;
            }

            .table td {
                padding: 0.5rem 0.25rem;
                vertical-align: middle;
                border-top: 1px solid #dee2e6;
            }

            /* Tabla de visitas sin asignar - Scroll horizontal en móvil */
            #tablaVisitasSinAsignar {
                font-size: 0.7rem !important;
                min-width: 800px; /* Ancho mínimo para mostrar todas las columnas */
            }

            /* Contenedor con scroll horizontal para la tabla */
            .tabla-scroll-container {
                overflow-x: auto;
                overflow-y: visible;
                -webkit-overflow-scrolling: touch; /* Smooth scrolling en iOS */
                border: 1px solid #dee2e6;
                border-radius: 0.5rem;
                background: white;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }

            /* Scrollbar personalizada para mejor UX */
            .tabla-scroll-container::-webkit-scrollbar {
                height: 8px;
            }

            .tabla-scroll-container::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 4px;
            }

            .tabla-scroll-container::-webkit-scrollbar-thumb {
                background: #888;
                border-radius: 4px;
            }

            .tabla-scroll-container::-webkit-scrollbar-thumb:hover {
                background: #555;
            }

            #tablaVisitasSinAsignar th {
                padding: 0.5rem 0.375rem !important;
                font-size: 0.65rem !important;
                white-space: nowrap;
                min-width: 80px;
            }

            #tablaVisitasSinAsignar td {
                padding: 0.5rem 0.375rem !important;
                font-size: 0.7rem !important;
                white-space: nowrap;
                min-width: 80px;
            }

            /* Botones más pequeños en la tabla móvil */
            #tablaVisitasSinAsignar .btn {
                padding: 0.25rem 0.375rem !important;
                font-size: 0.65rem !important;
                margin: 0.125rem !important;
                border-radius: 0.25rem !important;
            }

            /* Badges más pequeños */
            #tablaVisitasSinAsignar .badge {
                font-size: 0.6rem !important;
                padding: 0.25rem 0.375rem !important;
            }

            /* Dropdown toggle más pequeño */
            #tablaVisitasSinAsignar .dropdown-toggle {
                padding: 0.25rem 0.375rem !important;
                font-size: 0.65rem !important;
            }

            /* Texto más compacto */
            #tablaVisitasSinAsignar .text-wrap {
                line-height: 1.2 !important;
                max-width: 120px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            /* Checkbox más pequeño */
            #tablaVisitasSinAsignar .form-check-input {
                transform: scale(0.8);
            }

            /* Cards de clientes más compactas */
            .cliente-card {
                margin-bottom: 0.75rem;
                border-radius: 0.5rem;
                transition: all 0.2s ease;
            }

            .cliente-card .card-body {
                padding: 0.75rem;
            }

            .cliente-card .card-title {
                font-size: 0.9rem;
                margin-bottom: 0.5rem;
                font-weight: 600;
            }

            .cliente-card .card-text {
                font-size: 0.75rem;
                margin-bottom: 0.25rem;
            }

            /* Badges más compactos */
            .badge {
                font-size: 0.7rem;
                padding: 0.3rem 0.5rem;
                border-radius: 0.375rem;
            }

            /* Alertas más compactas */
            .alert {
                padding: 0.5rem 0.75rem;
                margin-bottom: 0.75rem;
                border-radius: 0.375rem;
                font-size: 0.8rem;
            }

            /* Estadísticas más compactas */
            .stat-card {
                margin-bottom: 0.75rem;
                border-radius: 0.5rem;
            }

            .stat-card .card-body {
                padding: 1rem 0.75rem;
                text-align: center;
            }

            .stat-card h3 {
                font-size: 1.5rem;
                margin-bottom: 0.25rem;
            }

            .stat-card p {
                font-size: 0.75rem;
                margin-bottom: 0;
            }

            /* Dropdown menus más compactos */
            .dropdown-menu {
                font-size: 0.8rem;
                border-radius: 0.375rem;
                box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,0.1);
            }

            .dropdown-item {
                padding: 0.375rem 0.75rem;
            }

            /* Optimización de espacios */
            .mb-3 {
                margin-bottom: 0.75rem !important;
            }

            .mb-4 {
                margin-bottom: 1rem !important;
            }

            .p-3 {
                padding: 0.75rem !important;
            }

            .p-4 {
                padding: 1rem !important;
            }

            /* Botones de acción en stack para móvil */
            .btn-group-vertical .btn {
                margin-bottom: 0.25rem;
            }

            /* Texto más pequeño en móviles */
            .text-muted {
                font-size: 0.75rem;
            }

            /* Headers de sección más compactos */
            h5 {
                font-size: 1rem;
                margin-bottom: 0.5rem;
            }

            h6 {
                font-size: 0.85rem;
                margin-bottom: 0.375rem;
            }

            /* Inputs de fecha y hora más compactos */
            input[type="date"], input[type="datetime-local"], input[type="time"] {
                font-size: 0.8rem;
                padding: 0.375rem 0.5rem;
            }

            /* Mejoras específicas para busqueda */
            .search-container {
                margin-bottom: 0.75rem;
            }

            .search-container .form-control {
                border-radius: 0.375rem;
            }

            /* Contenedor de resultados más compacto */
            #resultadosBusqueda {
                max-height: 60vh;
                overflow-y: auto;
                border-radius: 0.5rem;
            }

            /* Progress bars más delgadas */
            .progress {
                height: 0.5rem;
                border-radius: 0.25rem;
            }
        }

        /* Media query para móviles muy pequeños */
        @media (max-width: 480px) {

            /* Navegación de pestañas en scroll horizontal */
            .nav-tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
                overflow-y: hidden;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }

            .nav-tabs::-webkit-scrollbar {
                display: none;
            }

            .nav-tabs .nav-item {
                flex-shrink: 0;
            }

            .nav-tabs .nav-link {
                white-space: nowrap;
                padding: 0.5rem 1rem;
            }

            /* Formularios en una sola columna */
            .row .col-md-6,
            .row .col-md-4,
            .row .col-md-3 {
                margin-bottom: 0.5rem;
            }

            /* Botones más grandes para tocar fácilmente */
            .btn {
                min-height: 2.5rem;
                border-radius: 0.5rem;
            }

            /* Cards de estadísticas en stack */
            .stat-card {
                margin-bottom: 0.5rem;
            }

            /* Tablas con scroll horizontal */
            .table-responsive {
                border: 1px solid #dee2e6;
                border-radius: 0.5rem;
            }

            /* Mejoras específicas para tabla de visitas sin asignar en móviles pequeños */
            .tabla-scroll-container {
                position: relative;
            }

            .tabla-scroll-container::after {
                content: "← Desliza para ver más →";
                position: absolute;
                bottom: -20px;
                left: 50%;
                transform: translateX(-50%);
                font-size: 0.7rem;
                color: #6c757d;
                background: rgba(255,255,255,0.9);
                padding: 0.25rem 0.5rem;
                border-radius: 0.25rem;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                white-space: nowrap;
                animation: fadeInOut 3s ease-in-out;
            }

            @keyframes fadeInOut {
                0%, 100% { opacity: 0; }
                50% { opacity: 1; }
            }

            /* Hacer que la tabla tenga ancho fijo mínimo en móviles */
            #tablaVisitasSinAsignar {
                min-width: 900px !important; /* Aumentar para asegurar que se vean todas las columnas */
            }

            /* Columnas específicas con anchos fijos */
            #tablaVisitasSinAsignar th:nth-child(1) { min-width: 40px; } /* Checkbox */
            #tablaVisitasSinAsignar th:nth-child(2) { min-width: 150px; } /* Cliente */
            #tablaVisitasSinAsignar th:nth-child(3) { min-width: 100px; } /* Fecha */
            #tablaVisitasSinAsignar th:nth-child(4) { min-width: 120px; } /* MikroTik */
            #tablaVisitasSinAsignar th:nth-child(5) { min-width: 80px; } /* Estado */
            #tablaVisitasSinAsignar th:nth-child(6) { min-width: 100px; } /* Motivo */
            #tablaVisitasSinAsignar th:nth-child(7) { min-width: 80px; } /* Prioridad */
            #tablaVisitasSinAsignar th:nth-child(8) { min-width: 120px; } /* Acciones */

            #tablaVisitasSinAsignar td:nth-child(1) { min-width: 40px; }
            #tablaVisitasSinAsignar td:nth-child(2) { min-width: 150px; }
            #tablaVisitasSinAsignar td:nth-child(3) { min-width: 100px; }
            #tablaVisitasSinAsignar td:nth-child(4) { min-width: 120px; }
            #tablaVisitasSinAsignar td:nth-child(5) { min-width: 80px; }
            #tablaVisitasSinAsignar td:nth-child(6) { min-width: 100px; }
            #tablaVisitasSinAsignar td:nth-child(7) { min-width: 80px; }
            #tablaVisitasSinAsignar td:nth-child(8) { min-width: 120px; }

            /* Modales ocupan toda la pantalla */
            .modal-dialog {
                margin: 0;
                max-width: 100%;
                height: 100vh;
            }

            .modal-content {
                height: 100%;
                border-radius: 0;
                border: none;
            }

            .modal-body {
                max-height: calc(100vh - 120px);
                overflow-y: auto;
            }
        }
        /* Estilos para el modal de selección de BD */
        .bd-option {
            transition: all 0.3s ease;
            border-radius: 8px !important;
            margin-bottom: 10px;
        }

        .bd-option:hover {
            background-color: #f0f7ff !important;
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .bd-option h6 {
            margin-bottom: 4px;
            font-weight: 600;
        }

        .bd-option:active {
            transform: translateX(3px) scale(0.98);
        }

        .modal-header.bg-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        }

        #modalSeleccionarBD .alert-info {
            background-color: #e0f2fe;
            border-color: #7dd3fc;
            color: #0c4a6e;
        }

        /* Estilos para paginación de tabla de clientes externos */
        .pagination .page-link {
            color: #667eea;
            border-color: #dee2e6;
            transition: all 0.3s ease;
        }

        .pagination .page-link:hover {
            color: #764ba2;
            background-color: #f8f9fa;
            border-color: #667eea;
        }

        .pagination .page-item.active .page-link {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
        }

        .pagination .page-item.disabled .page-link {
            color: #6c757d;
            pointer-events: none;
            background-color: #fff;
            border-color: #dee2e6;
        }

        /* Estilos para el mapa de ubicaciones */
        #mapaUbicaciones {
            height: 600px;
            width: 100%;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .leaflet-popup-content-wrapper {
            border-radius: 8px;
        }

        .tecnico-popup h6 {
            margin: 0 0 10px 0;
            color: #667eea;
            font-weight: bold;
        }

        .tecnico-popup p {
            margin: 5px 0;
            font-size: 0.9em;
        }

        .marker-label {
            background-color: rgba(102, 126, 234, 0.9);
            border: 2px solid white;
            border-radius: 50%;
            color: white;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="fas fa-tools"></i> SolucNet - Admin Visitas</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/gestion_usuarios.html"><i class="fas fa-users-cog"></i> Gestión de Usuarios</a>
                <a class="nav-link" href="#" id="btnCerrarSesion"><i class="fas fa-home"></i> Principal</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Pestañas de navegación -->
        <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="crear-tab" data-bs-toggle="tab" data-bs-target="#crear" type="button">
                    <i class="fas fa-plus-circle"></i> Crear Visitas
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="reportes-tab" data-bs-toggle="tab" data-bs-target="#reportes" type="button">
                    <i class="fas fa-chart-bar"></i> Reportes
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="clientes-externos-tab" data-bs-toggle="tab" data-bs-target="#clientes-externos" type="button">
                    <i class="fas fa-users"></i> Clientes Solucnet.com
                </button>
            </li>
        </ul>

        <div class="tab-content" id="mainTabsContent">
            <!-- Pestaña Crear Visitas -->
            <div class="tab-pane fade show active" id="crear" role="tabpanel">
                <!-- PANEL DE BÚSQUEDA Y ESTADÍSTICAS - ARRIBA -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-search"></i> Buscar y Agregar Clientes</h5>
                            </div>
                            <div class="card-body">
                                <div class="search-container">
                                    <input type="text" class="form-control" id="inputBusqueda"
                                           placeholder="Buscar por cédula o nombre...">
                                    <div class="spinner-border spinner-border-sm loading-spinner d-none" id="searchSpinner"></div>
                                </div>
                                <div class="mt-3" id="resultadosBusqueda">
                                    <p class="text-muted">Ingresa una cédula o nombre para buscar clientes</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-chart-bar"></i> Estadísticas</h5>
                            </div>
                            <div class="card-body">
                                <div class="row text-center g-3">
                                    <div class="col-3">
                                        <div class="bg-warning text-white p-3 rounded stat-card" style="cursor: pointer;" onclick="mostrarVisitasProgramadas()" title="Click para ver visitas programadas">
                                            <div class="h5 mb-0" id="statProgramadas">0</div>
                                            <small>Programadas</small>
                                        </div>
                                    </div>
                                    <div class="col-3">
                                        <div class="bg-info text-white p-3 rounded stat-card" style="cursor: pointer;" onclick="mostrarVisitasAsignadas()" title="Click para ver visitas asignadas">
                                            <div class="h5 mb-0" id="statAsignadas">0</div>
                                            <small>Asignadas</small>
                                        </div>
                                    </div>
                                    <div class="col-3">
                                        <div class="bg-success text-white p-3 rounded stat-card" style="cursor: pointer;" onclick="mostrarVisitasEnProgreso()" title="Click para ver visitas en progreso">
                                            <div class="h5 mb-0" id="statProgreso">0</div>
                                            <small>En Progreso</small>
                                        </div>
                                    </div>
                                    <div class="col-3">
                                        <div class="bg-primary text-white p-3 rounded stat-card" style="cursor: pointer;" onclick="mostrarVisitasCompletadas()" title="Click para ver visitas completadas hoy">
                                            <div class="h5 mb-0" id="statCompletadas">0</div>
                                            <small>Completadas Hoy</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TABLA PRINCIPAL - ANCHO COMPLETO -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center bg-primary text-white">
                                <h5 class="mb-0"><i class="fas fa-user-clock"></i> Visitas Sin Asignar</h5>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-nuevo-cliente btn-sm" onclick="mostrarFormularioClienteNuevo()">
                                        <i class="fas fa-user-plus me-2"></i>
                                        <span>Cliente Nuevo</span>
                                        <i class="fas fa-plus-circle ms-1"></i>
                                    </button>
                                    <button class="btn btn-cambio-fecha-masivo btn-sm" id="btnCambioFechaMasivo" disabled>
                                        <i class="fas fa-calendar-alt me-2"></i>
                                        <span>Cambio Masivo de Fecha</span>
                                    </button>
                                    <button class="btn btn-asignar-masivo btn-sm" id="btnAsignarMasivo" disabled>
                                        <i class="fas fa-user-cog me-2"></i>
                                        <span>Asignar Técnico</span>
                                    </button>
                                    <button class="btn btn-danger btn-sm d-none" id="btnDesasignarMasivo" disabled>
                                        <i class="fas fa-user-times me-2"></i>
                                        <span>Desasignar Masivamente</span>
                                    </button>
                                    <button class="btn btn-success btn-sm" id="btnEnviarNotificaciones" disabled>
                                        <i class="fas fa-paper-plane"></i> Enviar Notificaciones
                                    </button>
                                    <button class="btn btn-info btn-sm" id="btnGestionTecnicos" data-bs-toggle="modal" data-bs-target="#modalGestionTecnicos">
                                        <i class="fas fa-users-cog"></i> Gestión Técnicos
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div id="tablaVisitas" style="min-height: 500px; overflow: visible; width: 100%;">
                                    <div class="p-4 text-center">
                                        <p class="text-muted">Las visitas sin asignar aparecerán aquí automáticamente</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Pestaña Reportes -->
            <div class="tab-pane fade" id="reportes" role="tabpanel">
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5><i class="fas fa-file-alt"></i> Reportes de Visitas Completadas</h5>
                                <button class="btn btn-primary btn-sm" onclick="cargarReportesCompletados()">
                                    <i class="fas fa-sync"></i> Actualizar
                                </button>
                            </div>
                            <div class="card-body">
                                <!-- Filtros de búsqueda -->
                                <div class="row mb-4">
                                    <div class="col-md-4">
                                        <label class="form-label">Buscar por cliente</label>
                                        <input type="text" class="form-control" id="busquedaReportes"
                                               placeholder="Nombre o cédula del cliente...">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Desde</label>
                                        <input type="date" class="form-control" id="fechaDesde">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Hasta</label>
                                        <input type="date" class="form-control" id="fechaHasta">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">&nbsp;</label>
                                        <div class="d-grid">
                                            <button class="btn btn-success btn-sm" onclick="filtrarReportes()">
                                                <i class="fas fa-search"></i> Filtrar
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Botones de filtros rápidos -->
                                <div class="mb-3">
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="filtrarPorDias(1)">Hoy</button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="filtrarPorDias(7)">7 días</button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="filtrarPorDias(30)">30 días</button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="limpiarFiltros()">Ver todos</button>
                                    </div>
                                </div>

                                <div id="reportesCompletados">
                                    <p class="text-muted">Cargando reportes...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pestaña Clientes Externos (Solucnet.com) -->
            <div class="tab-pane fade" id="clientes-externos" role="tabpanel">
                <div class="row mb-4">
                    <!-- Configuración de BD Externa -->
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                                <h5><i class="fas fa-database"></i> Configuración Base de Datos Externa</h5>
                                <button class="btn btn-light btn-sm" onclick="toggleConfigBD()">
                                    <i class="fas fa-cog"></i> Editar
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="configBDView">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <strong>Nombre:</strong> <span id="viewNombre">-</span>
                                        </div>
                                        <div class="col-md-3">
                                            <strong>Host:</strong> <span id="viewHost">-</span>
                                        </div>
                                        <div class="col-md-2">
                                            <strong>Usuario:</strong> <span id="viewUsuario">-</span>
                                        </div>
                                        <div class="col-md-2">
                                            <strong>Base de Datos:</strong> <span id="viewBaseDatos">-</span>
                                        </div>
                                        <div class="col-md-2">
                                            <strong>Última Sync:</strong><br><small id="viewUltimaSync" class="text-muted">-</small>
                                        </div>
                                    </div>
                                </div>
                                <div id="configBDForm" style="display: none;">
                                    <form id="formConfigBD">
                                        <input type="hidden" id="configId">
                                        <div class="row">
                                            <div class="col-md-2">
                                                <label class="form-label">Nombre</label>
                                                <input type="text" class="form-control" id="inputNombre" value="Solucnet.com">
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">Host</label>
                                                <input type="text" class="form-control" id="inputHost" placeholder="auth-db1999.hstgr.io">
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label">Usuario</label>
                                                <input type="text" class="form-control" id="inputUsuario" placeholder="u289377392_root">
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label">Contraseña</label>
                                                <input type="password" class="form-control" id="inputPassword" placeholder="*****">
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label">Base de Datos</label>
                                                <input type="text" class="form-control" id="inputBaseDatos" placeholder="nombre_bd">
                                            </div>
                                            <div class="col-md-1">
                                                <label class="form-label">Puerto</label>
                                                <input type="number" class="form-control" id="inputPuerto" value="3306">
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <button type="button" class="btn btn-info btn-sm" onclick="probarConexionBD()">
                                                <i class="fas fa-plug"></i> Probar Conexión
                                            </button>
                                            <button type="submit" class="btn btn-success btn-sm">
                                                <i class="fas fa-save"></i> Guardar
                                            </button>
                                            <button type="button" class="btn btn-secondary btn-sm" onclick="toggleConfigBD()">
                                                <i class="fas fa-times"></i> Cancelar
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5><i class="fas fa-users"></i> Clientes Registrados en Solucnet.com</h5>
                                <div>
                                    <button class="btn btn-success btn-sm me-2" onclick="sincronizarClientesExternos()">
                                        <i class="fas fa-sync"></i> Sincronizar Ahora
                                    </button>
                                    <button class="btn btn-info btn-sm" onclick="cargarClientesExternos()">
                                        <i class="fas fa-refresh"></i> Recargar
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- Estadísticas -->
                                <div class="row mb-4">
                                    <div class="col-md-3">
                                        <div class="card text-center bg-light">
                                            <div class="card-body">
                                                <h3 id="statTotalExternos" class="text-primary">0</h3>
                                                <p class="mb-0">Total Clientes</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card text-center bg-light">
                                            <div class="card-body">
                                                <h3 id="statActivosExternos" class="text-success">0</h3>
                                                <p class="mb-0">Activos</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card text-center bg-light">
                                            <div class="card-body">
                                                <h3 id="statInactivosExternos" class="text-warning">0</h3>
                                                <p class="mb-0">Inactivos</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card text-center bg-light">
                                            <div class="card-body">
                                                <p class="mb-1"><strong>Última Sync</strong></p>
                                                <small id="statUltimaSyncExternos" class="text-muted">-</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Buscador -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <input type="text" class="form-control" id="busquedaClientesExternos"
                                               placeholder="Buscar por nombre, cédula o teléfono...">
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-control" id="filtroEstadoExternos">
                                            <option value="">Todos los estados</option>
                                            <option value="Activo">Activos</option>
                                            <option value="Inactivo">Inactivos</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-primary w-100" onclick="filtrarClientesExternos()">
                                            <i class="fas fa-search"></i> Buscar
                                        </button>
                                    </div>
                                </div>

                                <!-- Tabla de clientes -->
                                <div style="width: 100%; overflow: visible;">
                                    <table class="table table-striped table-hover" style="width: 100%; table-layout: auto;">
                                        <thead class="table-dark">
                                            <tr>
                                                <th style="cursor: pointer; white-space: nowrap;" onclick="ordenarTablaClientesExternos('id')">
                                                    ID <i class="fas fa-sort"></i>
                                                </th>
                                                <th style="cursor: pointer; white-space: nowrap;" onclick="ordenarTablaClientesExternos('nombre')">
                                                    Nombre <i class="fas fa-sort"></i>
                                                </th>
                                                <th style="white-space: nowrap;">Cédula</th>
                                                <th style="white-space: nowrap;">Teléfono</th>
                                                <th style="white-space: nowrap;">Móvil</th>
                                                <th style="white-space: nowrap;">Dirección</th>
                                                <th style="white-space: nowrap;">Email</th>
                                                <th style="white-space: nowrap;">Plan</th>
                                                <th style="cursor: pointer; white-space: nowrap;" onclick="ordenarTablaClientesExternos('fecha')">
                                                    Fecha de Inscripción <i class="fas fa-sort"></i>
                                                </th>
                                                <th style="white-space: nowrap;">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tablaClientesExternos">
                                            <tr>
                                                <td colspan="10" class="text-center">
                                                    <p class="text-muted">Cargando clientes...</p>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Paginación -->
                                <div class="d-flex justify-content-between align-items-center mt-3">
                                    <div>
                                        <p class="text-muted mb-0">
                                            Mostrando <span id="clientesDesde">0</span> a <span id="clientesHasta">0</span> de <span id="clientesTotal">0</span> clientes
                                        </p>
                                    </div>
                                    <nav>
                                        <ul class="pagination mb-0" id="paginacionClientesExternos">
                                            <!-- Se genera dinámicamente -->
                                        </ul>
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Modal para seleccionar base de datos -->
    <div class="modal fade" id="modalSeleccionarBD" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-database"></i> Registrar Instalación
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <strong><i class="fas fa-user"></i> Cliente:</strong> <span id="modalClienteNombre"></span><br>
                        <strong><i class="fas fa-id-card"></i> Cédula:</strong> <span id="modalClienteCedula"></span>
                    </div>

                    <h6 class="mb-3"><i class="fas fa-server"></i> Seleccione la base de datos de destino:</h6>

                    <div class="list-group">
                        <button type="button" class="list-group-item list-group-item-action bd-option" data-bd="REPOSO">
                            <div class="d-flex w-100 justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1"><i class="fas fa-database text-primary"></i> REPOSO</h6>
                                    <small class="text-muted">192.168.99.50 - Mikrowisp6</small>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </button>

                        <button type="button" class="list-group-item list-group-item-action bd-option" data-bd="CHURIDO">
                            <div class="d-flex w-100 justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1"><i class="fas fa-database text-success"></i> CHURIDO</h6>
                                    <small class="text-muted">192.168.99.11 - Mikrowisp6</small>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </button>

                        <button type="button" class="list-group-item list-group-item-action bd-option" data-bd="RIO_GRANDE">
                            <div class="d-flex w-100 justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1"><i class="fas fa-database text-warning"></i> RIO GRANDE</h6>
                                    <small class="text-muted">192.168.99.2 - Mikrowisp6</small>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para agendar instalación (seleccionar zona) -->
    <div class="modal fade" id="modalAgendarInstalacion" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-calendar-plus"></i> Agendar Instalación
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-success">
                        <strong><i class="fas fa-user"></i> Cliente:</strong> <span id="modalAgendarClienteNombre"></span><br>
                        <strong><i class="fas fa-id-card"></i> Cédula:</strong> <span id="modalAgendarClienteCedula"></span>
                    </div>

                    <div class="mb-3">
                        <label class="form-label"><i class="fas fa-file-pdf"></i> Adjuntar PDF de instalación *</label>
                        <input type="file" class="form-control" id="pdfInstalacion" accept=".pdf" required>
                        <div class="form-text text-danger">
                            <i class="fas fa-exclamation-circle"></i> Es obligatorio adjuntar el PDF antes de continuar
                        </div>
                    </div>

                    <h6 class="mb-3"><i class="fas fa-map-marker-alt"></i> Seleccione la zona de instalación:</h6>

                    <div class="list-group">
                        <button type="button" class="list-group-item list-group-item-action zona-option" data-zona="REPOSO">
                            <div class="d-flex w-100 justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-0"><i class="fas fa-map-pin text-primary"></i> REPOSO</h6>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </button>

                        <button type="button" class="list-group-item list-group-item-action zona-option" data-zona="SALVADOR">
                            <div class="d-flex w-100 justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-0"><i class="fas fa-map-pin text-success"></i> SALVADOR</h6>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </button>

                        <button type="button" class="list-group-item list-group-item-action zona-option" data-zona="CHURIDO">
                            <div class="d-flex w-100 justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-0"><i class="fas fa-map-pin text-info"></i> CHURIDO</h6>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </button>

                        <button type="button" class="list-group-item list-group-item-action zona-option" data-zona="SALSIPUEDES">
                            <div class="d-flex w-100 justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-0"><i class="fas fa-map-pin text-warning"></i> SALSIPUEDES</h6>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </button>

                        <button type="button" class="list-group-item list-group-item-action zona-option" data-zona="RIO GRANDE">
                            <div class="d-flex w-100 justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-0"><i class="fas fa-map-pin text-danger"></i> RIO GRANDE</h6>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </button>

                        <button type="button" class="list-group-item list-group-item-action zona-option" data-zona="OSITO">
                            <div class="d-flex w-100 justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-0"><i class="fas fa-map-pin text-secondary"></i> OSITO</h6>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </button>

                        <button type="button" class="list-group-item list-group-item-action zona-option" data-zona="MI LUCHA">
                            <div class="d-flex w-100 justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-0"><i class="fas fa-map-pin text-dark"></i> MI LUCHA</h6>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </button>

                        <button type="button" class="list-group-item list-group-item-action zona-option zona-otro" data-zona="OTRO">
                            <div class="d-flex w-100 justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-0"><i class="fas fa-edit text-muted"></i> OTRA LOCALIDAD</h6>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </button>
                    </div>

                    <div id="zonaOtraContainer" class="mt-3 d-none">
                        <label class="form-label"><i class="fas fa-pen"></i> Escriba la localidad:</label>
                        <input type="text" class="form-control" id="zonaOtraInput" placeholder="Ingrese el nombre de la localidad">
                        <button type="button" class="btn btn-success mt-2 w-100" onclick="confirmarZonaOtra()">
                            <i class="fas fa-check"></i> Confirmar Zona
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para agregar visita -->
    <div class="modal fade" id="modalAgregarVisita" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-calendar-plus"></i> Programar Visita Técnica</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formVisita">
                        <input type="hidden" id="clienteId">
                        <input type="hidden" id="bdOrigen">
                        <input type="hidden" id="clienteDireccion">
                        <input type="hidden" id="mikrotikNombre">
                        <input type="hidden" id="usuarioPpp">
                        <input type="hidden" id="clienteCoordenadas">
                        <input type="hidden" id="mikrotikSerial">
                        <input type="hidden" id="equipoMac">
                        <input type="hidden" id="onuSerial">
                        <input type="hidden" id="serialEquipoAsignado">
                        <input type="hidden" id="equipoTipo">
                        <input type="hidden" id="equipoEstado">

                        <div class="mb-3">
                            <label class="form-label">Cliente</label>
                            <input type="text" class="form-control" id="clienteInfo" readonly>
                        </div>

                        <!-- Información de equipos y seriales -->
                        <div class="mb-3" id="equiposSeriales" style="display: none;">
                            <div class="alert alert-info">
                                <h6 class="alert-heading"><i class="fas fa-microchip"></i> Información de Equipos</h6>
                                <div id="infoEquipos"></div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Localidad *</label>
                            <select class="form-select" id="localidadVisita" required>
                                <option value="">Seleccione la zona de instalación...</option>
                                <option value="REPOSO">REPOSO</option>
                                <option value="SALVADOR">SALVADOR</option>
                                <option value="CHURIDO">CHURIDO</option>
                                <option value="SALSIPUEDES">SALSIPUEDES</option>
                                <option value="RIO GRANDE">RIO GRANDE</option>
                                <option value="OSITO">OSITO</option>
                                <option value="MI LUCHA">MI LUCHA</option>
                                <option value="OTRA">OTRA LOCALIDAD</option>
                            </select>
                        </div>

                        <div class="mb-3" id="localidadOtraDiv" style="display: none;">
                            <label class="form-label">Especificar localidad</label>
                            <input type="text" class="form-control" id="localidadOtra" placeholder="Ingrese el nombre de la localidad">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Motivo de la visita *</label>
                            <select class="form-select" id="motivoVisita" required>
                                <option value="">Seleccionar motivo...</option>
                                <option value="Luz roja en el equipo">Luz roja en el equipo</option>
                                <option value="Traslado">Traslado</option>
                                <option value="Instalación">Instalación</option>
                                <option value="Cambio de equipo">Cambio de equipo</option>
                                <option value="Retiro">Retiro</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>

                        <div class="mb-3" id="motivoPersonalizadoDiv" style="display: none;">
                            <label class="form-label">Especificar motivo</label>
                            <textarea class="form-control" id="motivoPersonalizado" rows="2"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Fecha programada *</label>
                            <input type="date" class="form-control" id="fechaProgramada" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Notas adicionales</label>
                            <textarea class="form-control" id="notasAdmin" rows="3"
                                      placeholder="Información adicional para el técnico..."></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Adjuntar PDF para técnico (opcional)</label>
                            <input type="file" class="form-control" id="archivosPdf" accept=".pdf" multiple>
                            <div class="form-text">Puedes subir varios archivos PDF que el técnico podrá descargar.</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="guardarVisita()">
                        <i class="fas fa-save"></i> Programar Visita
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para asignar técnico -->
    <div class="modal fade" id="modalAsignarTecnico" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-user-cog"></i> Asignar Técnico</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formAsignarTecnico">
                        <input type="hidden" id="visitaIdAsignar">
                        <div class="mb-3">
                            <label class="form-label">Seleccionar técnico *</label>
                            <select class="form-select" id="tecnicoAsignar" required>
                                <option value="">Cargando técnicos...</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="confirmarAsignacion()">
                        <i class="fas fa-check"></i> Asignar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para asignación masiva de técnico -->
    <div class="modal fade" id="modalAsignarMasivo" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title"><i class="fas fa-users-cog"></i> Asignar Técnico Masivamente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Asignación Masiva:</strong> El técnico seleccionado será asignado a todas las visitas marcadas.
                    </div>

                    <!-- Lista de visitas seleccionadas -->
                    <div class="mb-4">
                        <h6><i class="fas fa-list"></i> Visitas a asignar (<span id="contadorVisitasSeleccionadas">0</span>):</h6>
                        <div id="listaVisitasSeleccionadas" class="border rounded p-3 bg-light" style="max-height: 200px; overflow-y: auto;">
                            <!-- Se llena dinámicamente -->
                        </div>
                    </div>

                    <form id="formAsignarMasivo">
                        <div class="mb-3">
                            <label class="form-label">Seleccionar técnico *</label>
                            <select class="form-select" id="tecnicoAsignarMasivo" required>
                                <option value="">Cargando técnicos...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notas adicionales (opcional)</label>
                            <textarea class="form-control" id="notasAsignacionMasiva" rows="3"
                                      placeholder="Instrucciones especiales para el técnico..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-warning" onclick="confirmarAsignacionMasiva()">
                        <i class="fas fa-users-cog"></i> Asignar a Todas
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para cambio masivo de fecha -->
    <div class="modal fade" id="modalCambioFechaMasivo" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="fas fa-calendar-alt"></i> Cambio Masivo de Fecha</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Cambio Masivo:</strong> Todas las visitas seleccionadas serán reprogramadas a la nueva fecha elegida.
                    </div>

                    <!-- Lista de visitas seleccionadas -->
                    <div class="mb-4">
                        <h6><i class="fas fa-list"></i> Visitas a reprogramar (<span id="contadorVisitasCambioFecha">0</span>):</h6>
                        <div id="listaVisitasCambioFecha" class="border rounded p-3 bg-light" style="max-height: 200px; overflow-y: auto;">
                            <!-- Se llena dinámicamente -->
                        </div>
                    </div>

                    <form id="formCambioFechaMasivo">
                        <div class="mb-3">
                            <label class="form-label">Nueva fecha programada *</label>
                            <input type="date" class="form-control" id="nuevaFechaProgramada" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Motivo del cambio (opcional)</label>
                            <textarea class="form-control" id="motivoCambioFecha" rows="3"
                                      placeholder="Razón por la cual se reprograman las visitas..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-info" onclick="confirmarCambioFechaMasivo()">
                        <i class="fas fa-calendar-check"></i> Cambiar Fechas
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para crear cliente nuevo -->
    <div class="modal fade" id="modalClienteNuevo" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-user-plus"></i> Crear Cliente Nuevo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formClienteNuevo">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Nombre completo *</label>
                                    <input type="text" class="form-control" id="nuevoClienteNombre" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Cédula *</label>
                                    <input type="text" class="form-control" id="nuevoClienteCedula" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Teléfono *</label>
                                    <input type="tel" class="form-control" id="nuevoClienteTelefono" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Móvil</label>
                                    <input type="tel" class="form-control" id="nuevoClienteMovil">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Dirección *</label>
                                    <textarea class="form-control" id="nuevoClienteDireccion" rows="3" required></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" id="nuevoClienteEmail">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Coordenadas GPS</label>
                                    <input type="text" class="form-control" id="nuevoClienteCoordenadas"
                                           placeholder="Latitud, Longitud">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Localidad *</label>
                                    <select class="form-select" id="nuevoClienteLocalidad" required>
                                        <option value="">Seleccione la zona de instalación...</option>
                                        <option value="REPOSO">REPOSO</option>
                                        <option value="SALVADOR">SALVADOR</option>
                                        <option value="CHURIDO">CHURIDO</option>
                                        <option value="SALSIPUEDES">SALSIPUEDES</option>
                                        <option value="RIO GRANDE">RIO GRANDE</option>
                                        <option value="OSITO">OSITO</option>
                                        <option value="MI LUCHA">MI LUCHA</option>
                                        <option value="OTRA">OTRA LOCALIDAD</option>
                                    </select>
                                </div>
                                <div class="mb-3" id="nuevoClienteLocalidadOtraDiv" style="display: none;">
                                    <label class="form-label">Especificar localidad</label>
                                    <input type="text" class="form-control" id="nuevoClienteLocalidadOtra" placeholder="Ingrese el nombre de la localidad">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Motivo de la visita *</label>
                                    <select class="form-select" id="nuevoClienteMotivoVisita" required>
                                        <option value="">Seleccionar motivo...</option>
                                        <option value="Luz roja en el equipo">Luz roja en el equipo</option>
                                        <option value="Traslado">Traslado</option>
                                        <option value="Instalación">Instalación</option>
                                        <option value="Cambio de equipo">Cambio de equipo</option>
                                        <option value="Retiro">Retiro</option>
                                        <option value="Otro">Otro</option>
                                    </select>
                                </div>
                                <div class="mb-3" id="nuevoClienteMotivoPersonalizadoDiv" style="display: none;">
                                    <label class="form-label">Especificar motivo</label>
                                    <textarea class="form-control" id="nuevoClienteMotivoPersonalizado" rows="2"></textarea>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Fecha programada *</label>
                                    <input type="date" class="form-control" id="nuevoClienteFechaProgramada" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Notas adicionales</label>
                                    <textarea class="form-control" id="nuevoClienteNotas" rows="3"
                                              placeholder="Información adicional para el técnico..."></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Adjuntar PDFs para técnico (opcional)</label>
                            <input type="file" class="form-control" id="nuevoClienteArchivosPdf" accept=".pdf" multiple>
                            <div class="form-text">Puedes subir varios archivos PDF que el técnico podrá descargar.</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="crearClienteYVisita()">
                        <i class="fas fa-save"></i> Crear Cliente y Programar Visita
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para ver detalles de orden -->
    <div class="modal fade" id="modalDetalleOrden" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-tools"></i> Detalles de la Orden</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- Información principal -->
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-primary text-white">
                                    <h6><i class="fas fa-info-circle"></i> Información de la Orden</h6>
                                </div>
                                <div class="card-body">
                                    <p><strong>ID:</strong> <span id="modalOrdenId">-</span></p>
                                    <p><strong>Cliente:</strong> <span id="modalOrdenCliente">-</span></p>
                                    <p><strong>Dirección:</strong> <span id="modalOrdenDireccion">-</span></p>
                                    <p><strong>Descripción:</strong> <span id="modalOrdenDescripcion">-</span></p>
                                    <p><strong>Prioridad:</strong> <span id="modalOrdenPrioridad" class="badge">-</span></p>
                                    <p><strong>Estado:</strong> <span id="modalOrdenEstado" class="badge">-</span></p>
                                </div>
                            </div>
                        </div>

                        <!-- Información del técnico -->
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-success text-white">
                                    <h6><i class="fas fa-user-cog"></i> Técnico Asignado</h6>
                                </div>
                                <div class="card-body">
                                    <p><strong>Nombre:</strong> <span id="modalTecnicoNombre">-</span></p>
                                    <p><strong>Teléfono:</strong> <span id="modalTecnicoTelefono">-</span></p>
                                    <p><strong>Estado:</strong> <span id="modalTecnicoEstado" class="badge">-</span></p>
                                    <p><strong>Ubicación:</strong> <span id="modalTecnicoUbicacion">-</span></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Timeline de la orden -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-warning text-dark">
                                    <h6><i class="fas fa-history"></i> Historial de la Orden</h6>
                                </div>
                                <div class="card-body">
                                    <div id="modalOrdenTimeline">
                                        <p class="text-muted">Cargando historial...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Reportes y archivos -->
                    <div class="row mt-3" id="modalReportesSection" style="display: none;">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h6><i class="fas fa-file-alt"></i> Reportes y Archivos</h6>
                                </div>
                                <div class="card-body">
                                    <div id="modalOrdenReportes">
                                        <p class="text-muted">No hay reportes disponibles</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" id="btnActualizarEstado" onclick="mostrarCambioEstado()">
                        <i class="fas fa-edit"></i> Actualizar Estado
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Gestión de Técnicos -->
    <div class="modal fade" id="modalGestionTecnicos" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-users-cog"></i> Gestión de Técnicos
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-grid gap-3">
                        <button class="btn btn-primary btn-lg" onclick="mostrarUbicacionesTecnicos()" data-bs-dismiss="modal">
                            <i class="fas fa-map-marker-alt"></i> Ubicar Técnicos
                            <br><small class="d-block mt-1">Ver ubicación en tiempo real de los técnicos</small>
                        </button>

                        <button class="btn btn-success btn-lg" onclick="mostrarPermisosNap()" data-bs-dismiss="modal">
                            <i class="fas fa-map-pin"></i> Gestionar Permisos Cajas NAP
                            <br><small class="d-block mt-1">Activar/desactivar permiso para agregar cajas NAP</small>
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para ubicaciones de técnicos -->
    <div class="modal fade" id="modalUbicacionesTecnicos" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-map-marked-alt"></i> Ubicación de Técnicos en Tiempo Real
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        Muestra la última ubicación reportada por cada técnico en el mapa.
                        Usa los controles superiores para cambiar entre vista normal y satélite.
                    </div>

                    <!-- Contenedor del mapa -->
                    <div id="mapaUbicaciones"></div>

                    <!-- Información adicional -->
                    <div id="ubicacionesTecnicosContainer">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="mt-2">Cargando ubicaciones de técnicos...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-info" onclick="cargarUbicacionesTecnicos()">
                        <i class="fas fa-sync"></i> Actualizar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Gestionar Permisos Cajas NAP -->
    <div class="modal fade" id="modalPermisosNap" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-map-pin"></i> Gestionar Permisos Cajas NAP
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Permisos para agregar cajas NAP:</strong> Los técnicos con este permiso podrán agregar nuevas cajas NAP desde sus dispositivos móviles con validación GPS de precisión.
                    </div>

                    <div id="listaTecnicosNap">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="mt-2">Cargando técnicos...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-success" onclick="cargarTecnicosPermisosNap()">
                        <i class="fas fa-sync"></i> Actualizar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Verificación de autenticación al cargar la página
        (function() {
            console.log('🔍 Verificando autenticación para acceso a /admin...');

            const token = localStorage.getItem('token');

            if (!token) {
                console.log('❌ No se encontró token en localStorage');
                window.location.href = '/?error=auth_required';
                return;
            }

            console.log('✅ Token encontrado, verificando validez...');

            // Verificar token con el servidor
            fetch('/api/session?token=' + token)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.user) {
                        console.log('✅ Token válido, usuario autenticado:', data.user.username);
                        // Token válido, continuar cargando la página
                        document.addEventListener('DOMContentLoaded', function() {
                            console.log('📋 Página admin cargada correctamente');
                        });
                    } else {
                        console.log('❌ Token inválido o expirado');
                        localStorage.removeItem('token');
                        window.location.href = '/?error=token_invalid';
                    }
                })
                .catch(error => {
                    console.error('❌ Error verificando token:', error);
                    window.location.href = '/?error=server_error';
                });
        })();
    </script>
    <!-- Leaflet JS para mapas -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/admin_visitas.js?v=20251024-SERIAL-REPORTE"></script>
</body>
</html>